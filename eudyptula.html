<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Eudyptula Challenge</title>
<meta name="generator" content="Org mode" />
<meta name="description" content="Documenting my way through the eudyptula challenge"
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<style type="text/css">
h1.title { text-align: center; }
h2 { border-bottom: 1px solid #f0c; padding-bottom: 0.5em; padding-top: 0.5em; font-size: 1.75em; }
h3 { margin-bottom: 0; padding-bottom: 0; font-size: 1.4em; }
h4 { margin-bottom: 0; padding-bottom: 0; font-size: 1.15em; }
h5 { margin-bottom: 0; padding-bottom: 0; font-size: 1em; font-style: italic; }
h6 { margin-bottom: 0; padding-bottom: 0; font-size: 0.8em; font-style: italic; }
.outline-text-4 > :first-child { margin-top: .5em; }
#table-of-contents { position: fixed; left: 0; top: 0; width: 300px; height: 100%; overflow: auto; padding-left: 5px; padding-right: 5px; text-align:center; font-size: 0.85em; }
#table-of-contents ul { padding: 0; margin: 5px; padding-left: 15px; text-align:left; }
pre { margin-left: 3em; border-left: 2px solid #767676; background: #F1F1F1; padding: 1em 0em 1em 1em; font-size: 0.95em; }
pre.src { overflow-x: auto; overflow-y: visible; }
#postamble { text-align: center; font-size: 0.7em; border-top: 1px solid #ABA6A6; margin-top: 4em; color: #808080; }
#postamble p { width: 100%; }
body { font-family: Palatino; font-size: 1.00em; min-width: 250px; max-width: 650px; margin-left: 340px; padding-left: 15px; text-align: left; background-color: #fff7f4; line-height: 1.5; -webkit-font-smoothing: antialiased; }
html { scrollbar-color: #ABA6A6 #fff7f4; scroll-behavior: smooth; }
code { background: #EDEDED; font-size: 1.2em; font-weight: normal; font-style: normal; }
p, li { max-width: 59em; }
li p { margin: 0px; }
dt { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: normal; font-style: italic; }
span.todo, span.done { font-size: 50%; text-decoration: none; border-radius: 5px; padding: 3px; color: white; }
span.todo { background: #dd0000; }
span.done { background: #00dd00; }
blockquote { background: #dddddd; padding: .5em 1em .5em 1em; }
.figure { padding: 5px; }
table { margin-bottom:24px; }
a { cursor: pointer; color: #217ab7; line-height: inherit; transition: .14s; }
a:hover { color: white; background-color: #3297d3; }
a:visited { color: #43458b; border-color: #43458b; }
a:visited:hover { color: white; background-color: #9251ac; }
::selection { color: white; background: #ff4081; }
.org-bold { /* bold */ font-weight: bold; }
.org-bold-italic { /* bold-italic */ font-weight: bold; font-style: italic; }
.org-buffer-menu-buffer { /* buffer-menu-buffer */ font-weight: bold; }
.org-builtin { /* font-lock-builtin-face */ color: #7a378b; }
.org-button { /* button */ text-decoration: underline; }
.org-calendar-today { /* calendar-today */ text-decoration: underline; }
.org-change-log-acknowledgement { /* change-log-acknowledgement */ color: #b22222; }
.org-change-log-conditionals { /* change-log-conditionals */ color: #a0522d; }
.org-change-log-date { /* change-log-date */ color: #8b2252; }
.org-change-log-email { /* change-log-email */ color: #a0522d; }
.org-change-log-file { /* change-log-file */ color: #0000ff; }
.org-change-log-function { /* change-log-function */ color: #a0522d; }
.org-change-log-list { /* change-log-list */ color: #a020f0; }
.org-change-log-name { /* change-log-name */ color: #008b8b; }
.org-comint-highlight-input { /* comint-highlight-input */ font-weight: bold; }
.org-comint-highlight-prompt { /* comint-highlight-prompt */ color: #00008b; }
.org-comment { /* font-lock-comment-face */ color: #999988; font-style: italic; }
.org-comment-delimiter { /* font-lock-comment-delimiter-face */ color: #999988; font-style: italic; }
.org-completions-annotations { /* completions-annotations */ font-style: italic; }
.org-completions-common-part { /* completions-common-part */ color: #000000; background-color: #ffffff; }
.org-completions-first-difference { /* completions-first-difference */ font-weight: bold; }
.org-constant { /* font-lock-constant-face */ color: #008b8b; }
.org-diary { /* diary */ color: #ff0000; }
.org-diff-context { /* diff-context */ color: #7f7f7f; }
.org-diff-file-header { /* diff-file-header */ background-color: #b3b3b3; font-weight: bold; }
.org-diff-function { /* diff-function */ background-color: #cccccc; }
.org-diff-header { /* diff-header */ background-color: #cccccc; }
.org-diff-hunk-header { /* diff-hunk-header */ background-color: #cccccc; }
.org-diff-index { /* diff-index */ background-color: #b3b3b3; font-weight: bold; }
.org-diff-nonexistent { /* diff-nonexistent */ background-color: #b3b3b3; font-weight: bold; }
.org-diff-refine-change { /* diff-refine-change */ background-color: #d9d9d9; }
.org-dired-directory { /* dired-directory */ color: #0000ff; }
.org-dired-flagged { /* dired-flagged */ color: #ff0000; font-weight: bold; }
.org-dired-header { /* dired-header */ color: #228b22; }
.org-dired-ignored { /* dired-ignored */ color: #7f7f7f; }
.org-dired-mark { /* dired-mark */ color: #008b8b; }
.org-dired-marked { /* dired-marked */ color: #ff0000; font-weight: bold; }
.org-dired-perm-write { /* dired-perm-write */ color: #b22222; }
.org-dired-symlink { /* dired-symlink */ color: #a020f0; }
.org-dired-warning { /* dired-warning */ color: #ff0000; font-weight: bold; }
.org-doc { /* font-lock-doc-face */ color: #8b2252; }
.org-escape-glyph { /* escape-glyph */ color: #a52a2a; }
.org-file-name-shadow { /* file-name-shadow */ color: #7f7f7f; }
.org-flyspell-duplicate { /* flyspell-duplicate */ color: #cdad00; font-weight: bold; text-decoration: underline; }
.org-flyspell-incorrect { /* flyspell-incorrect */ color: #ff4500; font-weight: bold; text-decoration: underline; }
.org-fringe { /* fringe */ background-color: #f2f2f2; }
.org-function-name { /* font-lock-function-name-face */ color: teal; }
.org-header-line { /* header-line */ color: #333333; background-color: #e5e5e5; }
.org-help-argument-name { /* help-argument-name */ font-style: italic; }
.org-highlight { /* highlight */ background-color: #b4eeb4; }
.org-holiday { /* holiday */ background-color: #ffc0cb; }
.org-isearch { /* isearch */ color: #b0e2ff; background-color: #cd00cd; }
.org-isearch-fail { /* isearch-fail */ background-color: #ffc1c1; }
.org-italic { /* italic */ font-style: italic; }
.org-keyword { /* font-lock-keyword-face */ color: #0086b3; }
.org-lazy-highlight { /* lazy-highlight */ background-color: #afeeee; }
.org-link { /* link */ color: #0000ff; text-decoration: underline; }
.org-link-visited { /* link-visited */ color: #8b008b; text-decoration: underline; }
.org-log-edit-header { /* log-edit-header */ color: #a020f0; }
.org-log-edit-summary { /* log-edit-summary */ color: #0000ff; }
.org-log-edit-unknown-header { /* log-edit-unknown-header */ color: #b22222; }
.org-match { /* match */ background-color: #ffff00; }
.org-next-error { /* next-error */ background-color: #eedc82; }
.org-nobreak-space { /* nobreak-space */ color: #a52a2a; text-decoration: underline; }
.org-org-archived { /* org-archived */ color: #7f7f7f; }
.org-org-block { /* org-block */ color: #7f7f7f; }
.org-org-block-begin-line { /* org-block-begin-line */ color: #b22222; }
.org-org-block-end-line { /* org-block-end-line */ color: #b22222; }
.org-org-checkbox { /* org-checkbox */ font-weight: bold; }
.org-org-checkbox-statistics-done { /* org-checkbox-statistics-done */ color: #228b22; font-weight: bold; }
.org-org-checkbox-statistics-todo { /* org-checkbox-statistics-todo */ color: #ff0000; font-weight: bold; }
.org-org-clock-overlay { /* org-clock-overlay */ background-color: #ffff00; }
.org-org-code { /* org-code */ color: #7f7f7f; }
.org-org-column { /* org-column */ background-color: #e5e5e5; }
.org-org-column-title { /* org-column-title */ background-color: #e5e5e5; font-weight: bold; text-decoration: underline; }
.org-org-date { /* org-date */ color: #a020f0; text-decoration: underline; }
.org-org-document-info { /* org-document-info */ color: #191970; }
.org-org-document-info-keyword { /* org-document-info-keyword */ color: #7f7f7f; }
.org-org-document-title { /* org-document-title */ color: #191970; font-size: 144%; font-weight: bold; }
.org-org-done { /* org-done */ color: #228b22; font-weight: bold; }
.org-org-drawer { /* org-drawer */ color: #0000ff; }
.org-org-ellipsis { /* org-ellipsis */ color: #b8860b; text-decoration: underline; }
.org-org-footnote { /* org-footnote */ color: #a020f0; text-decoration: underline; }
.org-org-formula { /* org-formula */ color: #b22222; }
.org-org-headline-done { /* org-headline-done */ color: #bc8f8f; }
.org-org-hide { /* org-hide */ color: #ffffff; }
.org-org-latex-and-export-specials { /* org-latex-and-export-specials */ color: #8b4513; }
.org-org-level-1 { /* org-level-1 */ color: #0000ff; }
.org-org-level-2 { /* org-level-2 */ color: #a0522d; }
.org-org-level-3 { /* org-level-3 */ color: #a020f0; }
.org-org-level-4 { /* org-level-4 */ color: #b22222; }
.org-org-level-5 { /* org-level-5 */ color: #228b22; }
.org-org-level-6 { /* org-level-6 */ color: #008b8b; }
.org-org-level-7 { /* org-level-7 */ color: #7a378b; }
.org-org-level-8 { /* org-level-8 */ color: #8b2252; }
.org-org-link { /* org-link */ color: #0000ff; text-decoration: underline; }
.org-org-meta-line { /* org-meta-line */ color: #b22222; }
.org-org-mode-line-clock { /* org-mode-line-clock */ color: #000000; background-color: #bfbfbf; }
.org-org-mode-line-clock-overrun { /* org-mode-line-clock-overrun */ color: #000000; background-color: #ff0000; }
.org-org-quote { /* org-quote */ color: #7f7f7f; }
.org-org-scheduled { /* org-scheduled */ color: #006400; }
.org-org-scheduled-previously { /* org-scheduled-previously */ color: #b22222; }
.org-org-scheduled-today { /* org-scheduled-today */ color: #006400; }
.org-org-sexp-date { /* org-sexp-date */ color: #a020f0; }
.org-org-special-keyword { /* org-special-keyword */ color: #a020f0; }
.org-org-table { /* org-table */ color: #0000ff; }
.org-org-tag { /* org-tag */ font-weight: bold; }
.org-org-target { /* org-target */ text-decoration: underline; }
.org-org-time-grid { /* org-time-grid */ color: #b8860b; }
.org-org-todo { /* org-todo */ color: #ff0000; font-weight: bold; }
.org-org-upcoming-deadline { /* org-upcoming-deadline */ color: #b22222; }
.org-org-verbatim { /* org-verbatim */ color: #7f7f7f; }
.org-org-verse { /* org-verse */ color: #7f7f7f; }
.org-org-warning { /* org-warning */ color: #ff0000; font-weight: bold; }
.org-outline-1 { /* outline-1 */ color: #0000ff; }
.org-outline-2 { /* outline-2 */ color: #a0522d; }
.org-outline-3 { /* outline-3 */ color: #a020f0; }
.org-outline-4 { /* outline-4 */ color: #b22222; }
.org-outline-5 { /* outline-5 */ color: #228b22; }
.org-outline-6 { /* outline-6 */ color: #008b8b; }
.org-outline-7 { /* outline-7 */ color: #7a378b; }
.org-outline-8 { /* outline-8 */ color: #8b2252; }
.org-preprocessor { /* font-lock-preprocessor-face */ color: #7a378b; }
.org-query-replace { /* query-replace */ color: #b0e2ff; background-color: #cd00cd; }
.org-regexp-grouping-backslash { /* font-lock-regexp-grouping-backslash */ font-weight: bold; }
.org-regexp-grouping-construct { /* font-lock-regexp-grouping-construct */ font-weight: bold; }
.org-region { /* region */ background-color: #eedc82; }
.org-secondary-selection { /* secondary-selection */ background-color: #ffff00; }
.org-shadow { /* shadow */ color: #7f7f7f; }
.org-show-paren-match { /* show-paren-match */ background-color: #40e0d0; }
.org-show-paren-mismatch { /* show-paren-mismatch */ color: #ffffff; background-color: #a020f0; }
.org-string { /* font-lock-string-face */ color: #dd1144; }
.org-tool-bar { /* tool-bar */ color: #000000; background-color: #bfbfbf; }
.org-tooltip { /* tooltip */ color: #000000; background-color: #ffffe0; }
.org-trailing-whitespace { /* trailing-whitespace */ background-color: #ff0000; }
.org-type { /* font-lock-type-face */ color: #228b22; }
.org-underline { /* underline */ text-decoration: underline; }
.org-variable-name { /* font-lock-variable-name-face */ color: teal; }
.org-warning { /* font-lock-warning-face */ color: #ff0000; font-weight: bold; }
.org-widget-button { /* widget-button */ font-weight: bold; }
.org-widget-button-pressed { /* widget-button-pressed */ color: #ff0000; }
.org-widget-documentation { /* widget-documentation */ color: #006400; }
.org-widget-field { /* widget-field */ background-color: #d9d9d9; }
.org-widget-inactive { /* widget-inactive */ color: #7f7f7f; }
.org-widget-single-line-field { /* widget-single-line-field */ background-color: #d9d9d9; }
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Eudyptula Challenge</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#introduction">Introduction</a>
<ul>
<li><a href="#32aca210-6455-4ad6-9f83-78aba01cb38a">Setting up a virtual machine for development</a></li>
<li><a href="#fb318868-a843-4e6c-8483-db73d832b726">Credits</a></li>
<li><a href="#df2be478-eaa9-47f4-bbc5-9b9dd0ba83f9">Corrections</a></li>
</ul>
</li>
<li><a href="#task-01">1. Task 01</a>
<ul>
<li><a href="#796f8af5-c998-4ced-b76c-cc3ef18c4028">1.1. Linux headers</a></li>
<li><a href="#870e35ef-9ef0-47ca-a22b-20af91cd2d3d">1.2. Kbuild summarised</a></li>
<li><a href="#4fafb3ff-d889-4385-8d19-5f19fe4038bc">1.3. Creating the makefile for our out-of-tree module</a></li>
<li><a href="#5fd7fcd5-aa63-41f5-a706-0bbb1fb00b0a">1.4. Creating the first c file</a></li>
<li><a href="#087cb4b9-c8e8-4c47-91c9-1f4d269118f9">1.5. Compiling the module</a></li>
<li><a href="#73e04251-16ac-4999-84c4-1bd142016d02">1.6. Loading the module</a></li>
<li><a href="#0bee8a53-c137-49c1-acc0-8bbcaa060481">1.7. Unloading the module</a></li>
</ul>
</li>
<li><a href="#task-02">2. Task 02</a>
<ul>
<li><a href="#49e5b5b3-ef8e-44e1-b2d6-7ab6ed31d6b8">2.1. Fetching the latest tree</a></li>
<li><a href="#3fda4956-bf84-4e15-92bd-e0fa0f14922c">2.2. Creating a configuration file</a></li>
<li><a href="#6b1dd7f0-89ff-48ff-a59a-b58515eba1f9">2.3. Editing the configuration</a></li>
<li><a href="#00c06df9-606c-4bd0-a1fc-b05dbc333d3d">2.4. Building the kernel</a>
<ul>
<li><a href="#9b02819b-b51b-4339-8adc-99031847779a">2.4.1. The build process in a nutshell</a>
<ul>
<li><a href="#03221f99-a68c-42eb-a8ee-6649869f56ac">2.4.1.1. Preparation</a></li>
<li><a href="#0e65e166-9ffe-4103-ae09-35831a7e4dee">2.4.1.2. Compilation</a></li>
<li><a href="#24586f85-e4b8-432d-b93b-b2de6b4936be">2.4.1.3. Building bzImage</a></li>
</ul>
</li>
<li><a href="#57a3af29-fedc-41bd-b90a-28c4c1a3169a">2.4.2. Miscellaneous Kbuild features</a></li>
</ul>
</li>
<li><a href="#f7859da4-52ed-4327-a352-7c892bf99cd8">2.5. Installing and booting the kernel</a></li>
</ul>
</li>
<li><a href="#task-03">3. Task 03</a>
<ul>
<li><a href="#ba2b0280-b527-4e64-a3d8-4c74ab650119">3.1. Modifying the makefile</a></li>
<li><a href="#f991e442-3bfb-40e5-a0d5-9252bfee2424">3.2. Patch submission overview</a>
<ul>
<li><a href="#8f3424ab-c459-41a8-8a49-a8f1ce4296cf">3.2.1. Generating a patch</a></li>
<li><a href="#a944b06f-a915-40a1-907d-9104316ceec6">3.2.2. Reviewing the changes</a></li>
<li><a href="#f94fde9c-9319-4be1-a04c-c065dc93d257">3.2.3. Describing the changes</a></li>
<li><a href="#503e1947-f374-4f8e-af59-7f30a9927256">3.2.4. Style-checking</a></li>
<li><a href="#e5fdebc8-59be-4165-ae62-8ba33845cc95">3.2.5. Selecting the recipients</a></li>
<li><a href="#58bd21c9-148d-49df-ad6d-ae92d1252601">3.2.6. Email issues</a></li>
<li><a href="#39cf59d3-0ee8-4502-97e0-18dae366b26e">3.2.7. Feedback</a></li>
</ul>
</li>
<li><a href="#80867276-19a9-4cc9-9c66-fc23589fbe7b">3.3. Creating our patch</a></li>
</ul>
</li>
<li><a href="#task-04">4. Task 04</a>
<ul>
<li><a href="#3059ef5f-6256-4674-8e98-63f1ab336f8a">4.1. Linux kernel coding style</a></li>
<li><a href="#bc6ba800-d10d-41c9-a9b3-646f4ea93c53">4.2. Running checkpatch.pl</a></li>
</ul>
</li>
<li><a href="#task-05">5. Task 05</a>
<ul>
<li><a href="#7dec8acc-8de6-4b4c-93d1-59850d71e7f7">5.1. The device model: a super-quick primer</a></li>
<li><a href="#c94004f2-c0ce-490c-895c-1569717784b2">5.2. A detour through udev</a>
<ul>
<li><a href="#013c2fc3-cc14-4a15-918b-9044cef2102b">5.2.1. Basics of udev and hotplug events</a></li>
<li><a href="#2bfd1af6-336c-40df-b5af-5dc440db7a66">5.2.2. Udev rules</a>
<ul>
<li><a href="#7ef99fb1-8d4c-4913-99c7-fe95f2eb4fe3">5.2.2.1. Where do rule files go?</a></li>
<li><a href="#7e9c0898-b070-45b0-af44-6273c0662f38">5.2.2.2. Syntax</a></li>
<li><a href="#2d0f522c-2958-40b3-a600-724fb9589671">5.2.2.3. Matching keys</a></li>
<li><a href="#292c74fa-0c3f-4d53-8008-506659775a48">5.2.2.4. Assignable keys</a></li>
<li><a href="#8b0d2d2d-46ed-4816-9249-ec5dac8c4493">5.2.2.5. Getting information about our device</a></li>
<li><a href="#d7dc3f0b-d414-44b1-9f93-db449e02f468">5.2.2.6. Testing and debugging</a></li>
<li><a href="#1c8f0de9-22d8-41c6-9fd3-db29a3b67051">5.2.2.7. Device nodes and persistent naming</a></li>
<li><a href="#bee7ac40-79e5-4d1c-85c3-eb2efb36cb79">5.2.2.8. A caveat about &ldquo;remove&rdquo; actions</a></li>
</ul>
</li>
<li><a href="#3dc9b642-60d9-4cb1-9531-cb07d0cc5d90">5.2.3. Implementing a rule</a></li>
</ul>
</li>
<li><a href="#88750d69-5d84-478c-9ea6-a4f5388fa3be">5.3. Module device tables</a></li>
<li><a href="#1b41b15a-5d3b-4eb9-a2f4-a2246de3533d">5.4. Module aliases</a></li>
<li><a href="#fa713ee2-069a-4e8d-aba4-3ba57e926021">5.5. Getting the modalias for a USB keyboard</a></li>
<li><a href="#a3cee954-faab-4205-baf5-a375d73702c2">5.6. Testing</a></li>
<li><a href="#288997b5-ba67-4ac3-a0f8-d49028149d59">5.7. Some final notes</a></li>
</ul>
</li>
<li><a href="#task-06">6. Task 06</a>
<ul>
<li><a href="#628566a0-dd52-425e-b686-b6e31e2ebdfe">6.1. Device numbers</a></li>
<li><a href="#0ead0429-3ed9-423d-ad8b-d38ab99e0df7">6.2. The misc driver interface</a></li>
<li><a href="#ddfd869d-eaa0-492d-85fb-e2827a3ec726">6.3. The <code>read()</code> and <code>write()</code> methods</a></li>
</ul>
</li>
<li><a href="#task-07">7. Task 07</a>
<ul>
<li><a href="#51d453ee-3820-493c-9a0b-7a1ef245fa14">7.1. The development process</a></li>
<li><a href="#e5245215-1ea9-49ac-afaa-14c42f256953">7.2. Tracking <code>linux-next</code></a></li>
<li><a href="#9d458971-912d-4195-a90d-3ea26402117e">7.3. Building and booting</a></li>
</ul>
</li>
<li><a href="#task-08">8. Task 08</a>
<ul>
<li><a href="#378a8d38-264d-4191-ac39-0d6c6a130a4e">8.1. The debugfs interface</a></li>
<li><a href="#318c0505-15a5-484e-97dc-0e77ebe8741a">8.2. Writing the module</a></li>
</ul>
</li>
<li><a href="#task-09">9. Task 09</a>
<ul>
<li><a href="#0f44c8ce-e15d-4def-9581-af00df326fdf">9.1. The sysfs interface (user-space)</a></li>
<li><a href="#54a76569-1db2-400c-8d39-a32b708b2334">9.2. The sysfs interface (kernel-space)</a></li>
<li><a href="#a71711c3-9f80-4153-a4a6-de82bcdcd297">9.3. Writing the module</a></li>
</ul>
</li>
<li><a href="#task-10">10. Task 10</a>
<ul>
<li><a href="#a027dab5-0f27-47e8-96bd-6545365c4f11">10.1. Email</a>
<ul>
<li><a href="#ece3540d-ebdd-4382-bfb5-7cb3c7591ca7">10.1.1. Concepts</a>
<ul>
<li><a href="#bfbf5793-b0db-4708-bf7e-34ff8fcd1424">10.1.1.1. Agents</a></li>
<li><a href="#32d52f3f-88e3-45f9-a363-4c63f7e3b6bc">10.1.1.2. Protocols</a></li>
<li><a href="#70c18aa3-235f-4cea-88ac-29be3397ecbd">10.1.1.3. Mail exchanger record</a></li>
<li><a href="#e0a94050-39f2-473b-8f75-21681fa1590d">10.1.1.4. Maildir/mbox</a></li>
<li><a href="#ca8eb5d9-cf1e-4ba7-b0a2-693d10300928">10.1.1.5. <code>MAIL FROM</code> and <code>FROM</code> addresses</a></li>
</ul>
</li>
<li><a href="#c2939824-a819-492b-8b04-1ee6bb2b2748">10.1.2. Workflow</a></li>
<li><a href="#751648db-fa8d-4d8d-9bd4-aa7d490f7b6d">10.1.3. Setting things up</a>
<ul>
<li><a href="#10772f62-bbcb-430a-8dae-e4e3d9902419">10.1.3.1. Configuring git</a></li>
<li><a href="#95f2185c-3c3a-4513-b67f-a0daeecd7509">10.1.3.2. Miscellaneous settings</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#d235cb47-cd5b-473f-b198-12ab2dc0279d">10.2. Sending patches with <code>git send-email</code></a>
<ul>
<li><a href="#8648a480-a1d8-4eb3-856f-b1f816f2f18f">10.2.1. Bonus: Sending patches as drafts</a></li>
</ul>
</li>
<li><a href="#f0bcc5fd-ad27-4a24-b877-cc168da7f10d">10.3. Applying patches with <code>git am</code></a></li>
<li><a href="#c8e5030c-1c37-481f-ba8a-0c0fe7678477">10.4. Interacting with the mailing lists</a></li>
<li><a href="#18f371b7-45c3-422d-8021-99d3c0f47f3b">10.5. Developing the patch</a>
<ul>
<li><a href="#696e1817-149c-4d21-95a5-0662bbfc0589">10.5.1. Bug hunting</a></li>
<li><a href="#693d8d1f-7542-4be1-a1cc-0878ac475f20">10.5.2. Bonus: Setting up a git hook</a></li>
<li><a href="#ab7ca52b-c336-472f-8eb3-46513861c2f8">10.5.3. Bonus: Integrating clang-format with our tools</a></li>
</ul>
</li>
<li><a href="#e09ad9cf-ae87-46fb-9dce-899b38cebe8e">10.6. Building and testing</a>
<ul>
<li><a href="#e91e9b02-d5b6-4120-b040-587ffafd9573">10.6.1. Static analysis</a></li>
<li><a href="#5d3c4be3-a897-4157-bcbb-193196b0ae48">10.6.2. Kicking the tyres</a></li>
<li><a href="#23793e7f-3916-431f-969f-decf81f15277">10.6.3. In-tree tests</a></li>
<li><a href="#18250311-d2c7-48bc-a3e4-650f7a9a3724">10.6.4. Configuration options</a></li>
<li><a href="#408921a2-e992-41fe-93ef-1167357ac5d0">10.6.5. Linux Test Project (LTP)</a></li>
<li><a href="#776e802a-d218-4a2a-8bda-4d37fd36d915">10.6.6. Fuzzing tools</a></li>
<li><a href="#24cc419b-7028-40eb-bc94-369977fd5976">10.6.7. CI services</a></li>
<li><a href="#ddd09c11-fd01-4937-8316-9d2346105c32">10.6.8. Other test frameworks</a></li>
</ul>
</li>
<li><a href="#546cf8d1-ff03-45c2-a9ad-ec2c1f871301">10.7. Submitting the patch</a>
<ul>
<li><a href="#27563f63-557d-4f7b-afa4-39bd7107b4e7">10.7.1. Bonus: Integrating <code>get_maintainer.pl</code> with <code>git send-email</code></a></li>
</ul>
</li>
<li><a href="#a316f564-f9e6-450e-ad1f-8a1659a6f35c">10.8. Finishing the task: a timeline</a></li>
</ul>
</li>
<li><a href="#task-11">11. Task 11</a>
<ul>
<li><a href="#4b1a98a8-f2a4-4919-89b7-cf695e87c782">11.1. Choosing a driver</a></li>
<li><a href="#670db2c8-3179-4003-9323-cd50b2b2a5bf">11.2. Changing my workflow</a>
<ul>
<li><a href="#97f80e94-2336-494f-a4f3-57a3f6c1d635">11.2.1. Bonus: Installing a kernel</a></li>
</ul>
</li>
<li><a href="#98abce55-66aa-4c88-b54c-4b892f8f4a7f">11.3. The pcspkr module</a>
<ul>
<li><a href="#16e442bc-e96b-442f-abbd-bb166f268f7a">11.3.1. What is a platform driver?</a></li>
<li><a href="#6d0562fc-cb54-4d48-85d4-246af8a032ad">11.3.2. The hardware</a></li>
<li><a href="#d1a45dbc-5ca3-4b81-bc7b-bbe22295f591">11.3.3. The software</a></li>
</ul>
</li>
<li><a href="#59287b31-6102-4b79-a2e3-28e29364b41d">11.4. Patching the driver</a></li>
</ul>
</li>
<li><a href="#task-12">12. Task 12</a>
<ul>
<li><a href="#459bf909-97d0-4e70-a002-e9c11ebca950">12.1. Linked lists</a></li>
<li><a href="#57afe223-be49-4bd7-9591-7aa677fa8cdf">12.2. Dynamic debug</a></li>
<li><a href="#de624811-3fef-4e50-86ce-73058ece10be">12.3. Additional remarks</a></li>
</ul>
</li>
<li><a href="#task-13">13. Task 13</a>
<ul>
<li><a href="#c0314dff-4d49-485b-bd4b-2664baa3d5e9">13.1. The slab layer</a></li>
</ul>
</li>
<li><a href="#task-14">14. Task 14</a>
<ul>
<li><a href="#a1202bce-7d58-4703-8b86-80a732a04a53">14.1. Tasks and task structs</a></li>
<li><a href="#ee25c264-b261-4a1e-b314-a06bc3932284">14.2. Procfs and tracing through a fork</a></li>
<li><a href="#20d257c6-777e-4aa7-b727-800100607fd5">14.3. Writing the patch</a></li>
</ul>
</li>
<li><a href="#task-15">15. Task 15</a>
<ul>
<li><a href="#588ee577-5c47-4944-aa44-5e324a8a2a72">15.1. System calls</a></li>
<li><a href="#8913729c-5b47-4710-bfb0-30fa1c9bd9f3">15.2. Syscalls in the kernel</a></li>
<li><a href="#0c51f5cf-4b22-4fba-a337-e7abee802d82">15.3. Adding the new syscall</a></li>
<li><a href="#843a8751-401b-43a1-9c25-803c899aa48d">15.4. Testing our new syscall</a></li>
</ul>
</li>
<li><a href="#task-16">16. Task 16</a>
<ul>
<li><a href="#e174e541-7e7c-4077-956a-217cb3c4154d">16.1. Sparse in more detail</a></li>
<li><a href="#1be643ca-f17f-4c4c-b6ef-66f77df933e9">16.2. Running sparse</a></li>
<li><a href="#168c4d3e-a3b8-4728-88c4-c5477e5c3698">16.3. Final remarks on Kbuild, et al.</a></li>
</ul>
</li>
<li><a href="#task-17">17. Task 17</a>
<ul>
<li><a href="#569a2838-056c-4534-912d-87169f0e33fd">17.1. Kthreads</a></li>
<li><a href="#581b8ea6-452a-4afd-bf81-967d09c67abc">17.2. Wait queues</a></li>
<li><a href="#1fa85feb-1770-490d-a705-2af56f13e57a">17.3. Final notes</a></li>
</ul>
</li>
<li><a href="#task-18">18. Task 18</a>
<ul>
<li><a href="#04bc961f-02bb-4176-8f20-771d17dce672">18.1. Final notes</a></li>
</ul>
</li>
<li><a href="#task-19">19. Task 19</a>
<ul>
<li><a href="#cd7fd39a-ccb8-4fea-a956-86587da6d880">19.1. Network devices and Netfilter</a></li>
<li><a href="#46e91529-0618-4365-8938-4a9b7bdef9d1">19.2. Packet-flow and Netfilter hooks</a></li>
<li><a href="#64aa9355-9e8a-4c65-be8c-14e609fe9f30">19.3. Registering hook ops</a></li>
<li><a href="#3f8d9bca-747a-4107-9011-a75747c533ed">19.4. Socket buffers</a></li>
<li><a href="#5574be25-c38b-4242-9017-f3e3fb9483c7">19.5. Inspecting packets</a></li>
<li><a href="#cd2ed185-d8ed-4358-b794-90e6c44ddd92">19.6. Testing</a></li>
</ul>
</li>
<li><a href="#task-20">20. Task 20</a>
<ul>
<li><a href="#d5a575b4-d3cd-417d-8845-c9ac28799743">20.1. Volume labels</a></li>
<li><a href="#a04c12ba-7f88-4def-92c8-4ff5f10c20ac">20.2. FAT</a>
<ul>
<li><a href="#fc0fd2ad-1761-471b-917e-66893301e55a">20.2.1. Structure</a></li>
<li><a href="#2305b3f8-4081-432f-ae10-bf04cf659ea8">20.2.2. Directory entries, VFAT, and LFNs</a></li>
<li><a href="#6a1df2b1-d23f-4f09-8d10-1f875d4a10ef">20.2.3. Metadata</a></li>
</ul>
</li>
<li><a href="#69228d1b-cd0a-426c-9f2d-d0c1c14e07e5">20.3. Revisiting earlier questions</a></li>
<li><a href="#37acde81-1719-4fcc-b189-cdc96f389c3d">20.4. Loop devices</a></li>
<li><a href="#64903da4-6a6a-4e88-89a0-bc2425fcfefc">20.5. Allocating a ramdisk</a></li>
<li><a href="#82e788e6-aeb4-4fa0-883e-7015f6e3eb75">20.6. Taking stock</a></li>
<li><a href="#0e411c07-9b10-4be0-8e04-d424da3b3992">20.7. The VFS layer</a></li>
<li><a href="#e6d3ab05-8a07-40b6-b3ed-62d1cf8affcd">20.8. The ioctl interface</a></li>
<li><a href="#741a2b59-aa6d-457f-a8df-f21ccd8ab743">20.9. Implementing the new ioctls</a></li>
</ul>
</li>
<li><a href="#appendices">Appendices</a>
<ul>
<li><a href="#paring-down-a-kernel-config">Paring down a kernel configuration</a></li>
<li><a href="#troubleshooting-cifs">Troubleshooting CIFS</a></li>
<li><a href="#resizing-a-vm-image">Resizing a VM image</a>
<ul>
<li><a href="#82b0cbdf-1d21-4cc4-b77f-50762db1e90c">Resizing the disk image</a></li>
<li><a href="#de0f6e93-299c-4b0c-926f-d3df2e67e031">Taking up the space</a></li>
</ul>
</li>
<li><a href="#the-pc-speaker-device">The pc speaker device</a></li>
<li><a href="#module-auto-loading">Module auto-loading</a></li>
<li><a href="#source-kernel-uninstall-script">Source kernel uninstall script</a></li>
<li><a href="#procfs">Procfs</a></li>
<li><a href="#setting-up-a-credential-helper-for-git">Setting up a credential helper for git</a></li>
<li><a href="#mailing-list-archives">Mailing list archives</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org581b294" class="outline-2">
<h2 id="introduction">Introduction</h2>
<div class="outline-text-2" id="text-introduction">
<p>
Why did I decide to do the eudyptula challenge?  And why bother writing about
it for that matter?
</p>
<ul class="org-ul">
<li>I was interested in learning more about the linux kernel on all levels.
Even if I never wrote a driver or port the kernel to a new architecture, I
have a belief that one can&rsquo;t wield a tool effectively if they haven&rsquo;t fully
grasped the problems it exists to solve.</li>
<li>It required engaging in and developing knowledge in adjacent topics (and
even some non-adjacent ones).<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup></li>
<li>The process of writing notes down is, I think, a good way of ensuring that
one has a <a href="https://www.lesswrong.com/posts/B7P97C27rvHPz3s9B/gears-in-understanding">gears-level understanding</a> of a topic.  If I find myself mentally
straining to enunciate some complex idea in plain english, this is good news
in a way &#x2014; it suggests that there&rsquo;s a blind spot or point of friction in
my understanding, and <a href="https://addyosmani.com/blog/write-learn/">more research is required</a>.  Perhaps you could call
this a kind of preemptive <a href="https://en.wikipedia.org/wiki/Rubber_duck_debugging">rubber-duck debugging</a>.</li>
<li>I wanted to challenge myself.</li>
<li>It may be of help to others that relate to the points above.</li>
<li>It&rsquo;s a vanity project.</li>
<li>I try to document everything I study, because my brain isn&rsquo;t so great at
remembering concrete facts or juggling many things in working memory.  So
writing this up probably didn&rsquo;t involve much extra work all things
considered.</li>
<li>Learning about the kernel is <i>fun</i>! ðŸ¤¡</li>
</ul>

<p>
The eudyptula challenge had not been accepting new applicants for a few years,
and seemed to be spoken of in the paste tense (the <a href="http://eudyptula-challenge.org/">original website</a> has been
dormant since 2017).  That being said, if you&rsquo;re going through the tasks
yourself, I would suggest only referring to these notes when you&rsquo;re stuck, or
as a sanity check once you&rsquo;ve completed a task.  At some point after
publishing this, I&rsquo;ll include my solutions on github.
</p>

<p>
Occasionally in the course of completing the tasks I will go over information
that&rsquo;s already available from cited texts or websites, or branch off into
tangentially-related topics &#x2014; feel free to skip those subsections.
(Conversely, there are probably many adjacent topics or snippets of info that
I omitted which might have been useful to the odd person.)
</p>

<p>
If you have any questions or feedback, <a href="mailto:scottjcrouch%20at%20jee-male">please get in touch</a>!
</p>
</div>
<div id="outline-container-org745055f" class="outline-3">
<h3 id="32aca210-6455-4ad6-9f83-78aba01cb38a">Setting up a virtual machine for development</h3>
<div class="outline-text-3" id="text-32aca210-6455-4ad6-9f83-78aba01cb38a">
<p>
For these tasks, as an alternative to developing natively, I set up a 64-bit
Debian image within which I could safely play around.  The steps I took to set
this up were as follows:
</p>
<ul class="org-ul">
<li>download latest Debian release</li>
<li>install qemu</li>
<li>create a script to launch QEMU with some basic options (see github)</li>
<li><p>
create a base image
</p>
<div class="org-src-container">
<pre class="src src-bash">qemu-img create -f qcow2 img1.qcow2 8G
</pre>
</div></li>
<li>install Debian on the base image</li>
<li><p>
install development tools (see the <a href="https://www.kernel.org/doc/html/latest/process/changes.html">official docs</a>)
</p>
<div class="org-src-container">
<pre class="src src-bash">apt install gcc make git bc libssl-dev libncurses5-dev linux-headers-$(uname -r) samba
</pre>
</div></li>
<li><p>
freeze the base image and create an image overlay to do the tasks on
</p>
<div class="org-src-container">
<pre class="src src-bash">qemu-img create -o <span class="org-variable-name">backing_file</span>=img1.qcow2,<span class="org-variable-name">backing_fmt</span>=qcow2 -f qcow2 img1_overlay.qcow2
</pre>
</div></li>
<li><p>
configure automounting of the samba share<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup><sup>, </sup><sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup>
</p>
<div class="org-src-container">
<pre class="src src-bash">mkdir -p /mnt/qemu
<span class="org-builtin">echo</span> <span class="org-string">"//10.0.2.4/qemu /mnt/qemu cifs x-systemd.automount,username=guest,file_mode=0777,dir_mode=0777 0 0"</span> &gt;&gt; /etc/fstab
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgdd2deda" class="outline-3">
<h3 id="fb318868-a843-4e6c-8483-db73d832b726">Credits</h3>
<div class="outline-text-3" id="text-fb318868-a843-4e6c-8483-db73d832b726">
<p>
Much of this information I was able to source from various blog posts by
kernel developers and community forums.  I provide links to these where
relevant.  A special shout-out goes to Jonathan Corbet&rsquo;s endlessly helpful
exegetical writings at <a href="https://lwn.net/">LWN.net</a> and his efforts to improve the kernel
documentation, as well as Greg Kroah-Hartman&rsquo;s (GKH) indefatigable patience
with lesser experienced folk on the mailing lists.
</p>

<p>
Some texts that I found to be helpful were:
</p>
<ul class="org-ul">
<li>Linux Kernel Development, Robert Love, 3rd Ed. (LKD)</li>
<li>Linux Device Drivers, Jonathan Corbet, 3rd Ed. (LDD)</li>
<li>Linux Kernel in a Nutshell, Greg Kroah-Hartman (LKN)</li>
<li>Mastering Embedded Linux Programming, Chris Simmonds (MELP)</li>
</ul>

<p>
The first three texts are somewhat out-of-date, dating as far back as 2.6.
However, 2.6 was a fairly significant milestone for the kernel, when it really
began to take shape.  It still provides a base of contextual knowledge
necessary to make sense of revisions that have come since.  Nowadays, the
definitive resource for kernel/module/driver development is the <a href="https://docs.kernel.org/driver-api/">in-tree kernel
documentation</a>, which has improved considerably in recent years.  Ideally,
this is supposed to replace existing, comparatively static texts that can&rsquo;t
keep up with the rapid pace of kernel development.  Some tangential resources
of note here include an enumeration of available <a href="https://docs.kernel.org/dev-tools/">dev-tools</a>, and a description
of the <a href="https://docs.kernel.org/process/">kernel development process</a>.<sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup>
</p>
</div>
</div>
<div id="outline-container-orgb3ebf36" class="outline-3">
<h3 id="df2be478-eaa9-47f4-bbc5-9b9dd0ba83f9">Corrections</h3>
<div class="outline-text-3" id="text-df2be478-eaa9-47f4-bbc5-9b9dd0ba83f9">
<p>
This document mainly follows my thought process as I worked through the tasks.
Furthermore, my solutions were not subject to code review from an experienced
kernel developer.  As such, it should not be considered an iron-clad
reference.  However, it&rsquo;s important that I not perpetuate untruths, which an
inexperienced person is apt to do.  As such, I warmly welcome any corrections,
qualifying remarks, or requests for attestation.  If so, please get in touch
via <a href="mailto:scottjcrouch%20at%20jee-male">email</a>.  Bear in mind, however, that since most of this was a process of
learning on-the-go, information introduced in later tasks will sometimes
provide more detail or better methods of doing earlier ones.  (For that
reason, it might even be a good idea to read this backwards, and jump to
earlier tasks when procedural details are found wanting but for the sake of
brevity were omitted.)
</p>
</div>
</div>
</div>
<div id="outline-container-org785f84f" class="outline-2">
<h2 id="task-01"><span class="section-number-2">1</span> Task 01</h2>
<div class="outline-text-2" id="text-task-01">
<blockquote>
<p>
Write a Linux kernel module, and stand-alone Makefile, that when loaded prints
to the kernel debug log level, &ldquo;Hello World!&rdquo; Be sure to make the module be
able to be unloaded as well. The Makefile should build the kernel module
against the source for the currently running kernel, or, use an environment
variable to specify what kernel tree to build it against.
</p>
</blockquote>
</div>
<div id="outline-container-orge53c495" class="outline-3">
<h3 id="796f8af5-c998-4ced-b76c-cc3ef18c4028"><span class="section-number-3">1.1</span> Linux headers</h3>
<div class="outline-text-3" id="text-796f8af5-c998-4ced-b76c-cc3ef18c4028">
<p>
First, we need to obtain the linux headers we are going to build against.  (We
<i>could</i> just build against our kernel tree, but this requires that the kernel
built therein is the one we&rsquo;ll be running when we test the module).  For this,
we&rsquo;ll need the headers specifically for building kernel modules out-of-tree.
For example, installing the <code>linux-headers-$(uname -r)</code> package on Debian-based
distros will install the headers for the running kernel in
<code>/usr/src/linux-headers-$(uname -r)</code>.  Alternatively, we may be better off
installing something like the <code>linux-headers-generic</code> package (or equivalent for
your distro), which will keep these headers up-to-date with the generic kernel
that is installed.
</p>

<p>
Note that those are not the same thing as the sanitised, API-stable kernel
headers (or &ldquo;UAPI&rdquo; headers) specifically meant for user-space and libc.  The
unsanitised kernel headers, in their raw state, are for internal use only, as
they contain symbols extraneous to user-space.  The sanitised headers are
normally installed in <code>/usr/include/</code> by your package manager (alternatively, by
running <code class="src src-bash">make <span class="org-variable-name">INSTALL_HDR_PATH</span>=<span class="org-string">"/usr/local"</span> headers_install</code>), and contains the following subdirectories:
</p>
<dl class="org-dl">
<dt><code>/usr/include/asm/*.h</code></dt><dd>Architecture-specific assembly headers</dd>
<dt><code>/usr/include/asm-generic/*.h</code></dt><dd>Architecture-independent assembly headers
which contain portable C</dd>
<dt><code>/usr/include/drm/*.h</code></dt><dd>Headers for interacting with the Direct Rendering
Manager (DRM) subsystem (video output)</dd>
<dt><code>/usr/include/linux/*.h</code></dt><dd>Core Linux API headers</dd>
<dt><code>/usr/include/misc/*.h</code></dt><dd>Miscellaneous headers</dd>
<dt><code>/usr/include/mtd/*.h</code></dt><dd>Headers for interacting with Memory Technology
Devices (MTD)</dd>
<dt><code>/usr/include/rdma/*.h</code></dt><dd>Headers for Remote Direct Memory Access (RDMA)</dd>
<dt><code>/usr/include/scsi/*.h</code></dt><dd>Headers for interacting with SCSI devices</dd>
<dt><code>/usr/include/sound/*.h</code></dt><dd>Sound subsystem (ALSA) headers</dd>
<dt><code>/usr/include/video/*.h</code></dt><dd>Headers for some frame buffer devices</dd>
<dt><code>/usr/include/xen/*.h</code></dt><dd>Headers for the Xen hypervisor</dd>
</dl>

<p>
These headers are backwards compatible; a C library that uses older kernel
headers will work on a newer kernel (though anything built against the older
headers obviously won&rsquo;t have access to newer kernel features).
</p>

<p>
The various makefiles scattered about the kernel source tree are tasked with,
<i>inter alia</i>, specifying how to process and export headers that need to be
exported to user-space.  This pre-processing step includes:
</p>
<ul class="org-ul">
<li>removing kernel-specific annotations;</li>
<li>removing inclusion of <code>compiler.h</code>; and</li>
<li>removing sections that are kernel internal, i.e., guarded by <code>#ifdef
  __KERNEL__</code>.</li>
</ul>

<p>
UAPI headers will be covered again in <a href="#task-15">task 15</a>.
</p>
</div>
</div>
<div id="outline-container-org469144a" class="outline-3">
<h3 id="870e35ef-9ef0-47ca-a22b-20af91cd2d3d"><span class="section-number-3">1.2</span> Kbuild summarised</h3>
<div class="outline-text-3" id="text-870e35ef-9ef0-47ca-a22b-20af91cd2d3d">
<p>
The Kbuild system consists of:
</p>
<ul class="org-ul">
<li>the (user-customisable) config file;</li>
<li>the top-level makefile;</li>
<li>the arch-specific makefile in <code>arch/$(ARCH)/</code>;</li>
<li>common rules for all Kbuild makefiles; <code>scripts/Makefile.*</code>; and</li>
<li>individual makefiles in each source-code-containing subdirectory.</li>
</ul>

<p>
Each Kbuild makefile specifies what objects are to be built, and when to do
so, by appending the names of build targets to the <code>obj-y</code> or <code>obj-m</code> variables
defined at the top-level.  A module named <code>foo</code>, for example, might add its
object files like so:
</p>
<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">obj-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_FOO</span></span><span class="org-variable-name">)</span> += foo.o
</pre>
</div>
<p>
In this case, <code>CONFIG_FOO</code> is expected to be defined in the configuration as
either &ldquo;y&rdquo;, &ldquo;m&rdquo;, or neither.  Adding objects to the <code>obj-y</code> list means they will
be built into the kernel; to this end, a <code>built-in.a</code> file will be built as an
intermediate step, and linked in to the final kernel image in a later pass.
The <code>obj-m</code> list is used for dynamically loadable modules.  There also exists a
<code>lib-y</code> list for creating static libraries.
</p>

<p>
If a module consists of multiple source files, one must inform Kbuild about
them by appending them to a <code>&lt;MODULE_NAME&gt;-y</code> variable:
</p>
<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">obj-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_FOO</span></span><span class="org-variable-name">)</span> += foo.o
<span class="org-variable-name">foo-y</span> := alpha.o beta.o gamma.o
</pre>
</div>
<p>
A makefile is only ever responsible for building files in its own directory
&#x2014; local subdirectories need their own makefiles, and so on.  To tell Kbuild
to descend down into a subdirectory such that it will be built, we simply add
the directory as though it were an object file:
</p>
<div class="org-src-container">
<pre class="src src-makefile"><span class="org-variable-name">obj-$(</span><span class="org-variable-name"><span class="org-variable-name">CONFIG_EXT2_FS</span></span><span class="org-variable-name">)</span> += ext2/
</pre>
</div>
<p>
If the config variable is set to &ldquo;y&rdquo;, then Kbuild will look for and link any
built-ins it finds into <code>vmlinux</code>.
</p>

<p>
Kbuild is dependency-aware.  Specifically, it knows when changes are made to
the:
</p>
<ul class="org-ul">
<li>target prerequisites (both *.c and *.h);</li>
<li><code>CONFIG_*</code> options used in prerequisite files; and</li>
<li>command-line arguments used to compile the target.</li>
</ul>

<p>
If any of these have changed since the last build, all files downstream from
them in the build process will be recompiled.
</p>
</div>
</div>
<div id="outline-container-orga02e139" class="outline-3">
<h3 id="4fafb3ff-d889-4385-8d19-5f19fe4038bc"><span class="section-number-3">1.3</span> Creating the makefile for our out-of-tree module</h3>
<div class="outline-text-3" id="text-4fafb3ff-d889-4385-8d19-5f19fe4038bc">
<div class="org-src-container">
<pre class="src src-makefile">ifeq ($(<span class="org-variable-name">KERNELRELEASE</span>),)

<span class="org-comment-delimiter"># </span><span class="org-comment">In order to compile our module, we'll need to be running our makefile within</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Kbuild, either from within a kernel source tree, or a module build directory</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">provided by the relevant linux-headers package.  If we have reached this</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">code path (KERNELRELEASE is undefined), then it means we're *not* inside</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Kbuild.  Thus here we define some targets to invoke make from within a</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Kbuild environment by proxy, and pointing it back to this directory.</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Defining M does exactly this, telling Kbuild that we wish to build external</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">modules in the directory specified.  By default, we'll build against the</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">same version as that of the running kernel.</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Define the directory where the headers for the running kernel are located.</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">The '?=' operator assigns the variable only if it was undefined, allowing us</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">to define this variable the command line instead.</span>
<span class="org-variable-name">KERNELDIR</span> ?= /lib/modules/$(<span class="org-variable-name">shell</span> uname -r)/build

<span class="org-comment-delimiter"># </span><span class="org-comment">Define the current working directory.  The ':=' operator means don't defer</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">substitution; evaluate it now.  Notice also how unlike bash, makefiles</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">require the "shell" command in order to do shell command substitution.</span>
<span class="org-variable-name">PWD</span> := $(<span class="org-variable-name">shell</span> pwd)

<span class="org-makefile-targets">modules</span>:
        $(<span class="org-variable-name">MAKE</span>) -C $(<span class="org-variable-name">KERNELDIR</span>) M=$(<span class="org-variable-name">PWD</span>) modules

<span class="org-makefile-targets">modules_install</span>:
        $(<span class="org-variable-name">MAKE</span>) -C $(<span class="org-variable-name">KERNELDIR</span>) M=$(<span class="org-variable-name">PWD</span>) modules_install

<span class="org-makefile-targets">clean</span>:
        rm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions

<span class="org-makefile-targets">.PHONY</span>: modules modules_install clean

else

<span class="org-comment-delimiter"># </span><span class="org-comment">If we reach this code path, we're successfully called ourselves from Kbuild,</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">so all we need to do here is define the module objects we want built.</span>

<span class="org-variable-name">obj-m</span> := hello.o

endif
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbe238c3" class="outline-3">
<h3 id="5fd7fcd5-aa63-41f5-a706-0bbb1fb00b0a"><span class="section-number-3">1.4</span> Creating the first c file</h3>
<div class="outline-text-3" id="text-5fd7fcd5-aa63-41f5-a706-0bbb1fb00b0a">
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/init.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/module.h&gt;</span>

MODULE_LICENSE(<span class="org-string">"Dual BSD/GPL"</span>);

<span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">hello_init</span>(<span class="org-type">void</span>)
{
    printk(KERN_ALERT <span class="org-string">"Hello world\n"</span>);
    <span class="org-keyword">return</span> 0;
}

<span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">hello_exit</span>(<span class="org-type">void</span>)
{
    printk(KERN_ALERT <span class="org-string">"Goodbye world\n"</span>);
}

<span class="org-function-name">module_init</span>(hello_init);
<span class="org-function-name">module_exit</span>(hello_exit);
</pre>
</div>
</div>
</div>
<div id="outline-container-org0bf5dc3" class="outline-3">
<h3 id="087cb4b9-c8e8-4c47-91c9-1f4d269118f9"><span class="section-number-3">1.5</span> Compiling the module</h3>
<div class="outline-text-3" id="text-087cb4b9-c8e8-4c47-91c9-1f4d269118f9">
<p>
Punch it!<sup><a id="fnr.6" class="footref" href="#fn.6">6</a></sup>
</p>
<div class="org-src-container">
<pre class="src src-bash">make modules
</pre>
</div>

<p>
(Assuming everything went well,) what do the resulting build artifacts
actually represent?
</p>
<dl class="org-dl">
<dt><code>hello.o</code></dt><dd>The initial object file resulting from compilation of our source
file.</dd>
<dt><code>hello.mod.{c,o}</code></dt><dd>Generated files containing lots of info about the module,
such as versioning.</dd>
<dt><code>hello.ko</code></dt><dd>Our final module binary, combining both of the above.</dd>
<dt><code>Module.symvers</code></dt><dd>A list of exported symbols resulting from this build.  The
syntax used therein is <code>&lt;CRC&gt; &lt;symbol&gt; &lt;namespace&gt; &lt;module&gt; &lt;export_type&gt;</code>
(the CRC is only relevant if <code>MODVERSIONS</code> is enabled).  In our case, this
file is empty because <code>hello.c</code> doesn&rsquo;t export anything.</dd>
<dt><code>modules.order</code></dt><dd>A list of the order in which compilation and creation of
<code>.ko</code> files took place.  In our case, there&rsquo;s only one entry because we only
compiled one module.</dd>
<dt><code>.hello.{o,ko,mod.o}.cmd</code></dt><dd>Commands that were executed to produce the
respective files above.</dd>
<dt><code>.tmp_versions/hello.mod</code></dt><dd>A list of paths to files on disk that export
symbols.  (Deprecated??)</dd>
<dt><code>built-in.o</code></dt><dd>This file only applies to built-in modules, not loadable ones
like ours.  Kbuild links this file together from module object files in
<code>$(obj-y)</code>.  It later forms the <code>vmlinux</code> ELF binary.  (<a href="#task-02">Task 02</a> will revisit
this.)</dd>
</dl>
</div>
</div>
<div id="outline-container-org9811caf" class="outline-3">
<h3 id="73e04251-16ac-4999-84c4-1bd142016d02"><span class="section-number-3">1.6</span> Loading the module</h3>
<div class="outline-text-3" id="text-73e04251-16ac-4999-84c4-1bd142016d02">
<p>
There are a couple of ways to do this.  Firstly:
</p>
<div class="org-src-container">
<pre class="src src-bash">/sbin/insmod hello.ko
</pre>
</div>
<p>
We should see the &ldquo;Hello world&rdquo; message pop up in the terminal (provided that
our loglevel wasn&rsquo;t changed; more about this <a href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html">here</a>).  To confirm the module was
loaded, we may inspect the output of <code>lsmod</code>.
</p>

<p>
Alternatively, we can use modprobe:
</p>
<div class="org-src-container">
<pre class="src src-bash">/sbin/modprobe hello
</pre>
</div>
<p>
However, for this to work, we have to <i>install</i> the module first.<sup><a id="fnr.7" class="footref" href="#fn.7">7</a></sup>  By default, modprobe only recognises modules
installed to <code>/lib/modules/$(uname -r)/</code>, though it may be configured to search
other paths, or load/blacklist modules explicitly.  Once installed, we can
refer to it by name (sans <code>.ko</code> suffix).
</p>

<p>
To install the module:
</p>
<div class="org-src-container">
<pre class="src src-bash">mkdir -p /lib/modules/$(uname -r)/mymodules
ln -s /mnt/qemu/hello.ko /lib/modules/$(uname -r)/mymodules
depmod
</pre>
</div>
<p>
The depmod command regenerates the module dependencies (<code>modules.dep</code>) and map
files.  We can run <code>depmod -A</code> to see if that&rsquo;s actually necessary, i.e. whether
any modules are newer than the <code>modules.dep</code> file.
</p>
</div>
</div>
<div id="outline-container-org6430cdd" class="outline-3">
<h3 id="0bee8a53-c137-49c1-acc0-8bbcaa060481"><span class="section-number-3">1.7</span> Unloading the module</h3>
<div class="outline-text-3" id="text-0bee8a53-c137-49c1-acc0-8bbcaa060481">
<p>
Again, there are a couple of ways to do so:
</p>
<div class="org-src-container">
<pre class="src src-bash">/sbin/rmmod hello.ko
<span class="org-comment-delimiter"># </span><span class="org-comment">OR</span>
/sbin/modprobe -r hello
</pre>
</div>
<p>
As before, but now we should see the &ldquo;Goodbye world&rdquo; message pop up in the
terminal.  Likewise, the module should disappear from <code>lsmod</code> output.
</p>
</div>
</div>
</div>
<div id="outline-container-orgde6c9aa" class="outline-2">
<h2 id="task-02"><span class="section-number-2">2</span> Task 02</h2>
<div class="outline-text-2" id="text-task-02">
<blockquote>
<p>
Now that you have written your first kernel module, it&rsquo;s time to take off the
training wheels and move on to building a custom kernel.  No more distro
kernels for you, for this task you must run your own kernel.  And use git!
Exciting isn&rsquo;t it!  No, oh, ok&#x2026;
</p>

<p>
The tasks for this round is:
</p>
<ul class="org-ul">
<li>Download Linus&rsquo;s latest git tree from git.kernel.org (you have to figure out
which one is his, it&rsquo;s not that hard, just remember what his last name is
and you should be fine.)</li>
<li>Build it, install it, and boot it.  You can use whatever kernel
configuration options you wish to use, but you must enable
<code>CONFIG_LOCALVERSION_AUTO</code>.</li>
<li>Show proof of booting this kernel.  Bonus points for you if you do it on a
&ldquo;real&rdquo; machine, and not a virtual machine (virtual machines are acceptable,
but come on, real kernel developers don&rsquo;t mess around with virtual machines,
they are too slow.  Oh yeah, we aren&rsquo;t real kernel developers just yet.
Well, I&rsquo;m not anyway, I&rsquo;m just a script&#x2026;)  Again, proof of running this
kernel is up to you, I&rsquo;m sure you can do well.</li>
</ul>

<p>
Hint, you should look into the &rsquo;make localmodconfig&rsquo; option, and base your
kernel configuration on a working distro kernel configuration.  Don&rsquo;t sit
there and answer all 1625 different kernel configuration options by hand, even
I, a foolish script, know better than to do that!
</p>

<p>
After doing this, don&rsquo;t throw away that kernel and git tree and configuration
file.  You&rsquo;ll be using it for later tasks, a working kernel configuration file
is a precious thing, all kernel developers have one they have grown and tended
to over the years.  This is the start of a long journey with yours, don&rsquo;t
discard it like was a broken umbrella, it deserves better than that.
</p>
</blockquote>
</div>
<div id="outline-container-org4eb293c" class="outline-3">
<h3 id="49e5b5b3-ef8e-44e1-b2d6-7ab6ed31d6b8"><span class="section-number-3">2.1</span> Fetching the latest tree</h3>
<div class="outline-text-3" id="text-49e5b5b3-ef8e-44e1-b2d6-7ab6ed31d6b8">
<p>
Linus&rsquo;s main development tree, and many others, can be obtained from
<a href="https://git.kernel.org/">git.kernel.org</a>.  We&rsquo;ll talk about these a bit more in <a href="#task-07">task 07</a>, but for now,
let&rsquo;s fetch the main development tree:
</p>
<div class="org-src-container">
<pre class="src src-bash">git clone https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/
</pre>
</div>
</div>
</div>
<div id="outline-container-orgeb68188" class="outline-3">
<h3 id="3fda4956-bf84-4e15-92bd-e0fa0f14922c"><span class="section-number-3">2.2</span> Creating a configuration file</h3>
<div class="outline-text-3" id="text-3fda4956-bf84-4e15-92bd-e0fa0f14922c">
<p>
To build the kernel, we need a configuration file appropriate for the target
it is to run on.
</p>

<p>
In large projects, the makefile will often include a <code>help</code> target.  With regard
to Kbuild (the build system for the Linux kernel), running <code class="src src-bash">make help</code> will list available make targets, as well as make parameters
we may specify.
</p>

<p>
Let&rsquo;s start with a clean configuration:
</p>
<div class="org-src-container">
<pre class="src src-bash">make mrproper
</pre>
</div>

<p>
Building up a config additively from scratch can take a lot of work, which is
why the task suggests basing our <code>.config</code> file on a working distro kernel
configuration.  This will provide us with a &ldquo;kitchen-sink&rdquo; solution that we
can tweak later if need be.
</p>

<p>
The kernel configuration used by your distro may be found in a few places:
</p>
<ul class="org-ul">
<li>a plain-text file in <code>/boot/</code> next to the kernel image; xor<sup><a id="fnr.8" class="footref" href="#fn.8">8</a></sup></li>
<li>in <code>/proc/config.gz</code> (may require unzipping; try <code>gzip -cdv</code> or <code>zcat</code>); xor</li>
<li>distributed with the kernel source package, which, if present, will be
installed in <code>/usr/src/linux/</code>.</li>
</ul>

<p>
For these early tasks, I will be loading a kernel image and root filesystem
image directly into QEMU.  We may copy the <code>.config</code> file from a location above
to the kernel tree on our host machine, and build it from there.  This is, of
course, on the proviso that the host machine has the right toolchain for the
target architecture (the QEMU virtual machine).  Additionally, it will be
preferable to link any modules that might be required directly into the kernel
image.  Thus I would recommend running <code class="src src-bash">make mod2yesconfig</code> on the config.
</p>

<p>
For further notes on paring down a configuration file, see the .
</p>
</div>
</div>
<div id="outline-container-orgb2b76eb" class="outline-3">
<h3 id="6b1dd7f0-89ff-48ff-a59a-b58515eba1f9"><span class="section-number-3">2.3</span> Editing the configuration</h3>
<div class="outline-text-3" id="text-6b1dd7f0-89ff-48ff-a59a-b58515eba1f9">
<p>
The <code>menuconfig</code> make target launches a curses-based config browser/editor for
browsing the existing <code>.config</code> (make sure <code>libncurses5-dev</code> is installed).  The
task asks us to enable <code>CONFIG_LOCALVERSION_AUTO</code>, which appends version info
(the commit hash) to the version string.  (It may or may not already be
enabled for you).  As per the description:
</p>
<div class="org-src-container">
<pre class="src src-text">This will try to automatically determine if the current tree is a release tree
by looking for git tags that belong to the current top of tree revision.
</pre>
</div>

<p>
Some other options that you may wish to enable for convenience:
</p>
<dl class="org-dl">
<dt><code>CONFIG_DEBUG_INFO</code></dt><dd>This adds debug symbols to the kernel image.  (Enabling
this implies <code>CONFIG_DEBUG_KERNEL</code> is also set.)</dd>
<dt><code>CONFIG_KALLSYMS</code></dt><dd>This adds extra symbols to help with debugging crashes.</dd>
<dt><code>CONFIG_GDB_SCRIPTS</code></dt><dd>This creates symlinks in the build directory which
point to GDB helper scripts.  (It is in fact possible to load <code>vmlinux</code> into a
GDB session on the host and play around; in such a case these helper scripts
are imported automatically.)</dd>
</dl>
</div>
</div>
<div id="outline-container-org106ec19" class="outline-3">
<h3 id="00c06df9-606c-4bd0-a1fc-b05dbc333d3d"><span class="section-number-3">2.4</span> Building the kernel</h3>
<div class="outline-text-3" id="text-00c06df9-606c-4bd0-a1fc-b05dbc333d3d">
<p>
The <code>--jobs</code> flag of make let us specify the maximum number of simultaneous
commands compilation will be limited to (defaults to 1).  The <code>nproc</code> command
will return the number of logical cores available on your system.
Recommendations on what number to give this flag in order to maximise
throughput tends to vary from <code>nproc + 1</code> to <code>nproc * 2</code>.
</p>

<p>
Punch it!
</p>
<div class="org-src-container">
<pre class="src src-bash">make -j$(($(nproc) + 1)) <span class="org-comment-delimiter"># </span><span class="org-comment">you do not (and ought not) run this as root!!!</span>
</pre>
</div>

<p>
Assuming we have all the necessary tools installed (again, refer to <a href="https://www.kernel.org/doc/html/latest/process/changes.html">the
official docs</a>), after a protracted length of time we should see something
like the following:
</p>
<div class="org-src-container">
<pre class="src src-text">[...]
Setup is 14044 bytes (padded to 14336 bytes).
System is 8050 kB
CRC 4403d3d1
Kernel: arch/x86/boot/bzImage is ready  (#1)
</pre>
</div>

<p>
Before booting this kernel, I want to go over how this build process works,
and the kinds of files it emits.
</p>
</div>
<div id="outline-container-org0679471" class="outline-4">
<h4 id="9b02819b-b51b-4339-8adc-99031847779a"><span class="section-number-4">2.4.1</span> The build process in a nutshell</h4>
<div class="outline-text-4" id="text-9b02819b-b51b-4339-8adc-99031847779a">
<p>
(Disclaimer: This section is merely my attempt at a general/vague outline of
Kbuild, which I proffer without a great deal of confidence in its accuracy.
If need be, consult <a href="https://www.kernel.org/doc/html/latest/kbuild/index.html">the horse&rsquo;s mouth</a>.)
</p>

<p>
Running <code>make</code> with no arguments will evaluate both the <code>vmlinux</code> and <code>modules</code>
targets &#x2014; the former is what creates our final, ELF-formatted kernel image.
Many other targets are available: to generate tags, install sanitised kernel
headers, and other arch-specific targets.  Run the <code>help</code> target for the more or
less complete list.
</p>

<p>
Kbuild is comprised of a makefile in the top-level directory, which
recursively invokes makefiles in each subdirectory that contains code; each of
these nested makefiles do the same in turn.  (An exception to this is the
arch-specific makefile in <code>arch/$(SRCARCH)/</code>, which is included inline in the
top-level makefile, and contains arch-specific definitions and targets for
building and post-processing the kernel image.)
</p>

<p>
The stages of compilation are somewhat as follows.
</p>
</div>
<div id="outline-container-orgf9b249b" class="outline-5">
<h5 id="03221f99-a68c-42eb-a8ee-6649869f56ac"><span class="section-number-5">2.4.1.1</span> Preparation</h5>
<div class="outline-text-5" id="text-03221f99-a68c-42eb-a8ee-6649869f56ac">
<p>
Before any targets are run, the top-level makefile will firstly define some
important variables necessary for keeping track of the build process and
configuring the kernel.  Of these, variables that must be made visible to the
other makefiles in this process are &ldquo;exported&rdquo; with the <code>export</code> keyword.  These
include:
</p>
<dl class="org-dl">
<dt><code>VERSION</code>, <code>PATCHLEVEL</code>, <code>SUBLEVEL</code>, <code>EXTRAVERSION</code></dt><dd>These define the triplet of
numbers that make up the kernel version; <code>EXTRAVERSION</code> is typically used to
denote additional patchsets that have been applied.  They are used in a few
places, most notably the <code>KERNELRELEASE</code> string (see below).</dd>
<dt><code>KERNELRELEASE</code></dt><dd>This is a concatenation of the above as a string.  An
example might be &ldquo;2.4.0-pre4&rdquo;.  It is suitable for use in version strings or
directory names.</dd>
<dt><code>ARCH</code></dt><dd>This describes the target architecture, e.g. &ldquo;i386&rdquo;, &ldquo;arm&rdquo;.  Usually
this will be the same as the host architecture, not so if we&rsquo;re doing a
cross-build.</dd>
<dt><code>INSTALL_PATH</code></dt><dd>This tells the arch-specific makefile where to install the
kernel image, <code>System.map</code> files, etc.</dd>
<dt><code>INSTALL_MOD_PATH</code>, <code>MODLIB</code></dt><dd>These indicate where modules are to be
installed.</dd>
<dt><code>INSTALL_MOD_STRIP</code></dt><dd>This is a setting to indicate whether and how modules
are to be stripped once installed.</dd>
</dl>

<p>
If the user defines the <code>C</code> variable to &ldquo;1&rdquo; or &ldquo;2&rdquo;, this will cause <code>CHECK</code> to be
invoked on some or all C files respectively.  By default, <code>CHECK</code> is set to a
static analysis tool called <code>sparse</code>.  While we&rsquo;re on that topic, the user may
add their own flags, such as <code>-Wextra</code>, to <code>EXTRA_CFLAGS</code> if desired.  (More on
static analysis in .)
</p>

<p>
With regard to the <code>modules</code> target, the user may also define the <code>M</code> variable to
specify the location of an out-of-tree kernel module to build (as was
demonstrated in ).
</p>

<p>
Definitions for various tools involved in the build process are pulled in from
<code>scripts/Kbuild.include</code>; this includes <code>CC</code>, <code>AS</code> etc.  The purpose of the <code>HOSTCC</code>,
<code>HOSTCFLAGS</code>, et al., are for compiling some of these supplementary host
utilities.
</p>

<p>
<code>LINUXINCLUDE</code> and <code>USERINCLUDE</code> specify paths to directories containing the Linux
headers (i.e. for internal use) and the uapi headers (i.e. for external use).
</p>

<p>
<code>KBUILD_CFLAGS</code> defines a set of standard flags for the C compiler.  These may
be changed in the nested makefiles.
</p>

<p>
(Up to this point, nothing has yet been printed to the terminal.)
</p>
</div>
</div>
<div id="outline-container-orga423a67" class="outline-5">
<h5 id="0e65e166-9ffe-4103-ae09-35831a7e4dee"><span class="section-number-5">2.4.1.2</span> Compilation</h5>
<div class="outline-text-5" id="text-0e65e166-9ffe-4103-ae09-35831a7e4dee">
<p>
Once preparation is complete, it can start executing the <code>vmlinux</code> target.  This
involves compiling and linking together the <code>built-in.a</code> and other object files
listed in <code>vmlinux-deps</code> as dependencies.  There will be one <code>built-in.a</code> file per
source directory (sans those modules which are configured as external
modules).
</p>

<p>
Each <code>built-in.a</code> file depends on and is assembled from the individual object
files in its respective subdirectory tree.  The makefile in this tree
indicates these dependencies by adding them to the <code>obj-y</code> list (the <code>obj-m</code> list
is for module-only dependencies).
</p>

<p>
Once all <code>built-in.a</code> files are built, they are statically linked together,
along with other core object files, into the <code>vmlinux</code> file (see
<code>scripts/link-vmlinux.sh</code>).  A <code>System.map</code> file is also created.  Both these
files are placed in the top-level directory.
</p>

<p>
While these files are useful for debugging purposes, we&rsquo;re not quite done yet.
In particular, we need to strip <code>vmlinux</code> of all symbols and relocation
metadata, compress it, make it self-extracting, and make it bootable.
</p>
</div>
</div>
<div id="outline-container-org0fb66ee" class="outline-5">
<h5 id="24586f85-e4b8-432d-b93b-b2de6b4936be"><span class="section-number-5">2.4.1.3</span> Building bzImage</h5>
<div class="outline-text-5" id="text-24586f85-e4b8-432d-b93b-b2de6b4936be">
<p>
The <code>bzImage</code> file is what <code>vmlinux</code> becomes after being compressed and wrapped to
make it bootable on x86 machines.  This process requires additional tools that
themselves need building as an intermediate step.  In our case, this process
will be laid out in the makefile that lives in <code>arch/x86/boot/</code>.
</p>

<p>
Broadly, <code>bzImage</code> consists of a few different segments:
</p>
<ul class="org-ul">
<li>the boot sector, one-off code for getting the system into a usable state;</li>
<li>setup code, routines to decompress and bring up the kernel; and</li>
<li>a stripped and compressed copy of the <code>vmlinux</code> image.</li>
</ul>

<p>
The function <code>decompress_kernel()</code> is responsible for decompressing the
compressed kernel image at boot, as indicated by this familiar console
message:
</p>
<div class="org-src-container">
<pre class="src src-text">Decompressing Linux... done
Booting the kernel.
</pre>
</div>

<p>
Other image formats include <code>zImage</code> (an older compression format for smaller
kernels) and <code>uImage</code> (used by U-Boot for embedded platforms).  The file
ultimately copied into the boot partition is often named <code>vmlinuz</code>, or
<code>vmlinuz-$(uname -r)</code>, regardless of format, to indicate that it is a bootable,
self-extracting kernel image.
</p>
</div>
</div>
</div>
<div id="outline-container-org1d2b475" class="outline-4">
<h4 id="57a3af29-fedc-41bd-b90a-28c4c1a3169a"><span class="section-number-4">2.4.2</span> Miscellaneous Kbuild features</h4>
<div class="outline-text-4" id="text-57a3af29-fedc-41bd-b90a-28c4c1a3169a">
<p>
Here are some helpful make variables I found:
</p>
<dl class="org-dl">
<dt><code>V={1,2}</code></dt><dd>The former will perform a more verbose build; the latter will
additionally print reasons for the rebuild of targets.  <code>V=0</code> is the usual
default.</dd>
<dt><code>O=&lt;path&gt;</code></dt><dd>This specifies where to store the build&rsquo;s output files, as an
alternative to just littering them throughout the kernel tree.  It will also
include the <code>.config</code> file used for the build.  This can be handy when you are
trying out multiple configurations, and want their build artefacts to be
kept apart &#x2014; just specify a different output directory for each.</dd>
<dt><code>C={1,2}</code></dt><dd>This will perform static analysis on source files, as mentioned
.  <code>C=1</code> will check only those files that are [re]compiled; <code>C=2</code> will
check all files.</dd>
<dt><code>W={1,2,3}</code></dt><dd>This will enable various levels of checks, from least to most
verbose.  Usually, <code>W=1</code> by itself is sufficient.</dd>
</dl>

<p>
As for targets:
</p>
<ul class="org-ul">
<li>The difference between <code>clean</code> and <code>mrproper</code> depends on whether you want to
keep the existing <code>.config</code>; the latter wipes it.</li>
<li>The <code>tags</code> and <code>gtags</code> targets generate tag databases for aiding code navigation
in a a text editor or IDE; likewise for the <code>cscope</code> target.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org32edc7f" class="outline-3">
<h3 id="f7859da4-52ed-4327-a352-7c892bf99cd8"><span class="section-number-3">2.5</span> Installing and booting the kernel</h3>
<div class="outline-text-3" id="text-f7859da4-52ed-4327-a352-7c892bf99cd8">
<p>
Once built, the resulting <code>bzImage</code> can be copied over to <code>/boot/</code> by running the
<code>install</code> target.  In brief, this target will (usually) end up running a
distro-specific kernel install script that copies the image over to <code>/boot/</code>
with a sensible filename, regenerates the initramfs, and updates the
bootloader entries.  (The <code>install</code> target is covered in more detail in .)
</p>

<p>
(N.B.: If we compiled any loadable modules, we&rsquo;ll need to run the
<code>modules_install</code> <i>first</i>, <i>before</i> running <code>install</code>.  This will copy the loadable
modules over to an aptly named directory in <code>/lib/modules/</code>.  We must do this
first because certain modules from this directory have to be bundled into the
initramfs when it is generated, modules needed early in the boot process.)
</p>

<p>
However, since I&rsquo;m just testing this kernel in a virtual machine, we may
alternatively:
</p>
<ul class="org-ul">
<li>run the <code>isoimage</code> to generate a bootable CD-ROM, and boot that somehow; xor</li>
<li>invoke QEMU on the command-line, passing it the kernel directly.</li>
</ul>

<p>
For now, I will do the latter.
</p>

<p>
Normally, QEMU just boots a virtual disk image (specied with the <code>-drive</code> flag),
and the bootloader and kernel that reside therein take us the rest of the way.
The <code>-kernel</code> flag, on the other hand, can be used to load and boot a kernel
image residing on the host.  When a kernel is booted, the root filesystem it
is to mount will be specified in the kernel boot parameters (specifically,
<code>root=</code>); these parameters are set/provided by the bootloader.  QEMU has a
virtual bootloader for booting external kernel, but it cannot magically infer
what <code>root=</code> should be set to &#x2014; we must provide the parameters ourselves with
the <code>-append</code> flag.
</p>

<p>
The simplest solution to this is to find out the name of the root partition as
assigned by udev, or its UUID, and then append that as a kernel argument &#x2014;
something like <code>-append "=root=/dev/sda1"</code> or <code>-append "=root=UUID=${rootfs_uuid}"</code>.
For example, inside my Debian virtual machine, these are the arguments it says
it was invoked with:
</p>
<div class="org-src-container">
<pre class="src src-text">$ cat /proc/cmdline
BOOT_IMAGE=/boot/vmlinuz-4.19.0-8-686-pae root=UUID=07318365-3a31-41ca-b219-e6de6df9a5bf ro quiet
</pre>
</div>
<p>
(We don&rsquo;t need to set <code>BOOT_IMAGE=</code>; the <code>-kernel</code> flag has done this for us.)
</p>

<p>
If we ran <code class="src src-bash">make mod2yesconfig</code> as mentioned earlier,
then we should not need to provide an init ramdisk to the VM, so we shouldn&rsquo;t
need to specify <code>initrd=</code>, but I imagine it would play out similarly.  (Later on
I transition to , as
this setup was getting annoying.)
</p>

<p>
In any case, let&rsquo;s fire up our virtual machine and confirm the change we made
to our config:
</p>
<div class="org-src-container">
<pre class="src src-text">$ uname -r
5.9.0-rc6-00338-ga1bffa48745a
</pre>
</div>
<p>
Awesome!  That&rsquo;s the same hash as the git commit we built our kernel on, and
was appended to the version string because we enabled
<code>CONFIG_LOCALVERSION_AUTO</code>.<sup><a id="fnr.9" class="footref" href="#fn.9">9</a></sup>
</p>
</div>
</div>
</div>
<div id="outline-container-org5d08aa7" class="outline-2">
<h2 id="task-03"><span class="section-number-2">3</span> Task 03</h2>
<div class="outline-text-2" id="text-task-03">
<blockquote>
<p>
Now that you have your custom kernel up and running, it&rsquo;s time to modify it!
</p>

<p>
The tasks for this round is:
</p>
<ul class="org-ul">
<li>Take the kernel git tree from Task 02 and modify the Makefile to and modify
the EXTRAVERSION field.  Do this in a way that the running kernel (after
modifying the Makefile, rebuilding, and rebooting) has the characters
&ldquo;-eudyptula&rdquo; in the version string.</li>
<li>Show proof of booting this kernel.  Extra cookies for you by providing
creative examples, especially if done in interpretive dance at your local
pub.</li>
<li>Send a patch that shows the Makefile modified.  Do this in a manner that
would be acceptable for merging in the kernel source tree.  (Hint, read the
file Documentation/SubmittingPatches and follow the steps there.)</li>
</ul>
</blockquote>
</div>
<div id="outline-container-org881d69f" class="outline-3">
<h3 id="ba2b0280-b527-4e64-a3d8-4c74ab650119"><span class="section-number-3">3.1</span> Modifying the makefile</h3>
<div class="outline-text-3" id="text-ba2b0280-b527-4e64-a3d8-4c74ab650119">
<p>
This is easy enough &#x2014; just open up <code>menuconfig</code> and append &ldquo;-eudyptula&rdquo; to the
<code>EXTRAVERSION</code> field.  After building and booting the kernel, we&rsquo;ll see
something like the following:
</p>
<div class="org-src-container">
<pre class="src src-text">$ uname -r
5.9.0-rc6-eudyptula-00338-ga1bffa48745a-dirty
</pre>
</div>

<p>
Note how Kbuild has also appended &ldquo;-dirty&rdquo; to this string.  This was done by
<code>scripts/setlocalversion</code>, invoked by the top-level makefile.  This script adds
local version information from the version control system to the kernel
release string.  In this case, it adds &ldquo;-dirty&rdquo; if the build contains some as
yet uncommitted changes.
</p>
</div>
</div>
<div id="outline-container-org8051745" class="outline-3">
<h3 id="f991e442-3bfb-40e5-a0d5-9252bfee2424"><span class="section-number-3">3.2</span> Patch submission overview</h3>
<div class="outline-text-3" id="text-f991e442-3bfb-40e5-a0d5-9252bfee2424">
<p>
The formal steps involved in submitting a patch to the mailing lists is
well-documented <a href="https://www.kernel.org/doc/html/latest/process/submitting-patches.html">here</a> and <a href="https://www.kernel.org/doc/html/latest/process/submit-checklist.html">here</a>.  Let&rsquo;s go over them.
</p>
</div>
<div id="outline-container-org909d046" class="outline-4">
<h4 id="8f3424ab-c459-41a8-8a49-a8f1ce4296cf"><span class="section-number-4">3.2.1</span> Generating a patch</h4>
<div class="outline-text-4" id="text-8f3424ab-c459-41a8-8a49-a8f1ce4296cf">
<p>
One way to generate a patch by hand is to invoke <code class="src src-bash">diff -uprN</code> on a pair of source directories.  The meaning of the flags,
respectively:
</p>
<ul class="org-ul">
<li>print in &ldquo;unified diff&rdquo; format (explained <a href="https://en.wikipedia.org/wiki/Diff#Unified_format">here</a>);</li>
<li>print which C function each change is in;</li>
<li>compare subdirectories recursively; and</li>
<li>treat absent files as being empty files.</li>
</ul>

<p>
However, it&rsquo;s simpler to generate them with <code class="src src-bash">git diff</code>,
which uses said flags by default, but can also compare files across any
combination of working tree, index, or revision/commit in a git repository.
(The syntax for selecting a revision, or specifying a range of revisions, is
described <a href="https://git-scm.com/docs/gitrevisions.html">here</a>, and nicely summarised <a href="https://devhints.io/git-revisions">here</a>.)
</p>

<p>
If we&rsquo;re submitting this patch upstream, we also need to provide some
information, including the commit message.  The <a href="https://lore.kernel.org/lists.html">mailing list archives</a> provide
endless examples of this.  Thankfully, <code class="src src-bash">git format-patch</code> (documented <a href="https://git-scm.com/docs/git-format-patch">here</a>) does most of the leg-work for us, but I will
go over a few of the more salient parts.
</p>

<p>
The subject line, which the first line of the commit message occupies, is
prepended with some additional information to help identify it.  This
includes:
</p>
<ul class="org-ul">
<li>the fact that it is a patch;</li>
<li>optional tags, e.g. &ldquo;v2&rdquo; (version 2), &ldquo;RFC&rdquo; (request-for-comment);</li>
<li>the patch number, if it is part of a patch set (e.g. &ldquo;02/15&rdquo;);
ior<sup><a id="fnr.10" class="footref" href="#fn.10">10</a></sup></li>
<li>the subsystem(s) or module(s) of relevance to the change.</li>
</ul>

<p>
This format makes it easy to process and sort emails by subject line using
tools like <code>grep</code>.  An example:
</p>
<div class="org-src-container">
<pre class="src src-text">Subject: [PATCH v2 01/27] staging: rtl8723bs: remove initialisation of globals to 0
</pre>
</div>
<p>
One might also see patches starting with <code>[PATCH][next]</code>, <code>[PATCH -next]</code>, or
<code>[PATCH][4.x.y]</code>.  These (presumably) indicate which tree or revision the patch
ought to be applied to.
</p>

<p>
The body of the message, synonymous with the body of the commit message, is
line-wrapped at 75 columns.
</p>

<p>
After a line-break comes a signature.  This is a simple line at the end of the
explanation for the patch certifying who wrote it and passed it on:
</p>
<div class="org-src-container">
<pre class="src src-text">Signed-off-by: Random J Developer <a href="mailto:random%40developer.example.org">&lt;random@developer.example.org&gt;</a>
</pre>
</div>
<p>
Following this may be signatures from other contributors, or relevant persons
who have reviewed the code and given it the all-clear; frequently one sees
things like &ldquo;Co-developed-by:&rdquo; or &ldquo;Cc:&rdquo; (the latter indicates a person who was
cc&rsquo;d and is to be kept in the loop regarding the patch).
</p>

<p>
A line containing a triple-dash follows, which demarcates the end of the
commit message.  After this line, we may add additional comments not suitable
for inclusion in the changelog.  For example, the output of <code class="src src-bash">diffstat -p 1 -w 70</code> (or <code class="src src-bash">git diff --stat</code>) is
often provided here &#x2014; this gives a summary of the files that have changed
and the number of inserted and/or deleted lines, and changes that may have
occurred between &ldquo;v1&rdquo; and &ldquo;v2&rdquo; of the patch.
</p>

<p>
Finally, the actual patch is shown (in <a href="https://en.wikipedia.org/wiki/Diff#Unified_format">unified diff</a>).
</p>

<p>
Here&rsquo;s an example:
</p>
<div class="org-src-container">
<pre class="src src-text">Subject: [PATCH v2 1/2] USB: at91: fix the number of endpoint parameter

In sama5d3 SoC, there are 16 endpoints, which is different with
earlier SoCs (only have 7 endpoints). The USBA_NR_ENDPOINTS micro
is not suitable for sama5d3. So, get the endpoints number through
the udc-&gt;num_ep, which get from platform data for non-dt kernel,
or parse from dt node.

Signed-off-by: Bo Shen <a href="mailto:omitted%40omitted.com">&lt;omitted@omitted.com&gt;</a>
---
Changes in v2:
  - Make the commit message more clearer.

 drivers/usb/gadget/atmel_usba_udc.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/usb/gadget/atmel_usba_udc.c b/drivers/usb/gadget/atmel_usba_udc.c
index 2cb52e0..7e67a81 100644
[...]
</pre>
</div>

<p>
Thankfully, much of this can be automated by configuring and using <code>git
format-patch</code>.  For example:
</p>
<div class="org-src-container">
<pre class="src src-bash">git format-patch -n -s --cover-letter --subject-prefix=<span class="org-string">"PATCH v2"</span>
</pre>
</div>
<dl class="org-dl">
<dt><code>-n</code></dt><dd>This generates numbered patches in the <code>[PATCH n/m]</code> format.  (If there
is only a single patch, it with print <code>1/1</code>).</dd>
<dt><code>-s</code></dt><dd>This prints the <code>Signed-off-by:</code> line for us in the message so we don&rsquo;t
forget it.</dd>
<dt><code>--cover-letter</code></dt><dd>This lets us write a cover letter file for describing the
entire patch set (usually unnecessary for singular patches).  This is a
standalone message that acts as &ldquo;patch 0&rdquo;.</dd>
<dt><code>--subject-prefix=&lt;foo&gt;</code></dt><dd>This changes the default &ldquo;PATCH&rdquo; prefix that is
normally given in the square brackets.  This option is useful when sending
new patch revisions after getting feedback, where a prefix like <code>[PATCH v2]</code>
would be appropriate (passing <code>-v2</code> is a shorthand for this).</dd>
</dl>
</div>
</div>
<div id="outline-container-org15c8c8e" class="outline-4">
<h4 id="a944b06f-a915-40a1-907d-9104316ceec6"><span class="section-number-4">3.2.2</span> Reviewing the changes</h4>
<div class="outline-text-4" id="text-a944b06f-a915-40a1-907d-9104316ceec6">
<p>
Patches must compile.  This ensures they can be <a href="https://git-scm.com/docs/git-bisect">bisected</a> to track down
problems.  Also, if the patch depends on some other patch to be applied first,
this is OK, but we must say so in the comments.
</p>

<p>
A patch should address one problem only.  If our patch contains a lot of
deltas, it may be wise to split it up into logical parts as a patch set.  For
example, a patch that contains both a bug fix and a performance enhancement
should be separated.  A change that includes both an API update and a new
driver which uses that new API should also be separated.  But this is not an
exact science.
</p>

<p>
In git, the usual way to split up a patch would be to stage changes
interactively with <code class="src src-bash">git add -i</code> (or <code class="src src-bash">git add -p</code>).
</p>

<p>
If we had already made a commit out of our changes, we&rsquo;ll need to reset the
head and index beforehand.  For example:
</p>
<div class="org-src-container">
<pre class="src src-bash">git reset --mixed HEAD^ <span class="org-comment-delimiter"># </span><span class="org-comment">roll back HEAD and reset the index, but not the working tree</span>
</pre>
</div>
<p>
(If you screw up here and accidentally reset the working tree and all your
changes, don&rsquo;t panic; book an appointment with <a href="https://ohshitgit.com/">Dr. Reflog</a> ðŸ‘¨â€âš•ï¸ ðŸ©º)
</p>
</div>
</div>
<div id="outline-container-orgacb3734" class="outline-4">
<h4 id="f94fde9c-9319-4be1-a04c-c065dc93d257"><span class="section-number-4">3.2.3</span> Describing the changes</h4>
<div class="outline-text-4" id="text-f94fde9c-9319-4be1-a04c-c065dc93d257">
<p>
Where applicable, a patch message should include, firstly:
</p>
<ul class="org-ul">
<li>any information that could help route the change downstream, such as
circumstances precipitating the patch, excerpts from <code>dmesg</code>, crash
descriptions, performance regressions, latency spikes, lockups, etc.;</li>
<li>metrics regarding performance tradeoffs in regards to memory consumption,
speed, stack footprint, binary size, readability, etc.; ior</li>
<li>number and/or URL of a bug entry, or a URL from a mailing list discussion
(but the issue should be understandable from the patch description
regardless).</li>
</ul>

<p>
Once the problem is established, we are to describe in technical detail what
our patch is doing about it.
</p>

<p>
If our patch makes reference to a particular commit, we ought to include its
hash as well as a brief gist so it&rsquo;s easy to read (similarly, if the patch
depends on another patch, include a URL from the <a href="https://lore.kernel.org/">mailing list archives</a>).  In
particular, if a patch is fixing a regression (e.g. one discovered during a
<code>git bisect</code>), we should add a line to the description like this:
</p>
<div class="org-src-container">
<pre class="src src-text">Fixes: 54a4f0239f2e ("KVM: MMU: make kvm_mmu_zap_page() return the number of pages it actually freed")
</pre>
</div>

<p>
We can edit our <code>.gitconfig</code> to generate a string in this style for such
purposes:
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span class="org-type">core</span>]
        <span class="org-variable-name">abbrev</span> = 12
[<span class="org-type">pretty</span>]
        <span class="org-variable-name">fixes</span> = Fixes: %h (\"%s\")
</pre>
</div>
<p>
Then, to generate this string for a particular revision given by the hash:
</p>
<div class="org-src-container">
<pre class="src src-text">$ git --no-pager log -1 --pretty=fixes 54a4f0239f2e
Fixes: 54a4f0239f2e ("KVM: MMU: make kvm_mmu_zap_page() return the number of pages it actually freed")
</pre>
</div>
</div>
</div>
<div id="outline-container-orgae54434" class="outline-4">
<h4 id="503e1947-f374-4f8e-af59-7f30a9927256"><span class="section-number-4">3.2.4</span> Style-checking</h4>
<div class="outline-text-4" id="text-503e1947-f374-4f8e-af59-7f30a9927256">
<dl class="org-dl">
<dt>The long version</dt><dd><a href="https://www.kernel.org/doc/html/latest/process/coding-style.html">Read the docs</a>.</dd>
<dt>The short version</dt><dd>The rules governing coding style in the Linux kernel
are mostly already taken care of.  Firstly, the kernel tree includes a
<code>.clang-format</code> file for use with the <a href="https://www.kernel.org/doc/html/latest/process/clang-format.html">clang-format</a> tool.  (This works on
<code>*.{c,h}</code> source files rather than patch files.  Ways to use or integrate
clang-format into certain development environments, including git, are given
<a href="https://clang.llvm.org/docs/ClangFormat.html">here</a>.)  Additionally, we should run our patch file through
<code>scripts/checkpatch.pl</code> (which will be employed in the ).  There is
more to coding style than what these tools are able to identify (a tool
cannot tell you that your choice of variable name stinks, nor that a
function is too large and unwieldy), but they encode most of the formal
boilerplate.</dd>
</dl>
</div>
</div>
<div id="outline-container-orgb96fe7d" class="outline-4">
<h4 id="e5fdebc8-59be-4165-ae62-8ba33845cc95"><span class="section-number-4">3.2.5</span> Selecting the recipients</h4>
<div class="outline-text-4" id="text-e5fdebc8-59be-4165-ae62-8ba33845cc95">
<p>
Patches must be sent to the appropriate subsystem maintainer(s), and CC&rsquo;d to
at least one mailing list.  (Multiple mailing lists may be applicable.  When
uncertain, it is probably better to err on the side of including more mailing
lists &#x2014; the more eyes on a patch, the better.)  The
<code>scripts/get_maintainer.pl</code> script and the <code>MAINTAINERS</code> file are useful in this
regard.
</p>

<p>
Changes to the user-facing API should be shared with the man-pages maintainer,
and the linux-api mailing list.
</p>

<p>
For small patches, consider sending them to <code>trivial@kernel.org</code>, which collects
&ldquo;trivial&rdquo; patches, e.g. minor spelling fixes, documentation info, fixes
relating to compiler warnings, removal of deprecated functions/macros.
</p>

<p>
An exception to this relates to security patches.  These should be sent to
<code>security@kernel.org</code> privately, with a short embargo to allow distributors to
get the patch out to users.  If the patch fixes a severe bug in a live, stable
kernel, read <a href="https://www.kernel.org/doc/html/latest/process/stable-kernel-rules.html">here</a> for further guidance.
</p>
</div>
</div>
<div id="outline-container-orga14d652" class="outline-4">
<h4 id="58bd21c9-148d-49df-ad6d-ae92d1252601"><span class="section-number-4">3.2.6</span> Email issues</h4>
<div class="outline-text-4" id="text-58bd21c9-148d-49df-ad6d-ae92d1252601">
<p>
A patch email should be plain inline text &#x2014; no MIME content, links,
compression, or attachments.  They are intended to be parsable with standard
text-processing tools.  Inline patches should also be less than 300 kB.  Read
<a href="https://www.kernel.org/doc/html/latest/process/email-clients.html">here</a> for more on this.
</p>

<p>
Thankfully, <code>git send-mail</code> makes it easy to send patch emails via SMTP, with a
little configuration.  Here&rsquo;s the relevant section from my <code>.gitconfig</code>:
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span class="org-type">sendemail</span>]
        <span class="org-variable-name">from</span> = Scott J. Crouch <a href="mailto:omitted%40omitted.com">&lt;omitted@omitted.com&gt;</a>
        <span class="org-variable-name">smtpserver</span> = smtp.omitted.com
        <span class="org-variable-name">smtpuser</span> = omitted@omitted.com
        <span class="org-variable-name">smtpencryption</span> = tls
        <span class="org-variable-name">smtpserverport</span> = 587
        <span class="org-variable-name">thread</span> = true             <span class="org-comment-delimiter"># </span><span class="org-comment">when sending multiple patches, send successive patches as replies to the first or previous email</span>
        <span class="org-variable-name">chainreplyto</span> = false      <span class="org-comment-delimiter"># </span><span class="org-comment">when threading, send all successive patches as replies to the first email specifically (don't chain them)</span>
        <span class="org-variable-name">confirm</span> = always          <span class="org-comment-delimiter"># </span><span class="org-comment">always get one final confirmation before sending the email</span>
        <span class="org-variable-name">annotate</span> = yes            <span class="org-comment-delimiter"># </span><span class="org-comment">open the email one final time for inspection and last-second edits</span>
        <span class="org-variable-name">transferencoding</span> = 8bit   <span class="org-comment-delimiter"># </span><span class="org-comment">prevent Content-Transfer-Encoding from being set to quoted-printable</span>
</pre>
</div>

<p>
It might be worth sending the email to ourselves initially and make sure that
everything looks ok.  As part of that, we may save the email as raw text file,
headers and all, and then run <code>git am</code> on it &#x2014; this applies the patch to our
local repository (literally &ldquo;â€‹<b>a</b>â€‹pply â€‹<b>m</b>â€‹ail&rdquo;), where we can verify that it
looks and works fine.
</p>

<p>
More on this is covered later on in , where we actually develop and
send a patch.
</p>
</div>
</div>
<div id="outline-container-org566145f" class="outline-4">
<h4 id="39cf59d3-0ee8-4502-97e0-18dae366b26e"><span class="section-number-4">3.2.7</span> Feedback</h4>
<div class="outline-text-4" id="text-39cf59d3-0ee8-4502-97e0-18dae366b26e">
<p>
We must be patient &#x2014; give at least a week before resubmitting or pinging
reviewers, possibly longer during busy times (such as a merge-window).
</p>

<p>
Based on the comments made in reply, we may need to make revisions to our
patch and resubmit it.  If so, we should submit it in a new email thread,
rather than in reply to the old one.  We&rsquo;ll just need to remember to
regenerate the patch/email with the <code>-v2</code> flag, and include a comment on what
changed since v1.
</p>
</div>
</div>
</div>
<div id="outline-container-org2f1f772" class="outline-3">
<h3 id="80867276-19a9-4cc9-9c66-fc23589fbe7b"><span class="section-number-3">3.3</span> Creating our patch</h3>
<div class="outline-text-3" id="text-80867276-19a9-4cc9-9c66-fc23589fbe7b">
<p>
Let&rsquo;s put some of what we&rsquo;ve learned into practice.
</p>

<p>
A patch ought to have its own feature branch; let&rsquo;s make one and switch to it:
</p>
<div class="org-src-container">
<pre class="src src-bash">git checkout -b eudyptula-task03
</pre>
</div>

<p>
Now we&rsquo;ll commit our changes, giving them a sensible commit message.  We may
optionally pass the <code>-s</code> flag to <code>git commit</code> to have a <code>Signed-off-by:</code> line added
for us; I&rsquo;ve left that off here as I&rsquo;ll be adding that line when generating
the patch file:
</p>
<div class="org-src-container">
<pre class="src src-text">Append "-eudyptula" to the kernel version string

This is for task 03 of the eudyptula challenge.  Not much else to say here.
</pre>
</div>

<p>
What does the manpage say about <code>git format-patch</code>?
</p>
<div class="org-src-container">
<pre class="src src-text">git-format-patch - Prepare patches for e-mail submission

[...]

Prepare each commit with its patch in one file per commit, formatted to
resemble UNIX mailbox format. The output of this command is convenient for
e-mail submission or for use with git am.
</pre>
</div>
<p>
Further details state that we must specify a range of commits to generate
patch files for.  By default, we specify a particular root commit, and patches
will be generated for the sequence of changes from that commit until the end
of the current branch.  So, in our example, having created a feature branch
off of <code>master</code> which we committed our changes to:
</p>
<div class="org-src-container">
<pre class="src src-bash">git format-patch -s master
</pre>
</div>

<p>
Here&rsquo;s what my subsequent patch looks like:
</p>
<div class="org-src-container">
<pre class="src src-text">From e99132b9a2a7add5b7170b79493a83cfec7abaa2 Mon Sep 17 00:00:00 2001
From: "Scott J. Crouch" <a href="mailto:omitted%40omitted.com">&lt;omitted@omitted.com&gt;</a>
Date: Thu, 8 Oct 2020 10:22:52 +1100
Subject: [PATCH] Append "-eudyptula" to the kernel version string

This is for task 3 of the eudyptula challenge. Not much else to say here.

Signed-off-by: Scott J. Crouch <a href="mailto:omitted%40omitted.com">&lt;omitted@omitted.com&gt;</a>
---
 Makefile | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/Makefile b/Makefile
index 2b66d3398878..4db3b9bee411 100644
--- a/Makefile
+++ b/Makefile
@@ -2,7 +2,7 @@
 VERSION = 5
 PATCHLEVEL = 9
 SUBLEVEL = 0
-EXTRAVERSION = -rc6
+EXTRAVERSION = -rc6-eudyptula
 NAME = Kleptomaniac Octopus

 # *DOCUMENTATION*
-- 
2.28.0
</pre>
</div>

<p>
We&rsquo;ll clean up by deleting the old branch (perhaps not before it has been
accepted upstream):
</p>
<div class="org-src-container">
<pre class="src src-bash">git checkout master
git branch -D eudyptula-task03
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge74ece0" class="outline-2">
<h2 id="task-04"><span class="section-number-2">4</span> Task 04</h2>
<div class="outline-text-2" id="text-task-04">
<blockquote>
<p>
Wonderful job in making it this far, I hope you have been having fun.  Oh,
you&rsquo;re getting bored, just booting and installing kernels?  Well, time for
some pedantic things to make you feel that those kernel builds are actually
fun!
</p>

<p>
Part of the job of being a kernel developer is recognising the proper Linux
kernel coding style.  The full description of this coding style can be found
in the kernel itself, in the <code>Documentation/CodingStyle</code> file.  I&rsquo;d recommend
going and reading that right now, it&rsquo;s pretty simple stuff, and something that
you are going to need to know and understand.  There is also a tool in the
kernel source tree in the <code>scripts/</code> directory called <code>checkpatch.pl</code> that can be
used to test for adhering to the coding style rules, as kernel programmers are
lazy and prefer to let scripts do their work for them&#x2026;
</p>

<p>
And why a coding standard at all?  That&rsquo;s because of your brain (yes, yours,
not mine, remember, I&rsquo;m just some dumb shell scripts).  Once your brain learns
the patterns, the information contained really starts to sink in better.  So
it&rsquo;s important that everyone follow the same standard so that the patterns
become consistent.  In other words, you want to make it really easy for other
people to find the bugs in your code, and not be confused and distracted by
the fact that you happen to prefer 5 spaces instead of tabs for indentation.
Of course you would never prefer such a thing, I&rsquo;d never accuse you of that,
it was just an example, please forgive my impertinence!
</p>

<p>
Anyway, the tasks for this round all deal with the Linux kernel coding style.
Attached to this message are two kernel modules that do not follow the proper
Linux kernel coding style rules.  Please fix both of them up, and send it back
to me in such a way that does follow the rules.
</p>

<p>
What, you recognise one of these modules?  Imagine that, perhaps I was right
to accuse you of the using a &ldquo;wrong&rdquo; coding style :)
</p>

<p>
Yes, the logic in the second module is crazy, and probably wrong, but don&rsquo;t
focus on that, just look at the patterns here, and fix up the coding style, do
not remove lines of code.
</p>
</blockquote>

<p>
Hmm &#x2014; the github page I found online that lists the eudyptula tasks didn&rsquo;t
disclose the modules mentioned, so I had to do some digging.  Supposedly, the
two modules that this task wants us to clean up are (a) our original <code>hello.c</code>
module from , and (b) this other one I found:
</p>
<div class="org-src-container">
<pre class="src src-c" id="orgeb6370b"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/module.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/kernel.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;asm/delay.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/slab.h&gt;</span>


<span class="org-type">int</span> <span class="org-function-name">do_work</span>( <span class="org-type">int</span> * <span class="org-variable-name">my_int</span>, <span class="org-type">int</span> <span class="org-variable-name">retval</span> ) {
<span class="org-type">int</span> <span class="org-variable-name">x</span>;
<span class="org-type">int</span> <span class="org-variable-name">y</span>=*my_int;
<span class="org-type">int</span> <span class="org-variable-name">z</span>;


<span class="org-keyword">for</span>(x=0;x&lt; * my_int;++x) {
        udelay(10);
}

<span class="org-keyword">if</span> (y &lt; 10 )
        <span class="org-comment-delimiter">// </span><span class="org-comment">That was a long sleep, tell user-space about it</span>
        printk(<span class="org-string">"We slept a long time!"</span>);

z = x * y;

<span class="org-keyword">return</span> z;

}


<span class="org-type">int</span>
<span class="org-function-name">my_init</span> (<span class="org-type">void</span>)
{
<span class="org-type">int</span> <span class="org-variable-name">x</span> = 10;


x = do_work(&amp;x, x);

<span class="org-keyword">return</span> x;

}


<span class="org-type">void</span> <span class="org-function-name">my_exit</span>( <span class="org-type">void</span> )
{
<span class="org-keyword">return</span>;
}


<span class="org-function-name">module_init</span>(my_init);
<span class="org-function-name">module_exit</span>(my_exit);
</pre>
</div>
</div>
<div id="outline-container-org46e03e1" class="outline-3">
<h3 id="3059ef5f-6256-4674-8e98-63f1ab336f8a"><span class="section-number-3">4.1</span> Linux kernel coding style</h3>
<div class="outline-text-3" id="text-3059ef5f-6256-4674-8e98-63f1ab336f8a">
<p>
I mentioned the official coding style of the Linux kernel in ; <a href="https://www.kernel.org/doc/html/latest/process/coding-style.html">here&rsquo;s
the link again</a>.  It&rsquo;s worth giving it read if you want to understand the
rationale behind each decision.
</p>

<p>
Some personal remarks:
</p>
<ul class="org-ul">
<li>In my opinion, the most important overarching reason for any set of coding
style rules is consistency.  Most disputes over coding style amount to
<a href="https://en.wikipedia.org/wiki/Law_of_triviality">bike-shedding</a> (a crime which I&rsquo;m also guilty of).</li>
<li><p>
The Linux kernel&rsquo;s requirement of 8-space tabs &#x2014; like its intransigent
employment of email for collaboration &#x2014; seems unusual and somewhat
anachronistic, though it&rsquo;s not uncommon in C codebases.  Combine this with
the fact that line lengths are soft-limited to 80 chars, and it starts to
feel very restrictive.  I don&rsquo;t like the fact that it places downward
pressure on the length of variable names, which I often find far too terse
and uselessly undescriptive.  On the other hand, it may help curb the amount
of indentation developers use, which is soft-limited to 3 levels.  I also
think that long expressions and declarations are more readable when read
vertically for the same reason that websites often restrict the html body to
&lt; 80 chars: As our eyes scan a text, a <a href="https://en.wikipedia.org/wiki/Newline#Representation">LF</a> takes less effort to visually
perform than a <a href="https://en.wikipedia.org/wiki/Newline#Representation">CR</a>, and this disparity is proportional to the length of the
lines.  Compare:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">__fat_readdir</span>(<span class="org-keyword">struct</span> <span class="org-type">inode</span> *<span class="org-variable-name">inode</span>, <span class="org-keyword">struct</span> <span class="org-type">file</span> *<span class="org-variable-name">file</span>, <span class="org-keyword">struct</span> <span class="org-type">dir_context</span> *<span class="org-variable-name">ctx</span>, <span class="org-type">int</span> <span class="org-variable-name">short_only</span>, <span class="org-keyword">struct</span> <span class="org-type">fat_ioctl_filldir_callback</span> *<span class="org-variable-name">both</span>);

<span class="org-comment-delimiter">/* </span><span class="org-comment">vs.</span><span class="org-comment-delimiter"> */</span>

<span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">__fat_readdir</span>(<span class="org-keyword">struct</span> <span class="org-type">inode</span> *<span class="org-variable-name">inode</span>, <span class="org-keyword">struct</span> <span class="org-type">file</span> *<span class="org-variable-name">file</span>,
                         <span class="org-keyword">struct</span> <span class="org-type">dir_context</span> *<span class="org-variable-name">ctx</span>, <span class="org-type">int</span> <span class="org-variable-name">short_only</span>,
                         <span class="org-keyword">struct</span> <span class="org-type">fat_ioctl_filldir_callback</span> *<span class="org-variable-name">both</span>);

<span class="org-comment-delimiter">/* </span><span class="org-comment">or</span><span class="org-comment-delimiter"> */</span>

<span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">__fat_readdir</span>(<span class="org-keyword">struct</span> <span class="org-type">inode</span> *<span class="org-variable-name">inode</span>,
                         <span class="org-keyword">struct</span> <span class="org-type">file</span> *<span class="org-variable-name">file</span>,
                         <span class="org-keyword">struct</span> <span class="org-type">dir_context</span> *<span class="org-variable-name">ctx</span>,
                         <span class="org-type">int</span> <span class="org-variable-name">short_only</span>,
                         <span class="org-keyword">struct</span> <span class="org-type">fat_ioctl_filldir_callback</span> *<span class="org-variable-name">both</span>)
</pre>
</div></li>
<li>The prohibition of typedefs (except in certain circumstances) is worth
mentioning.  Ideally, a type should be opaque except with regard to its
functional interface, but in low-level code we can&rsquo;t afford such clean
abstractions.  But even if we could, typedefs aren&rsquo;t particularly good
anyway &#x2014; they&rsquo;re just dumb aliases, and not subject to type-checking.</li>
<li>The lack of namespacing in C really sucks for a big project like this.</li>
<li>Inline functions are preferred over macros that pose as regular functions.
Presumably this is for the benefit of the compiler.  (In fact I think macros
in general kind of stink; they make code less consistent, and are hostile to
IDEs and debuggers.)</li>
<li>Often we need to get the size of a struct.  We should use <code>sizeof(*p)</code> instead
of hard-coding the struct type.  (I often forget this tip.)</li>
<li>A function name that implies an action or command (e.g. <code>frobnicate_buf()</code>)
should return an integer-as-error-code (0 = success).  A function name that
implies a predicate (e.g. <code>is_empty()</code>) should return boolean logic (1 =
success).</li>
</ul>
</div>
</div>
<div id="outline-container-orgf05accd" class="outline-3">
<h3 id="bc6ba800-d10d-41c9-a9b3-646f4ea93c53"><span class="section-number-3">4.2</span> Running checkpatch.pl</h3>
<div class="outline-text-3" id="text-bc6ba800-d10d-41c9-a9b3-646f4ea93c53">
<p>
, the <code>script/checkpatch.pl</code> script performs static analysis.  The
<code>-help</code> flag shows the list of options available.  Basic usage looks something
like this:
</p>
<div class="org-src-container">
<pre class="src src-bash">scripts/checkpatch.pl --patch foo.patch ...  <span class="org-comment-delimiter"># </span><span class="org-comment">check patch file(s)</span>
scripts/checkpatch.pl --git hash1 ...        <span class="org-comment-delimiter"># </span><span class="org-comment">check commit(s)</span>
scripts/checkpatch.pl --file file1.c ...     <span class="org-comment-delimiter"># </span><span class="org-comment">check file(s)</span>
</pre>
</div>

<p>
As an example, the following issues were raised with regard to my original
<code>hello.c</code> module:
</p>
<dl class="org-dl">
<dt><code>ERROR: DOS line endings</code></dt><dd>Files must use Unix-style LF line-endings, not
the DOS-style CRLF.<sup><a id="fnr.11" class="footref" href="#fn.11">11</a></sup></dd>
<dt><code>WARNING: Missing or malformed SPDX-License-Identifier tag in line 1</code></dt><dd>SPDX
is a special file format for documenting the software license.  You can even
see this header in the checkpatch script itself.  <a href="https://lwn.net/Articles/739183/">This article</a> explains that
they are a recent addition to the source tree; machine-parsable headings
intended to make license compliance easier for companies.  Note that the
<code>MODULE_LICENSE</code> tag that modules also include is neither a replacement for
the SPDX ID, nor a canonical declaration of the license that applies to the
entire module, but rather, it is a mechanism for limiting which symbols the
module is permitted to have access to.</dd>
<dt><code>WARNING: Prefer [subsystem]_alert(), dev_alert(), or pr_alert() over printk()</code></dt><dd>My
code as it stands prints a string to the kernel ring buffer with <code>printk()</code> at
the &ldquo;alert&rdquo; loglevel.  However, these days one ought to use the shorthands
for each loglevel &#x2014; <code>pr_alert()</code> in our case.  Furthermore, if we are using
a subsystem-specific device struct, then there may exist a
subsystem-specific family of printk functions that ought to be used.  These
will prefix our message with device-specific identifying information.  We
should use <code>dev_warn()</code>, for example, when printing a warning regarding a
generic <code>struct device</code>.</dd>
<dt><code>WARNING: please, no spaces at the start of a line</code></dt><dd>We&rsquo;re to use tabs for
indentation.</dd>
</dl>

<p>
I could fix these manually, but often the script can fix them in-place on our
behalf &#x2014; just use the <code>--fix</code> or <code>--fix-inplace</code> flags.  (Doing this fixed the
issue with line-endings; the other warnings remained.)  Another thing to try
is running <a href="https://www.kernel.org/doc/html/latest/process/clang-format.html">clang-format</a> with the <code>.clang-format</code> file included in the source
tree.  (By default, <code>clang-format</code> looks for a <code>.clang-format</code> format file in the
project directory of the file it&rsquo;s being run on, so if the source file you&rsquo;re
working on is out-of-tree, you may need to copy this file over.)  Let&rsquo;s see
what this changes:
</p>
<div class="org-src-container">
<pre class="src src-text">$ diff hello.c &lt;(clang-format hello.c)
8,9c8,9
&lt;     printk(KERN_ALERT "Hello, world\n");
&lt;     return 0;
---
&gt;       printk(KERN_ALERT "Hello, world\n");
&gt;       return 0;
14c14
&lt;     printk(KERN_ALERT "Goodbye, cruel world\n");
---
&gt;       printk(KERN_ALERT "Goodbye, cruel world\n");
</pre>
</div>
<p>
Nice!  It converted all indentation to tabs instead of spaces.
</p>

<p>
Now on to the <code>coding_style.c</code> module.  This time, I&rsquo;ll instruct <code>clang-format</code> to
fix in-place:
</p>
<div class="org-src-container">
<pre class="src src-bash">clang-format -i coding_style.c
</pre>
</div>

<p>
For this file, <code>checkpatch.pl</code> indicates some more problems, which are fairly
self-explanatory:
</p>
<ul class="org-ul">
<li><code>WARNING: Use #include &lt;linux/delay.h&gt; instead of &lt;asm/delay.h&gt;</code></li>
<li><code>WARNING: braces {} are not necessary for single statement blocks</code></li>
<li><code>WARNING: void function return statements are not generally useful</code></li>
</ul>

<p>
One final thing not covered by these tests &#x2014; a file ought to include the
headers it needs.  What do I mean by that?  A header may pull in lots of other
headers, and likewise for each header it pulls in.  A dependency (on say,
stuff from <code>&lt;linux/sched.h&gt;</code>) may be satisfied by pulling in an unrelated header
(like <code>&lt;linux/kthread.h&gt;</code>).  In such a case, the dependency is satisfied by
accident.  Nevertheless, we should pull in both.
</p>
</div>
</div>
</div>
<div id="outline-container-orge802fcd" class="outline-2">
<h2 id="task-05"><span class="section-number-2">5</span> Task 05</h2>
<div class="outline-text-2" id="text-task-05">
<blockquote>
<p>
Yeah, you survived the coding style mess!  Now, on to some &ldquo;real&rdquo; things, as I
know you are getting bored by these so far.
</p>

<p>
So, simple task this time around:
</p>
<ul class="org-ul">
<li>take the kernel module you wrote for task 01, and modify it so that when a
USB keyboard is plugged in, the module will be automatically loaded by the
correct user-space hotplug tools (which are implemented by depmod / kmod /
udev / mdev / systemd, depending on what distro you are using.)</li>
</ul>

<p>
Yes, so simple, and yet, it&rsquo;s a bit tricky.  As a hint, go read chapter 14 of
the book, &ldquo;Linux Device Drivers, 3rd edition.&rdquo;  Don&rsquo;t worry, it&rsquo;s free, and
online, no need to go buy anything.
</p>
</blockquote>

<p>
Unfortunately, I didn&rsquo;t read this task properly the first time,<sup><a id="fnr.12" class="footref" href="#fn.12">12</a></sup> and erroneously interpreted the task as asking me to write
a udev rule, one that would load my module whenever a USB uevent occurred.
</p>

<p>
I think what finally pierced the veil of my ignorance was noticing my
confusion at being asked to modify the <i>module</i> such that user-space will load
it in response to a USB event.  &ldquo;Well, obviously a module cannot load itself,
so the only way this could possibly make sense is if some compile-time info is
provided with the module that says &lsquo;I contain logic capable of handling
generic USB keyboards&rsquo;, after which udev should be smart enough to load it.&rdquo;
And then I remembered that there does in fact exist a facility for disclosing
such information: the <code>MODULE_DEVICE_TABLE</code> macro.
</p>

<p>
This was, in the words of Bob Ross, a happy little accident.  I certainly
found it to be a fun little excursion, and didactic in more than one way.
(Read carefully!)  I also picked up a few helpful <code>udevadm</code> commands for
monitoring what udev is seeing and doing (which in doing the actual task
turned out to be needed for troubleshooting).
</p>

<p>
If you&rsquo;re not interested in learning about udev rules and whatnot, you can
ignore those sections and .
</p>
</div>
<div id="outline-container-org2f09138" class="outline-3">
<h3 id="7dec8acc-8de6-4b4c-93d1-59850d71e7f7"><span class="section-number-3">5.1</span> The device model: a super-quick primer</h3>
<div class="outline-text-3" id="text-7dec8acc-8de6-4b4c-93d1-59850d71e7f7">
<p>
The device model is a tree-like structure which reflects the topology of the
system; how things are connected to it.  It mirrors the hierarchy of devices,
buses, and miscellaneous interfaces branching out from the core, each of which
being made operable via a driver/module registered to it.  The &ldquo;nodes&rdquo; of this
tree may be static (as in a real-time clock), pseudo-static (as in a PCI bus
that is wed to the motherboard), hotpluggable (as in a USB keyboard that plugs
into a USB hub), or even virtual (as in a pseudo-tty).
</p>

<p>
The <i>kobject</i> is the fundamental structure that holds the device model together.
That is, it represents one &ldquo;node&rdquo; in this hierarchy, and is associated with a
particular kernel object in memory.  In fact, the sysfs directory tree is a
direct reflection of this hierarchy &#x2014; every nested subdirectory in <code>/sys/</code> has
a kobject associated with it.  In an overly simplified sense, it is similar to
a <code>struct list_head</code> (more on that data structure ), though its
responsibilities extend beyond merely linking objects together.
</p>

<p>
One of these additional responsibilities is to facilitate the generation of
events that notify user-space when the system toplogy changes; the comings and
goings of hardware.  A hotplug event is generated whenever a driver creates or
destroys a kobject.
</p>

<p>
(We will go over this topic more thoroughly in .)
</p>
</div>
</div>
<div id="outline-container-orga949583" class="outline-3">
<h3 id="c94004f2-c0ce-490c-895c-1569717784b2"><span class="section-number-3">5.2</span> A detour through udev</h3>
<div class="outline-text-3" id="text-c94004f2-c0ce-490c-895c-1569717784b2">
</div>
<div id="outline-container-org3ec77ed" class="outline-4">
<h4 id="013c2fc3-cc14-4a15-918b-9044cef2102b"><span class="section-number-4">5.2.1</span> Basics of udev and hotplug events</h4>
<div class="outline-text-4" id="text-013c2fc3-cc14-4a15-918b-9044cef2102b">
<p>
Historically, the conduit for hotplug events was the invocation of a
user-space program residing at some configurable path, usually <code>/sbin/hotplug</code>,
with a host of environment variables disclosed.
</p>

<p>
This has since changed.  Hotplug events &#x2014; called <i>uevents</i> &#x2014; are now
signalled through a <i><a href="https://en.wikipedia.org/wiki/Netlink">netlink socket</a></i>.  These are similar to <a href="https://en.wikipedia.org/wiki/Unix_domain_socket">unix domain sockets</a>,
but with the purpose of transferring networking info between kernel- and
user-space.  The addresses that netlink sockets bind are taken from the PID
namespace (daemons almost always bind it to <code>getpid()</code>), and uevents are
transmitted using the <code>NETLINK_KOBJECT_UEVENT</code> protocol.
</p>

<p>
The primary goal of <a href="https://en.wikipedia.org/wiki/Udev">udev</a> was to move policy decisions regarding the management
of <code>/dev/</code> to user-space.  (Formerly, such device management was handled
automatically from kernel-space by <i>devfs</i>.)  Such policy decisions concern
device node naming, permissions, and the user-space API for accessing info
about current system devices.<sup><a id="fnr.13" class="footref" href="#fn.13">13</a></sup>
</p>

<p>
As of 2012, udev has been incorporated into systemd (provided by the <i>udevd</i>
service).  As such, it takes advantage of systemd&rsquo;s socket protocol to listen
for such events.<sup><a id="fnr.14" class="footref" href="#fn.14">14</a></sup>  There are
two subgroups (or multicast groups) associated with <code>NETLINK_KOBJECT_UEVENT</code>
events: <code>GROUP_KERNEL</code>, which are handled immediately by udevd; and <code>GROUP_UDEV</code>,
which it delegates to an external <i>udev event process</i> or other user-space
processes that use <i>libudev</i>.
</p>

<p>
Logically, this all looks something like this:
</p>
<ul class="org-ul">
<li>A hardware event occurs; the registered device driver responds by creating
(or destroying) a kobject.</li>
<li>In response to this, the sysfs subsystem will:
<ul class="org-ul">
<li>send a uevent on a netlink socket to whoever is listening (udevd in this
case); and</li>
<li>update <code>/sys/</code> to reflect the new kobject hierarchy.</li>
</ul></li>
<li>After some processing, udevd spawns or communicates with the udev event
process, passing it relevant information about the event.</li>
<li>The udev event process parses whatever rules are defined on the filesystem,
and matches them to the event in question.</li>
<li>A matching rule may trigger:
<ul class="org-ul">
<li>storing device info to the udev database;</li>
<li>loading a module;</li>
<li>passing the event on to the <i>DBus</i> daemon (examples of user-space processes
that make use of libudev to listen to and/or broadcast events to <i>DBus</i>
include <i>udisks</i>, <i>upower</i>, and <i>NetworkManager</i>); ior</li>
<li>modifying the device file that was created in devtmpfs mounted at <code>/dev/</code>
(in the process, sysfs may need to be consulted to obtain more information
that was not disclosed in the event).</li>
</ul></li>
</ul>

<p>
The official <code>udevadm</code> command-line utility is developed and distributed with
udev for the purposes of querying and controlling its runtime behaviour.  Here
are some examples of usage (<code>-h</code> gives a full summary):
</p>
<dl class="org-dl">
<dt><code class="src src-bash">udevadm info --name=/dev/foobar</code></dt><dd>This queries device info stored in the
udev database, or properties of a device gleaned from its sysfs
representation.  This can be helpful for creating device-specific udev
rules.</dd>
<dt><code class="src src-bash">udevadm control --reload-rules &amp;&amp; udevadm trigger</code></dt><dd>This
manually forces udev to reload and trigger udev rules.</dd>
<dt><code class="src src-bash">udevadm settle</code></dt><dd>This watches the udev event
queue, and blocks until all current events are handled (e.g. wait for all
devices during boot).</dd>
<dt><code class="src src-bash">udevadm monitor --kernel --property</code></dt><dd>This listens
for events sent out by the kernel before they are processed by udev.  This
can be useful for analysing event timing.</dd>
<dt><code class="src src-bash">udevadm monitor --udev --property</code></dt><dd>This listens
for events <i>after</i> processing by udev.  This can similarly be useful for
analysing event timing.</dd>
<dt><code class="src src-bash">udevadm test $(udevadm info --query=path --name=/dev/foobar)</code></dt><dd>This
simulates events for the given device, and the actions that would
subsequently be triggered.</dd>
<dt><code class="src src-bash">udevadm test --action=$<span class="org-variable-name">action</span> $<span class="org-variable-name">dev_path</span></code></dt><dd>This
simulates a particular action.  Possible actions include <code>add</code>, <code>remove</code>,
<code>change</code>, <code>move</code>, <code>online</code>, <code>offline</code>, <code>bind</code>, and <code>unbind</code> (passing the <code>help</code> action
does what one would expect).</dd>
</dl>
</div>
</div>
<div id="outline-container-org98e8079" class="outline-4">
<h4 id="2bfd1af6-336c-40df-b5af-5dc440db7a66"><span class="section-number-4">5.2.2</span> Udev rules</h4>
<div class="outline-text-4" id="text-2bfd1af6-336c-40df-b5af-5dc440db7a66">
<p>
To restate (what I initially took to be) our task: configure udev to load our
&ldquo;hello&rdquo; module automatically when a USB keyboard is plugged in.
</p>

<p>
It would also be nice to have this module unloaded when the device is
unplugged (or more specifically, when the last device associated with the
driver is disconnected).  However, this doesn&rsquo;t seem to be a common practise.
A driver by itself, prior to having registered any device, has a fairly small
footprint in the kernel.  And in any case, a modern desktop &#x2014; udev&rsquo;s
wheelhouse &#x2014; will have plenty of memory to spare comparitively.
</p>

<p>
How do we write a udev rule?  Some examples can be seen <a href="http://www.reactivated.net/writing_udev_rules.html#example-printer">here</a>.  Let&rsquo;s go into
some of the details.
</p>
</div>
<div id="outline-container-orgded646e" class="outline-5">
<h5 id="7ef99fb1-8d4c-4913-99c7-fe95f2eb4fe3"><span class="section-number-5">5.2.2.1</span> Where do rule files go?</h5>
<div class="outline-text-5" id="text-7ef99fb1-8d4c-4913-99c7-fe95f2eb4fe3">
<p>
System-level rule files may be placed in <code>/etc/udev/rules.d/</code> by the
administrator.  System packages on the other hand install rule files to
<code>/usr/lib/udev/rules.d/</code>.
</p>

<p>
Each rule file must have a <code>.rules</code> suffix.  Collectively, the files are
evaluated in lexical order (which is while you&rsquo;ll normally see the filenames
prefixed with a number).  If there are two files with the same name in both
directories, then the one in <code>/etc/</code> takes precedence.
</p>

<p>
In general, we&rsquo;ll want our own custom rules to be parsed before any others, so
something like <code>/etc/udev/rules.d/10-local.rules</code> is a perfect place to stash
them.
</p>
</div>
</div>
<div id="outline-container-org2ac6ff7" class="outline-5">
<h5 id="7e9c0898-b070-45b0-af44-6273c0662f38"><span class="section-number-5">5.2.2.2</span> Syntax</h5>
<div class="outline-text-5" id="text-7e9c0898-b070-45b0-af44-6273c0662f38">
<p>
Every line (except for commented lines; those prepended with <code>#</code>) denotes
exactly one rule (rules do not span more than one line).  Udev applies all
rules that match a device (it doesn&rsquo;t stop at just the first match), thus a
device could trigger more than one.  We may, for example, create multiple
symlinks with persistent names that point to the same device.
</p>

<p>
Each rule is defined as a comma-separated list of key&#x2013;value pairs.  For
example:
</p>
<div class="org-src-container">
<pre class="src src-text">KERNEL=="hdb", DRIVER=="ide-disk", SYMLINK+="sparedisk"
</pre>
</div>

<p>
The operators are similar to bash syntax:
</p>
<ul class="org-ul">
<li><code>==</code></li>
<li><code>!=</code></li>
<li><code>=</code></li>
<li><code>+=</code> (like bash variables, keys can store lists of values; we can
assign/append multiple values at once using a space-delimited string)</li>
<li><code>:=</code> (this assigns a final value to a key, disallowing any later changes)</li>
</ul>
</div>
</div>
<div id="outline-container-org0d00522" class="outline-5">
<h5 id="2d0f522c-2958-40b3-a600-724fb9589671"><span class="section-number-5">5.2.2.3</span> Matching keys</h5>
<div class="outline-text-5" id="text-2d0f522c-2958-40b3-a600-724fb9589671">
<p>
A complete list of information we can match against is given in udev&rsquo;s
manpage.  The main key names are:
</p>
<ul class="org-ul">
<li><code>KERNEL</code>, to match against the kernel-assigned name for the device;</li>
<li><code>SUBSYSTEM</code>, to match against the subsystem of the device; and</li>
<li><code>DRIVER</code>, to match against the name of the driver backing the device.</li>
</ul>

<p>
Matching against sysfs attributes is done with <code>ATTR{&lt;attribute_name&gt;}</code>.  For
example:
</p>
<div class="org-src-container">
<pre class="src src-text">SUBSYSTEM=="block", ATTR{size}=="234441648", SYMLINK+="my_disk"
</pre>
</div>

<p>
Note that, with respect to the device tree hierarchy, the above key&#x2013;value
pairs are relevant only with respect to the device that generated the event in
question, not its parent or ancestor devices.  If we want a test to be
satisfiable by the device <i>or any of its ancestor devices</i>, these variants are
available:
</p>
<ul class="org-ul">
<li><code>KERNELS</code>, to match against the kernel-assigned name for the device <i>or the
kernel-assigned name of any of its ancestors</i>;</li>
<li><code>SUBSYSTEMS</code>, to match against the subsystem of the device <i>or the subsystem
of any of its ancestors</i>;</li>
<li><code>DRIVERS</code>, to match against the name of the driver backing the device <i>or the
name of the driver backing any of its ancestors</i>; and</li>
<li><code>ATTRS</code>, to match against the sysfs attributes of the device <i>or the sysfs
attributes of any of its ancestors</i>.</li>
</ul>
</div>
</div>
<div id="outline-container-org5249a60" class="outline-5">
<h5 id="292c74fa-0c3f-4d53-8008-506659775a48"><span class="section-number-5">5.2.2.4</span> Assignable keys</h5>
<div class="outline-text-5" id="text-292c74fa-0c3f-4d53-8008-506659775a48">
<p>
Again, refer to the manpage for a full list of these.  The main ones are:
</p>
<ul class="org-ul">
<li><code>NAME</code>, the name to assign to the new device node; and</li>
<li><code>SYMLINK</code>, a list of alternative names for the device node, for which symbolic
links are created.<sup><a id="fnr.15" class="footref" href="#fn.15">15</a></sup></li>
</ul>

<p>
Other keys way may assign to include:
</p>
<ul class="org-ul">
<li><code>OWNER</code>, <code>GROUP</code>, and <code>MODE</code>, which specify the owner, group, and permission bits
of the device node file and/or symlinks;</li>
<li><code>RUN</code>, which specifies an external program to run when the rule is triggered;</li>
<li><code>ACTION</code>, which specifies an environment variable which will be provided to
<code>RUN</code> if executed;</li>
<li><code>PROGRAM</code>, which specifies an external program to run, whose job is
specifically to name the device (thus allowing us specify our desired
naming-logic elsewhere); and</li>
<li><code>OPTIONS</code>, through which we may specify additional options, such as:
<ul class="org-ul">
<li><code>all_partitions</code>, to tell udev to create all possible partitions for a block
device;</li>
<li><code>ignore_device</code>, to ignore the event completely; and</li>
<li><code>last_rule</code>, to suppress the effect of any rules that come after this one.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org5282500" class="outline-5">
<h5 id="8b0d2d2d-46ed-4816-9249-ec5dac8c4493"><span class="section-number-5">5.2.2.5</span> Getting information about our device</h5>
<div class="outline-text-5" id="text-8b0d2d2d-46ed-4816-9249-ec5dac8c4493">
<p>
Fumbling around in the sysfs tree to get the information we need about a
particular device is rather cumbersome.  An easier method, which collates
information in a nicer format, is running <code class="src src-bash">udevadm info</code>.  We simply provide it the path to the device of interest as it lies in
sysfs.  For example:
</p>
<div class="org-src-container">
<pre class="src src-bash">udevadm info -a -p /sys/block/sda
<span class="org-comment-delimiter"># </span><span class="org-comment">OR, if we don't know where it is but do have the device node</span>
udevadm info -a -p $(udevadm info -q path -n /dev/sda)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb27d5ea" class="outline-5">
<h5 id="d7dc3f0b-d414-44b1-9f93-db449e02f468"><span class="section-number-5">5.2.2.6</span> Testing and debugging</h5>
<div class="outline-text-5" id="text-d7dc3f0b-d414-44b1-9f93-db449e02f468">
<p>
In newer kernels that have <a href="https://en.wikipedia.org/wiki/Inotify">inotify</a> support, udev will automatically detect
changes to rule files and reload them.  However, the rule will not be
re-evaluated until an actual hardware event occurs.  Fortunately, we can
simulate such events without necessarily having to touch the hardware.
</p>

<p>
To replay device events for a particular subset of existing devices, such that
the rules will be re-evaluated (as if one were rebooting), we can run
<code class="src src-bash">udevadm trigger</code> in lieu of physically disconnecting
and reconnecting the device(s).  And if the device is non-removable, this is
our only option outside of rebooting the system.
</p>

<p>
As an example, this line will generate events for all devices belonging to the
USB subsystem, and have a particular vendor ID:
</p>
<div class="org-src-container">
<pre class="src src-bash">udevadm trigger --verbose --type=subsystems --subsystem-match=usb --attr-match=<span class="org-string">"idVendor=abcd"</span>
</pre>
</div>
<p>
By default, this command will simulate a <code>change</code> action for all matching
devices.  If we want to simulate a specific event for a device to see what
rules <i>would be</i> evaluated, without actually doing so, we can run
<code class="src src-bash">udevadm test --action=$<span class="org-variable-name">action</span> $<span class="org-variable-name">dev_path</span></code>, as touched
on .  (In my experience, this didn&rsquo;t seem to process all consequents in
the matching rules &#x2014; <code>RUN</code> commands were not run, which I can only speculate
to be because they aren&rsquo;t guaranteed to be idempotent &#x2014; but it did create
the symlinks.)
</p>
</div>
</div>
<div id="outline-container-org3cccaa9" class="outline-5">
<h5 id="1c8f0de9-22d8-41c6-9fd3-db29a3b67051"><span class="section-number-5">5.2.2.7</span> Device nodes and persistent naming</h5>
<div class="outline-text-5" id="text-1c8f0de9-22d8-41c6-9fd3-db29a3b67051">
<p>
Udev is capable of providing persistent naming for certain types of devices.
This often means we can avoid having to write our own rules.
</p>

<p>
For example, udev may be configured to populate the <code>/dev/disk/</code> directory with
symlinks to the canonical device nodes associated with block devices.  The
symlinks are given various names corresponding to information about the
device, driver, or vendor, such as the UUID or the device tree path.<sup><a id="fnr.16" class="footref" href="#fn.16">16</a></sup>  Another directory is
<code>/dev/block/</code>, which names symlinks by the <code>major:minor</code> number pair of the
associated block device (more on major and minor numbers later in ).
</p>

<p>
On my distro (Debian), these in-built rules could be seen in
<code>/usr/lib/udev/rules.d/</code>.
</p>
</div>
</div>
<div id="outline-container-orgce606b6" class="outline-5">
<h5 id="bee7ac40-79e5-4d1c-85c3-eb2efb36cb79"><span class="section-number-5">5.2.2.8</span> A caveat about &ldquo;remove&rdquo; actions</h5>
<div class="outline-text-5" id="text-bee7ac40-79e5-4d1c-85c3-eb2efb36cb79">
<p>
When a device is removed, the kernel/driver will remove its corresponding
attributes in sysfs.  For this reason, sysfs attributes cannot be relied upon
when responding to a remove event.  Instead, we&rsquo;ll need to define our rule
based on environment variables, for example:
</p>
<div class="org-src-container">
<pre class="src src-text">ENV{ID_MODEL}=="foobar"
</pre>
</div>
<p>
(Again, one normally does not bother removing modules in response to remove
events, so this is not a big deal anyway.)
</p>

<p>
To see what environment variables are defined at removal time for a particular
device, try <code class="src src-bash">udevadm monitor --udev --environment</code>.
</p>
</div>
</div>
</div>
<div id="outline-container-org440e515" class="outline-4">
<h4 id="3dc9b642-60d9-4cb1-9531-cb07d0cc5d90"><span class="section-number-4">5.2.3</span> Implementing a rule</h4>
<div class="outline-text-4" id="text-3dc9b642-60d9-4cb1-9531-cb07d0cc5d90">
<p>
(Again, this is not what the task asked, so if you&rsquo;re not
interested in witnessing a wrestling match between udev and I.  There was
quite a bit of trial and error involved, and I&rsquo;ve included the gory details
here.)
</p>

<p>
So, what type of event do we need to match against?
</p>
<ul class="org-ul">
<li>It must relate to a USB device.</li>
<li>It must relate to a device and not a subsystem.</li>
<li>It must relate to an input device.</li>
<li>The input device must be a keyboard.</li>
<li>We&rsquo;re interested in <code>add</code> (and possibly <code>remove</code>) actions in relation to this
device.</li>
</ul>

<p>
Something we can try first up is to monitor udev while we plug in a USB
keyboard, and seeing what properties show up.  What we&rsquo;re interested in here
are not the raw events originating from the kernel, but the events originating
from udev after processing.  Namely, we need to run <code class="src src-bash">udevadm monitor --udev</code>.
</p>

<p>
This was the resulting output:
</p>
<div class="org-src-container">
<pre class="src src-text">UDEV  [62094.806310] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2 (usb)
UDEV  [62094.806551] add      /class/usbmisc (class)
UDEV  [62094.811891] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/wakeup/wakeup28 (wakeup)
UDEV  [62094.812322] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0 (usb)
UDEV  [62094.815475] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.1 (usb)
UDEV  [62094.816299] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011 (hid)
UDEV  [62094.818275] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.1/0003:046D:C318.0012 (hid)
UDEV  [62094.822616] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.1/0003:046D:C318.0012/input/input44 (input)
UDEV  [62094.827188] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.1/usbmisc/hiddev0 (usbmisc)
UDEV  [62094.829468] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/input/input43 (input)
UDEV  [62094.836468] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/input/input43/input43::numlock (leds)
UDEV  [62094.836554] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/input/input43/input43::capslock (leds)
UDEV  [62094.838935] change   /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/input/input43/input43::capslock (leds)
UDEV  [62094.841051] change   /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/input/input43/input43::numlock (leds)
UDEV  [62094.846911] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/input/input43/input43::kana (leds)
UDEV  [62094.849262] change   /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/input/input43/input43::kana (leds)
UDEV  [62094.853840] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/input/input43/input43::scrolllock (leds)
UDEV  [62094.858970] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/input/input43/input43::compose (leds)
UDEV  [62094.860217] change   /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/input/input43/input43::scrolllock (leds)
UDEV  [62094.868059] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.1/0003:046D:C318.0012/hidraw/hidraw1 (hidraw)
UDEV  [62094.868793] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/hidraw/hidraw0 (hidraw)
UDEV  [62094.884424] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.1/0003:046D:C318.0012/input/input44/event16 (input)
UDEV  [62094.886221] bind     /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.1/0003:046D:C318.0012 (hid)
UDEV  [62094.887796] bind     /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.1 (usb)
UDEV  [62094.892895] add      /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011/input/input43/event15 (input)
UDEV  [62094.894586] bind     /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0/0003:046D:C318.0011 (hid)
UDEV  [62094.895567] bind     /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2/4-1.2:1.0 (usb)
UDEV  [62094.896766] bind     /devices/pci0000:00/0000:00:1d.0/usb4/4-1/4-1.2 (usb)
</pre>
</div>

<p>
Hmm, there are quite a few events listed here.  From my understanding of the
USB subsystem&rsquo;s topology on Linux, the components of the device path are
interpreted as follows:
</p>
<dl class="org-dl">
<dt><code>pci0000:00</code></dt><dd>This is the PCI controller identifier.</dd>
<dt><code>0000:00:1d.0</code></dt><dd>This is the PCI device identifier; the root USB hub in our
case.</dd>
<dt><code>usb4</code></dt><dd>This is the USB root hub identifier.</dd>
<dt><code>4-1</code></dt><dd>This is the USB device port identifier (i.e. device port 1 on hub 4).</dd>
<dt><code>4-1.2</code></dt><dd>As above, but this further identifies the device port of a USB hub
daisy-chained to the root hub.  Where there is a chain of hubs used,
subsequent port numbers are appended, as in
<code>root_hub-hub_port-hub_port-...:config.interface</code>.</dd>
<dt><code>4-1.2:1.0</code> and <code>4-1.2:1.1</code></dt><dd>As above, but these further indicate the current
device configuration and the two interfaces (i.e. functions) that the USB
device provides.  (What these functions are we have yet to figure out.)</dd>
</dl>

<p>
Beyond this, I&rsquo;m not well versed on the different types of device node for
this device.  To hazard a guess, they may be exposing alternative or more
granular types of abstractions to user-space.  Additionally, while I can only
presume that <code>bind</code> relates to when a driver is bound to a device, I don&rsquo;t know
specifically what the <code>change</code> events involve.  I&rsquo;ll leave that be for now since
we&rsquo;re only interested in <code>add</code> events here.
</p>

<p>
Which of the events listed above is associated with our keyboard specifically?
Let&rsquo;s move on to looking at the properties associated with these events.
</p>
<div class="org-src-container">
<pre class="src src-bash">udevadm monitor --udev --property
</pre>
</div>

<p>
The only property I can see listed that contains &ldquo;keyboard&rdquo; in its name is
<code>ID_INPUT_KEYBOARD=1</code>, which relates to the <code>add</code> event of
<code>.../2-1.2:1.0/0003:046D:C318.000B/input/input31</code>.  (The number at the end is
different now, but presumably this is the same as <code>input43</code> in the output
above).  My first attempt at a rule will use a subset of these properties such
that it will (I hope) match all USB keyboards:
</p>
<div class="org-src-container">
<pre class="src src-text">ACTION=add SUBSYSTEM=input ID_INPUT_KEYBOARD=1 ID_TYPE=hid ID_BUS=usb
</pre>
</div>

<p>
An alternative approach: query the udev database for device attributes:
</p>
<div class="org-src-container">
<pre class="src src-bash">udevadm info -a -p $(udevadm info -q path -n /dev/input/by-id/usb-Logitech_Logitech_Illuminated_Keyboard-event-kbd)
</pre>
</div>
<p>
To my untrained eye, there seems to be less useful info here.  Apart from the
name the vendor has given to the device, it&rsquo;s not apparent at a glance as to
whether you can tell this is a keyboard, only that it&rsquo;s an input device.
</p>

<p>
In any case, we have some predicates; let&rsquo;s try (and fail) to describe our
consequent.  For initial testing, we&rsquo;ll call the <code>touch</code> command to create a
sentinel file.  Again, the examples <a href="http://www.reactivated.net/writing_udev_rules.html#example-printer">here</a> may serve as a useful guide.  Let&rsquo;s
save the following in a new file named <code>/etc/udev/rules.d/10-local.rules</code>:
</p>
<div class="org-src-container">
<pre class="src src-text">ACTION=add SUBSYSTEM=input ID_INPUT_KEYBOARD=1 ID_TYPE=hid ID_BUS=usb RUN+="/usr/bin/touch /tmp/udev_sentinel.txt"
</pre>
</div>
<p>
We then call <code class="src src-bash">udevadm control --reload-rules</code> to reload
the rules.  (As stated earlier, udev is supposed to use inotify to monitor for
changes to rule files automatically, but this didn&rsquo;t seem to happen for me, so
I had to reload manually after every change.)
</p>

<p>
Unsurprisingly, my initial attempt at writing a rule didn&rsquo;t work, so it&rsquo;s time
to debug:
</p>
<div class="org-src-container">
<pre class="src src-bash">udevadm test --action=add $(udevadm info --query=path --name=/dev/input/by-id/usb-Logitech_Logitech_Illuminated_Keyboard-event-kbd)
</pre>
</div>
<p>
This command tells me that the rule defined in my rule file has an invalid
key&#x2013;value pair, and was ignored.  The problems I identified were:
</p>
<ul class="org-ul">
<li>using single <code>=</code> in places where I should have used <code>==</code>;</li>
<li>failing to properly quote the values; and</li>
<li>failing to enclose the <code>ID_*</code> keys in <code>ATTR{...}</code> (they are sysfs attributes,
not properties).</li>
</ul>

<p>
The moral of the story is that one cannot simply copy and paste the properties
as given by <code>udevadm monitor</code> straight into our rule &#x2014; the syntax is
different.  (Though at a glance, the output from <code>udevadm info</code> seems to be the
correct syntax.)
</p>

<p>
After correcting these problems, my rule file is no longer producing errors,
but the test command doesn&rsquo;t mention my <code>RUN</code> command being executed.  Is it
still failing to match my device?  I tried removing the attribute predicates
from my rule, and now the test works.  That&rsquo;s odd.  I&rsquo;ll just leave those out
for now.
</p>

<p>
Unfortunately, plugging in the real keyboard still doesn&rsquo;t result in the
<code>udev_sentinel.txt</code> file appearing.  Let&rsquo;s instead try creating a symbolic link
and see if that works.
</p>
<div class="org-src-container">
<pre class="src src-text">ACTION=="add" SUBSYSTEM=="input" SYMLINK+="zzzz_keyboard"
</pre>
</div>
<p>
Upon running the test command, I get this error:
</p>
<div class="org-src-container">
<pre class="src src-text">event15: Failed to create symlink '/dev/foobar_keyboard.tmp-c13:79' to 'input/event15': Permission denied
</pre>
</div>
<p>
Running the test command as root fixes this, and the symlink is now being
created properly.  Progress!
</p>

<p>
Let&rsquo;s now try reintroducing some of those more specific predicates:
</p>
<div class="org-src-container">
<pre class="src src-text">ACTION=="add" SUBSYSTEM=="input" SUBSYSTEMS=="usb" ENV{ID_INPUT_KEYBOARD}="1" SYMLINK+="zzzz_keyboard"
ACTION=="remove" SUBSYSTEM=="input" SUBSYSTEMS=="usb" ENV{ID_INPUT_KEYBOARD}="1" RUN+="/usr/bin/touch /tmp/usb_kbd_remove"
</pre>
</div>
<p>
(Worth noting is that the <code>ID_INPUT_KEYBOARD</code> environment variable, which I&rsquo;m
using here to identify that the device is specifically a keyboard, is
information that is added to the environment by udev, and is not defined in
the raw event originating from the kernel.)
</p>

<p>
This worked in testing inside a VM; I opted to use qemu&rsquo;s in-built keyboard,
rather than trying to pass through my USB device to the VM.  This required
removing the &ldquo;usb&rdquo; subsystem predicate from the rule.If I wanted to pass
through my USB device, I would need to provide the associated bus and port
number to qemu: <code>-usb -device usb-host,hostbus=3,hostport=10</code>.  Though a better
alternative might be to ask qemu to add a generic device for us: <code>-usb -device
usb-kbd</code>.
</p>

<p>
Now that this works, I need to modify the rule to load my module.  Udev rules
I&rsquo;ve viewed online sometimes use a built-in udev command called <code>kmod</code> to do the
job in lieu of a call to <code>modprobe</code>:
</p>
<div class="org-src-container">
<pre class="src src-text">RUN{builtin}+="kmod load foo_module"
</pre>
</div>
<p>
I&rsquo;m not sure whether this built-in command handles dependencies or module
unloading, and I struggled to find any udev documentation about it online.  To
venture a guess, it might be duplicating the job of module loading normally
handled by the <code>kmod</code> family of utilities<sup><a id="fnr.17" class="footref" href="#fn.17">17</a></sup> for the sake of speed and/or ditching a dependency.  In
any case, the module has to be installed first.  Copying <code>hello.ko</code> over to
<code>/lib/modules/$(uname -r)/mymodules/</code> is enough for <a href="https://wiki.debian.org/depmod">depmod</a> to find it.
</p>

<p>
Here are my new rules:
</p>
<div class="org-src-container">
<pre class="src src-text">ACTION=="add" SUBSYSTEM=="input" SUBSYSTEMS=="usb" ENV{ID_INPUT_KEYBOARD}="1" SYMLINK+="zzzz_keyboard" RUN{builtin}+="kmod load hello"
ACTION=="remove" SUBSYSTEM=="input" SUBSYSTEMS=="usb" ENV{ID_INPUT_KEYBOARD}="1" RUN{builtin}+="kmod unload hello"
</pre>
</div>

<p>
After manually reloading the rules, I test them with:
</p>
<div class="org-src-container">
<pre class="src src-bash">udevadm trigger --subsystem-match=input --action=add
udevadm trigger --subsystem-match=input --action=remove
</pre>
</div>
<p>
The module successfully loads.
</p>

<p>
However, it does not <i>unload</i>.  I tested a different pair of <code>RUN</code> commands, and
they seemed to work.  I couldn&rsquo;t seem to find any documentation regarding the
built-in <code>kmod</code> command, so I gave up and replaced it with calls to <code>modprobe</code>,
and this fixed this problem.  Again, it&rsquo;s not typical practice to unload
modules when devices are unplugged, so I&rsquo;m not terribly fussed about this.
</p>

<p>
My final rules looked like this:
</p>
<div class="org-src-container">
<pre class="src src-text">ACTION=="add" SUBSYSTEM=="input" SUBSYSTEMS=="usb" ENV{ID_INPUT_KEYBOARD}="1" SYMLINK+="zzzz_keyboard" RUN+="/usr/sbin/modprobe hello"
ACTION=="remove" SUBSYSTEM=="input" SUBSYSTEMS=="usb" ENV{ID_INPUT_KEYBOARD}="1" RUN+="/usr/sbin/modprobe -r hello"
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org4540244" class="outline-3">
<h3 id="88750d69-5d84-478c-9ea6-a4f5388fa3be"><span class="section-number-3">5.3</span> Module device tables</h3>
<div class="outline-text-3" id="text-88750d69-5d84-478c-9ea6-a4f5388fa3be">
<p>
(Here&rsquo;s where the <i>real</i> task starts.)
</p>

<p>
<a href="#fb318868-a843-4e6c-8483-db73d832b726">LDD</a> mentions the <code>MODULE_DEVICE_TABLE</code> macro in a few places.  Chapter 13 in
particular covers USB drivers &#x2014; let&rsquo;s have a look.
</p>

<p>
Defined in <code>include/linux/module.h</code>, the <code>MODULE_DEVICE_TABLE</code> macro may be used
to register a static array of device-matching info that indicates the kind(s)
of device the driver supports.  This information is exported with the module,
namely, to:
</p>
<ul class="org-ul">
<li>the driver-specific subsystem, so that it knows which driver to bequeath a
new device to (or if no such drivers are present); and</li>
<li>user-space (in a manner that requires further explication; see ), so that it knows what kind(s) of device a module can handle, and
thus when to hotload it.</li>
</ul>

<p>
An example USB driver:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">static</span> <span class="org-keyword">struct</span> <span class="org-type">usb_device_id</span> <span class="org-variable-name">skel_table</span>[] = {
        { USB_DEVICE(VENDOR_ID, FOO_PRODUCT_ID_1) },
        { USB_DEVICE(VENDOR_ID, FOO_PRODUCT_ID_2) },
        <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
        { },
};
<span class="org-function-name">MODULE_DEVICE_TABLE</span>(usb, skel_table);
</pre>
</div>

<p>
These tables, and their entries, have a subsystem-specific structure, the
details of which can be seen in <code>include/linux/mod_devicetable.h</code>.  The first
argument of the <code>MODULE_DEVICE_TABLE</code> macro indicates the type of the array.
The example above lists <code>struct usb_device_id</code> structures, each containing a
fair bit of info germane to USB devices.  Helper macros exist to help the
module author be specific.
</p>

<p>
We&rsquo;ll need to define such an array containing a least one entry that filters
for all USB keyboards.  The helper macros in <code>include/usb.h</code> include:
</p>
<dl class="org-dl">
<dt><code>USB_DEVICE(vendor, product)</code></dt><dd>Match only a specific vendor and product ID,
useful when a USB device must be driven by a specific driver.</dd>
<dt><code>USB_DEVICE_VER(vendor, product, lo, hi)</code></dt><dd>This further restricts us to a
device version range.</dd>
<dt><code>USB_DEVICE_INFO(class, subclass, protocol)</code></dt><dd>Match a specific class of USB
devices.</dd>
<dt><code>USB_INTERFACE_INFO(class, subclass, protocol)</code></dt><dd>Match a specific class of
USB interface.</dd>
</dl>

<p>
Ok, there&rsquo;s some new nomenclature here.  Key to the USB spec are a few
high-level concepts, which are as follows:
</p>
<ul class="org-ul">
<li>USB devices (&ldquo;device&rdquo; in its quotidian sense of a physical object one plugs
in) have one or more <i>configurations</i>.
<ul class="org-ul">
<li>Only one configuration can be active at a given time.  This is selected by
the driver.</li>
<li>For example, a device may be runnable on multiple firmware images.  The
choice of image to be uploaded will then depend on the configuration.</li>
<li>However, devices with multiple configurations are rare.  Usually there is
just one.</li>
</ul></li>
<li><i>Configurations</i> have one or more <i>interfaces</i>.
<ul class="org-ul">
<li>Each interface specifies a function of the device.</li>
<li>Usually there is just one function per interface.</li>
</ul></li>
<li><i>Interfaces</i> have one or more <i>settings</i> pertaining to <i>endpoints</i>.
<ul class="org-ul">
<li><i>Endpoints</i> are the points through which to transfer data into, and out of,
the device.</li>
<li><i>Settings</i> change the properties of those endpoints in different ways (e.g.,
how much bandwidth to reserve).</li>
<li>Only one setting can be active at a time.</li>
</ul></li>
</ul>

<p>
A USB webcam with a built-in microphone and speaker provides a good example:
</p>
<ul class="org-ul">
<li>One interface might represent the camera.
<ul class="org-ul">
<li>One particular setting of that interface may be to disable the camera to
save bandwidth.  In doing so, the associated endpoint will disappear.</li>
<li>Another setting may correspond to when the camera is enabled and in use,
whereby a so-called <i>IN</i> endpoint is used to transfer the video data from
camera to host.</li>
</ul></li>
<li>Another interface might represent the microphone and speaker.
<ul class="org-ul">
<li>In the default setting, one <i>IN</i> endpoint might take noise detected by the
microphone and transfer it the host, while an <i>OUT</i> endpoint might take data
from the host and play it to the speaker.</li>
</ul></li>
</ul>

<p>
To repeat, a USB device may have multiple interfaces, each handled
independently by different drivers &#x2014; a USB driver binds to an <i>interface</i>, <i>not</i>
the entire USB device.  (The latter is handled by the USB subsystem proper.)
</p>

<p>
In our case, we&rsquo;re only interested in interfaces associated with a keyboard.
What <code>class</code>, <code>subclass</code>, and <code>protocol</code> would a USB keyboard have?  And what the
heck are classes anyway?
</p>

<p>
<i>Classes</i> refer to a set of standards that any USB device can follow.  They
include, for example, <i>storage</i>, <i>keyboard</i>, <i>mouse</i>, <i>network device</i>, and <i>modem</i>.  If
a device follows one of these standards, then a special driver for the device
is not necessary &#x2014; one of the generic USB drivers can do the job.  Devices
that otherwise don&rsquo;t fall into one of these classes require a vendor-specific
driver (many video or USB-to-serial devices fall in this category).
</p>

<p>
After taking a peek at the <a href="https://www.usb.org/defined-class-codes">USB class codes</a>, the <code>class</code> looks likely to be HID
(0x03).  According to its <a href="https://www.usb.org/document-library/device-class-definition-hid-111">device class definition</a>:
</p>
<ul class="org-ul">
<li>The HID class doesn&rsquo;t use subclasses, so perhaps we should just leave a zero
here.  (This was in fact a mistake; I&rsquo;ll rectify it later.)</li>
<li>Protocol code 0x1 refers to keyboards (0x2 to mice).</li>
</ul>

<p>
This should be all the information we need.
</p>

<p>
Before testing this, the module will need to be installed so that udev can
find it.  Copying it over to <code>/lib/modules/$(uname -r)/mymodules/</code> will be
enough for <a href="https://wiki.debian.org/depmod">depmod</a> to find it.
</p>

<p>
If you took the , you will have already learnt a way to test
this without needing to plug in a real keyboard &#x2014; <code class="src src-bash">udevadm trigger</code>!
</p>

<p>
Let&rsquo;s give that a try:
</p>
<div class="org-src-container">
<pre class="src src-bash">udevadm trigger --verbose --subsystem-match=usb --subsystem-match=input --property-match=<span class="org-variable-name">ID_INPUT_KEYBOARD</span>=1 --action=add
</pre>
</div>

<p>
Hmmm.  This didn&rsquo;t result in my module being loaded.  Let&rsquo;s do some
troubleshooting.
</p>

<p>
Running <code class="src src-bash">objdump --syms hello.ko</code> confirms that it
contains a global symbol called <code>__mod_usb__kbds_device_table</code>, so that aspect
looks OK.
</p>

<p>
As I later discovered, the information necessary to match devices to modules
is collated in the <code>modules.alias</code> file.  And sure enough, an entry for my
module resides therein:
</p>
<div class="org-src-container">
<pre class="src src-text">alias usb:v*p*d*dc*dsc*dp*ic03isc00ip01in* hello_kbd
</pre>
</div>
<p>
(We can also see this string if we run <code class="src src-bash">modinfo hello.ko</code>.)
</p>

<p>
So, what do these aliases represent, and how are they used?
</p>
</div>
</div>
<div id="outline-container-org4aa2c80" class="outline-3">
<h3 id="1b41b15a-5d3b-4eb9-a2f4-a2246de3533d"><span class="section-number-3">5.4</span> Module aliases</h3>
<div class="outline-text-3" id="text-1b41b15a-5d3b-4eb9-a2f4-a2246de3533d">
<p>
As mentioned in my earlier , when a uevent is sent from kernel to
user-space, a string of key&#x2013;value pairs is provided to help identify the
device in question.  What I missed from this is that a specially-formatted
string, called a module alias, is also disclosed (shout-out to the <a href="https://documentation.suse.com/sles/15-SP1/html/SLES-all/cha-udev.html">SLE docs</a>).
The string is a concatenation of vendor ID, product ID, and other
subsystem-specific values.  Every bus has its own scheme for these, as such
device-identifying metadata is bus-specific.  The <a href="https://documentation.suse.com/sles/15-SP1/html/SLES-all/cha-udev.html">SLE docs</a> show an example
alias published to user-space after having plugged in a USB mouse:
</p>
<div class="org-src-container">
<pre class="src src-text">MODALIAS=usb:v046DpC03Ed2000dc00dsc00dp00ic03isc01ip02
</pre>
</div>

<p>
On the user-space side, a module (<code>.ko</code>) file contains information regarding
supported devices in the ELF metadata.  This data is constructed from the
module device table we covered .  This information may then be collated
into a modalias string, as is done when we run <code>modinfo</code>.
</p>

<p>
The rules for constructing a modalias string from the module device table
embedded within the module file are subsystem specific; the particular module
may be determined in user-space just by inspecting the ELF binary and knowing
the subsystem-specific rules to be applied.  This subsystem-specific logic
lives in the scripts exported by the kernel in <code>scripts/mod/</code>, <code>modpost.c</code> and
<code>file2alias.c</code>.
</p>

<p>
(N.B.: A module can contain <i>both</i> a device table <i>and</i> other aliases associated
with it &#x2014; the latter are generated and added in a post-processing step
(without necessarily stripping out the device table).  We may also define and
add modaliases explicitly to our module using the <code>MODULE_ALIAS</code> macro.)
</p>

<p>
When modules are installed, the <code>depmod</code> program is run &#x2014; this will scan all
module files for aliases, and collate them in the <code>modules.alias</code> file.  This
greatly simplifies module loading; all udev needs to do is call
<code class="src src-bash">modprobe $<span class="org-variable-name">MODALIAS</span></code> for every uevent that provides a
<code>MODALIAS</code> key.  If a matching alias entry is found in <code>modules.alias</code>, <code>modprobe</code>
will load the corresponding module.  In fact, the default udev rule that
performs this is dead simple:
</p>
<div class="org-src-container">
<pre class="src src-text">DRIVER!="?*", ENV{MODALIAS}=="?*", RUN{builtin}="kmod load $env{MODALIAS}"
</pre>
</div>
</div>
</div>
<div id="outline-container-org56d029c" class="outline-3">
<h3 id="fa713ee2-069a-4e8d-aba4-3ba57e926021"><span class="section-number-3">5.5</span> Getting the modalias for a USB keyboard</h3>
<div class="outline-text-3" id="text-fa713ee2-069a-4e8d-aba4-3ba57e926021">
<p>
How does one find out the modalias for a device?  In this example, I want to
get the modalias of the virtual USB keyboard that QEMU is providing.
</p>

<p>
The alias of each device can be seen in sysfs.  We&rsquo;ll have to figure out which
directory ours might be in:
</p>
<div class="org-src-container">
<pre class="src src-bash">udevadm info --query=path --name=/dev/input/by-id/usb-QEMU_QEMU_USB_Keyboard_68284-0000<span class="org-string">\:</span>00<span class="org-string">\:</span>01.2-1-event-kbd
<span class="org-comment-delimiter"># </span><span class="org-comment">or alternatively</span>
udevadm info -a /dev/input/by-id/usb-QEMU_QEMU_USB_Keyboard_68284-0000<span class="org-string">\:</span>00<span class="org-string">\:</span>01.2-1-event-kbd
</pre>
</div>
<p>
This returns the following directory:
</p>
<div class="org-src-container">
<pre class="src src-text">/devices/pci0000:00/0000:00:01.2/usb1/1-1/1-1:1.0/0003:0627:0001.0001/input/input6/event5
</pre>
</div>
<p>
There appear to be several modalias files scattered about in the
subdirectories of this directory &#x2014; which one applies?  There are none in the
<code>event5/</code>, but there is one in <code>input6/</code> that reads as follows:
</p>
<div class="org-src-container">
<pre class="src src-text">input:b0003v0627p0001e0111-e0,1,4,11,14,k71,72,73,74,75,77,79,7A,7B,7C,7D,7E,7F,80,81,\
        82,83,84,85,86,87,88,89,8A,8C,8E,96,98,9E,9F,A1,A3,A4,A5,A6,AD,B0,B1,B2,B3,B4,\
        B7,B8,B9,BA,BB,BC,BD,BE,BF,C0,C1,C2,F0,ram4,l0,1,2,3,4,sfw
</pre>
</div>
<p>
Huh?  This looks nothing like the alias that we in the
<code>modules.alias</code> file for our module.  What are we to make of this?
</p>

<p>
It looks as though, when the device is added, not one but <i>multiple</i> uevents are
generated, and thus multiple aliases.  Only one of these aliases is generated
by the USB subsystem.
</p>

<p>
Sure enough, the modalias in the subdirectory <code>1-1:1.0/</code> looks like this:
</p>
<div class="org-src-container">
<pre class="src src-text">usb:v0627p0001d0000dc00dsc00dp00ic03isc01ip01in00
</pre>
</div>
<p>
That&rsquo;s starting to look a bit more like the string from earlier.  In fact, if
we take the asterisks (say that five times fast) to be representing wildcards,
then this leaves only one noticeable incongruity between the two strings: the
integer following <code>isc</code> is <code>01</code> for the device, but <code>00</code> for our module&rsquo;s alias.
What does this <code>isc</code> portion represent?  Let&rsquo;s decode the whole string:
</p>
<dl class="org-dl">
<dt><code>v</code>  </dt><dd>vendor ID</dd>
<dt><code>p</code>  </dt><dd>product ID</dd>
<dt><code>d</code>  </dt><dd>device version number</dd>
<dt><code>dc</code> </dt><dd>device class</dd>
<dt><code>dsc</code></dt><dd>device subclass associated with the device class</dd>
<dt><code>dp</code> </dt><dd>device protocol associated with the device class</dd>
<dt><code>ic</code> </dt><dd>interface class</dd>
<dt><code>isc</code></dt><dd>interface subclass associated with the interface class</dd>
<dt><code>ip</code> </dt><dd>interface protocol associated with the interface class</dd>
<dt><code>in</code> </dt><dd>interface number</dd>
</dl>

<p>
Aha!  So our interface subclass is wrong!  Looking back, we noted that the HID
class doesn&rsquo;t use subclasses, so we just put a zero.  Indubitably an erroneous
assumption! â˜ï¸ðŸ¤“
</p>

<p>
We could fix this by placing a wildcard here, but there&rsquo;s no macro available
for selecting <i>only</i> the class and protocol, so what gives?  I think it&rsquo;s likely
the subclass is <i>supposed</i> to be set to 1.  The official subclass codes are
described as follows:
</p>
<dl class="org-dl">
<dt>0     </dt><dd>No Subclass</dd>
<dt>1     </dt><dd>Boot Interface Subclass (the device &ldquo;supports a boot interface&rdquo;)</dd>
<dt>2&#x2013;255</dt><dd>Reserved</dd>
</dl>
<p>
After snooping around online, I get the sense that a HID device being
&ldquo;bootable&rdquo; is supposed to indicate that it adheres to a minimum basic protocol
such that it will be able to talk with the BIOS at boot.  In any case, I&rsquo;ve
set the interface subclass to 1.  The modalias strings are now a match.
</p>
</div>
</div>
<div id="outline-container-orgf670ca8" class="outline-3">
<h3 id="a3cee954-faab-4205-baf5-a375d73702c2"><span class="section-number-3">5.6</span> Testing</h3>
<div class="outline-text-3" id="text-a3cee954-faab-4205-baf5-a375d73702c2">
<p>
â€‹*â€‹recompilesâ€‹*â€‹
</p>

<p>
â€‹*â€‹reinstallsâ€‹*â€‹
</p>

<p>
â€‹*â€‹re-runs <code>depmod</code>â€‹*â€‹
</p>

<p>
â€‹*â€‹re-triggers insertion of virtual USB keyboardâ€‹*â€‹
</p>

<p>
â€‹*â€‹notices a distinct lack of module-loadingnessâ€‹*â€‹
</p>

<p>
â€‹*â€‹knees buckle in despairâ€‹*â€‹ OTL
</p>

<p>
Ok, perhaps it wasn&rsquo;t quite that dramatic.  I soon figured out that the
<code>udevadm trigger</code> call I devised was not triggering the uevent for the
USB interface, but only the uevents representing its sysfs subdirectories:
</p>
<div class="org-src-container">
<pre class="src src-text">/sys/devices/pci0000:00/0000:00:01.2/usb1/1-1/1-1:1.0/0003:0627:0001.0001/input/input5
/sys/devices/pci0000:00/0000:00:01.2/usb1/1-1/1-1:1.0/0003:0627:0001.0001/input/input5/event4
/sys/devices/platform/i8042/serio0/input/input0
/sys/devices/platform/i8042/serio0/input/input0/event0
</pre>
</div>

<p>
To fix this, I omitted some of the flags from the <code>trigger</code> call, such that it
would trigger devices across the whole USB subsystem (lazy, I know):
</p>
<div class="org-src-container">
<pre class="src src-bash">udevadm trigger --verbose --action=add --subsystem-match=usb
</pre>
</div>

<p>
And it worked!  The module was loaded!  Yeeeahh!  \o/
</p>
</div>
</div>
<div id="outline-container-org3919657" class="outline-3">
<h3 id="288997b5-ba67-4ac3-a0f8-d49028149d59"><span class="section-number-3">5.7</span> Some final notes</h3>
<div class="outline-text-3" id="text-288997b5-ba67-4ac3-a0f8-d49028149d59">
<p>
My solution appears sufficient for fulfilling the task as it was described.
Another solution I found online had additionally registered a <code>struct
usb_driver</code> at module init, complete with <code>probe()</code> and <code>disconnect()</code> callbacks.
(The <code>probe()</code> function is invoked by the USB core when it finds a device
matched to our driver, and this function is our final confirmation that it may
go ahead and register the device to us; vice versa for <code>disconnect()</code>.  We&rsquo;ll
come across this again in .)  Presumably, the USB subsystem would then
bind the device to this driver, provided that the generic USB driver had not
already claimed it; I&rsquo;m not sure what exactly would happen here.  In any case,
this isn&rsquo;t necessary for getting udev to auto-load your module.
</p>

<p>
Something else I learned in the process of completing this task is the way
uevents are triggered in module code.  The way this happens has changed; I
previously thought that adding kobjects would automatically generate a uevent.
Whether or not this was true in the past, it&rsquo;s certainly not true today &#x2014;
one must explicitly announce to the world that a kobject has been
created/registered.  These functions are used to signal this explicitly:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">enum</span> <span class="org-type">kobject_action</span> {
        <span class="org-variable-name">KOBJ_ADD</span>,
        <span class="org-variable-name">KOBJ_REMOVE</span>,
        <span class="org-variable-name">KOBJ_CHANGE</span>,
        <span class="org-variable-name">KOBJ_MOVE</span>,
        <span class="org-variable-name">KOBJ_ONLINE</span>,
        <span class="org-variable-name">KOBJ_OFFLINE</span>,
        <span class="org-variable-name">KOBJ_BIND</span>,
        <span class="org-variable-name">KOBJ_UNBIND</span>,
};
<span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
<span class="org-type">int</span> <span class="org-function-name">kobject_uevent</span>(<span class="org-keyword">struct</span> <span class="org-type">kobject</span> *<span class="org-variable-name">kobj</span>, <span class="org-keyword">enum</span> <span class="org-type">kobject_action</span> <span class="org-variable-name">action</span>);
<span class="org-type">int</span> <span class="org-function-name">kobject_uevent_env</span>(<span class="org-keyword">struct</span> <span class="org-type">kobject</span> *<span class="org-variable-name">kobj</span>, <span class="org-keyword">enum</span> <span class="org-type">kobject_action</span> <span class="org-variable-name">action</span>, <span class="org-type">char</span> *<span class="org-variable-name">envp</span>[]);
</pre>
</div>

<p>
Finally, in addition to devices, there exists one other way for modules to be
loaded: The kernel may request a module on demand (consider that not every
module controls a device).  This is called auto-loading.  I cover this briefly
in the if you are interested in learning more.
</p>
</div>
</div>
</div>
<div id="outline-container-orge9e4ea8" class="outline-2">
<h2 id="task-06"><span class="section-number-2">6</span> Task 06</h2>
<div class="outline-text-2" id="text-task-06">
<blockquote>
<p>
The task this time is this:
</p>
<ul class="org-ul">
<li>Take the kernel module you wrote for task 01, and modify it to be a misc
char device driver.  The misc interface is a very simple way to be able to
create a character device, without having to worry about all of the sysfs
and character device registration mess.  And what a mess it is, so stick to
the simple interfaces wherever possible.</li>
<li>The misc device should be created with a dynamic minor number, no need
running off and trying to reserve a real minor number for your test module,
that would be crazy.</li>
<li>The misc device should implement the read and write functions.</li>
<li>The misc device node should show up in <code>/dev/eudyptula</code>.</li>
<li>When the character device node is read from, your assigned id is returned to
the caller.</li>
<li>When the character device node is written to, the data sent to the kernel
needs to be checked.  If it matches your assigned id, then return a correct
write return value.  If the value does not match your assigned id, return
the &ldquo;invalid value&rdquo; error value.</li>
<li>The misc device should be registered when your module is loaded, and
unregistered when it is unloaded.</li>
<li>Provide some &ldquo;proof&rdquo; this all works properly.</li>
</ul>
</blockquote>

<p>
In summary:
</p>
<ul class="org-ul">
<li>Write a char device driver using the misc driver interface.</li>
<li>Register/de-register the device at module load/unload time, with a dynamic
minor number.</li>
<li>Configure a device file to appear at <code>/dev/eudyptula</code>.</li>
<li>Implement <code>read()</code> to return an ID.  (As I don&rsquo;t have one; I&rsquo;ll just return
&ldquo;eudyptula&rdquo;.)</li>
<li>Implement <code>write()</code> to perform a strcmp against that ID, and return some sort
of &ldquo;invalid value&rdquo; error code if they don&rsquo;t match.</li>
</ul>

<p>
So, what are the fundamental things that a char driver requires?  Broadly:
</p>
<ul class="org-ul">
<li>registration of a major&#x2013;minor number pair at module init, and
de-registration at module exit;</li>
<li>definition of file ops like <code>open()</code>, <code>release()</code>, <code>read()</code>, <code>write()</code>, <code>llseek()</code>,
etc. (which need not be defined exhaustively); and</li>
<li>allocate and register a char device structure (which is usually embedded
within a larger, driver-specific device structure).</li>
</ul>

<p>
My knowledge of driver registration interfaces is mostly limited to what you
can read in .  This text was written in the 2.6.x era, before the
interface () had existed.  After a cursory google, this
seems to be a simplified interface for implementing basic char drivers for
single devices.  Our device also needs to show up as <code>/dev/eudyptula</code>; hopefully
this interface takes care of that for us &#x2014; I&rsquo;d rather not have to write a
udev rule again!
</p>

<p>
But before looking at the misc driver interface, I want to explain what major
and minor numbers are.
</p>
</div>
<div id="outline-container-org740a03e" class="outline-3">
<h3 id="628566a0-dd52-425e-b686-b6e31e2ebdfe"><span class="section-number-3">6.1</span> Device numbers</h3>
<div class="outline-text-3" id="text-628566a0-dd52-425e-b686-b6e31e2ebdfe">
<p>
A device number identifies a registered device.  It has two parts: a <i>major</i>
number and a <i>minor</i> number (often printed <code>&lt;maj&gt;:&lt;min&gt;</code>):
</p>
<ul class="org-ul">
<li>The major number identifies the driver responsible for the device.<sup><a id="fnr.18" class="footref" href="#fn.18">18</a></sup></li>
<li>The minor number indexes the currently registered devices (real or virtual)
under that driver&rsquo;s control.</li>
</ul>

<p>
A list of standard major and minor numbers is given <a href="https://docs.kernel.org/admin-guide/devices.html">here</a>.  This list is more
or less frozen; major numbers are now assigned to drivers dynamically (unlike,
say, syscall numbers).
</p>

<p>
Running <code class="src src-bash">ls -l /dev</code> will list devices with their major
and minor numbers, as well as a character in the far left hand column of the
permissions &#x2014; either <code>c</code>, <code>b</code>, <code>d</code>, or <code>-</code> &#x2014; indicating whether it is,
respectively, a char device, block device, directory, or regular file.
</p>

<p>
With regard to block device drivers, typically the minor numbers will iterate
over not just physical devices but all the partitions as well.  For example,
here is the output of <code class="src src-bash">ls -l /dev/mmcblk*</code>:
</p>
<pre class="example">
brw-rw---- 1 root disk 179, 0   Jan 1 2000 /dev/mmcblk0
brw-rw---- 1 root disk 179, 1   Jan 1 2000 /dev/mmcblk0p1
brw-rw---- 1 root disk 179, 2   Jan 1 2000 /dev/mmcblk0p2
brw-rw---- 1 root disk 179, 8   Jan 1 2000 /dev/mmcblk1
brw-rw---- 1 root disk 179, 16  Jan 1 2000 /dev/mmcblk1boot0
brw-rw---- 1 root disk 179, 24  Jan 1 2000 /dev/mmcblk1boot1
brw-rw---- 1 root disk 179, 9   Jan 1 2000 /dev/mmcblk1p1
brw-rw---- 1 root disk 179, 10  Jan 1 2000 /dev/mmcblk1p2
</pre>
<p>
The major number is 179 (the MMC block driver) and the minor number is listed
in the adjacent column.  In this case, the MMC driver allocates 8 minor
numbers to each MMC device.  The first in each group of 8 maps the full block
device, while the rest are for partitions.<sup><a id="fnr.19" class="footref" href="#fn.19">19</a></sup><sup>, </sup><sup><a id="fnr.20" class="footref" href="#fn.20">20</a></sup>
</p>

<p>
Another example is the SCSI disk driver, or <code>sd</code> (major number 8).  This is used
to control a range of disks that use the SCSI command set, such as SCSI, SATA,
USB mass storage, and UFS.  This includes the familiar <code>sda</code>, <code>sdb</code>, etc. &#x2014; what
you typically see on desktop PCs as referring to the hard disks.
</p>

<p>
We can create these device nodes manually with <code>mknod</code> (though usually we leave
this to to udev or devtmpfs).  We need only indicate the major and minor
number, and whether it is a char or block device.  The major number informs
the kernel as to which driver should take responsibility for this file; the
minor number informs the driver as to which logical device under its purview
is being referenced.
</p>

<p>
Network devices are a special exception to this.  They don&rsquo;t have major/minor
numbers or device nodes.  They are instead referred to by name (one which is
generated internally by the corresponding driver; e.g. <code>eth0</code>, <code>lo</code>, <code>wlan0</code>), and
accessed through the socket API.<sup><a id="fnr.21" class="footref" href="#fn.21">21</a></sup>
</p>

<p>
The task asks that the minor number be assigned dynamically.  Fair enough.
What about the major number?  We would use <code>register_chrdev_region()</code> if we know
the specific major number we&rsquo;ll be using in advance, or <code>alloc_chrdev_region()</code>
if we don&rsquo;t but just want a major number allocated dynamically for us.  But
I&rsquo;ll wait and see what the misc driver interface looks like first before
deciding anything.
</p>

<p>
There does come a downside to having a major number assigned dynamically;
user-space won&rsquo;t know what that number will be ahead of time.  Fortunately,
this doesn&rsquo;t present a <i>major</i> problem (sorry) &#x2014; uevents disclose <code>MAJOR</code> and
<code>MINOR</code> in their environment.  They can also be gleaned from the device&rsquo;s sysfs
subdirectory, in a file called <code>dev</code>.  For example, <code>/sys/class/tty/tty0/dev</code>
returns <code>4:0</code>, meaning it&rsquo;s the first tty device.  (The <code>/proc/devices</code> file also
lists major numbers associated with extant devices.)
</p>
</div>
</div>
<div id="outline-container-org49d1543" class="outline-3">
<h3 id="0ead0429-3ed9-423d-ad8b-d38ab99e0df7"><span class="section-number-3">6.2</span> The misc driver interface</h3>
<div class="outline-text-3" id="text-0ead0429-3ed9-423d-ad8b-d38ab99e0df7">
<p>
(N.B.: This interface has nothing to do with the drivers in <code>drivers/misc/</code>.
That directory contains drivers that don&rsquo;t belong to any specific category.
For example, <code>drivers/misc/hm6352.c</code> is a compass driver that inter-operates via
<a href="https://en.wikipedia.org/wiki/I%C2%B2C">I2C</a>.)
</p>

<p>
A miscellaneous device is (de)registered with:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-type">int</span> <span class="org-function-name">misc_register</span>(<span class="org-keyword">struct</span> <span class="org-type">miscdevice</span> * <span class="org-variable-name">misc</span>);
<span class="org-type">void</span> <span class="org-function-name">misc_deregister</span>(<span class="org-keyword">struct</span> <span class="org-type">miscdevice</span> * <span class="org-variable-name">misc</span>);
</pre>
</div>

<p>
The <code>struct miscdevice</code> we must provide here looks like this:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">struct</span> <span class="org-type">miscdevice</span> {
        <span class="org-type">int</span> <span class="org-variable-name">minor</span>;
        <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>;
        <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">file_operations</span> *<span class="org-variable-name">fops</span>;
        <span class="org-keyword">struct</span> <span class="org-type">list_head</span> <span class="org-variable-name">list</span>;
        <span class="org-keyword">struct</span> <span class="org-type">device</span> *<span class="org-variable-name">parent</span>;
        <span class="org-keyword">struct</span> <span class="org-type">device</span> *<span class="org-variable-name">this_device</span>;
        <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">attribute_group</span> **<span class="org-variable-name">groups</span>;
        <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">nodename</span>;
        <span class="org-type">umode_t</span> <span class="org-variable-name">mode</span>;
};
</pre>
</div>

<p>
Setting <code>minor</code> before calling <code>misc_register()</code> will select a specific minor
number to be registered.  Otherwise, setting this to <code>MISC_DYNAMIC_MINOR</code> will
result in one being assigned dynamically on our behalf (<code>minor</code> will be set to
the new minor number after registration).  We&rsquo;ll also need to set <code>name</code> and
<code>nodename</code> to the appropriate strings.
</p>

<p>
Otherwise, this interace is pretty much plug-and-play.  The only file
operations in the <code>fops</code> structure that we really need to implement are <code>read()</code>
and/or <code>write()</code>.  By default, <code>file-&gt;private_data</code> will have been set to point to
the <code>struct miscdevice</code> associated with the file being read/written.
</p>
</div>
</div>
<div id="outline-container-org8f27a44" class="outline-3">
<h3 id="ddfd869d-eaa0-492d-85fb-e2827a3ec726"><span class="section-number-3">6.3</span> The <code>read()</code> and <code>write()</code> methods</h3>
<div class="outline-text-3" id="text-ddfd869d-eaa0-492d-85fb-e2827a3ec726">
<p>
Here are their prototypes:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-type">ssize_t</span> (*<span class="org-function-name">read</span>) (<span class="org-keyword">struct</span> <span class="org-type">file</span> *, <span class="org-type">char</span> <span class="org-variable-name">__user</span> *, <span class="org-type">size_t</span>, <span class="org-type">loff_t</span> *);
<span class="org-type">ssize_t</span> (*<span class="org-function-name">write</span>) (<span class="org-keyword">struct</span> <span class="org-type">file</span> *, <span class="org-keyword">const</span> <span class="org-type">char</span> <span class="org-variable-name">__user</span> *, <span class="org-type">size_t</span>, <span class="org-type">loff_t</span> *);
</pre>
</div>
<p>
Both implementations should return either:
</p>
<ul class="org-ul">
<li>the amount of data successfully transferred (having incremented the file
offset in the process);</li>
<li>0 upon end-of-file (EOF); xor</li>
<li>a negative error code.</li>
</ul>

<p>
Implementations often need to copy data of some arbitrary length to/from
user-space.  Rather than dereferencing the <code>char __user *</code> parameter<sup><a id="fnr.22" class="footref" href="#fn.22">22</a></sup> directly, we must use the following:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-function-name">copy_to_user</span>(<span class="org-type">void</span> <span class="org-variable-name">__user</span> *to, <span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">from</span>, <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">count</span>);
<span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-function-name">copy_from_user</span>(<span class="org-type">void</span> *<span class="org-variable-name">to</span>, <span class="org-keyword">const</span> <span class="org-type">void</span> <span class="org-variable-name">__user</span> *from, <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">count</span>);
</pre>
</div>
<p>
Accessing user-space memory from kernel-space is inherently unsafe &#x2014; we have
no guarantee as to whether the address corresponds to a valid region of memory
in the user&rsquo;s page table, nor that this region is currently paged in (these
functions will block in such a case).  If an error occurs, these will return
the amount of data left uncopied; 0 indicates success.
</p>

<p>
(Some helpful examples for <code>read()</code> and <code>write()</code> exist <a href="https://github.com/martinezjavier/ldd3/blob/4bb6409297fc97a0bc6872be9cb2ff427c54c810/scull/main.c#L295">here</a> and <a href="https://github.com/martinezjavier/ldd3/blob/4bb6409297fc97a0bc6872be9cb2ff427c54c810/scull/main.c#L339">here</a> which have
been adapted from the examples in <a href="#fb318868-a843-4e6c-8483-db73d832b726">LDD</a> to be compatible with more recent
kernels. &#x2014; Credit: martinezjavier)
</p>

<p>
I&rsquo;ve listed here some obstacles and oddities I encountered in the process of
implementing these functions; minor stuff for which advice was not sought:
</p>
<ul class="org-ul">
<li>The <code>-Wdeclaration-after-statement</code> flag asks for declarations to be made at
the top of the function, <a href="https://en.wikipedia.org/wiki/ANSI_C">ANSI-C-style</a>, so it seems this is another style
requirement we must adhere to.</li>
<li>I tested my <code>read()</code> implementation with <a href="https://en.wikipedia.org/wiki/Cat_(Unix)"><code>cat</code></a> and <a href="https://en.wikipedia.org/wiki/Strace"><code>strace</code></a>.  In doing so I
noticed that my <code>read()</code> method was being invoked twice &#x2014; surely one call
would be sufficient?  It turns out this behaviour is normal.  As stated
above, in order to indicate EOF, the <code>read()</code> call returns 0 (no bytes left to
read).  Therefore every complete read of a file must involve <i>at least</i> 2
reads (unless of course the file is empty to begin with).</li>
<li><p>
A <code>read()</code> implementation is supposed to return an ID, not a string.  Whether
or not we should return a <a href="https://en.wikipedia.org/wiki/Newline">LF</a> at the end is not clear to me.  I don&rsquo;t like
the fact that, should we omit it, <code>cat</code> will mess up the shell in a benign but
nevertheless annoying way:
</p>
<div class="org-src-container">
<pre class="src src-text">debian@debian:/dev$ cat eudyptula
eudyptuladebian@debian:/dev$ 
</pre>
</div></li>
<li>For <code>write()</code>, there were some decisions to make.  I think what would make the
most sense is to perform a string-compare up to the length of the ID.  If
the input is correct up to that point, then return that length as though it
were a partial write (see the <a href="https://man7.org/linux/man-pages/man2/write.2.html#RETURN_VALUE">write(2) manpage</a>).  Otherwise, in the
circumstance where the input is longer than necessary, subsequent writes
will return EOF instead of &ldquo;growing&rdquo; the file.</li>
<li>From a glance of the error codes listed in <code>include/uapi/asm-generic/errno*</code>
and the <a href="https://man7.org/linux/man-pages/man3/errno.3.html">errno(3) manpage</a>, it is difficult to determine exactly when to use
which code.  Often the best instruction comes from looking at what other
code is doing.  (, as Wittgenstein would say.)  From what I
gathered, an error during the copy should return <code>-EFAULT</code>, and an invalid
input should return <code>-EINVAL</code>.  If the user tries to append to the file beyond
the size of our ID, it&rsquo;s unclear whether we&rsquo;re supposed to return <code>-EFBIG</code> or
<code>-ENOSPC</code>, though I suspect that the latter is referring to the device as a
whole, and not the file, in which case the former seems to be the more
appropriate of the two.  If user-space tries to write too much data, this
return code will produce a &ldquo;file too large&rdquo; error message.</li>
<li>When testing <code>write()</code> with <code>echo</code>, we must pass the <code>-n</code> flag to prevent <code>echo</code>
from writing a trailing newline (though I suppose I could just ignore
whitespace).</li>
<li>If the user wants to write beyond the end of the file, I am unsure whether
<code>write()</code> should perform a partial write up to the end and then pass the error
in the next call, or return the error immediately.  The expected behaviour
documented in the <a href="https://man7.org/linux/man-pages/man2/write.2.html#RETURN_VALUE">write(2) manpage</a> suggests the former.</li>
<li>Pay attention when running <code>strace</code> with piped commands; it can become
confusing as to which process each trace output originated from.</li>
<li>I added <code>goto</code> statements as scaffolding for any future need to relinquish
resources before returning (e.g. releasing a lock), but it was not strictly
necessary here.</li>
</ul>

<p>
To test <code>read()</code>:
</p>
<div class="org-src-container">
<pre class="src src-bash">cat /dev/eudyptula
</pre>
</div>
<p>
To test <code>write()</code>:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-builtin">echo</span> -n <span class="org-string">"voidstarfoobar"</span> &gt; <span class="org-string">"/dev/eudyptula"</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">OR</span>
<span class="org-builtin">echo</span> -n <span class="org-string">"voidstarfoobar"</span> | tee <span class="org-string">"/dev/eudyptula"</span> &gt; <span class="org-string">"/dev/null"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">if not running as root</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">OR</span>
<span class="org-builtin">echo</span> -n <span class="org-string">"voidstarfoobar"</span> | strace -e write tee <span class="org-string">"/dev/eudyptula"</span> &gt; <span class="org-string">"/dev/null"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">trace the process</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">OR</span>
strace -ff -e write sh -c <span class="org-string">'echo -n "voidstarfoobar" | tee "/dev/eudyptula" &gt; /dev/null'</span> <span class="org-comment-delimiter"># </span><span class="org-comment">trace the entire process group</span>
</pre>
</div>

<p>
At the end I did a final <code>clang-format</code> to correct the formatting:
</p>
<div class="org-src-container">
<pre class="src src-bash">clang-format -i eudyptula.c
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org034cec0" class="outline-2">
<h2 id="task-07"><span class="section-number-2">7</span> Task 07</h2>
<div class="outline-text-2" id="text-task-07">
<blockquote>
<p>
The tasks this round are:
</p>
<ul class="org-ul">
<li>Download the linux-next kernel for today.  Or tomorrow, just use the latest
one.  It changes every day so there is no specific one you need to pick.
Build it.  Boot it.  Provide proof that you built and booted it.</li>
</ul>

<p>
What is the linux-next kernel?  Ah, that&rsquo;s part of the challenge.
</p>

<p>
For a hint, you should read the excellent documentation about how the Linux
kernel is developed in <code>Documentation/development-process/</code> in the kernel source
itself.  It&rsquo;s a great read, and should tell you all you never wanted to know
about what Linux kernel developers do and how they do it.
</p>
</blockquote>
</div>
<div id="outline-container-orgeb1cb8d" class="outline-3">
<h3 id="51d453ee-3820-493c-9a0b-7a1ef245fa14"><span class="section-number-3">7.1</span> The development process</h3>
<div class="outline-text-3" id="text-51d453ee-3820-493c-9a0b-7a1ef245fa14">
<p>
Here&rsquo;s my best summary of what&rsquo;s in the guide, which may be perused in full
<a href="https://www.kernel.org/doc/html/latest/process/development-process.html">here</a>:
</p>
<dl class="org-dl">
<dt>Benefits of mainlining one&rsquo;s code</dt><dd><ul class="org-ul">
<li>availability</li>
<li>can receive patches if the kernel&rsquo;s internal API changes (though
ultimately someone still needs to be assigned maintainer for each driver)</li>
<li>community code review, meaning fewer bugs, better performance</li>
<li>influence on direction of development</li>
<li>no duplication of effort</li>
</ul></dd>
<dt>License issues</dt><dd><ul class="org-ul">
<li>all contributed code must be GPLv2 or 3-clause BSD license</li>
<li>merged code implicitly retains its original ownership</li>
<li>anonymous contributions are not accepted; each must be signed-off on</li>
<li>patches that risk license integrity are not accepted,
e.g. reverse-engineered code</li>
<li>kernel devs are not lawyers, and can&rsquo;t necessarily provide legal advice</li>
</ul></dd>
<dt>Rolling release cycle</dt><dd><ul class="org-ul">
<li>major kernel releases (as enumerated by the first two version numbers)
come 2&#x2013;3 months apart</li>
<li>each release has a two-week merge-window, managed by Linus, during which
stable code is merged into mainline as <code>-rc1</code> (release candidate 1)</li>
<li>this &ldquo;prepatch&rdquo;, or &ldquo;RC&rdquo;, is iterated upon with fixes until considered
stable enough to release officially</li>
<li>major regressions are showstoppers; minor regressions may be deferred
(fixing <i>all</i> extant regressions is unrealistic)</li>
<li>once released, a mainline kernel is passed off to the &ldquo;stable&rdquo; team,
managed by GKH</li>
<li>significant bug fixes are applied to the current stable kernel (as
enumerated by the third version number) until the next mainline kernel
release arrives (the exception to this being long-term support (LTS)
kernels, for which back-ports for major security patches are guaranteed
for some set number of years; more on this <a href="https://www.kernel.org/category/releases.html">here</a>)</li>
</ul></dd>
<dt>The stages of a patch</dt><dd><ul class="org-ul">
<li>design is ideally done out in the open with community involvement</li>
<li>posted to mailing list(s) for early review and to identify major problems</li>
<li>once close to finished, the patch is submitted to the relevant subsystem
maintainer on the mailing list, which if accepted, will show up in the
maintainer&rsquo;s subsystem tree; such patches are rolled continually into the
<code>-next</code> trees (see below) to ease development, integration, testing</li>
<li>finally, the patch will make its way into mainline during the merge-window
(and/or back-ported into a release candidate, if some urgent fix) where
the next kernel release is given a test-drive</li>
<li>eventually, that becomes a stable release, where it will be exposed to
many users, and yet more problems may arise</li>
<li>then, long-term maintenance; the original patch or driver author may still
need to take responsibility for that code if it is to remain useful
long-term</li>
</ul></dd>
<dt><code>-next</code> trees</dt><dd><ul class="org-ul">
<li>patches work their way up to the mainline tree via a hierarchy of
subsystem trees</li>
<li>the &ldquo;next&rdquo; trees exist in tandem with these, so that devs are able to see
what kinds of patches are being prepared for the next merge-window, for
integration testing purposes, and to anticipate changes and conflicts
before they land in mainline</li>
<li>many next trees exist; see <a href="https://git.kernel.org/">here</a> for a more-or-less comprehensive
list<sup><a id="fnr.23" class="footref" href="#fn.23">23</a></sup></li>
<li>the mainmost next tree is Stephen Rothwell&rsquo;s <code>linux-next</code>, which
conglomerates other subsystem next trees, and represents a snapshot of
what mainline is expected to look like after the next merge-window closes</li>
<li>as a heads up, and to inform developers of potential merge conflicts,
almost all patches merged during a merge-window will have made their way
into <code>linux-next</code> at some point first, via the subsystem-specific next
trees</li>
<li>you can see which trees in particular have been pulled into the most
recent iteration of <code>linux-next</code> (which renews daily) <a href="https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/tree/Next/Trees?id=HEAD">here</a>; typically
developers will reset or rebase their feature-branch onto the newest tag
periodically during development until it&rsquo;s ready for proper submission to
a particular maintainer/subsystem</li>
<li>N.B.: the next trees do <i>not</i> pull in other trees in the manner of a typical
git workflow; the tagged commits, <code>next-20230605</code>, <code>next-20230606</code>, and such,
do not follow a direct lineage, so when you want to rebase your
development branch to the most recent next tag, you must specify where the
root of your feature-branch is</li>
<li>similarly, changes in <code>linux-next</code> are pulled into mainline not
automatically but on a case-by-case basis; patches may be left stewing in
<code>linux-next</code> until deemed ready (or excised entirely)</li>
</ul></dd>
<dt>Staging</dt><dd><ul class="org-ul">
<li>the kernel source tree contains <code>drivers/staging/</code>, where in-development
drivers and filesystems live on their way to being added to the kernel
(this directory is maintained in a separate tree by GKH; <code>staging</code>)</li>
<li>as the name suggests, this directory is available for people to work on as
yet incomplete drivers in public view (we&rsquo;ll encounter this again in )</li>
<li>each subdirectory contains, as well as the source files, a <code>TODO</code> file
listing pending work, and people that need to be CC&rsquo;d if/when patches are
submitted to the driver</li>
<li>changes to these drivers are required to compile properly at the very
least</li>
</ul></dd>
<dt>Tools</dt><dd><ul class="org-ul">
<li>git is obviously the main one here</li>
<li>quilt is another tool, a patch management system, used mainly by subsystem
maintainers, to keep track of bundles of patches, so that they may be more
easily applied, unapplied, modified, combined, etc. (more on this <a href="https://tools.ietf.org/doc/quilt/quilt.html">here</a>);
this is necessary because source packages often need such patch management
for selectively adding features, testing, etc., but doing such management
via the version control system involves needless overhead</li>
</ul></dd>
<dt>Mailing lists</dt><dd><ul class="org-ul">
<li>a master-list of sorts exists <a href="http://vger.kernel.org/vger-lists.html">here</a></li>
<li>the core mailing list is <code>linux-kernel</code> (perusable <a href="https://lkml.org/">here</a>), which is a bit of
a fire-hose (&gt;1k messages per day)</li>
<li>when replying, make sure you retain all CC&rsquo;d recipients and mailing lists</li>
<li>no html; only raw text</li>
<li>no <a href="https://en.wikipedia.org/wiki/Posting_style#Top-posting">top-posting</a>; only <a href="https://en.wikipedia.org/wiki/Posting_style#Bottom-posting">bottom-posting</a> (optionally with <a href="https://en.wikipedia.org/wiki/Posting_style#Interleaved_style">inlined replies</a>)</li>
<li>wrap lines to ~80 chars (manually; we don&rsquo;t want to wrap the body of a
patch, obviously, only the message)</li>
</ul></dd>
<dt>Getting started with kernel development</dt><dd><ul class="org-ul">
<li>you might be tempted to dip your toes in by submitting do-nothing patches
like fixing spelling errors or minor coding style issues</li>
<li>however, the #1 priority for beginners should be to make sure the kernel
runs perfectly at all times on all machines, which usually means working
with others to test and fix issues</li>
<li>look at the current lists of regressions and open bugs; there is never a
shortage of these</li>
<li>download, build, and test the latest -rc and -next kernels</li>
<li>despite this, submitting janitorial patches remains an important way for
new developers to learn the ropes and become accustomed to the standard
email workflow that the kernel development community adheres to</li>
<li>the <code>kernel-janitors</code> mailing list covers minor stuff like code reviews,
fixing up of unmaintained code, API conversion, et al.</li>
</ul></dd>
</dl>
</div>
</div>
<div id="outline-container-org1fdca7d" class="outline-3">
<h3 id="e5245215-1ea9-49ac-afaa-14c42f256953"><span class="section-number-3">7.2</span> Tracking <code>linux-next</code></h3>
<div class="outline-text-3" id="text-e5245215-1ea9-49ac-afaa-14c42f256953">
<p>
On the advice of <a href="https://www.kernel.org/doc/man-pages/linux-next.html">this old manpage</a>, instead of just cloning <a href="https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git">linux-next</a>, we
should instead add it as a remote tracking branch to our copy of <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git">mainline</a>.
</p>

<p>
I&rsquo;m a bit of a git noob; my experience with git up to this point mostly
involved working on a private repo with a single remote &#x2014; &ldquo;origin&rdquo; &#x2014;
pointing to github.
</p>

<p>
So, what are &ldquo;tracking branches&rdquo; and &ldquo;remote tracking branches&rdquo;, strictly
speaking?  From <a href="https://git-scm.com/book/en/v2/Git-Branching-Remote-Branches"><i>Pro Git</i>, 2nd ed. (2014)</a>:
</p>
<blockquote>
<p>
Remote references are references (pointers) in your remote repositories,
including branches, tags, and so on.
</p>

<p>
[&#x2026;]
</p>

<p>
<i>Remote-tracking branches</i> [emphasis mine] are references to the state of remote
branches.  They&rsquo;re local references that you can&rsquo;t move; Git moves them for
you whenever you do any network communication, to make sure they accurately
represent the state of the remote repository.  Think of them as bookmarks, to
remind you where the branches in your remote repositories were the last time
you connected to them.
</p>

<p>
Remote-tracking branch names take the form <code>&lt;remote&gt;/&lt;branch&gt;</code>.  For instance,
if you wanted to see what the <code>master</code> branch on your <code>origin</code> remote looked like
as of the last time you communicated with it, you would check the
<code>origin/master</code> branch.
</p>

<p>
[&#x2026;]
</p>

<p>
Checking out a local branch from a remote-tracking branch automatically
creates what is called a <i>&ldquo;tracking branch&rdquo;</i> [emphasis mine] (and the branch it
tracks is called an &ldquo;upstream branch&rdquo;).  Tracking branches are local branches
that have a direct relationship to a remote branch.  If you&rsquo;re on a tracking
branch and type <code>git pull</code>, Git automatically knows which server to fetch from
and which branch to merge in.
</p>

<p>
When you clone a repository, it generally automatically creates a master
branch that tracks <code>origin/master</code>.  However, you can set up other tracking
branches if you wish &#x2014; ones that track branches on other remotes, or don&rsquo;t
track the master branch.
</p>

<p>
[&#x2026;]
</p>

<p>
While the <code>git fetch</code> command will fetch all the changes on the server that you
don&rsquo;t have yet, it will not modify your working directory at all.  It will
simply get the data for you and let you merge it yourself.  However, there is
a command called <code>git pull</code> which is essentially a <code>git fetch</code> immediately
followed by a <code>git merge</code> in most cases.  If you have a tracking branch set up
as demonstrated in the last section, either by explicitly setting it or by
having it created for you by the <code>clone</code> or <code>checkout</code> commands, <code>git pull</code> will
look up what server and branch your current branch is tracking, fetch from
that server and then try to merge in that remote branch.
</p>
</blockquote>

<p>
So, by default, after having cloned a respository:
</p>
<ul class="org-ul">
<li><code>origin</code> is a remote</li>
<li><code>origin/master</code> is a (read-only) remote tracking branch; and</li>
<li><code>master</code> is a tracking branch that is tracking <code>origin/master</code>.</li>
</ul>

<p>
To fetch a remote means to update our local snapshot of it, downloading any
new binary blobs in the process.  To push, on the other hand, works in the
opposite direction.<sup><a id="fnr.24" class="footref" href="#fn.24">24</a></sup>
</p>

<p>
By creating a remote tracking branch, one obtains a snapshot of the state of
the remote branch, which one may periodically update by fetching.  A local
branch which is &ldquo;tracking&rdquo; that remote branch can then perform a merge by
pulling.<sup><a id="fnr.25" class="footref" href="#fn.25">25</a></sup>
</p>

<p>
Let&rsquo;s add a remote-tracking branch for <code>linux-next</code> to our local tree:
</p>
<div class="org-src-container">
<pre class="src src-bash">git remote add linux-next git://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git
</pre>
</div>

<p>
Now we must fetch it (include the <code>linux-next</code> tags too<sup><a id="fnr.26" class="footref" href="#fn.26">26</a></sup>):
</p>
<div class="org-src-container">
<pre class="src src-bash">git fetch --tags linux-next
</pre>
</div>

<p>
Note that when it&rsquo;s time to update our work against <code>linux-next</code>, never run <code>git
pull</code>!  As I mentioned , this tree doesn&rsquo;t work that way.  Always run <code>git
fetch --tags</code> first, and then rebase to today&rsquo;s tag.  In fact, our
feature-branch doesn&rsquo;t need to be tracking any remote branch at all.
</p>
</div>
</div>
<div id="outline-container-orgb896084" class="outline-3">
<h3 id="9d458971-912d-4195-a90d-3ea26402117e"><span class="section-number-3">7.3</span> Building and booting</h3>
<div class="outline-text-3" id="text-9d458971-912d-4195-a90d-3ea26402117e">
<p>
Let&rsquo;s view the recent tags:
</p>
<div class="org-src-container">
<pre class="src src-bash">git tag -l <span class="org-string">"next-*"</span> | tail
</pre>
</div>

<p>
I&rsquo;ll just checkout the most recent one:
</p>
<div class="org-src-container">
<pre class="src src-bash">git checkout $(git tag -l <span class="org-string">"next-*"</span> | tail -n 1)
</pre>
</div>

<p>
There might be some new config options &#x2014; just select the defaults:
</p>
<div class="org-src-container">
<pre class="src src-bash">make olddefconfig
</pre>
</div>

<p>
Punch it!
</p>
<div class="org-src-container">
<pre class="src src-bash">make -j$(($(nproc) + 1))
</pre>
</div>

<p>
To boot this, we just repeat what we did in .  Once there, we should
double-check what we&rsquo;re running:
</p>
<div class="org-src-container">
<pre class="src src-text">debian@debian:~$ uname -r
5.10.0-rc3-next-20201113
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgee9081a" class="outline-2">
<h2 id="task-08"><span class="section-number-2">8</span> Task 08</h2>
<div class="outline-text-2" id="text-task-08">
<blockquote>
<p>
We will come back to the linux-next kernel in a later exercise, so don&rsquo;t go
and delete that directory, you&rsquo;ll want it around.  But enough of building
kernels, let&rsquo;s write more code!
</p>

<p>
This task is much like the 06 task with the misc device, but this time we are
going to focus on another user/kernel interface, debugfs.  It is rumoured that
the creator of debugfs said that there is only one rule for debugfs use,
&ldquo;There are no rules when using debugfs.&rdquo;  So let&rsquo;s take them up on that offer
and see how to use it.
</p>

<p>
debugfs should be mounted by your distro in <code>/sys/kernel/debug/</code>, if it isn&rsquo;t,
then you can mount it with the line:
        <code>mount -t debugfs none /sys/kernel/debug/</code>
</p>

<p>
Make sure it is enabled in your kernel, with the <code>CONFIG_DEBUG_FS</code> option, you
will need it for this task.
</p>

<p>
The task, in specifics is:
</p>
<ul class="org-ul">
<li>Take the kernel module you wrote for task 01, and modify it to be create a
debugfs subdirectory called &ldquo;eudyptula&rdquo;.  In that directory, create 3
virtual files called &ldquo;id&rdquo;, &ldquo;jiffies&rdquo;, and &ldquo;foo&rdquo;.</li>
<li>The file &ldquo;id&rdquo; operates just like it did for example 06, use the same logic
there, the file must be readable and writable by any user.</li>
<li>The file &ldquo;jiffies&rdquo; is to be read only by any user, and when read, should
return the current value of the jiffies kernel timer.</li>
<li>The file &ldquo;foo&rdquo; needs to be writable only by root, but readable by anyone.
When writing to it, the value must be stored, up to one page of data.  When
read, which can be done by any user, the value must be returned that is
stored in it.  Properly handle the fact that someone could be reading from
the file while someone else is writing to it (oh, a locking hint!)</li>
<li>When the module is unloaded, all of the debugfs files are cleaned up, and
any memory allocated is freed.</li>
<li>Provide some &ldquo;proof&rdquo; this all works.</li>
</ul>
</blockquote>

<p>
In summary, our module should create a debugfs subdirectory &#x2014; called
&ldquo;eudyptula&rdquo; &#x2014; containing:
</p>
<ul class="org-ul">
<li>an &ldquo;id&rdquo; file which behaves like our module from <a href="#task-06">task 06</a>;</li>
<li>a read-only &ldquo;jiffies&rdquo; file which returns the current jiffies value; and</li>
<li>a &ldquo;foo&rdquo; file, to which root may write and store up to one page of data, and
from which any user may read.</li>
</ul>
</div>
<div id="outline-container-orga5a9223" class="outline-3">
<h3 id="378a8d38-264d-4191-ac39-0d6c6a130a4e"><span class="section-number-3">8.1</span> The debugfs interface</h3>
<div class="outline-text-3" id="text-378a8d38-264d-4191-ac39-0d6c6a130a4e">
<p>
Debugfs, which is normally mounted to <code>/sys/kernel/debug/</code>, is a dumping ground
for anything-goes files that don&rsquo;t follow the typical one-value-per-file
heuristic regarding sysfs attributes.<sup><a id="fnr.27" class="footref" href="#fn.27">27</a></sup>
</p>

<p>
This filesystem is already enabled and mounted on my distro (Debian).
Otherwise, it is enabled via <code>CONFIG_DEBUG_FS</code>, and mounted like so:
</p>
<div class="org-src-container">
<pre class="src src-bash">mount -t debugfs none /sys/kernel/debug
</pre>
</div>

<p>
As per <a href="https://www.kernel.org/doc/html/latest/filesystems/debugfs.html">the docs</a>, code that wants to make use of debugfs must include
<code>&lt;linux/debugfs.h&gt;</code>.  Here are the main functions of the interface:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">struct</span> <span class="org-type">dentry</span> *<span class="org-function-name">debugfs_create_dir</span>(<span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>, <span class="org-keyword">struct</span> <span class="org-type">dentry</span> *<span class="org-variable-name">parent</span>);
<span class="org-keyword">struct</span> <span class="org-type">dentry</span> *<span class="org-function-name">debugfs_create_file</span>(<span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>, <span class="org-type">umode_t</span> <span class="org-variable-name">mode</span>,
                                   <span class="org-keyword">struct</span> <span class="org-type">dentry</span> *<span class="org-variable-name">parent</span>, <span class="org-type">void</span> *<span class="org-variable-name">data</span>,
                                   <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">file_operations</span> *<span class="org-variable-name">fops</span>);
<span class="org-keyword">struct</span> <span class="org-type">dentry</span> *<span class="org-function-name">debugfs_create_symlink</span>(<span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>,
                                      <span class="org-keyword">struct</span> <span class="org-type">dentry</span> *<span class="org-variable-name">parent</span>,
                                      <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">target</span>);
<span class="org-type">void</span> <span class="org-function-name">debugfs_remove</span>(<span class="org-keyword">struct</span> <span class="org-type">dentry</span> *<span class="org-variable-name">dentry</span>);
<span class="org-type">void</span> <span class="org-function-name">debugfs_remove_recursive</span>(<span class="org-keyword">struct</span> <span class="org-type">dentry</span> *<span class="org-variable-name">dentry</span>);
</pre>
</div>

<p>
If all our debugfs file does is read from/write to a primitive, we can skip
the need for a file ops struct &#x2014; debugfs files created with the
<code>debugfs_create_*()</code> family of functions support both reads and writes to the
char pointer, depending on the mode bits provided:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-comment-delimiter">/* </span><span class="org-comment">For values read/written in decimal</span><span class="org-comment-delimiter"> */</span>
<span class="org-type">void</span> <span class="org-function-name">debugfs_create_u8</span>(<span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>, <span class="org-type">umode_t</span> <span class="org-variable-name">mode</span>,
                       <span class="org-keyword">struct</span> <span class="org-type">dentry</span> *<span class="org-variable-name">parent</span>, <span class="org-type">u8</span> *<span class="org-variable-name">value</span>);
<span class="org-comment-delimiter">/* </span><span class="org-comment">For values read/written in hex</span><span class="org-comment-delimiter"> */</span>
<span class="org-type">void</span> <span class="org-function-name">debugfs_create_x8</span>(<span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>, <span class="org-type">umode_t</span> <span class="org-variable-name">mode</span>,
                       <span class="org-keyword">struct</span> <span class="org-type">dentry</span> *<span class="org-variable-name">parent</span>, <span class="org-type">u8</span> *<span class="org-variable-name">value</span>);
<span class="org-comment-delimiter">/* </span><span class="org-comment">et al.</span><span class="org-comment-delimiter"> */</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc2a6839" class="outline-3">
<h3 id="318c0505-15a5-484e-97dc-0e77ebe8741a"><span class="section-number-3">8.2</span> Writing the module</h3>
<div class="outline-text-3" id="text-318c0505-15a5-484e-97dc-0e77ebe8741a">
<p>
For the &ldquo;id&rdquo; file, we can just copy the code we used in .  For the
&ldquo;jiffies&rdquo; file, our file ops struct will only need to implement a <code>read()</code>
method, one that just returns the jiffies value.
</p>

<p>
That just leaves us with the &ldquo;foo&rdquo; file.  For this, we&rsquo;ll need to allocate a
page at module load time.  To allocate this page, suggests calling
<code>__get_free_page()</code> with the <code>GFP_KERNEL</code> flag.  I have a couple of questions
though.  Firstly, do I need to zero this memory, or will that be unnecessary
here?  Also, in C, it is convention to prefix symbols with underscores to mark
them &ldquo;private&rdquo; &#x2014; should I be using something other function then?
</p>

<p>
After perusing <a href="https://www.kernel.org/doc/html/latest/core-api/memory-allocation.html">here</a> and in <code>include/linux/gfp.h</code>, I can confidently say <i>yes</i> to
both.  <i>Yes</i>, we should zero the memory just to be safe.  (Even if we don&rsquo;t plan
on letting user-space read this page arbitrarily, we should still zero it just
in case.)  And <i>yes</i>, we should use <code>get_zeroed_page()</code> instead.  (N.B.: This
returns the starting virtual address of the page, whereas <code>__get_free_page()</code>
returns a <code>struct page</code>.<sup><a id="fnr.30" class="footref" href="#fn.30">30</a></sup>)  We can free this page at module exit
with <code>free_page()</code>, to which we pass the original starting virtual address.
</p>

<p>
Another thing we must consider is how to handle concurrent accesses to the
file.  When a write starts, we must ensure that no other reads or writes are
taking place.  We could use one of the kernel&rsquo;s reader-writer locks; this
would be appropriate in cases where writes are rare and reads frequent.  This
might qualify, but I get the sense that this technique should be avoided by
default &#x2014; unless the use case is well-defined.  And this is a debug file
after all, so&#x2026;  I&rsquo;ll just keep things simple and use a vanilla mutex &#x2014;
something like this (documented <a href="https://www.kernel.org/doc/html/latest/locking/mutex-design.html">here</a>):
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-function-name">DEFINE_MUTEX</span>(name);
<span class="org-type">int</span> <span class="org-function-name">mutex_lock_interruptible</span>(<span class="org-keyword">struct</span> <span class="org-type">mutex</span> *<span class="org-variable-name">lock</span>);
<span class="org-type">void</span> <span class="org-function-name">mutex_unlock</span>(<span class="org-keyword">struct</span> <span class="org-type">mutex</span> *<span class="org-variable-name">lock</span>);
</pre>
</div>

<p>
I must also remember to check for a <a href="https://en.wikipedia.org/wiki/Spurious_wakeup">spurious wakeup</a> upon acquiring the lock
(in brief, the lock can be woken prematurely for no particular reason; more on
this later in ).  If one occurred, we start over and ask the user to
retry:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">if</span> (mutex_lock_interruptible(&amp;mut))
    <span class="org-keyword">return</span> -ERESTARTSYS;
</pre>
</div>

<p>
Some miscellanea:
</p>
<ul class="org-ul">
<li>A <code>umode_t</code> must be given to specify the permissions of the created files.
Permission bits are specified in the same format in kernel-space as they are
in user-space, namely, in octal (which a leading zero indicates), where bits
[11:9] correspond to the <a href="https://en.wikipedia.org/wiki/Setuid">SUID, GUID, and sticky bits</a>.</li>
<li>The existing root debugfs directory on both my systems is <code>0700</code>, so users
aren&rsquo;t able to access the files regardless of what permissions I set (see
some discussion about this <a href="https://lwn.net/Articles/429321/">here</a>).  If one wanted to get around this, they
could remount debugfs with <code>-o users</code>.</li>
<li>I wasn&rsquo;t sure whether to return the raw jiffies value or a string
representation.  Ultimately, I did the latter, specifically using <code>snprintf</code>
and in hex format.</li>
<li>I decided to return a different jiffies value per open file, which meant
that I needed to implement the <code>open</code> and <code>release</code> methods, and store the
jiffies value in <code>file-&gt;private_data</code>.  (For the life of me, I cannot remember
why I did this.)</li>
<li>I was a bit unsure of how to respond if <code>copy_to_user</code> or <code>copy_from_user</code>
return non-zero (i.e. less than the full amount was copied) &#x2014; I wasn&rsquo;t
sure whether a partial copy was an error condition for these functions, or
whether it represented a spurious wakeup and therefore user-space should
retry &#x2014; but kernel code elsewhere suggests it might be an error condition,
that I should return <code>-EFAULT</code> unconditionally if anything less than a full
copy takes place.</li>
<li>I forgot to run <code>checkpatch.pl -f</code> on the module from , so I did it
here (after a <code>clang-format -i</code> for good measure.)  It seems to complain about
the &ldquo;id&rdquo; file being world-writable, but since these are non-permanent
debugfs files and I&rsquo;m doing exactly what the exercise asks, I&rsquo;ll ignore
this.</li>
</ul>

<p>
To test the <code>foo</code> file, I used:
</p>
<div class="org-src-container">
<pre class="src src-bash">xxd /sys/kernel/debug/eudyptula/foo | less
</pre>
</div>

<p>
To edit it, I just used a text editor.  (Specifically, I used <a href="https://github.com/troglobit/mg">mg</a>, a minimal
emacs-based editor.  Conveniently, any null characters show up as <code>^@</code>.)
</p>
</div>
</div>
</div>
<div id="outline-container-org28530ee" class="outline-2">
<h2 id="task-09"><span class="section-number-2">9</span> Task 09</h2>
<div class="outline-text-2" id="text-task-09">
<blockquote>
<p>
Nice job with debugfs, that is a handy thing to remember when wanting to print
out some debugging information.  Never use <i>proc</i> that is only for processes,
use debugfs instead.
</p>

<p>
Along with debugfs, sysfs is a common place to put information that needs to
move from the user to the kernel.  So let us focus on sysfs for this task.
</p>

<p>
The task this time:
</p>
<ul class="org-ul">
<li>Take the code you wrote in task 08, and move it to sysfs.  Put the
&ldquo;eudyptula&rdquo; directory under the <code>/sys/kernel/</code> location in sysfs.</li>
<li>Provide some &ldquo;proof&rdquo; this works.</li>
</ul>

<p>
That&rsquo;s it!  Simple, right?  No, you are right, it&rsquo;s more complex, sysfs is
complicated.  I&rsquo;d recommend reading <code>Documentation/kobject.txt</code> as a primer on
how to use kobjects and sysfs.
</p>

<p>
Feel free to ask for hints and help with this one if you have questions by
sending in code to review if you get stuck, many people have dropped out in
the challenge at this point in time, so don&rsquo;t feel bad about asking, we don&rsquo;t
want to see you go away just because sysfs is so damn complicated.
</p>
</blockquote>
</div>
<div id="outline-container-org3322a4a" class="outline-3">
<h3 id="0f44c8ce-e15d-4def-9581-af00df326fdf"><span class="section-number-3">9.1</span> The sysfs interface (user-space)</h3>
<div class="outline-text-3" id="text-0f44c8ce-e15d-4def-9581-af00df326fdf">
<p>
As I already touched on , the structure of <code>/sys/</code> reflects the structure
of the various kobjects &#x2014; each of which is embedded in some kernel data
structure &#x2014; that are linked together.  The sysfs hierarchy thus mirrors the
structure of the kernel subsystems it represents.
</p>

<p>
The end-points/leaves of this tree are called <i>attributes</i> &#x2014; the files we may
read from and write to, which serve as an interface to some kernel data
structure.  (All extant sysfs attributes are documented in
<a href="https://docs.kernel.org/admin-guide/abi-stable.html">Documentation/ABI/stable/</a>.)
</p>

<p>
The fact that there are multiple top-level directories in sysfs (<code>fs/</code>, <code>block/</code>,
<code>module/</code>, etc.) reflects the fact that there are multiple object hierarchies,
many of which may overlap.  This overlapping is why many of the files in sysfs
are symlinks.  For example, <code>class/</code> mostly just contains symbolic links to
other directories in <code>devices/</code>.  If it made sense to call any of these
top-level directories the <i>canonical</i> hierarchy, it would be <code>devices/</code> &#x2014; much
of sysfs is just alternate organisations of this tree.  But the term &ldquo;device&rdquo;
makes sense only loosely.  Sysfs exposes all kinds of data structures, not
just those pertaining to physically distinct devices.  The term &ldquo;device&rdquo;
includes virtual/ephemeral devices, and parts of the platform that are
baked-in.
</p>

<p>
The top-level sysfs directories are:
</p>

<dl class="org-dl">
<dt><code>/sys/block/</code></dt><dd><p>
This contains a flat list of symlinks to <code>/sys/devices/</code>
(described below) corresponding to registered block devices, sans
partitions.
</p>

<p>
This directory mostly exists for historical reasons.  We should use
<code>/sys/dev/block/</code> or <code>/sys/class/block/</code> instead (these are described below).
</p></dd>

<dt><code>/sys/bus/</code></dt><dd>This groups together buses into types (e.g. acpi, pci, scsi,
usb).  Each bus-type contains two subdirectories:

<dl class="org-dl">
<dt><code>/sys/bus/*/devices/</code></dt><dd><p>
This contains a flat list of symlinks to the
entries in the <code>/sys/devices/</code> tree (described below) corresponding to
devices registered on this bus-type.
</p>

<p>
This listing is bus-specific.  For example, <code>/sys/bus/usb/devices/</code>
enumerates the usb hubs, the device ports connected to each hub, and the
interfaces on each port.
</p></dd>

<dt><code>/sys/bus/*/drivers/</code></dt><dd>This contains a directory for every driver that is
registered to handle devices on this bus-type.</dd>
</dl></dd>

<dt><code>/sys/class/</code></dt><dd><p>
Each directory in here represents a device class (e.g. ttys,
network devices, drm devices), containing a flat list of symlinks to places
in <code>/sys/devices/</code> (described below) corresponding to a particular device
registered to that class.
</p>

<p>
Classes organise devices by high-level function &#x2014; how userspace interacts
with the device.  Often, the class of a particular device will be implied by
the subsystem its driver hooks into.
</p>

<p>
Notably, block devices get their own class, but char devices do not &#x2014;
those seem to be scattered about.
</p>

<p>
Some classes of note:
</p>

<dl class="org-dl">
<dt><code>/sys/class/block/</code></dt><dd>This lists block devices by name, but, unlike
<code>/sys/block/</code>, also lists partitions.</dd>

<dt><code>/sys/class/firmware/</code></dt><dd><p>
Some devices need a firmware image uploaded onto
them before the driver can use them (usually because RAM is cheaper than
ROM, and OEMs are cost-cutting machines).  This involves making an
asynchronous request to user-space to supply an appropriate firmware
image.  This directory facilitates such requests.
</p>

<p>
(This is not to be confused with <code>/sys/firmware/</code>, described below.)
</p></dd>

<dt><code>/sys/class/input/</code></dt><dd>This lists input devices.  (Read about the user-space
API for input devices <a href="https://www.kernel.org/doc/html/latest/input/input_uapi.html">here</a>.)  These are normally managed by
libevdev/libinput, and are given a home in <code>/dev/input/</code>.</dd>

<dt><code>/sys/class/mem/</code></dt><dd>This groups together a handful of virtual char devices,
which classically show up as <code>/dev/zero</code>, <code>/dev/random</code>, et al.</dd>

<dt><code>/sys/class/net/</code></dt><dd>This one&rsquo;s fairly self-explanatory.  Network devices
aren&rsquo;t represented in <code>/sys/dev/</code> (described below), but can easily be found
here.</dd>

<dt><code>/sys/class/tty/</code></dt><dd><p>
This contains the terminal device files.  Notably, this
does not include the pseudo-terminal slave devices.  Those are populated
in <a href="https://en.wikipedia.org/wiki/Devpts">devpts</a>, which is normally mounted to <code>/dev/pts/</code>.  There doesn&rsquo;t seem to
be any way to write udev rules against ptys, as far as I can tell:
</p>
<div class="org-src-container">
<pre class="src src-text">debian@debian:~$ ls -al /dev/pts/
crw--w----  1 debian tty  136, 0 Sep  9  2023 0
c---------  1 root   root   5, 2 Aug 29 20:08 ptmx
debian@debian:~$ file /dev/pts/0
/dev/pts/0: character special (136/0)
debian@debian:~$ udevadm info -a /dev/pts/0
Unknown device "/dev/pts/0": No such device
</pre>
</div>
<p>
However, where a given process is using them, <code>/proc/&lt;pid&gt;/fd/</code> will
contains symlinks to them.  To see which ones the terminal emulator itself
is using, for example:
</p>
<div class="org-src-container">
<pre class="src src-text">debian@debian:~$ ls -al /proc/self/fd
lr-x------ 1 debian users 64 Sep  9 12:22 3 -&gt; /proc/474932/fd/
lrwx------ 1 debian users 64 Sep  9 12:22 0 -&gt; /dev/pts/0
lrwx------ 1 debian users 64 Sep  9 12:22 1 -&gt; /dev/pts/0
lrwx------ 1 debian users 64 Sep  9 12:22 2 -&gt; /dev/pts/0
</pre>
</div>
<p>
The console, on the other hand, will be using the real terminal devices,
which <i>are</i> represented in sysfs:
</p>
<div class="org-src-container">
<pre class="src src-text">debian@debian:~$ ls -al /proc/self/fd
lr-x------ 1 debian users 64 Sep  9 12:25 3 -&gt; /proc/475093/fd/
lrwx------ 1 debian users 64 Sep  9 12:25 0 -&gt; /dev/tty2
l-wx------ 1 debian users 64 Sep  9 12:25 1 -&gt; /dev/tty2
lrwx------ 1 debian users 64 Sep  9 12:25 2 -&gt; /dev/tty2
debian@debian:~$ udevadm info --query=path --name=/dev/tty2
/devices/virtual/tty/tty2
</pre>
</div></dd>
</dl></dd>

<dt><code>/sys/dev/</code></dt><dd>This contains a flat list of symlinks to <code>/sys/devices/</code>
(described below) corresponding to registered block and char devices.  The
names of the symlinks correspond to their major&#x2013;minor number pair.</dd>

<dt><code>/sys/devices/</code></dt><dd><p>
The structure of this directory is a picture of the
topology of devices across the whole system (synonymous with a <a href="https://en.wikipedia.org/wiki/Devicetree">device tree</a>).
Each directory represents a <code>struct device</code>; thus it reflects the device
hierarchy as it is represented in memory.
</p>

<p>
This includes non-peripheral hardware that is wed to the platform, such as
cores and clocks, and virtual devices, such as
<code>/sys/devices/virtual/mem/null</code>.
</p>

<p>
The value of <code>DEVPATH</code> &#x2014; as disclosed in a uevent (see ) for a device
&#x2014; corresponds to the path to that device in this tree (the <code>/sys</code> prefix is
omitted).  This represents a kind of unique key for the device at the time
of the uevent.
</p></dd>

<dt><code>/sys/firmware/</code></dt><dd><p>
This directory is for interfacing with platform-specific
firmware, which may include, for example, ACPI and/or EFI.
</p>

<p>
(This is not to be confused with <code>/sys/class/firmware/</code>, described above.)
</p></dd>

<dt><code>/sys/fs/</code></dt><dd>Herein may be exported various parameters for registered
filesystems and filesystem drivers.</dd>

<dt><code>/sys/kernel/</code></dt><dd>This exposes a wealth of run-time information and tunable
parameters for the running kernel.</dd>

<dt><code>/sys/module/</code></dt><dd>All extant modules are listed here, each of which export
module-specific parameters.  This listing includes built-in modules.</dd>

<dt><code>/sys/power/</code></dt><dd>This exposes the power management subsystem.</dd>
</dl>

<p>
Note that the structure of sysfs is less stable than other parts of the kernel
ABI.  Usually we access this stuff indirectly via other low-level user-space
tools and libraries like udev and libevdev &#x2014; projects which are normally
developed in close parallel with the kernel.
</p>

<p>
Sysfs was introduced to take some responsibilities away from the older procfs.
Still, procfs exports a lot of helpful data, much of it being
process-specific.  The files and subdirectories of procfs are described more
comprehensively in the <a href="https://man7.org/linux/man-pages/man5/proc.5.html">proc(5) manpage</a>.  I&rsquo;ve summarised some of its more
notable contents in the <a href="#procfs">appendix</a>.  (Of most similarity to sysfs might be the
<code>/proc/sys/</code> tree, which you can read more about by reading the documentation in
<code>Documentation/admin-guide/sysctl/</code> and the <a href="https://man7.org/linux/man-pages/man8/sysctl.8.html">sysctl(8) manpage</a>.)
</p>
</div>
</div>
<div id="outline-container-orgd4fe000" class="outline-3">
<h3 id="54a76569-1db2-400c-8d39-a32b708b2334"><span class="section-number-3">9.2</span> The sysfs interface (kernel-space)</h3>
<div class="outline-text-3" id="text-54a76569-1db2-400c-8d39-a32b708b2334">
<p>
My understanding of the kobject hierarchy comes primarily from chapter 14 of
<a href="#fb318868-a843-4e6c-8483-db73d832b726">LDD</a>.  The text also suggests reading <code>Documentation/kobject.txt</code> &#x2014; this file
has since moved to <code>Documentation/core-api/kobject.rst</code>, which can be read
online <a href="https://www.kernel.org/doc/html/latest/core-api/kobject.html">here</a>.  This doc is from 2007, but presumably the information is still
relevant.  Additionally, there exists some code samples in <code>samples/kobject/</code>.
These resources should be plenty sufficient for grokking the topic, but I also
provide my own description below, in case one becomes stuck and wants to
around to view things in a different set of words.
</p>

<p>
One could describe <code>struct kobject</code> as a kind of top-level abstract class, one
which all sysfs entities must implement.  To implement this class is to
provide some methods for exposing the functionality of the entity to
user-space by way of simple file operations.  Every sysfs (sub)directory is
associated with a kobject.
</p>

<p>
In keeping with the object-oriented view, the &ldquo;vtable&rdquo; for the methods of a
kobject would be found in the kobject&rsquo;s assigned <i>ktype</i> (<code>struct kob_type</code>).  So
we could perhaps view ktypes as describing subclasses.
</p>

<p>
Sets/collections of related kobjects may be bundled together into <i>ksets</i>
(<code>struct kset</code>).  Furthermore, ksets themselves also contain, and are linked
together by, kobjects.  Every kset lives under exactly one top-level sysfs
directory.  A sysfs directory that contains a bunch of subdirectories
generally means that each of those subdirectories are in the same kset (more
specifically, their associated kobjects will be in the same kset).
</p>

<p>
A directory can be added to sysfs with <code>kobject_add()</code> (requires
<code>&lt;linux/sysfs.h&gt;</code>).  We&rsquo;ll also want to fill that directory with some useful
files for user-space to read and write to.  In kernel-space, these files are
called <i>attributes</i>.  Every new kobject gets some set of default attributes &#x2014;
these are determined by what ktype it is.  Note though that it&rsquo;s still up to
the driver to actually implement the accessor methods for these and any other
attributes &#x2014; <code>show()</code> and <code>store()</code>.
</p>

<p>
Kobjects also contain a reference count on behalf of the object they&rsquo;re
embedded within.  This count is manipulated with <code>kobject_get()</code> and
<code>kobject_put()</code>.  The ref count is initialised to 1 when the kobject is
initialised (with <code>kobject_init()</code>).  When it falls to 0, the kobject and the
structure it is embedded within are freed (using yet another method from the
kobject&rsquo;s ktype).<sup><a id="fnr.31" class="footref" href="#fn.31">31</a></sup>
</p>

<p>
That&rsquo;s pretty much the gist of it.  Likely, the <code>eudyptula/</code> directory in our
solution will be represented by a kobject embedded in some structure, and
we&rsquo;ll need to register this kobject at module init.  The kobject will need
some additional attributes to represent the <code>id</code>, <code>jiffies</code>, and <code>foo</code> files, and a
pair of <code>show()</code> and <code>store()</code> methods to collectively implement them.
</p>
</div>
</div>
<div id="outline-container-orgddfdf64" class="outline-3">
<h3 id="a71711c3-9f80-4153-a4a6-de82bcdcd297"><span class="section-number-3">9.3</span> Writing the module</h3>
<div class="outline-text-3" id="text-a71711c3-9f80-4153-a4a6-de82bcdcd297">
<p>
A super-simplified picture of things:
</p>
<ul class="org-ul">
<li>A kobject is nominally embedded in a device-specific structure.</li>
<li>A kobject is a member of a kset.</li>
<li>A kset defines (non-exhaustively):
<ul class="org-ul">
<li>where its associated sysfs directory lives;</li>
<li>the ktype; and</li>
<li>hotplug ops.</li>
</ul></li>
<li>A ktype defines (non-exhaustively):
<ul class="org-ul">
<li>a set of default attributes;</li>
<li>implementations for <code>show()</code> and <code>store()</code> to operate on them (which will
involve accessing the device-specific structure encompassing the kobject);
and</li>
<li>a <code>release()</code> method, invoked when a kobject&rsquo;s ref count reaches 0.</li>
</ul></li>
</ul>

<p>
When initialising the kobject, we must specify its ktype:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-type">void</span> <span class="org-function-name">kobject_init</span>(<span class="org-keyword">struct</span> <span class="org-type">kobject</span> *<span class="org-variable-name">kobj</span>, <span class="org-keyword">struct</span> <span class="org-type">kobj_type</span> *<span class="org-variable-name">ktype</span>);
</pre>
</div>

<p>
When we add the kobject to the sysfs hierarchy, we must specify its parent
kobject, and the name of the sysfs entry:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-type">int</span> <span class="org-function-name">kobject_add</span>(<span class="org-keyword">struct</span> <span class="org-type">kobject</span> *<span class="org-variable-name">kobj</span>, <span class="org-keyword">struct</span> <span class="org-type">kobject</span> *<span class="org-variable-name">parent</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">fmt</span>, ...);
</pre>
</div>

<p>
For this task, we can leave both <code>parent</code> and <code>kobj-&gt;kset</code> as <code>NULL</code> &#x2014; the kobject
is thus bequeathed to the root of the sysfs tree.
</p>

<p>
Some miscellanea:
</p>
<ul class="org-ul">
<li>The <code>show()</code> and <code>store()</code> operations are provided a char buffer by the kernel,
to which they are to write from or read to.  The buffer is a single page.
If it were ever the case that an entire page was not enough &#x2014; that we
needed to be pass around more than a page worth of data at a time &#x2014; then,
according to <a href="#fb318868-a843-4e6c-8483-db73d832b726">LDD</a>, we should consider splitting it up this one attribute into
several.  Attributes are mostly intended for exposing singular values or
signals to user-space.</li>
<li>While debugging my module init/exit routines, I encountered an error that
seemed to prevent me from later unloading the module; it was supposedly &ldquo;in
use&rdquo; by something, but that &ldquo;something&rdquo; wasn&rsquo;t listed by <code>lsmod</code>.  Most
likely, since my module was crashing, the kernel was just unable to unload
it.  To fix this, I just rebooted.  Rebooting is a tedious impediment to
development though &#x2014; I had to do it many times for various reasons (e.g. I
unloaded the module, but the sysfs directory wasn&rsquo;t removed, and I couldn&rsquo;t
load the module again due to trying to create an existing directory, unless
I were to name it something random each time).  It would be nice if there
were a way to call my exit function in response to a panic.  Perhaps I just
need to <a href="https://en.wiktionary.org/wiki/git_gud">git gud</a>, as they say.</li>
<li>Don&rsquo;t ever run <code>clang-format</code> on file globs willy nilly, unless it&rsquo;s something
like <code>*.{c,h}</code>; it will happily wreak havoc on non-source files.  (Lesson
learned ðŸ™ƒ)</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org4646c53" class="outline-2">
<h2 id="task-10"><span class="section-number-2">10</span> Task 10</h2>
<div class="outline-text-2" id="text-task-10">
<blockquote>
<p>
Yeah, you conquered the sysfs monster, great job!
</p>

<p>
Now you know to never want to mess with a kobject again, right?  Trust me,
there are easier ways to create sysfs files, and we will get into that for a
future task, but for now, let&rsquo;s make it a bit more simple after all of that
coding.
</p>

<p>
For this task, go back to the linux-next tree you used for task 07.  Update
it, and then do the following:
</p>
<ul class="org-ul">
<li>Create a patch that fixes one coding style problem in any of the files in
<code>drivers/staging/</code></li>
<li>Make sure the patch is correct by running it through <code>scripts/checkpatch.pl</code></li>
<li>Submit the code to the maintainer of the driver/subsystem, finding the
proper name and mailing lists to send it to by running the tool,
<code>scripts/get_maintainer.pl</code> on your patch.</li>
<li>Send a web link back to me of your patch on the public mailing list archive
(don&rsquo;t cc: me on the patch, that will only confuse me and everyone in the
kernel development community.)</li>
<li>If you want to mention the Eudyptula Challenge as the reason for writing the
patch, feel free to do so in the body of the patch, but it&rsquo;s not necessary
at all.</li>
</ul>

<p>
Hopefully this patch will be accepted into the kernel tree, and all of a
sudden, you are an &ldquo;official&rdquo; kernel developer!
</p>

<p>
Don&rsquo;t worry, there&rsquo;s plenty more tasks coming, but a little breather every now
and again for something simple is always nice to have.
</p>
</blockquote>

<p>
&ldquo;Don&rsquo;t worry&rdquo; they say!  &ldquo;Have a little breather&rdquo; they say!  To be honest,
this is the part I was dreading; having to wander outside my cave and interact
with the real world, and be subject to its scorn and ridicule for clogging up
the mailing list with a patch that is stupid, facile, or wrong in some minor
technical way, being some unknown person posting off a gmail account.  (Gmail
is somewhat hostile to plaintext email.  Plus, no kernel hacker in their right
mind would use <i>jee-male</i>, riiight?)
</p>

<p>
And upon reflection, not all of this was simple imposter syndrome &#x2014; the <a href="https://lkml.org/">lkml</a>
is genuinely intimidating in its volume and velocity, its curt and frank
feedback, its somewhat archaic platform (at least by today&rsquo;s standards), and
the formalities by which patches must strictly adhere.  Its impenetrability,
some would argue, is by design (for good reason).  (Though the fact that FOSS
communities tend to lean conservative with regard to their tooling ecosystems
(for better or worse) certainly explains at least some of this obstinacy.)
</p>

<p>
As always, all of the information I made use of to complete this task has been
documented below.  The actual patch I submitted I will leave to .
</p>
</div>
<div id="outline-container-org70330e9" class="outline-3">
<h3 id="a027dab5-0f27-47e8-96bd-6545365c4f11"><span class="section-number-3">10.1</span> Email</h3>
<div class="outline-text-3" id="text-a027dab5-0f27-47e8-96bd-6545365c4f11">
<p>
Gmail accounts make up a relatively sizable portion of the addresses in use on
the mailing list.  However, its browser interface is known to cause problems
with tabs vs. spaces, line-wrapping, line-endings, char-encoding, and
content-type.  Plus, sending and receiving patches via the browser interface
would be an unwieldy and impractical cut-and-paste job.  Fortunately, git has
tools to automate this process, namely:
</p>
<dl class="org-dl">
<dt><code>git send-email</code></dt><dd>This generates and sends patch files.  Under the hood, it
generates the patches with <code>git format-patch</code> (which we covered in ).</dd>
<dt><code>git am</code></dt><dd>This creates new commits out of the contents of an email/mailbox
file.  Under the hood, this applies patches to the working tree using <code>git
  apply</code>.</dd>
</dl>

<p>
To get these tools to interoperate with our gmail account or other email
server, we&rsquo;ll need to go into the account settings, as well as make a few
additions to our <code>.gitconfig</code>.
</p>

<p>
The mailing list aren&rsquo;t just for transmitting patches though; it is the domain
for much discussion.  We <i>could</i> use gmail&rsquo;s browser interface for this purpose,
but it&rsquo;s not a pleasant experience.<sup><a id="fnr.32" class="footref" href="#fn.32">32</a></sup>
</p>

<p>
Having outsourced the management of email affairs to this lumbering behemoth
for much of my life, my understanding of email and its infrastructure was not
so stellar.  So before I figured how to set things up, I had to brush up on
some of its concepts.  (More recently I&rsquo;ve found an outstanding and
comprehensive resource on this topic <a href="https://explained-from-first-principles.com/email/">here</a>.)
</p>
</div>
<div id="outline-container-org818521e" class="outline-4">
<h4 id="ece3540d-ebdd-4382-bfb5-7cb3c7591ca7"><span class="section-number-4">10.1.1</span> Concepts</h4>
<div class="outline-text-4" id="text-ece3540d-ebdd-4382-bfb5-7cb3c7591ca7">
</div>
<div id="outline-container-orgdcab8a9" class="outline-5">
<h5 id="bfbf5793-b0db-4708-bf7e-34ff8fcd1424"><span class="section-number-5">10.1.1.1</span> Agents</h5>
<div class="outline-text-5" id="text-bfbf5793-b0db-4708-bf7e-34ff8fcd1424">
<p>
Email agents are the clients and servers that make up the chain of email
infrastructure that an email travels through.
</p>

<p>
The transmission of an email could be pictured, after a fashion, as:
</p>
\begin{gather*}
\text{client} \longrightarrow
\text{server} \longrightarrow
\text{server} \longrightarrow
\text{client}
\end{gather*}

<p>
However, there are multiple agents involved in each step, reflecting the
division of work, e.g. email composition, transmission, storage.
</p>

<p>
This picture (which <a href="https://en.wikipedia.org/wiki/Email_agent_(infrastructure)">this wiki article</a> illustrates well) includes:
</p>
<dl class="org-dl">
<dt>Mail User Agent (MUA)</dt><dd>This refers to the client as a whole &#x2014; the app(s)
responsible for talking to the mail server which hosts the user&rsquo;s email
address.  Outlook (as in the desktop app) and gmail (as in its browser
interface) are examples.  This job may be further divided into separate
responsibilities (potentially handled by separate apps), such as
browsing/managing the local mailbox, composing emails, sending mail to the
MSA (see below), and fetching mail from the MDA (see below).  (The latter
may be called a Mail Retrieval Agent, or MRA.)</dd>
<dt>Mail Submission Agent (MSA)</dt><dd>This is a component of the mail server which
receives mail from an MUA (after authenticating the user), checks the mail
for errors, and passes it on to the MTA (see below) hosted on the same mail
server.  This communication is done over SMTP.  Often, MSAs are bundled with
the MTA.</dd>
<dt>Mail Transfer Agent (MTA)</dt><dd>Also known as a mail relay, this component
receives mail from either the local MSA, or an MTA elsewhere on the web.  It
is responsible for the server-to-server transmission and reception of
emails, which often comes bundled with an MSA as stated.  When the MTA
receives an email, the job of deciding where it should be sent involves
looking up the MX record (see below) associated with the intended
recipient&rsquo;s domain.  It then transfers the mail (via SMTP) to another MTA
(AKA SMTP relaying).  Or, if the recipient&rsquo;s server is this one, it
transfers it to the local MDA (see below).  Often, an MTA may act as the MSA
<i>and</i> MDA.  Examples of MTAs that bundle these responsibilities include
sendmail and qmail.</dd>
<dt>Mail Delivery Agent (MDA)</dt><dd>Also known as the Local Delivery Agent (LDA),
this is another server component.  (We could perhaps think of this as a
post-office?)  Its job is to receive mail from the local MTA, perform any
requisite processing (e.g. filtering, spam detection), and stash it in a
mailbox.  Clients may then fetch the mail from here via POP3/IMAP (see
below).  (Perhaps the fetching part represents the postie?)</dd>
</dl>
</div>
</div>
<div id="outline-container-org0049a2d" class="outline-5">
<h5 id="32d52f3f-88e3-45f9-a363-4c63f7e3b6bc"><span class="section-number-5">10.1.1.2</span> Protocols</h5>
<div class="outline-text-5" id="text-32d52f3f-88e3-45f9-a363-4c63f7e3b6bc">
<p>
SMTP is the protocol used for the &ldquo;sending&rdquo; leg of the journey, namely all of:
</p>
\begin{gather*}
\overset{\text{client}}{\text{MUA}} \longrightarrow
\overset{\text{server}}{(\text{MSA} \longrightarrow \text{MTA})} \longrightarrow
\overset{\text{server}}{(\text{MTA} \longrightarrow \text{MDA})}
\end{gather*}
<p>
For this reason, the SMTP header is often referred to as the email &ldquo;envelope&rdquo;.
Strictly speaking, the Extended SMTP protocol is the variant in use today,
which supports more features like authentication and encryption.  The
well-known port reserved for SMTP is TCP port 25, but clients generally
connect to an MSA through port 587, which requires SMTP authentication (SMTP
AUTH).
</p>

<p>
POP3 and IMAP are protocols used for the final &ldquo;retrieving&rdquo; leg of the
journey, namely:
</p>
\begin{gather*}
\overset{\text{server}}{(\cdots \; \text{MDA})} \longrightarrow
\overset{\text{client}}{\text{MUA/MRA}}
\end{gather*}
<p>
The difference between the two protocols is that of transfer vs. access: POP3
deletes the mail from the server after they have been downloaded, while IMAP
does not.  For a remotely managed email service, like gmail, IMAP is usually
what we want.
</p>
</div>
</div>
<div id="outline-container-org4208acf" class="outline-5">
<h5 id="70c18aa3-235f-4cea-88ac-29be3397ecbd"><span class="section-number-5">10.1.1.3</span> Mail exchanger record</h5>
<div class="outline-text-5" id="text-70c18aa3-235f-4cea-88ac-29be3397ecbd">
<p>
A mail exchanger record (or MX record) is a record in the DNS system that
specifies which server is responsible for accepting emails on a particular
domain.  (Basically it&rsquo;s just a DNS record, but for email addresses
specifically.)  An MX record contains a host name, and references to one or
more address records (IPv4 or IPv6) to which the name is registered.  It must
not point to any CNAME records (those define domain aliases, not addresses).
</p>
</div>
</div>
<div id="outline-container-org1ec922f" class="outline-5">
<h5 id="e0a94050-39f2-473b-8f75-21681fa1590d"><span class="section-number-5">10.1.1.4</span> Maildir/mbox</h5>
<div class="outline-text-5" id="text-e0a94050-39f2-473b-8f75-21681fa1590d">
<p>
These are the two most common storage formats for a mailbox on disk.
</p>

<p>
Mbox stashes all the mail in a single file.  Maildir on the other hand puts
emails into separate files, and uses the filesystem to organise them into a
directory tree using various naming conventions.
</p>

<p>
Maildir tends to be more popular.
</p>
</div>
</div>
<div id="outline-container-org8440348" class="outline-5">
<h5 id="ca8eb5d9-cf1e-4ba7-b0a2-693d10300928"><span class="section-number-5">10.1.1.5</span> <code>MAIL FROM</code> and <code>FROM</code> addresses</h5>
<div class="outline-text-5" id="text-ca8eb5d9-cf1e-4ba7-b0a2-693d10300928">
<p>
The <code>MAIL FROM</code> address (AKA the bounce address, RFC5321.MailFrom, Envelope
sender address, Envelope from address, or Return Path address) resides in the
SMTP &ldquo;envelope&rdquo; header, and specifies where bounce messages should be
delivered to.  (Bounce messages inform if, why, and at which hop, an email
failed to be delivered.)
</p>

<p>
The <code>FROM</code> address (AKA the header From address, or RFC5322.From) is given in
the header of the email proper; the address displayed to the end user in the
MUA.  (The <code>MAIL FROM</code> address is only relevant to transmission.)
</p>
</div>
</div>
</div>
<div id="outline-container-org0a50391" class="outline-4">
<h4 id="c2939824-a819-492b-8b04-1ee6bb2b2748"><span class="section-number-4">10.1.2</span> Workflow</h4>
<div class="outline-text-4" id="text-c2939824-a819-492b-8b04-1ee6bb2b2748">
<p>
Greg Kroah-Hartman wrote a great <a href="http://kroah.com/log/blog/2019/08/14/patch-workflow-with-mutt-2019/">blog post</a> where he goes over his email
workflow.<sup><a id="fnr.33" class="footref" href="#fn.33">33</a></sup>  This provides an interesting picture of his day-to-day work as a kernel
maintainer, so I thought it worthwhile to go over.
</p>

<p>
Since he receives many patches, for different trees, he must spend a fair bit
of time reading them, and sorting them into boxes based on what is to be done
with them.  For many, this will mean reviewing them, part of which involves
applying them to a tree.  Others may simply need to be followed for the sake
of the discussion that branches off of them.
</p>

<p>
Messages that require action he leaves in the inbox, and only removed once
sorted or disposed of.  This may include moving them to a <code>todo</code> mbox (for
patches that must be reviewed, given feedback on, or applied to a tree), and a
<code>stable</code> mbox (for patches destined for the next stable release).  Apart from
the typical tasks a mail client facilitates, he frequently applies filters to
the inbox using different patterns, such that it display messages of only one
particular type at a time.
</p>
<blockquote>
<p>
&ldquo;As an example, I want to read all of the messages sent to the linux-usb
mailing list right now, and not see anything else.  To do that, in mutt, I
press l (limit) which brings up a prompt for a filter to apply to the mbox.
This ability to limit messages to one type of thing is really powerful and I
use it in many different ways within mutt [a popular TUI-based MUA].&rdquo;
</p>
</blockquote>

<p>
When he&rsquo;s ready to review and apply patches, he&rsquo;ll <code>cd</code> into the relevant
development tree (on the branch it is to be applied), launch mutt, filter down
to the messages relating to that tree, and then save them to an mbox file.
He&rsquo;ll then close mutt and re-open it on that new mbox file, and repeat this
process, this time sorting further by driver type, and again by patch set.
</p>

<p>
At this stage, there may be some patches that don&rsquo;t yet need action (e.g. it
needs review by others).  Those patch emails are deferred by moving them back
into the <code>todo</code> list.
</p>

<p>
Where patches have been given some some kind of acknowledgement by others in
one of the replies, he may add a &ldquo;Acked-by:&rdquo; or &ldquo;Reviewed-by:&rdquo; line.  He does
this by editing the raw message from within mutt, then cleans up by deleting
the replies (supposedly this step can be automated with patchwork).
</p>

<p>
Finally, he applies the mbox file with <code>git am</code>, including the <code>-s</code> flag to sign
off on it himself.
</p>

<p>
For patches that must be applied to the stable tree in particular, he uses
<code>quilt</code> (a tool I mentioned earlier in ) in lieu of <code>git am</code>.  The stable
tree is developed as a giant patch series applied on top of the previous
stable release.  The need for <code>quilt</code> arises where changes require an unwieldy
amount of rebasing; often patches will need to be added or dropped from the
middle of this patch series.
</p>

<p>
The process of backporting patches is partially automated with scripting.
Namely, patches in the <code>stable</code> mbox are piped to a special script that
determines which stable tree each patch was based off (a patch to the 4.19
tree means it should be applied only to trees &gt;4.19, for example).  They are
then passed to another script which finds the git commit IDs associated with
the patches as they exist in Linus&rsquo;s tree, and exports them for any
last-minute editing.  After saving the file, the script finally applies the
patches to one or more stable trees.  Additionally, backported patches are
stored in a quilt series that is stored in version control (see: <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/stable-queue.git/">stable-queue</a>,
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable-rc.git/">linux-stable-rc</a>).
</p>

<p>
Outside the email client workflow, newly applied patches are subjected to some
kernel build tests, among other things, before emails are sent out to indicate
whether or not the patch was accepted.
</p>
</div>
</div>
<div id="outline-container-orge2e6f91" class="outline-4">
<h4 id="751648db-fa8d-4d8d-9bd4-aa7d490f7b6d"><span class="section-number-4">10.1.3</span> Setting things up</h4>
<div class="outline-text-4" id="text-751648db-fa8d-4d8d-9bd4-aa7d490f7b6d">
<p>
I decided to use my gmail account as an IMAP server, which I will access via a
local MUA<sup><a id="fnr.34" class="footref" href="#fn.34">34</a></sup>, as well as git for sending patches.
</p>

<p>
The instructions for enabling this for your gmail account are to go into the
settings page, and:
</p>
<ul class="org-ul">
<li>under &ldquo;Forwarding and POP/IMAP&rdquo;, enable IMAP access, and disable
auto-expunge (so that messages will be moved to the trash when I delete them
in the client); and</li>
<li>under &ldquo;Labels&rdquo;, select which labels you want to be exported and accessible
from your client.</li>
</ul>

<p>
We configure the MUA-side of things with the following information:
</p>
<ul class="org-ul">
<li>Incoming Mail (IMAP) Server:
<ul class="org-ul">
<li><code>imap.gmail.com</code></li>
<li>Requires SSL: Yes</li>
<li>Port: 993</li>
</ul></li>
<li>Outgoing Mail (SMTP) Server:
<ul class="org-ul">
<li><code>smtp.gmail.com</code></li>
<li>Requires SSL: Yes</li>
<li>Requires TLS: Yes (if available)</li>
<li>Requires Authentication: Yes</li>
<li>Port for SSL: 465</li>
<li>Port for TLS/STARTTLS: 587</li>
</ul></li>
<li>Full Name or Display Name: <code>&lt;your_actual_name&gt;</code></li>
<li>Account Name, User name, or Email address: <code>&lt;your_actual_gmail_address&gt;</code></li>
<li>Password (if applicable): <code>&lt;your_newly_generated_app_password&gt;</code></li>
</ul>

<p>
If you&rsquo;re using two-factor authentication on your google account (which you
should), and the app supports it (<a href="https://www.thunderbird.net/">thunderbird</a> does; <a href="https://git-scm.com/docs/git-send-email">git-send-email</a> does
not<sup><a id="fnr.35" class="footref" href="#fn.35">35</a></sup>), then authentication will happen
separately, and a password won&rsquo;t be necessary here.  Otherwise, we&rsquo;ll need to
generate an app-specific password in our google account; more about this <a href="https://security.google.com/settings/security/apppasswords">here</a>.
This password is a random jumble of character, and not something one can
easily enter into a command-line prompt.  There is a way to store this
password in your <code>.gitconfig</code> which avoids this, but I&rsquo;m not a fan.  Thankfully
I found a way around this, which I describe below.
</p>
</div>
<div id="outline-container-org5ee0ee8" class="outline-5">
<h5 id="10772f62-bbcb-430a-8dae-e4e3d9902419"><span class="section-number-5">10.1.3.1</span> Configuring git</h5>
<div class="outline-text-5" id="text-10772f62-bbcb-430a-8dae-e4e3d9902419">
<p>
The documentation for the <code>git send-email</code> command can be read <a href="https://git-scm.com/docs/git-send-email">here</a>.  For git
configuration more generally, see <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Configuration">here</a> and <a href="https://git-scm.com/docs/git-config">here</a>.
</p>

<p>
Our <code>.gitconfig</code> needs to include something like this:<sup><a id="fnr.36" class="footref" href="#fn.36">36</a></sup>
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span class="org-type">sendemail</span>]
        <span class="org-variable-name">from</span> = Your Actual Name <a href="mailto:your_actual_gmail_address%40gmail.com">&lt;your_actual_gmail_address@gmail.com&gt;</a>
        <span class="org-variable-name">smtpServer</span> = smtp.gmail.com
        <span class="org-variable-name">smtpUser</span> = your_actual_gmail_address@gmail.com
        <span class="org-variable-name">smtpEncryption</span> = tls
        <span class="org-variable-name">smtpServerPort</span> = 587
</pre>
</div>

<p>
Despite the fact that my machine is single-user with an encrypted root
filesystem, I&rsquo;m not so enthused about storing passwords in plaintext.  One
workaround for this would be to encrypt the file that contains the password,
and manually decrypt it when using the software &#x2014; something like
<code class="src src-bash">git send-email --smtp-pass=$(gpg2 --decrypt your_passkey.gpg) patch_to_send.patch</code>.  But this is not ideal since it will
be visible in <code class="src src-bash">/proc/$<span class="org-variable-name">PID</span>/cmdline</code> for the lifetime of
the process.
</p>

<p>
A better solution: have git fetch the credentials from a <i>credential helper</i>.
The credential helper will in turn prompt us for a password before coughing up
our app-specific password.  Git already supports interoperability with a
credential helper when attempting to connect to a repository, as well as
providing its own credential helpers out of the box &#x2014; you can read all about
this <a href="https://git-scm.com/book/en/v2/Git-Tools-Credential-Storage">here</a>, <a href="https://git-scm.com/docs/gitcredentials">here</a>, and <a href="https://git-scm.com/doc/credential-helpers">here</a>.  In fact, around the time of writing, github was
deprecating basic password authentication in favour of token or SSH-based
access (read <a href="https://github.blog/2020-12-15-token-authentication-requirements-for-git-operations/">here</a>).  So by setting this up, we&rsquo;re solving two problems!
</p>

<p>
Outside the default (prompt for the password every time), the credential
helpers that come out of the box are:
</p>
<ul class="org-ul">
<li><a href="https://git-scm.com/docs/git-credential-cache">cache</a>, which, once entered the first time, will cache the password in memory
(in plain-text) for some configurable length of time; and</li>
<li><a href="https://git-scm.com/docs/git-credential-store">store</a>, which saves the credentials (in plain-text) to a file on disk.</li>
</ul>

<p>
The former means I would have to enter the app password manually; the latter
would mean it&rsquo;s cached on disk.  Neither of these appealed to me, so I opted
for an external credential helper.  What external credential helper you might
decide to use will be OS-specific, and the instructions on how to set it up
may vary.  (If you want to see how I set up mine, check out the .)
</p>
</div>
</div>
<div id="outline-container-orgfeb3078" class="outline-5">
<h5 id="95f2185c-3c3a-4513-b67f-a0daeecd7509"><span class="section-number-5">10.1.3.2</span> Miscellaneous settings</h5>
<div class="outline-text-5" id="text-95f2185c-3c3a-4513-b67f-a0daeecd7509">
<p>
In order to get my mail client (Thunderbird) to play nicely with patches, I
had to edit some settings (adapt these to your circumstances):
</p>
<ul class="org-ul">
<li><i>Edit</i> â†³ <i>Settings</i>:
<ul class="org-ul">
<li>de-select &ldquo;Use paragraph format&rdquo;</li>
</ul></li>
<li><i>Edit</i> â†³ <i>Settings</i> â†³ <i>Config Editor</i>:
<ul class="org-ul">
<li>set <code>mailnews.send_plaintext_flowed</code> to <code>false</code></li>
<li>set <code>mailnews.wraplength</code> from <code>72</code> to <code>0</code></li>
</ul></li>
<li><i>View</i> â†³ <i>Text Encoding</i>:
<ul class="org-ul">
<li>select &ldquo;Unicode&rdquo;</li>
</ul></li>
<li><i>View</i> â†³ <i>Sort by</i>:
<ul class="org-ul">
<li>select &ldquo;Threaded&rdquo;</li>
</ul></li>
<li><i>Edit</i> â†³ <i>Account Settings</i> â†³ <i>Composition &amp; Addressing</i>:
<ul class="org-ul">
<li>de-select &ldquo;Compose messages in HTML format&rdquo;</li>
</ul></li>
<li><i>Edit</i> â†³ <i>Account Settings</i> â†³ <i>Server Settings</i>:
<ul class="org-ul">
<li>use gmail&rsquo;s trash folder as the destination for deleted messages</li>
</ul></li>
</ul>

<p>
Additionally, with regard to mailing lists, you may need to whitelist them
from gmail&rsquo;s spam filter, and create some filters to sort them into dedicated
folders.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd1f3666" class="outline-3">
<h3 id="d235cb47-cd5b-473f-b198-12ab2dc0279d"><span class="section-number-3">10.2</span> Sending patches with <code>git send-email</code></h3>
<div class="outline-text-3" id="text-d235cb47-cd5b-473f-b198-12ab2dc0279d">
<p>
Since, as stated, send-email (documented <a href="https://git-scm.com/docs/git-send-email">here</a>) looks roughly like this:
</p>
<div class="org-src-container">
<pre class="src src-bash">git send-email [git-send-email-specific-options...] &lt;git-format-patch-specific-options...&gt;
<span class="org-comment-delimiter"># </span><span class="org-comment">OR</span>
git send-email [git-send-email-specific-options...] &lt;patch-files...&gt;
</pre>
</div>
<p>
The section for git-format-patch-specific options includes the revisions we
wish to send as a patch set.  (We covered <a href="https://git-scm.com/docs/git-format-patch">format-patch</a> and the <a href="https://git-scm.com/docs/gitrevisions">syntax for
specifying revisions and ranges</a> earlier in .)  But if we already have
at hand the patch files we want to send, we can just provide those instead.
</p>

<p>
Some typical examples:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter"># </span><span class="org-comment">Send the most recent commit in the current branch</span>
git send-email --to=<span class="org-string">"foodev@vendor.com"</span> --cc=<span class="org-string">"mailing@list.com"</span> -1

<span class="org-comment-delimiter"># </span><span class="org-comment">Send a patch set of the last 3, and include a cover letter to which they will be replies</span>
git send-email --cover-letter --thread --to=<span class="org-string">"foodev@vendor.com"</span> --cc=<span class="org-string">"mailing@list.com"</span> -3

<span class="org-comment-delimiter"># </span><span class="org-comment">Send five patches, starting from the given commit hash, and include a cover letter</span>
git send-email -5 e6de6df9 --compose
</pre>
</div>

<p>
Some of the more relevant <a href="https://git-scm.com/docs/git-format-patch">format-patch-specific</a> flags that concern us here:
</p>
<dl class="org-dl">
<dt><code>--subject-prefix=&lt;string&gt;</code></dt><dd>This changes the default &ldquo;PATCH&rdquo; tag prepended
to the subject, which is needed if we&rsquo;re updating a patch that requires
revisions (e.g. &ldquo;PATCH v2&rdquo;), or requesting for comments (e.g. &ldquo;RFC
PATCH&rdquo;).  The <code>--rfc</code> and <code>-v2</code> flags are available as convenient shorthands for
this.</dd>
<dt><code>--cover-letter</code></dt><dd>See <code>--compose</code>, described below.</dd>
<dt><code>--thread</code></dt><dd>This groups all the emails into one email thread.  Ensure
<code>sendemail.chainreplyto</code> is disabled so that all patches are second-level
replies to the top-level cover-letter (what mailing lists generally expect)
rather than forming one long reply chain.</dd>
<dt><code>--signoff</code></dt><dd>This adds a to the email a <code>Signed-Off-By:</code> section in your name.
Arguably, this should not be enabled by default, since signing off on
something should be a conscious, affirmative action, certifying that you
have the rights to submit the work under a compatible open source license.</dd>
</dl>

<p>
Some of the more relevant <a href="https://git-scm.com/docs/git-send-email">send-email-specific</a> flags that concern us here:
</p>
<dl class="org-dl">
<dt><code>--dry-run</code></dt><dd>Do everything but send the email.</dd>
<dt><code>--suppresscc=&lt;option&gt;</code></dt><dd>This lets us prevent certain addresses from being
automatically added to the CC list, which by default will include the
authors of the included patches (possibly ourselves).<sup><a id="fnr.37" class="footref" href="#fn.37">37</a></sup></dd>
<dt><code>--compose</code></dt><dd>The <code>--cover-letter</code> flag of <code>format-patch</code> generates an extra
patch file (named something like <code>0000-cover-letter.patch</code>) to serve as the
top-level email, may be used to provide a short summary of the full
patchset.  It automatically includes other helpful info such as author
names, commit messages, and changed files.  Normally we have to manually
edit the cover letter.  The <code>--compose</code> flag pops up an editor to let us
compose this cover letter on the fly.</dd>
<dt><code>--confirm=&lt;mode&gt;</code></dt><dd>This specifies which operations are to request
confirmation before sending off the email.  Setting this to &ldquo;always&rdquo; or
&ldquo;never&rdquo; are self-explanatory; &ldquo;cc&rdquo; will result in a prompt only in cases
where the <code>send-email</code> command has automatically appended addresses from the
patch to the CC list; &ldquo;compose&rdquo; will prompt before sending the first email
of a <code>--compose</code>; &ldquo;auto&rdquo; is equivalent to &ldquo;cc&rdquo; + &ldquo;compose&rdquo; (this is the
default).</dd>
<dt><code>--annotate</code></dt><dd>This opens the email(s) one final time for inspection and for
possible changes before final submission.  I recommend enabling this by
default in your <code>.gitconfig</code> by setting <code>sendemail.annotate</code> to &ldquo;yes&rdquo;.</dd>
</dl>

<p>
I should also mention the purpose of the &ldquo;scissors separator&rdquo;; the line
containing three hyphens.  Additional patch information and comments can be
inserted between this line and the beginning of the diff &#x2014; these lines will
be ignored when the patch is applied (i.e. their text won&rsquo;t appear in the
commit message).
</p>

<p>
The number at the bottom of the patch denotes the version of git which was
used to generate it.
</p>

<p>
As a final note, I found that I needed to set <code>sendemail.transferencoding</code> to
&ldquo;8bit&rdquo; in my config, because the &ldquo;Content-Transfer-Encoding&rdquo; field in the
email header was otherwise being set to &ldquo;quoted-printable&rdquo;, and this was
messing with line-endings that were causing <code>git am</code> to fail.
</p>
</div>
<div id="outline-container-org70c4c87" class="outline-4">
<h4 id="8648a480-a1d8-4eb3-856f-b1f816f2f18f"><span class="section-number-4">10.2.1</span> Bonus: Sending patches as drafts</h4>
<div class="outline-text-4" id="text-8648a480-a1d8-4eb3-856f-b1f816f2f18f">
<p>
Instead of annotating the final email with <code>git send-email</code>, we may instead use
<code>git imap-send</code> to send the patch to our IMAP server&rsquo;s draft folder, where we
can review and edit it in our MUA before sending it off.  (Make sure you have
configured your MUA first so that it won&rsquo;t wrap the lines or change the
content type.)
</p>

<p>
How I set this up:
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span class="org-type">imap</span>]
        <span class="org-variable-name">host</span> = imaps://imap.gmail.com
        <span class="org-variable-name">user</span> = username@gmail.com
        <span class="org-variable-name">port</span> = 993
        <span class="org-variable-name">sslverify</span> = true
        <span class="org-variable-name">folder</span> = [Gmail]/Drafts
</pre>
</div>

<p>
Caveats:
</p>
<ul class="org-ul">
<li><p>
Its usage is slightly different:
</p>
<div class="org-src-container">
<pre class="src src-bash">git format-patch --stdout | git imap-send
</pre>
</div></li>
<li>It won&rsquo;t be there later to remind us to edit the subject line.</li>
<li>It will set the mail date as the commit date, which is almost certainly not
what we want.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org046e10f" class="outline-3">
<h3 id="f0bcc5fd-ad27-4a24-b877-cc168da7f10d"><span class="section-number-3">10.3</span> Applying patches with <code>git am</code></h3>
<div class="outline-text-3" id="text-f0bcc5fd-ad27-4a24-b877-cc168da7f10d">
<p>
As stated, <code>git am</code> (documented <a href="https://git-scm.com/docs/git-am">here</a>) is the logical inverse of <code>git send-email</code>;
it takes a maildir or mailbox file as input, and creates new commit(s) out of
the patches therein.  The &ldquo;am&rdquo; literally stands for &ldquo;apply mailbox&rdquo;, though it
will also work on patch files.
</p>

<p>
If we want to apply a patch set consisting of multiple patches, we&rsquo;ll need to
save all of the patch-containing messages into a single mbox file or a maildir
(a plain directory).  Some MUAs make this easier than others.<sup><a id="fnr.38" class="footref" href="#fn.38">38</a></sup>
Alternatively, you can fetch them from one of the <a href="https://lore.kernel.org/">mailing list archives</a>.
</p>

<p>
Some relevant flags for this command:
</p>
<dl class="org-dl">
<dt><code>--signoff/-s</code></dt><dd>This will add a <code>Signed-off-by:</code> line in our name to the
commit message.  If we were a maintainer accepting patches from the mailing
list, we would often use this.</dd>
<dt><code>--interactive/-i</code></dt><dd>This will apply the patches interactively.</dd>
</dl>

<p>
Should <code>git am</code> fail due to conflicts, you can retry with <code>--3way</code> to attempt a
standard <a href="https://en.wikipedia.org/wiki/Merge_(version_control)#Three-way_merge">three-way merge</a>.  If <i>this</i> fails, it means we have entered interactive
mode and will need to manually intervene: run <code>git status</code> to identify the
offending file, open it up in your editor to manually resolve the conflict,
<code>git add</code> it back to the index, and run <code>git am --continue</code> to continue the
interactive session.  A few other flags also become relevant here:
</p>
<dl class="org-dl">
<dt><code>--show-current-patch=diff</code></dt><dd>This prints the message associated with the
patch that is holding us up due to a conflict.</dd>
<dt><code>--abort</code></dt><dd>This aborts the patching operation, restoring things to their
prior state.</dd>
<dt><code>--quit</code></dt><dd>This aborts the patching operation, but unlike <code>--abort</code> this will
leave the HEAD and the index as modified up to this point.</dd>
<dt><code>--skip</code></dt><dd>This skips the current patch in the session.  (If the first patch
is a cover letter, you may need to skip it.)</dd>
</dl>
</div>
</div>
<div id="outline-container-org86289d0" class="outline-3">
<h3 id="c8e5030c-1c37-481f-ba8a-0c0fe7678477"><span class="section-number-3">10.4</span> Interacting with the mailing lists</h3>
<div class="outline-text-3" id="text-c8e5030c-1c37-481f-ba8a-0c0fe7678477">
<p>
Which addresses do messages need to be sent/replied to?
</p>
<ul class="org-ul">
<li>Messages should be sent <code>To:</code> the maintainer(s).</li>
<li>They should also be <code>CC:</code>&rsquo;d to at least one mailing list, and any others which
may be relevant (e.g. the stable mailing list may want to know about an
urgent bug fix to be backported).</li>
<li>Other interested parties to add at your own discretion might include
adjacent maintainers, authors of previous changes to the files, the author
of a bug report that the patch addresses, or any other person that may
want/need to lay eyes on the patch.</li>
</ul>

<p>
How are mailing list threads structured?
</p>
<ul class="org-ul">
<li><p>
A patchset is sent as a new email thread, introduced by the first patch (or
cover letter) in that patch series.  Subsequent patches in the series are
flat replies to the first, rather than being nested on top of each other;
normal correspondence should be chained off the specific patch/email in
question.  (Email threads are structured by the message IDs given in each
<code>In-Reply-To:</code> header-field; this field denotes an email&rsquo;s parent.)  For
example:
</p>
<div class="org-src-container">
<pre class="src src-text">[PATCH 0/9] drm: Annotate structs with __counted_by
  &#10551; [PATCH 1/9] drm/amd/pm: Annotate struct smu10_voltage_dependency_table
      &#10551; &lt;reply&gt;
  &#10551; [PATCH 2/9] drm/amdgpu/discovery: Annotate struct ip_hw_instance
      &#10551; &lt;reply&gt;
          &#10551; &lt;reply&gt;
              &#10551; &lt;reply&gt;
          &#10551; &lt;reply&gt;
  &#10551; [PATCH 3/9] drm/i915/selftests: Annotate struct perf_series
      &#10551; &lt;reply&gt;
  &#10551; [PATCH 4/9] drm/msm/dpu: Annotate struct dpu_hw_intr
  &#10551; [PATCH 5/9] drm/nouveau/pm: Annotate struct nvkm_perfdom
  &#10551; [PATCH 6/9] drm/vc4: Annotate struct vc4_perfmon
  &#10551; [PATCH 7/9] drm/virtio: Annotate struct virtio_gpu_object_array
  &#10551; [PATCH 8/9] drm/vmwgfx: Annotate struct vmw_surface_dirty
      &#10551; &lt;reply&gt;
  &#10551; [PATCH 9/9] drm/v3d: Annotate struct v3d_perfmon
</pre>
</div></li>
<li>One should always &ldquo;Reply-all&rdquo; in order to preserve the recipients.</li>
<li>A patch revision (e.g. <code>[PATCH v2 0/9] ...</code>) should go in a new thread, rather
than as a reply to the original thread.</li>
</ul>

<p>
Regarding the behaviour of gmail, (as mentioned <a href="https://www.spinics.net/lists/newbies/msg60023.html">here</a>):
</p>
<ul class="org-ul">
<li>When one sends an email to a mailing list, the direct recipients of that
email may get two copies: one from the sender, and one from the mailing
list.</li>
<li>The MUA should (rightfully) de-duplicate these.</li>
<li>On the other hand, if <i>you&rsquo;re</i> the sender, you would just receive the one copy
(from the mailing list).  However, gmail may suppress this, since it&rsquo;s
identical to the email you sent.</li>
<li>If you don&rsquo;t like this behaviour, you may need to add yourself to the
recipients.  (Mailing lists won&rsquo;t add the sender to the <code>To:</code> or <code>CC:</code> lists;
they just broadcast the email (presumably, all subscribers are part of a
giant <code>BCC:</code> list).  This makes it easy to create filters for discussions that
you have specifically been tagged in.)</li>
</ul>

<p>
Common tags used within the email body include the following (credit <a href="https://www.kernel.org/doc/html/latest/process/5.Posting.html">here</a>):
</p>
<ul class="org-ul">
<li><code>Signed-off-by:</code> gives the developer&rsquo;s word that they have the right to submit
the patch for inclusion in the kernel.  (Code without a proper signoff
cannot be merged into mainline.)</li>
<li><code>Co-developed-by:</code> is for patches that were co-authored.  (This still requires
a <code>Signed-off-by:</code> line in the patch for all parties.)</li>
<li><code>Acked-by:</code> provides an acknowledgement by a non-author (say, the maintainer
of the original code being patched) that the patch is OK.</li>
<li><code>Tested-by:</code> indicates who has tested the patch (implying it passed).</li>
<li><code>Reviewed-by:</code> states who has code-reviewed the patch (implying it&rsquo;s OK).</li>
<li><code>Reported-by:</code> credits the person(s) who reported the issue that this patch
addresses.</li>
<li><code>Cc:</code> lists persons who received a copy of the patch and were given the
opportunity to comment.  In particular, adding <code>Cc: stable@vger.kernel.org</code> to
a patch submitted for mainline inclusion will cause it to be automatically
pulled in by the stable trees (see <a href="https://www.kernel.org/doc/html/latest/process/stable-kernel-rules.html">here</a>).</li>
</ul>

<p>
With the exception of <code>Cc:</code>, permission must first be granted by any persons
named in these tags.
</p>

<p>
A good place to start, I thought, would be to subscribe to the <a href="https://lists.kernelnewbies.org/mailman/listinfo/kernelnewbies">kernelnewbies</a>
and <a href="http://vger.kernel.org/vger-lists.html#kernel-janitors">kernel-janitors</a> lists.  The main <a href="http://vger.kernel.org/lkml/">linux-kernel</a> list seemed far too
voluminous for me to casually peruse (&gt;1000 messages per day!), but
fortunately, one can obtain a far more digestible picture of what is currently
happening in proverbial kernel-space via:
</p>
<ul class="org-ul">
<li><a href="https://lwn.net/Kernel/">LWN.net/Kernel/</a></li>
<li><a href="https://kernelnewbies.org/LinuxChanges">kernelnewbies.org/LinuxChanges</a></li>
<li><a href="https://www.phoronix.com/linux/Linux+Kernel">www.phoronix.com/linux/Linux+Kernel</a></li>
</ul>
</div>
</div>
<div id="outline-container-org9e5ff6d" class="outline-3">
<h3 id="18f371b7-45c3-422d-8021-99d3c0f47f3b"><span class="section-number-3">10.5</span> Developing the patch</h3>
<div class="outline-text-3" id="text-18f371b7-45c3-422d-8021-99d3c0f47f3b">
<p>
Spamming an open-source project with low quality patches is generally frowned
upon.  (Though I suppose that, since this task does not involve the
distribution of free t-shirts to participants, I&rsquo;m not at risk of contributing
to an incident <a href="https://joel.net/how-one-guy-ruined-hacktoberfest2020-drama">like this one</a>.)  Trivial fixes (typos, whitespace, etc.) are
seen as a kind of <a href="https://lkml.org/lkml/2004/12/20/255">necessary annoyance</a> &#x2014; an opportunity for new developers to
cut their teeth.  But even where the patches are well-formed and technically
acceptable, bombarding the mailing list with such changes, especially to the
older, battle-tested parts of the code-base, is generally not worth everyone&rsquo;s
time (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=690b0543a813b0ecfc51b0374c0ce6c8275435f0">this rather adorable patch</a> by a 4 year old niece notwithstanding).
Fortunately, the <a href="https://docs.kernel.org/process/2.Process.html#staging-trees">staging tree</a>, which governs <code>drivers/staging/</code> and is
maintained by GKH (as running <code class="src src-bash">scripts/get_maintainer.pl drivers/staging/</code> would tell you) is an ideal
place to start.
</p>

<p>
In <a href="https://www.youtube.com/watch?v=fMeH7wqOwXA">this talk</a>, GKH goes over some of the common reasons for code being
rejected:
</p>
<ul class="org-ul">
<li>coding style issues</li>
<li>patch failed to build, or produced certain warnings (intermediate patches in
a patch series must also compile and not break stuff)</li>
<li>too big for one patch/patchset (should be split into separate submissions)</li>
<li>bad <a href="https://docs.kernel.org/doc-guide/kernel-doc.html">kernel-doc</a></li>
<li>the patch explains the <i>what</i> but not the <i>why</i></li>
</ul>

<p>
In short, you should try to anticipate any reason for rejecting your patch
prior to submitting it.  &ldquo;Measure twice, cut once.&rdquo;
</p>

<p>
This task asks us to fix a coding style problem somewhere in <code>drivers/staging/</code>.
This is a high-visibility staging area for stand-alone drivers and filesystems
that are on their way to being added to the kernel, but not quite yet up to
snuff.  Each subdirectory usually contains a <code>TODO</code> file which lists pending
work that must be completed before the driver can be officially integrated
into the kernel, as well people that should be CC&rsquo;d when submitting a patch.
If said <code>TODO</code> file doesn&rsquo;t exist, we may want to try scanning the source files
directly with something like <code class="src src-bash">grep <span class="org-string">"TODO"</span> -i -r --include=<span class="org-string">\*</span>.{c,h}</code> to see if anything relevant can be found.
</p>

<p>
I had some confusion as to which <i>tree</i> I should be developing off of.  The text
says use <code>linux-next</code>, but subsystem maintainers usually run their own trees, so
I though perhaps it should be GKH&rsquo;s <code>staging</code> tree (as the <a href="https://www.kernel.org/doc/html/latest/process/maintainers.html">maintainers list</a>
would suggest).  However, <a href="https://lwn.net/Articles/324279/">this old email</a> from GKH clarifies a few things.  In
particular, <code>drivers/staging/</code> exists in the <code>linux</code> tree so that users can
play-test those drivers before they&rsquo;re finished, and that we can base our
patches off of <code>linux-next</code>.  So my assessment is that one should develop off of
<code>linux-next</code>, submit patches to the appropriate maintainers/mailing lists, and
they (GKH in this case) will pull those patches into their tree (<code>staging</code> in
this case).  Eventually, these changes will appear in <code>linux-next</code> (and
hopefully bubble their way up to the Linus&rsquo;s tree).
</p>

<p>
Before going hunting for something to fix, I made sure to fetch and checkout
the latest <code>linux-next</code> tag.  Since this tree is a rapidly moving target, we may
need to do this a few times before generating and submitting our final patch
to ensure our changes aren&rsquo;t obsolete or conflict with recent changes.
</p>
</div>
<div id="outline-container-org39be02c" class="outline-4">
<h4 id="696e1817-149c-4d21-95a5-0662bbfc0589"><span class="section-number-4">10.5.1</span> Bug hunting</h4>
<div class="outline-text-4" id="text-696e1817-149c-4d21-95a5-0662bbfc0589">
<p>
We tested out the <code>checkpatch.pl</code> and <code>clang-format</code> tools .
</p>

<p>
To use clang-format, for example:
</p>
<div class="org-src-container">
<pre class="src src-bash">diff hello.c &lt;(clang-format hello.c)
</pre>
</div>
<p>
There are a lot of arbitrary style considerations not covered by this tool
enforces, so our code does not necessarily need to look <i>exactly</i> the same as
what it emits, so long as we&rsquo;re adhering to the <a href="https://www.kernel.org/doc/html/latest/process/coding-style.html">official coding style rules</a>.
</p>

<p>
But our assignment here was to use <code>checkpatch.pl</code>:
</p>
<div class="org-src-container">
<pre class="src src-bash">scripts/checkpatch.pl foo.patch <span class="org-comment-delimiter"># </span><span class="org-comment">on a patch</span>
scripts/checkpatch.pl -f hello.c <span class="org-comment-delimiter"># </span><span class="org-comment">on a source file</span>
</pre>
</div>
<p>
Code should adhere pretty strictly to the edicts made by this script &#x2014; any
issues it identifies that one intends not to fix need to be justified somehow.
So its warnings and errors are good candidates for fixes.
</p>

<p>
To run this on all the files in <code>drivers/staging/</code>, I ran the following:<sup><a id="fnr.39" class="footref" href="#fn.39">39</a></sup>
</p>
<div class="org-src-container">
<pre class="src src-bash" id="org1cad694">find drivers/staging/ -name <span class="org-string">'*.[ch]'</span> | xargs scripts/checkpatch.pl --terse --summary-file -f 2&gt; /dev/null
</pre>
</div>

<p>
Grepping through the output of this, I found that there were many <code>CHECK</code>â€‹s, some
<code>WARNING</code>â€‹s, and just a few <code>ERROR</code>â€‹s here and there.  These are numerous enough
that, in future, we can restrict ourselves to just looking for <code>ERROR</code>â€‹s.
</p>

<p>
It is worth mentioning that many <code>ERROR</code>â€‹s can be found elsewhere in the older,
more ossified parts of the kernel.  I suppose these are left alone because
such areas of the kernel are already battle-tested, and not worth polluting
the commit history with fixes for.
</p>

<p>
(I mention the actual patch <i>I</i> submitted at .)
</p>
</div>
</div>
<div id="outline-container-orgbb18cf2" class="outline-4">
<h4 id="693d8d1f-7542-4be1-a1cc-0878ac475f20"><span class="section-number-4">10.5.2</span> Bonus: Setting up a git hook</h4>
<div class="outline-text-4" id="text-693d8d1f-7542-4be1-a1cc-0878ac475f20">
<p>
While I think of it, it would be nice to incorporate some of these tools into
our workflow so that they are run automatically during a commit operation &#x2014;
namely, a git hook.
</p>

<p>
Git hooks are simple scripts invoked automatically every time a particular
event occurs in a git repository.  Projects often use them to enforce a
commit-policy or <a href="https://en.wikipedia.org/wiki/Continuous_integration">CI</a> workflow, for example.
</p>

<p>
The hook scripts are installed to <code>.git/hooks/</code> (which as you can see already
contains some examples).  The name of the script file will correspond to the
event that triggers them.  (The example scripts won&rsquo;t work until you truncate
the <code>.sample</code> suffix from the name.)
</p>

<p>
They can be stored locally to run on a local repo, or on the server.
</p>

<p>
When git invokes a hook script, it passes some command-line arguments specific
to the event, as well as some environment variables.
</p>

<p>
The most relevant hooks:
</p>
<ul class="org-ul">
<li>for <code>git am</code>:
<ul class="org-ul">
<li><code>applypatch-msg</code>:
<ul class="org-ul">
<li>lets the user edit the commit message before creating the commit</li>
<li>is passed the name of a file that contains the proposed commit message</li>
<li>if this returns non-zero, the <code>git am</code> operation will be aborted</li>
</ul></li>
<li><code>pre-applypatch</code>:
<ul class="org-ul">
<li>invoked after the patch is applied, but before the changes are committed</li>
<li>if this returns non-zero, the changes will remain staged but
uncommitted</li>
<li>may be used to let the user do a final verification before committing
the changes</li>
</ul></li>
<li><code>post-applypatch</code>:
<ul class="org-ul">
<li>runs after the patch is applied and committed</li>
<li>mainly used for notifying a group or patch author that this patch was
applied</li>
</ul></li>
</ul></li>
<li>for <code>git commit</code>:
<ul class="org-ul">
<li><code>pre-commit</code>:
<ul class="org-ul">
<li>invoked before the user is prompted for the commit message</li>
<li>if this returns non-zero, the commit will be aborted</li>
<li>can be used to inspect the commit itself</li>
</ul></li>
<li><code>prepare-commit-msg</code>:
<ul class="org-ul">
<li>this script has the opportunity to edit the default commit message,
i.e. the pre-filled text presented to the user when the commit message
editor pops up</li>
<li>returning non-zero will abort the commit</li>
<li>the arguments passed to this script:
<ul class="org-ul">
<li>path of a file containing the default commit message</li>
<li>the type of the commit being made
(message/template/merge/squash/commit)</li>
<li>if operating on an existing commit, the commit&rsquo;s hash</li>
</ul></li>
</ul></li>
<li><code>commit-msg</code>:
<ul class="org-ul">
<li>this script has the opportunity to edit the commit message input by the
user</li>
<li>returning non-zero will abort the commit</li>
<li>is passed the path of the file that holds the proposed message</li>
</ul></li>
<li><code>post-commit</code>:
<ul class="org-ul">
<li>invoked after the actual commit is made</li>
<li>might be used, for example, on a git server to automatically notify
relevant parties</li>
</ul></li>
</ul></li>
<li>for <code>git rebase</code>:
<ul class="org-ul">
<li><code>pre-rebase</code>:
<ul class="org-ul">
<li>runs before actual rebasing takes place</li>
<li>can be used to halt the rebase (by returning non-zero) where it might be
a bad idea (e.g. if the commits being rebased have already been pushed
and made public)</li>
<li>the arguments passed to this script:
<ul class="org-ul">
<li>the upstream remote tracking branch from where it was forked</li>
<li>the branch being rebased (if we&rsquo;re rebasing a branch other than the
current one)</li>
</ul></li>
</ul></li>
</ul></li>
<li>for <code>git checkout</code>:
<ul class="org-ul">
<li><code>post-checkout</code>:
<ul class="org-ul">
<li>mainly used to check the environment, and modify/configure it if
necessary</li>
<li>the arguments passed to this script:
<ul class="org-ul">
<li>ref of the previous HEAD</li>
<li>ref of the new HEAD</li>
<li>flag indicating whether you checked out a file (0) or a branch (1)</li>
</ul></li>
<li>this will, by extension, also be invoked after a <code>git clone</code></li>
</ul></li>
</ul></li>
<li>for <code>git merge</code>:
<ul class="org-ul">
<li><code>post-merge</code>:
<ul class="org-ul">
<li>invoked after the merge takes place</li>
<li>can be used to save or restore what git doesn&rsquo;t otherwise handle, such
as file permissions, external files</li>
<li>is passed a flag that indicates whether the merge was a squash</li>
<li>this will, by extension, also be invoked after a <code>git pull</code></li>
</ul></li>
</ul></li>
<li>for <code>git push</code>:
<ul class="org-ul">
<li><code>pre-push</code>:
<ul class="org-ul">
<li>invoked prior to the push taking place</li>
<li>the arguments passed to this script:
<ul class="org-ul">
<li>name of the target remote tracking branch</li>
<li>URL of the target remote tracking branch</li>
</ul></li>
<li>if the user ran <code>push</code> without specifying a named remote, those two
arguments will be the same</li>
<li><p>
a special string is also passed in, via stdin, having the following
format:
</p>
<div class="org-src-container">
<pre class="src src-text">&lt;local_ref&gt; &lt;local_sha1&gt; &lt;remote_ref&gt; &lt;remote_sha1&gt;
</pre>
</div></li>
<li>returning non-zero will abort the push</li>
</ul></li>
</ul></li>
</ul>

<p>
Here&rsquo;s an example of a pre-commit hook we might use.  This will halt a commit
operation if the prospective patch contains any problems as identified by
checkpatch:
</p>
<div class="org-src-container">
<pre class="src src-bash" id="org359c5a6"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/</span><span class="org-keyword">env</span><span class="org-comment"> bash</span>
git show --format=email HEAD | ./scripts/checkpatch.pl --strict --codespell
</pre>
</div>

<p>
As for clang-format&#x2026;
</p>
</div>
</div>
<div id="outline-container-org0d89032" class="outline-4">
<h4 id="ab7ca52b-c336-472f-8eb3-46513861c2f8"><span class="section-number-4">10.5.3</span> Bonus: Integrating clang-format with our tools</h4>
<div class="outline-text-4" id="text-ab7ca52b-c336-472f-8eb3-46513861c2f8">
<p>
This tool is best used a bit more selectively, since it will often steamroll
over any manual alignment of initialisers and arrays we might have performed.
</p>

<p>
Assuming clang-format (and more specifically <code>/usr/bin/git-clang-format</code>) is
installed, you can invoke it via git:
</p>
<div class="org-src-container">
<pre class="src src-bash">git clang-format <span class="org-comment-delimiter"># </span><span class="org-comment">format all currently staged changes in the index</span>
git clang-format HEAD~2 <span class="org-comment-delimiter"># </span><span class="org-comment">format all the work done since two commits ago</span>
git clang-format master <span class="org-comment-delimiter"># </span><span class="org-comment">format all the work done in the current branch since breaking off master</span>
</pre>
</div>

<p>
In emacs:
</p>
<div class="org-src-container">
<pre class="src src-elisp">(load <span class="org-string">"/usr/share/clang/clang-format.el"</span>)
(global-set-key [C-M-tab] 'clang-format-region)
</pre>
</div>

<p>
For other tools, see <a href="https://clang.llvm.org/docs/ClangFormat.html">here</a>.
</p>
</div>
</div>
</div>
<div id="outline-container-org09c6117" class="outline-3">
<h3 id="e09ad9cf-ae87-46fb-9dce-899b38cebe8e"><span class="section-number-3">10.6</span> Building and testing</h3>
<div class="outline-text-3" id="text-e09ad9cf-ae87-46fb-9dce-899b38cebe8e">
<p>
At a minimum, a patch will need to actually build (on one of the default
configs if nothing else) and pass some basic checks before we can submit it.
Some further questions to ask:
</p>
<ul class="org-ul">
<li>What testing methods (whether in-tree or out-of-tree) are available?</li>
<li>What tests should be run at a bare minimum?</li>
</ul>

<p>
A major challenge for testing the kernel is that it interfaces with real
hardware.  Physical devices are difficult to mock.  Countless combinations of
architecture, configuration, and device topology are possible.  Being familiar
with the underlying code can also become a disadvantage &#x2014; a naive end-user
going in blind may have a better chance at triggering unexpected behaviour
than the original authors.
</p>

<p>
For these reasons, a significant proportion of test coverage and kernel
hardening efforts relies on user-space developers and end-users.  The advice
often given to people wanting to help out with testing is to simply use the
latest kernel (especially the RC releases) on their particular hardware as a
daily driver, and report problems as they arise.  (In fact, compiling and
installing a kernel is an effective stress test in itself.)
</p>

<p>
For something a bit more purposive and rigorous, several automated testing
solutions are available.  Since the kernel&rsquo;s job, unlike most other software,
is to provide a complete run-time for running programs, user-space is ideally
positioned for this task, but there exist other fully-fledged frameworks that
can test-build and -boot the kernel on different architectures.
</p>

<p>
(The credit for the bulk of this information should go to Shuah Kahn,
maintainer of the selftest framework, who wrote <a href="https://www.linuxjournal.com/content/linux-kernel-testing-and-debugging">this terrific article</a>.  Some
of this may be out of date at the time of writing.)
</p>
</div>
<div id="outline-container-orgaf75479" class="outline-4">
<h4 id="e91e9b02-d5b6-4120-b040-587ffafd9573"><span class="section-number-4">10.6.1</span> Static analysis</h4>
<div class="outline-text-4" id="text-e91e9b02-d5b6-4120-b040-587ffafd9573">
<p>
Before building, there are a few static analysis tools available we might want
to give a spin, all of which can be invoked through <code>make</code>.  Be aware that
static analysers are not infallible, and can produce false-positives.  Odds
are that the original author deliberately ignored that warning &#x2014; don&rsquo;t just
blindly fix stuff without reading it in context.
</p>

<p>
Running make with <code>C=1</code> will run a static analysis tool, whose path is indicated
by <code>CHECK</code>, on only the files that are (re)compiled (<code>C=2</code> will run it on all
files regardless).  By default, <code>CHECK</code> is set to <a href="https://www.kernel.org/doc/html/latest/dev-tools/sparse.html">sparse</a> (which unfortunately
does not come bundled with the kernel tree; one must install it
separately<sup><a id="fnr.40" class="footref" href="#fn.40">40</a></sup>), a semantic checker for C programs.  However, we can change this to any
tool we like.  To run <a href="http://smatch.sourceforge.net/">smatch</a>, for example:
</p>
<div class="org-src-container">
<pre class="src src-bash">make <span class="org-variable-name">CHECK</span>=<span class="org-string">"~/path/to/smatch/smatch -p=kernel"</span> <span class="org-variable-name">C</span>=1 drivers/staging/
</pre>
</div>

<p>
NOTE: If we want to compile only a particular subdirectory, we just treat that
directory as a make target.  What we <i>do not</i> do is specify that subdirectory
with <code>M</code> variable, as we would do when compiling an external module.  (I wasted
far too much time before I figured this out.  Don&rsquo;t make the same mistake I
did!)  In general, if you are setting the <code>M</code> variable, you should also be
specifying the root of the kernel tree with the <code>-C</code> flag.
</p>

<p>
We&rsquo;ll get to try this out in .
</p>

<p>
Otherwise, there are some make targets of interest here:
</p>
<ul class="org-ul">
<li><code>coccicheck</code>
<ul class="org-ul">
<li>runs the <a href="https://www.kernel.org/doc/html/latest/dev-tools/coccinelle.html">coccinelle</a> tool (again, we must obtain this tool separately; it
is not bundled in with the kernel tree<sup><a id="fnr.41" class="footref" href="#fn.41">41</a></sup>)</li>
<li>has four basic operating modes<sup><a id="fnr.42" class="footref" href="#fn.42">42</a></sup></li>
<li>checks can be run in parallel with <code>J=&lt;threads&gt;</code></li>
</ul></li>
<li><code>checkstack</code>
<ul class="org-ul">
<li>generates a list of stack hogs</li>
<li>for each function listed, the amount of space needed in its stack frame is
given<sup><a id="fnr.43" class="footref" href="#fn.43">43</a></sup></li>
</ul></li>
<li><code>versioncheck</code>
<ul class="org-ul">
<li>finds uses of <code>LINUX_VERSION_CODE</code> or <code>KERNEL_VERSION</code> macros in the code
where <code>&lt;linux/version.h&gt;</code> wasn&rsquo;t included but ought to have been</li>
<li>also finds instances where <code>&lt;linux/version.h&gt;</code> was included unnecessarily</li>
</ul></li>
<li><code>includecheck</code>
<ul class="org-ul">
<li>finds instances of headers being included more than once</li>
<li>this only considers duplicate includes in a given file; it doesn&rsquo;t follow
nested includes, which are also a potential source of duplication<sup><a id="fnr.44" class="footref" href="#fn.44">44</a></sup></li>
</ul></li>
<li><code>export_report</code>
<ul class="org-ul">
<li>lists all exported symbols, their type (e.g. whether it&rsquo;s GPL or not),
and their usage count by other in-tree modules</li>
<li>also lists the other modules and symbols that each module uses</li>
</ul></li>
<li><code>headerdep</code>
<ul class="org-ul">
<li>detects inclusion cycles in headers</li>
<li>there are many such instances in the kernel</li>
</ul></li>
<li><code>clang-analyzer</code> and <code>clang-tidy</code>
<ul class="org-ul">
<li>these run the eponymous clang tools</li>
<li>they are only relevant if we have set <code>CC=clang</code><sup><a id="fnr.45" class="footref" href="#fn.45">45</a></sup></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org9617dd3" class="outline-4">
<h4 id="5d3c4be3-a897-4157-bcbb-193196b0ae48"><span class="section-number-4">10.6.2</span> Kicking the tyres</h4>
<div class="outline-text-4" id="text-5d3c4be3-a897-4157-bcbb-193196b0ae48">
<p>
Beyond just checking that the kernel boots properly, there are a few extra
things we can do in user-space:
</p>
<ul class="org-ul">
<li>Check the kernel log for regressions.
<ul class="org-ul">
<li><p>
For example:
</p>
<div class="org-src-container">
<pre class="src src-bash">dmesg -l err,crit,alert,emerg
<span class="org-comment-delimiter"># </span><span class="org-comment">OR, if you're running systemd</span>
journalctl -k -p 3
</pre>
</div></li>
<li>Look for any new <code>err</code> messages.</li>
<li>New <code>warn</code> messages should be paid attention to, but as the name indicates,
they are just warnings.</li>
</ul></li>
<li>Run the <code>rsync</code> tool to sync a large directory over ssh.</li>
<li>Fire up a web browser.</li>
<li>Play some multimedia.</li>
<li>Connect and test some novel USB devices.</li>
<li>Clone 3&#x2013;4 copies of the kernel tree (e.g. mainline, stable, linux-next) and
compile them all in parallel as a basic stress test.
<ul class="org-ul">
<li>This is a good exercise of various parts of the kernel.</li>
<li>Doing this under the <a href="https://en.wikipedia.org/wiki/Time_(Unix)"><code>time</code></a> command can serve as a helpful basis of
comparison, and can easily be scripted.</li>
</ul></li>
<li>If we&rsquo;re testing a patch that was a bugfix, ensure it actually fixed the
problem.</li>
</ul>
</div>
</div>
<div id="outline-container-org9ced654" class="outline-4">
<h4 id="23793e7f-3916-431f-969f-decf81f15277"><span class="section-number-4">10.6.3</span> In-tree tests</h4>
<div class="outline-text-4" id="text-23793e7f-3916-431f-969f-decf81f15277">
<p>
Adding to the gamut of subsystem-specific test suites out in the wild (from
both the open-source community and from hardware vendors), the kernel tree
provides some of its own.  These can be found in <code>tools/testing/</code> (see also the
output of <code>make tools/help</code>).  This includes:
</p>
<ul class="org-ul">
<li><code>fault-injection/</code>
<ul class="org-ul">
<li>a user-space script which lets you run a command in a special sandbox to
which we can inject and simulate page and slab allocation failures</li>
<li>the script utilises debugfs to simulate and control the frequency of
faults</li>
<li>boot options are also available for creating such faults early during
boot, before debugfs is available</li>
<li>more on this <a href="https://docs.kernel.org/fault-injection/fault-injection.html">here</a></li>
</ul></li>
<li><code>ktest/</code>
<ul class="org-ul">
<li>perl script for building, installing, booting, and testing kernels
remotely, based off a simple config file</li>
<li>requires the host be able to access the target&rsquo;s console, and remotely
power cycle it</li>
<li>several different categories of tests may be performed (e.g. git
bisecting)</li>
<li>can also run cross-compile tests, if the tools are there</li>
</ul></li>
<li><code>kunit/</code>
<ul class="org-ul">
<li>lightweight unit-testing and mocking framework for the kernel, consisting
of a set of macros</li>
<li>these tests are compiled into the kernel, and run at boot or module load
time</li>
<li>test suites output their results to the kernel log in <a href="https://testanything.org/">TAP</a> format, and a
debugfs representation is also provided in
<code>/sys/kernel/debug/kunit/&lt;test_suite&gt;</code></li>
<li>kunit can also utilise a kernel feature called <a href="https://en.wikipedia.org/wiki/User-mode_Linux">User-Mode Linux</a>, a special
pseudo-architecture which makes the kernel runnable from user-space as if
it were a program, so tests can be run locally, avoiding the need to spin
up a VM or boot on separate hardware</li>
<li>kunit tests run fast</li>
<li>more on this <a href="https://kunit.dev/usage/index.html">here</a></li>
</ul></li>
<li><code>nvdimm/</code>
<ul class="org-ul">
<li>unit test infrastructure for libnvdimm, which supports non-volatile RAM
devices</li>
</ul></li>
<li><code>radix-tree/</code>
<ul class="org-ul">
<li>for testing the radix tree implementation</li>
</ul></li>
<li><code>scatterlist/</code>
<ul class="org-ul">
<li>for testing scatterlists, which relate to Linux&rsquo;s <a href="https://en.wikipedia.org/wiki/Direct_memory_access">DMA</a> layer (discussed in
chapter 15 of )</li>
</ul></li>
<li><code>selftests/</code>
<ul class="org-ul">
<li>small tests run from user-space, for various subsystems</li>
<li>these tests may be supported or extended by writing additional helper
kernel modules</li>
<li>tests are written to exercise particular code paths in the kernel</li>
<li>see <code>make help</code> for a list of selftest targets to run</li>
<li>these require some configuration of the kernel to work, but are otherwise
simple to run</li>
<li>further documentation <a href="https://www.kernel.org/doc/html/latest/dev-tools/kselftest.html">here</a> and <a href="https://kselftest.wiki.kernel.org/">here</a></li>
</ul></li>
<li><code>vsock/</code>
<ul class="org-ul">
<li>VM sockets facilitate communication between a virtual machine and its
host; they establish a communication channel between the guest and the
host hypervisor, independent of the network</li>
<li>these tests exercise <code>net/vmw_vsock/</code> sockets between guest&#x2013;host for
VMware, KVM, and Hyper-V</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org6887686" class="outline-4">
<h4 id="18250311-d2c7-48bc-a3e4-650f7a9a3724"><span class="section-number-4">10.6.4</span> Configuration options</h4>
<div class="outline-text-4" id="text-18250311-d2c7-48bc-a3e4-650f7a9a3724">
<p>
Some notable ones:
</p>
<ul class="org-ul">
<li><code>CONFIG_KMEMCHECK</code>
<ul class="org-ul">
<li>NOTE: this was removed as of 2017 (see <a href="https://lore.kernel.org/all/20171007030159.22241-4-alexander.levin@verizon.com/T/">here</a>); use <code>CONFIG_KASAN</code> instead
(see below)</li>
<li>formerly enabled kmemcheck, which looks for and warns about some uses of
uninitialised memory at runtime (a bit like Valgrind, but for
kernel-space)</li>
</ul></li>
<li><code>CONFIG_KMEMLEAK</code>
<ul class="org-ul">
<li>enables kmemleak</li>
<li>similar to kmemcheck, but checks for memory leaks at runtime</li>
<li>works similar to how a garbage collector looks for orphaned memory, but
instead will report them to debugfs</li>
<li>see <code>Documentation/dev-tools/kmemleak.txt</code> for more info</li>
</ul></li>
<li><code>CONFIG_DEBUG_KERNEL</code>
<ul class="org-ul">
<li>meta-option that enables a bunch of other debugging options</li>
</ul></li>
<li><code>CONFIG_DEBUG_SLAB</code>
<ul class="org-ul">
<li>enables several types of checks of kernel memory allocation functions,
e.g. memory overruns, missing initialisations</li>
<li>does this by setting sentinel values in allocated memory, freed memory,
and memory that sits before and after the allocated region</li>
</ul></li>
<li><code>CONFIG_DEBUG_PAGEALLOC</code>
<ul class="org-ul">
<li>normally, after whole pages are freed, they&rsquo;re left in the memory map for
later reuse; this option removes them entirely from the kernel address
space after freeing</li>
<li>this slows the kernel down a bit but can force some memory problems to the
surface</li>
</ul></li>
<li><code>CONFIG_DEBUG_SPINLOCK</code>
<ul class="org-ul">
<li>checks for operations on uninitialised spinlocks, unlocking a lock twice,
et al.</li>
</ul></li>
<li><code>CONFIG_DEBUG_SPINLOCK_SLEEP</code>
<ul class="org-ul">
<li>checks for attempts to sleep while holding a spinlock, or functions that
could <i>potentially</i> sleep (regardless of whether they actually will)</li>
</ul></li>
<li><code>CONFIG_INIT_DEBUG</code>
<ul class="org-ul">
<li>checks for code that attempts to access initialisation-time memory (memory
that is intended to be used only during boot or module load time) after
initialisation-time has passed</li>
<li>this refers specifically to things marked <code>__init</code> or <code>__initdata</code>, which are
discarded after system init/module load time</li>
</ul></li>
<li><code>CONFIG_DEBUG_STACKOVERFLOW</code>
<ul class="org-ul">
<li>stack overflow checks</li>
</ul></li>
<li><code>CONFIG_DEBUG_STACK_USAGE</code>
<ul class="org-ul">
<li>monitors stack usage and makes some statistics available via the SysRq key</li>
<li>note that SysRq itself will require <code>CONFIG_MAGIC_SYSRQ</code></li>
</ul></li>
<li><code>CONFIG_ACPI_DEBUG</code>
<ul class="org-ul">
<li>turns on verbose <a href="https://en.wikipedia.org/wiki/ACPI">ACPI</a> debug messages, where a problem is suspected there</li>
</ul></li>
<li><code>CONFIG_DEBUG_DRIVER</code>
<ul class="org-ul">
<li>turns on debug info in the driver core</li>
</ul></li>
<li><code>CONFIG_SCSI_CONSTANTS</code>
<ul class="org-ul">
<li>turns on verbose SCSI error messages</li>
</ul></li>
<li><code>CONFIG_INPUT_EVBUG</code>
<ul class="org-ul">
<li>turns on verbose logging of input events</li>
<li>be aware of the security implications of this (e.g. it will effectively
log everything you type)</li>
</ul></li>
<li><code>CONFIG_PROFILING</code>
<ul class="org-ul">
<li>for checking performance</li>
</ul></li>
<li><code>CONFIG_KASAN</code>
<ul class="org-ul">
<li>kernel address sanitiser</li>
<li>this inserts compile-time instrumentation for checking every access to
memory</li>
<li>helpful for finding use-after-free and out-of-bounds bugs</li>
<li>only available on x86<sub>64</sub> and arm64</li>
</ul></li>
<li><code>CONFIG_UBSAN</code>
<ul class="org-ul">
<li>runtime undefined behaviour checker</li>
<li>inserts code that performs certain kinds of checks before operations that
may cause undefined behaviour</li>
</ul></li>
<li><code>CONFIG_DEBUG_LOCKDEP</code>
<ul class="org-ul">
<li>performs additional runtime checks regarding lock-dependencies</li>
</ul></li>
<li><code>CONFIG_PROVE_LOCKING</code>
<ul class="org-ul">
<li>allows the kernel to mathematically rule out the possiblity of any locking
during runtime; that no possible situation could cause a deadlock</li>
</ul></li>
<li><code>CONFIG_HARDLOCKUP_DETECTOR</code> and <code>CONFIG_SOFTLOCKUP_DETECTOR</code>
<ul class="org-ul">
<li>enables watchdogs to detect hard and soft lockups (lockups lasting more
than 10 seconds, or more than 20 seconds, respectively)</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orga89745d" class="outline-4">
<h4 id="408921a2-e992-41fe-93ef-1167357ac5d0"><span class="section-number-4">10.6.5</span> Linux Test Project (LTP)</h4>
<div class="outline-text-4" id="text-408921a2-e992-41fe-93ef-1167357ac5d0">
<p>
As per their <a href="https://linux-test-project.github.io/">github page</a>:
</p>
<blockquote>
<p>
The Linux Test Project is a joint project started by SGI, developed and
maintained by IBM, Cisco, Fujitsu, SUSE, Red Hat and others, that has a goal
to deliver test suites to the open source community that validate the
reliability, robustness, and stability of Linux.  The LTP test suite contains a
collection of tools for testing the Linux kernel and related features.
</p>
</blockquote>

<p>
These test scenarios, implemented in C and shell scripts, run in user-space on
the target kernel, and usually take a few hours.  They extend their reach to
many parts of the kernel, can be customised, and are a good (albeit slow) way
to validate new patches.
</p>
</div>
</div>
<div id="outline-container-orga3b0cec" class="outline-4">
<h4 id="776e802a-d218-4a2a-8bda-4d37fd36d915"><span class="section-number-4">10.6.6</span> Fuzzing tools</h4>
<div class="outline-text-4" id="text-776e802a-d218-4a2a-8bda-4d37fd36d915">
<p>
<a href="https://en.wikipedia.org/wiki/Fuzzing">Fuzzing</a> tools generate and pass random inputs to an interface in order to
provoke unexpected behaviour such as crashes, memory leaks; in general to
probe for improper handling of bad input.  There are two main fuzzing tools
available:
</p>
<ul class="org-ul">
<li><a href="https://github.com/kernelslacker/trinity">Trinity</a>
<ul class="org-ul">
<li>system call fuzzer</li>
</ul></li>
<li><a href="https://github.com/google/syzkaller">Syzkaller</a>
<ul class="org-ul">
<li>kernel fuzzer developed by google</li>
<li>spawns VMs to perform fuzzing</li>
<li>can target Linux as well as other operating systems</li>
<li><a href="https://syzkaller.appspot.com/upstream">Syzbot</a> is an automated tool that continually runs Syzkaller on a handful
of trees</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org198d306" class="outline-4">
<h4 id="24cc419b-7028-40eb-bc94-369977fd5976"><span class="section-number-4">10.6.7</span> CI services</h4>
<div class="outline-text-4" id="text-24cc419b-7028-40eb-bc94-369977fd5976">
<ul class="org-ul">
<li><a href="https://scan.coverity.com/">Coverity scan</a>
<ul class="org-ul">
<li>a free cloud-based service for monitoring various open-source code bases
with <a href="https://en.wikipedia.org/wiki/Coverity">coverity</a>, a static analysis tool for various languages</li>
<li>results and statistics for the Linux kernel specifically can be seen <a href="https://scan.coverity.com/projects/linux">here</a></li>
</ul></li>
<li><a href="https://kernelci.org/">KernelCI</a>
<ul class="org-ul">
<li>a community-based, distributed test automation system, supported by the
<a href="https://en.wikipedia.org/wiki/Linux_Foundation">Linux Foundation</a></li>
<li>has a particular focus on validating the upstream kernel</li>
<li>builds and boots kernels on several development trees on a variety of
targets, to ensure problems are caught before reaching mainline</li>
<li>the latest results for various trees/branches can be seen <a href="https://kernelci.org/">here</a></li>
<li>this project uses the <a href="https://lavasoftware.org/">LAVA framework</a> to help with automated installation
and execution of tests</li>
</ul></li>
<li><a href="https://lkft.linaro.org/">Linaro LKFT</a> (Linux Kernel Functional Testing)
<ul class="org-ul">
<li>a CI tool and test framework for performing and reporting functional
regression tests on several kernel development trees, similar to KernelCI</li>
<li>builds are performed with the <a href="https://en.wikipedia.org/wiki/OpenEmbedded">OpenEmbedded</a> framework</li>
<li>automated tests are performed on ARM and x86 platforms (32-bit and 64-bit)</li>
<li>helps encourage downstream hardware vendors to more frequently update the
kernel running on their device(s)</li>
<li>uses the <a href="https://lavasoftware.org/">LAVA</a> framework (Linaro Automated Validation Architecture)</li>
</ul></li>
<li><a href="https://kerneltests.org/">Kerneltests</a>
<ul class="org-ul">
<li>a kernel test bot that runs build tests and some boot tests for different
QEMU targets</li>
<li>uses the <a href="https://buildbot.net/">Buildbot</a> CI framework</li>
</ul></li>
<li><a href="https://01.org/lkp/documentation/0-day-test-service">0-Day Test Service</a>
<ul class="org-ul">
<li>a test infrastructure and service maintained by Intel, with a focus on
testing the x86 architecture</li>
<li>monitors various development and production trees, alerting developers by
email about unexpected regressions</li>
<li>performs build, boot, functional, and performance testing, covering a wide
number of kernel subsystems and components</li>
</ul></li>
<li><a href="https://syzkaller.appspot.com/upstream">Syzbot</a>
<ul class="org-ul">
<li>see</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org45c876e" class="outline-4">
<h4 id="ddd09c11-fd01-4937-8316-9d2346105c32"><span class="section-number-4">10.6.8</span> Other test frameworks</h4>
<div class="outline-text-4" id="text-ddd09c11-fd01-4937-8316-9d2346105c32">
<ul class="org-ul">
<li>XFSTests
<ul class="org-ul">
<li>targets filesystems</li>
</ul></li>
<li>MMTests
<ul class="org-ul">
<li>targets the scheduler and memory management subsystem</li>
</ul></li>
<li>Hackbench
<ul class="org-ul">
<li>targets the scheduler</li>
</ul></li>
<li>Fuego Test System
<ul class="org-ul">
<li>designed for testing embedded Linux</li>
<li>tests are initiated from within a docker container on a remote host with a
web interface</li>
<li>includes a suite of existing tests</li>
<li>more info <a href="http://fuegotest.org/">here</a></li>
</ul></li>
<li>Autotest
<ul class="org-ul">
<li>testing framework designed primarily for the Linux kernel</li>
<li>may be operated from a remote host, or run locally</li>
<li>more info <a href="https://github.com/autotest/autotest">here</a></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org36f2e25" class="outline-3">
<h3 id="546cf8d1-ff03-45c2-a9ad-ec2c1f871301"><span class="section-number-3">10.7</span> Submitting the patch</h3>
<div class="outline-text-3" id="text-546cf8d1-ff03-45c2-a9ad-ec2c1f871301">
<p>
Who or where should our new patchset be sent to?  We can find this out by
running <code>get_maintainer.pl</code> on a patch file or git commit.  For example:
</p>
<div class="org-src-container">
<pre class="src src-bash">scripts/get_maintainer.pl 0001-fix-the-thing.patch
<span class="org-comment-delimiter"># </span><span class="org-comment">OR</span>
scripts/get_maintainer.pl -f file_or_directory <span class="org-comment-delimiter"># </span><span class="org-comment">-f uses slightly different get_maintainer.pl flags</span>
</pre>
</div>

<p>
This script looks at what parts of the tree the patch modifies, and matches
each to the relevant mailing list and/or maintainer &#x2014; such information is
stashed in the top-level <code>MAINTAINERS</code> file.
</p>

<p>
By default, the script will emit the names, emails, and statistics of
maintainers and other potentially relevant persons (as <a href="https://git-scm.com/docs/git-blame"><code>git blame</code></a> sees it),
as well as the relevant mailing lists.
</p>

<p>
Additional flags can be given to print the authors, committers, and
signatories.  These ones seemed to be the most useful (<code>--help</code> prints them
all):
</p>
<ul class="org-ul">
<li><code>--git</code> includes persons mentioned in <code>Signed-off-by:</code>â€‹/â€‹<code>Reviewed-by:</code>â€‹/â€‹<code>Acked-by:</code>
bylines from the past 12 months.</li>
<li><code>--norolestats</code> omits rolestats; statistics regarding potentially relevant
developers that help to ascertain whether they are actively involved
contributors to patch-adjacent code.  This flag must be added if we&rsquo;re
feeding the output of this script into <code>send-email</code> via the <code>--to-cmd</code> and
<code>--cc-cmd</code> flags (see ).</li>
<li><code>--scm</code> prints the URLs of associated repos for each matching entry.</li>
<li><code>--subsystem</code> prints the relevant subsystems for each matching entry.</li>
<li><code>--interactive</code> lets us interactively select or deselect matching entries to
be included in the output; this can be helpful when using the <code>--git</code> flag,
which tends to include many developers.</li>
<li><code>--git-blame</code> includes additional developers listed by the eponymous git
command.</li>
</ul>

<p>
Once the recipients are established, we can send it off.  For example:
</p>
<div class="org-src-container">
<pre class="src src-bash">git send-email <span class="org-sh-escaped-newline">\</span>
    --to foo@bar.com <span class="org-sh-escaped-newline">\</span>
    --cc bar@foo.com <span class="org-sh-escaped-newline">\</span>
    0001-fix-the-thing.patch
</pre>
</div>
<p>
(It appears typical to send a patch directly <code>--to</code> the relevant maintainer(s),
and <code>--cc</code> to the relevant mailing list(s).)
</p>

<p>
If there are multiple patch files in the patch set, we must remember to
<code>--thread</code> the emails, and include a <code>--cover-letter</code>.
</p>

<p>
But we&rsquo;re getting ahead of ourselves here.  Let&rsquo;s send this patch to ourselves
first to make sure everything is as it should be.  At this point, some kind of
final checklist is in order:
</p>
<ul class="org-ul">
<li>the patchset solves one problem only</li>
<li>each logical change in the patchset is in its own patch</li>
<li>it applies cleanly to the latest tree</li>
<li>each patch in the patchset builds properly</li>
<li>it doesn&rsquo;t introduce any new regressions</li>
<li>it reasonably satisfies <code>clang-format</code> and <code>checkpatch.pl</code>, and perhaps some of
the static analysers</li>
<li>the change, and what it addresses, are described in detail (potentially
including the circumstances it will affect, hard data, trade-offs, etc.)</li>
<li>includes the URL, Message-Id, and brief summary of any earlier discussions
mentioned (where a direct reply to said discussion would have been
impractical)</li>
<li>includes the URL of any bug it references</li>
<li>includes the output of <code>git log -1 --pretty=fixes &lt;hash&gt;</code> of a commit that
this patch fixes, if applicable (see my config from )</li>
<li>includes a <code>Signed-off-by:</code> line</li>
</ul>

<p>
If everything looks good, we can re-run <code>git send-email</code> with the full list of
recipients, and send it on its way.  (If we set <code>sendemail.confirm</code> to &ldquo;always&rdquo;,
we&rsquo;ll get one final confirmation; see my config from .)
</p>

<p>
It may take a while for the patch to be accepted, or to receive feedback, so
be patient and give it at least a week or two.  (Things may be especially slow
during a merge-window.)
</p>
</div>
<div id="outline-container-org391c299" class="outline-4">
<h4 id="27563f63-557d-4f7b-afa4-39bd7107b4e7"><span class="section-number-4">10.7.1</span> Bonus: Integrating <code>get_maintainer.pl</code> with <code>git send-email</code></h4>
<div class="outline-text-4" id="text-27563f63-557d-4f7b-afa4-39bd7107b4e7">
<p>
Rather than manually adding the emails listed by <code>get_maintainer.pl</code> to the list
of recipients, I added an additional <a href="https://git-scm.com/docs/git-config#Documentation/git-config.txt-sendemailltidentitygt">identity</a> for <code>sendemail</code> to my <code>.gitconfig</code>:
</p>
<div class="org-src-container">
<pre class="src src-text">[sendemail.kernel]
    tocmd ="$(pwd)/scripts/get_maintainer.pl --nogit --nogit-fallback --norolestats --nol"
    cccmd ="$(pwd)/scripts/get_maintainer.pl --nogit --nogit-fallback --norolestats --nom"
</pre>
</div>
<p>
Using this identity will mean that the maintainer addresses are automatically
added to the <code>--to</code> list with <code>--to-cmd</code>, and the mailing list addresses are
automatically added to the <code>--cc</code> list with <code>--cc-cmd</code>.
</p>

<p>
To use it:
</p>
<div class="org-src-container">
<pre class="src src-bash">git send-email --identity=kernel ./0001-my-fancy-patch.patch
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org00c0e98" class="outline-3">
<h3 id="a316f564-f9e6-450e-ad1f-8a1659a6f35c"><span class="section-number-3">10.8</span> Finishing the task: a timeline</h3>
<div class="outline-text-3" id="text-a316f564-f9e6-450e-ad1f-8a1659a6f35c">
<p>
Since this task involved a bit more preparatory work than earlier ones, I
provide here an informal timeline of the steps I took to develop and submit
this patch:
</p>
<ul class="org-ul">
<li>fetched the latest tags for <code>linux-next</code></li>
<li>reset my master branch onto the latest tag</li>
<li>scoured for checkpatch issues
<ul class="org-ul">
<li>see <a href="#org1cad694">the one-liner I used earlier</a></li>
</ul></li>
<li>went through them to pick out something
<ul class="org-ul">
<li><code>drivers/staging/greybus/loopback.c</code>
<ul class="org-ul">
<li>the log shows very little work on this file in recent years</li>
<li>Greybus was initially intended for <a href="https://en.wikipedia.org/wiki/Project_Ara">Project Ara</a> (now discontinued), but
has other applications such as IoT (read more about this <a href="https://lwn.net/Articles/715955/">here</a>)</li>
<li>so-called modular phones require an internal bus that can handle
hardware modules that may come and go at any time, which previously was
not typical of cellphones</li>
<li>the hardware modules could communicate with the main processors or other
modules directly over a <a href="https://en.wikipedia.org/wiki/UniPro">UniPro</a> bus interface, whose spec is managed by
the <a href="https://en.wikipedia.org/wiki/MIPI_Alliance">MIPI Alliance</a></li>
<li>a new bus interface was necessary because there were special
requirements that USB and PCIe were unsuitable for</li>
<li>Greybus is an application layer bus protocol related to this</li>
</ul></li>
<li><code>drivers/staging/iio/frequency/ad9834.c</code>
<ul class="org-ul">
<li>this directory contains drivers for the <a href="https://www.kernel.org/doc/html/v4.12/driver-api/iio/index.html">Industrial I/O subsystem</a>, whose
purpose is to provide support for devices that involve <a href="https://en.wikipedia.org/wiki/Analog-to-digital_converter">ADC</a> and <a href="https://en.wikipedia.org/wiki/Digital-to-analog_converter">DAC</a>
conversion, such as accelerometers, gyros, various sensors, etc.</li>
<li>this subsystem fills a gap between <code>hwmon</code> (for low sample rate sensors)
and <code>input</code> (for input devices)</li>
<li>it also has its own separate mailing list</li>
<li>mainline drivers for this subsystem already exist; <code>drivers/staging/iio/</code>
is a staging directory for ones in development</li>
</ul></li>
<li><code>drivers/staging/rtl8723bs/os_dep/{os_intfs.c,ioctl_linux.c,os_intfs.c}</code>
<ul class="org-ul">
<li>rtl8723bs is a realtek WLAN/Bluetooth chip, usually integrated into
things like Set-Top boxes, IP Cameras, and Tablets</li>
<li>the log shows somewhat steady contributions</li>
<li>the <code>TODO</code> file requests <code>checkpatch.pl</code> fixes, among other things</li>
<li>this seems like a good choice</li>
</ul></li>
</ul></li>
<li>re-ran the checkpatch one-liner on <code>drivers/staging/rtl8723bs/os_dep/</code></li>
<li>enabled the relevant module in my config
<ul class="org-ul">
<li>found at <code>CONFIG_STAGING</code> â†³ <code>CONFIG_RTL8723BS</code></li>
<li>this depends on <code>CONFIG_WLAN</code>, <code>CONFIG_MMC</code>, and <code>CONFIG_CFG80211</code>, so I had to
enable those first</li>
<li>for whatever reason, this module can only be built as a loadable module;
it cannot be built-in (the <code>depends on m</code> line in its Kconfig entry is what
enforces this)</li>
</ul></li>
<li>compiled the kernel, which emits the <code>arch/x86/boot/bzImage</code> file</li>
<li>compiled the module as is, which emits the
<code>drivers/staging/rtl8723bs/r87123bs.ko</code> file</li>
<li>booted the kernel up in the VM and loaded a copy of the module file as a
sanity check
<ul class="org-ul">
<li>at this point I reconsidered whether to compile and install the kernel
directly inside the VM instead (I bite the bullet on this in )</li>
</ul></li>
<li>looked at the existing checkpatch errors in <code>drivers/staging/rtl8723bs/</code>
<ul class="org-ul">
<li><p>
the ones that seemed possibly dangerous and not just cosmetic:
</p>
<div class="org-src-container">
<pre class="src src-text">ERROR: Macros with complex values should be enclosed in parentheses
ERROR: Macros starting with if should be enclosed by a do - while loop to avoid possible if/else logic defects
ERROR: Macros with multiple statements should be enclosed in a do - while loop
ERROR: do not use assignment in if condition
ERROR: do not initialise globals to 0
ERROR: do not initialise globals to NULL
ERROR: do not initialise statics to 0
</pre>
</div></li>
<li>other errors included problems with whitespace, indentation, bracing
style, types not conforming to the <code>foo *bar</code> or <code>(foo *)</code> style, and other
cosmetic stuff</li>
</ul></li>
<li><p>
decided to fix the &ldquo;do not use assignment in if condition&rdquo; issue
</p>
<div class="org-src-container">
<pre class="src src-diff"><span class="org-diff-header">diff --git a/drivers/staging/rtl8723bs/core/rtw_ieee80211.c b/drivers/staging/rtl8723bs/core/rtw_ieee80211.c</span>
<span class="org-diff-header">index be4cffce4f5d..d4a661bd311d 100644</span>
<span class="org-diff-header">--- </span><span class="org-diff-header"><span class="org-diff-file-header">a/drivers/staging/rtl8723bs/core/rtw_ieee80211.c</span></span>
<span class="org-diff-header">+++ </span><span class="org-diff-header"><span class="org-diff-file-header">b/drivers/staging/rtl8723bs/core/rtw_ieee80211.c</span></span>
<span class="org-diff-hunk-header">@@ -1115,7 +1115,7 @@</span><span class="org-diff-function"> void rtw_macaddr_cfg(struct device *dev, u8 *mac_addr)</span>
<span class="org-diff-context">        }</span>

<span class="org-diff-context">        if (is_broadcast_ether_addr(mac) || is_zero_ether_addr(mac)) {</span>
<span class="org-diff-indicator-removed">-</span><span class="org-diff-removed">               if ((addr = of_get_property(np, "local-mac-address", &amp;len)) &amp;&amp;</span>
<span class="org-diff-indicator-removed">-</span><span class="org-diff-removed">                   len == ETH_ALEN) {</span>
<span class="org-diff-indicator-added">+</span><span class="org-diff-added">               addr = of_get_property(np, "local-mac-address", &amp;len);</span>
<span class="org-diff-indicator-added">+</span><span class="org-diff-added">               if (addr &amp;&amp; (len == ETH_ALEN)) {</span>
<span class="org-diff-context">                        ether_addr_copy(mac_addr, addr);</span>
<span class="org-diff-context">                } else {</span>
                        eth_random_addr(mac_addr);
</pre>
</div></li>
<li><p>
figured out the relevant subsystem
</p>
<div class="org-src-container">
<pre class="src src-bash">scripts/get_maintainer.pl --subsystem -f drivers/staging/rtl8723bs
</pre>
</div></li>
<li><p>
committed the change with a sane commit message, prepending the relevant
subsystem(s) and the name of the driver to the subject line
</p>
<div class="org-src-container">
<pre class="src src-text">staging: rtl8723bs: Remove assignment in if condition

This fixes the following checkpatch.pl error:

    ERROR: do not use assignment in if condition
</pre>
</div></li>
<li><p>
built the module as a sanity check
</p>
<div class="org-src-container">
<pre class="src src-bash">make olddefconfig
make prepare
make drivers/staging/rtl8723bs/
</pre>
</div></li>
<li><p>
formatted it into a patch file, which I signed off on
</p>
<div class="org-src-container">
<pre class="src src-bash">git format-patch -1 -s
</pre>
</div></li>
<li><p>
emailed a copy to myself, saved the email as an mbox file, and reapplied
it, as a sanity check:
</p>
<div class="org-src-container">
<pre class="src src-bash">git send-email 0001-staging-rtl8723bs-Remove-assignment-in-if-condition.patch --to myemail@mydomain.com
git am ~/Downloads/patch.mbox
git diff HEAD^
</pre>
</div></li>
<li>identified recipient(s)
<ul class="org-ul">
<li><p>
leaving it up to <code>get_maintainer.pl</code> would result in these maintainers and
lists being included in the recipients:
</p>
<div class="org-src-container">
<pre class="src src-text">gregkh@linuxfoundation.org
ross.schm.dev@gmail.com
devel@driverdev.osuosl.org
linux-kernel@vger.kernel.org
</pre>
</div></li>
<li>another mailing list worth adding here is <code>kernel-janitors@vger.kernel.org</code></li>
</ul></li>
<li>updated my remotes once more</li>
<li>inspected changes to <code>drivers/staging/rtl8723bs/</code> as of the latest tag with
<code>git log</code>
<ul class="org-ul">
<li>uh oh! the issue has since been addressed in <a href="https://lore.kernel.org/linux-staging/8e784a7e1407924724c97398af8e5aeb23460612.1616600897.git.fabioaiuto83@gmail.com/">this patch set</a>!</li>
</ul></li>
<li>fetched and reset my master branch onto the latest tag once again, and
searched for something else to patch as before
<ul class="org-ul">
<li><p>
I found these:
</p>
<div class="org-src-container">
<pre class="src src-text">drivers/staging/rtl8723bs/os_dep/os_intfs.c:120: ERROR: do not initialise globals to 0
drivers/staging/rtl8723bs/os_dep/os_intfs.c:131: ERROR: do not initialise globals to NULL
</pre>
</div></li>
</ul></li>
<li>made a new commit and rebased onto the latest next tree to confirm no
conflicts before generating the patch again</li>
<li><p>
sent it off
</p>
<div class="org-src-container">
<pre class="src src-bash">git send-email 0001-staging-rtl8723bs-Remove-initialisation-of-globals-t.patch --identity=kernel
</pre>
</div>
<ul class="org-ul">
<li>argh! I forgot to CC the kernel-janitors list! no biggie</li>
<li>I also forgot to CC the other persons mentioned in
<code>drivers/staging/rtl8723bs/TODO</code></li>
<li>something to remember for next time!</li>
</ul></li>
<li>it was accepted into <code>staging-next</code>, <a href="https://lore.kernel.org/linux-staging/20210804001335.16742-1-scottjcrouch@gmail.com/">woohoo</a>!</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org1b9cb2f" class="outline-2">
<h2 id="task-11"><span class="section-number-2">11</span> Task 11</h2>
<div class="outline-text-2" id="text-task-11">
<blockquote>
<p>
You made a successful patch to the kernel source tree, that&rsquo;s a great step!
</p>

<p>
But, let&rsquo;s not rest, time to get back to code.
</p>

<p>
Remember that mess of kobject and sysfs code back in task 09?  Let&rsquo;s move one
level up the tree and start to mess with devices and not raw kobjects.
</p>

<p>
For this task:
</p>
<ul class="org-ul">
<li>Write a patch against any driver that you are currently using on your
machine.  So first you have to figure out which drivers you are using, and
where the source code in the kernel tree is for that driver.</li>
<li>In that driver, add a sysfs file to show up in the <code>/sys/devices/</code> tree for
the device that is called &ldquo;id&rdquo;.  As you might expect, this file follows the
same rules as task 09 as for what you can read and write to it.</li>
<li>The file is to show up only for devices that are controlled by a single
driver, not for all devices of a single type (like all USB devices.  But all
USB maibox LEDs would be acceptable, if you happen to have the device that
that driver controls.)</li>
</ul>

<p>
Submit both the patch, in proper kernel commit form, and &ldquo;proof&rdquo; of it working
properly on your machine.
</p>
</blockquote>
</div>
<div id="outline-container-orgb7ac669" class="outline-3">
<h3 id="4b1a98a8-f2a4-4919-89b7-cf695e87c782"><span class="section-number-3">11.1</span> Choosing a driver</h3>
<div class="outline-text-3" id="text-4b1a98a8-f2a4-4919-89b7-cf695e87c782">
<p>
Here&rsquo;s a list of modules I found loaded on my desktop as per the output of
<code>lsmod</code>:
</p>
<ul class="org-ul">
<li><code>usbhid</code>
<ul class="org-ul">
<li>USB HID (human interface device) core driver</li>
</ul></li>
<li><code>usb_storage</code>
<ul class="org-ul">
<li>support for USB storage devices</li>
</ul></li>
<li><code>uas</code>
<ul class="org-ul">
<li>USB Attached SCSI, a protocol supported by some USB storage devices</li>
<li>permits higher performance by supporting multiple outstanding commands, in
comparison to the older USB Mass Storage Bulk-Only Transport (BOT)
drivers</li>
<li>requires <code>usb_storage</code></li>
</ul></li>
<li><code>nvidia*</code>
<ul class="org-ul">
<li>drivers for my nvidia card</li>
</ul></li>
<li><code>intel_rapl*</code>
<ul class="org-ul">
<li>support for the Intel Running Average Power Limit (RAPL) technology via
MSR interface</li>
<li>allows power limits to be enforced and monitored on modern Intel
processors (Sandy Bridge and later)</li>
</ul></li>
<li><code>snd*</code>
<ul class="org-ul">
<li>ALSA support, plus support for high-definition audio codecs, DSP, USB
audio, et al.</li>
</ul></li>
<li><code>soundcore</code>
<ul class="org-ul">
<li>core sound module, needed by <code>snd</code></li>
</ul></li>
<li><code>soundwire*</code>
<ul class="org-ul">
<li>support for the SoundWire 2-pin interface, optimised for integrating audio
devices in mobile systems</li>
</ul></li>
<li><code>mc</code>
<ul class="org-ul">
<li>device node registration for media drivers</li>
</ul></li>
<li><code>ledtrig_audio</code>
<ul class="org-ul">
<li>LED trigger for audio mute control</li>
</ul></li>
<li><code>ac97_bus</code>
<ul class="org-ul">
<li>used to &ldquo;avoid config and link hard dependencies between the sound
subsystem and other function drivers completely unrelated to sound
although they&rsquo;re sharing the AC97 bus&rdquo;</li>
</ul></li>
<li><code>x86_pkg_temp_thermal</code>
<ul class="org-ul">
<li>x86-specific driver for CPU temp sensor</li>
</ul></li>
<li><code>intel_powerclamp</code>
<ul class="org-ul">
<li>relates to management of CPU C-states (idle states) to control power
consumption for Intel CPUs</li>
</ul></li>
<li><code>coretemp</code>
<ul class="org-ul">
<li>driver for temp sensors inside Intel CPUs</li>
</ul></li>
<li><code>kvm*</code>
<ul class="org-ul">
<li>kvm support</li>
</ul></li>
<li><code>rfkill</code>
<ul class="org-ul">
<li>RF switch support, used for enabling and disabling wireless devices</li>
</ul></li>
<li><code>irqbypass</code>
<ul class="org-ul">
<li>IRQ bypass manager utility module</li>
<li>used by <code>kvm</code>, relates to the assignment of hardware to a VM, and how
hardware interrupts are handled or forwarded</li>
</ul></li>
<li><code>rapl</code>
<ul class="org-ul">
<li>relates to Running Average Power Limit, for limiting the running
temperature of a package</li>
</ul></li>
<li><code>iTCO*_wdt</code>
<ul class="org-ul">
<li>Intel TCO watchdog timer support</li>
</ul></li>
<li><code>intel_pmc_bxt</code>
<ul class="org-ul">
<li>Intel Broxton PMC (Power Management Controller) driver</li>
</ul></li>
<li><code>at24</code>
<ul class="org-ul">
<li>driver for most I2C EEPROMs</li>
</ul></li>
<li><code>nls_iso8859_1</code>
<ul class="org-ul">
<li>Native Language Support, specifically for Western-European character sets</li>
<li>a number of filesystems may depend on NLS</li>
</ul></li>
<li><code>intel_cstate</code>
<ul class="org-ul">
<li>support for management of C-states (idle states) to control power
consumption on Intel CPUs</li>
</ul></li>
<li><code>intel_uncore</code>
<ul class="org-ul">
<li>&ldquo;uncore&rdquo; is a term used by Intel to describe the functions of a
microprocessor (called a &ldquo;system agent&rdquo;) that are not in the core, but
which must be closely connected to the core to achieve high performance</li>
<li>uncore functions include FSB controllers, L3 cache, other on-die stuff</li>
<li>presumably this provides access to those elements</li>
</ul></li>
<li><code>fat</code>, <code>vfat</code>
<ul class="org-ul">
<li>support for (Virtual) File Allocation Table filesystem</li>
</ul></li>
<li><code>drm_kms_helper</code>
<ul class="org-ul">
<li>Direct Rendering Manager (DRM) is the subsystem responsible for
interfacing with modern GPUs</li>
<li>Kernel Mode Setting (KMS) is for exposing a GPU&rsquo;s mode-setting functions</li>
<li>presumably this module helps to abstract some of that work</li>
</ul></li>
<li><code>cec</code>
<ul class="org-ul">
<li>device node registration for CEC drivers</li>
<li>CEC is a protocol for allowing HDMI-connected devices to talk to each
other</li>
</ul></li>
<li><code>syscopyarea</code>, <code>sysfillrect</code>, <code>sysimgblt</code>, <code>fb_sys_fops</code>
<ul class="org-ul">
<li>relates to framebuffer devices whose framebuffer lives in RAM</li>
</ul></li>
<li><code>drm</code>
<ul class="org-ul">
<li>Direct Rendering Manager subsystem infrastructure</li>
</ul></li>
<li><code>agpgart</code>
<ul class="org-ul">
<li>Accelerated Graphics Port support</li>
<li>GART stands for Graphics Address Remapping Table, an IOMMU used by AGP
card, and which is involved in DMA for data exchange between video and
main memory</li>
</ul></li>
<li><code>i2c_i801</code>
<ul class="org-ul">
<li>one of several I2C drivers, this supports the Intel 801 family of
mainboard I2C interfaces</li>
</ul></li>
<li><code>i2c_smbus</code>
<ul class="org-ul">
<li>I2C SMBus protocol extensions support</li>
<li>SMBus is a bus similar to, and built on top of, I2C, thus devices are
usually compatible at the hardware level</li>
<li>SMBus has different minimum and maximum clock speeds, as well as slightly
different electrical characteristics in its spec</li>
</ul></li>
<li><code>pcspkr</code>
<ul class="org-ul">
<li>PC Speaker beeper driver, for those little piezoelectric speakers on the
motherboard</li>
</ul></li>
<li><code>xpad</code>
<ul class="org-ul">
<li>X-Box gamepad driver</li>
</ul></li>
<li><code>ff_memless</code>
<ul class="org-ul">
<li>force feedback support for memoryless devices</li>
<li>needed by <code>xpad</code></li>
</ul></li>
<li><code>joydev</code>
<ul class="org-ul">
<li>joystick support</li>
</ul></li>
<li><code>mousedev</code>
<ul class="org-ul">
<li>PS/2 mouse support</li>
</ul></li>
<li><code>lpc_ich</code>
<ul class="org-ul">
<li>ICH refers to Intel&rsquo;s I/O Controller Hub, which was used on Intel chipsets
based on the Intel Hub Architecture</li>
<li>LPC refers to the Low Pin Count bus, used for connecting low-bandwidth
devices to the CPU</li>
<li>this module supports units on said bus</li>
</ul></li>
<li><code>mei*</code>
<ul class="org-ul">
<li>Intel Management Engine Interface support</li>
</ul></li>
<li><code>atl1c</code>
<ul class="org-ul">
<li>Qualcomm Atheros 100/1000M ethernet network driver</li>
</ul></li>
<li><code>parport*</code>
<ul class="org-ul">
<li>parallel port drivers</li>
</ul></li>
<li><code>ppdev</code>
<ul class="org-ul">
<li>exposes parallel port devices so that drivers may be implemented in
user-space</li>
</ul></li>
<li><code>mac_hid</code>
<ul class="org-ul">
<li>for emulating certain macintosh hardware</li>
</ul></li>
<li><code>video</code>
<ul class="org-ul">
<li>ACPI Video Driver</li>
</ul></li>
<li><code>pkcs8_key_parser</code>
<ul class="org-ul">
<li>PKCS#8 certificate parser</li>
<li>supports parsing of PKCS#8 format blobs for private key data, and provides
the ability to instantiate a crypto key from that data</li>
</ul></li>
<li><code>fuse</code>
<ul class="org-ul">
<li>stands for Filesystem in User-Space, which is&#x2026; an interface for
implementing filesystems in user-space</li>
</ul></li>
<li><code>bpf_preload</code>
<ul class="org-ul">
<li>BPF stands for Berkeley Packet Filters, an interface for implementing
packet filtering in user-space which then runs in the deeper network layers
in kernel-space in a sandboxed environment</li>
<li>this module contains several embedded BPF programs that are pinned into
BPF FS mount point as human readable files that are useful in debugging
and introspection of BPF programs and maps</li>
</ul></li>
<li><code>x_tables</code>
<ul class="org-ul">
<li>backend module for <code>{ip,ip6,arp,eb}_tables</code></li>
</ul></li>
<li><code>ip_tables</code>
<ul class="org-ul">
<li>IPv4 packet filter</li>
<li>requires <code>x_tables</code></li>
</ul></li>
<li><code>dm_crypt</code> and <code>dm_mod</code>
<ul class="org-ul">
<li>support for transparent encryption/decryption</li>
<li>the latter is a device-mapper driver</li>
</ul></li>
<li><code>cbc</code>
<ul class="org-ul">
<li>relates to the CBC block cipher</li>
</ul></li>
<li><code>tpm</code>
<ul class="org-ul">
<li>driver for the Trusted Platform Module, a standard for dedicated MCUs
designed for performing crypto operations securely</li>
</ul></li>
<li><code>encrypted_keys</code>
<ul class="org-ul">
<li>support for in-kernel creation and storage of keys, as well as
encryption/decryption, on behalf of the user</li>
<li>requires <code>tpm</code></li>
</ul></li>
<li><code>trusted</code>
<ul class="org-ul">
<li>presumably something to do with keys</li>
<li>requires <code>encrypted_keys</code></li>
</ul></li>
<li><code>rng_core</code>
<ul class="org-ul">
<li>requires <code>tpm</code></li>
<li>support for random number generation in hardware</li>
</ul></li>
<li><code>serio</code>
<ul class="org-ul">
<li>serial I/O support, for input devices that use serial I/O to communicate
with the system, e.g. standard keyboards, PS/2 mice</li>
</ul></li>
<li><code>serio_raw</code>
<ul class="org-ul">
<li>provides raw access to serial I/O ports</li>
</ul></li>
<li><code>atkbd</code>
<ul class="org-ul">
<li>support for standard AT or PS/2 keyboards</li>
</ul></li>
<li><code>i8042</code>
<ul class="org-ul">
<li>support for the i8042 chip, over which the standard AT keyboard and PS/2
mouse are connected</li>
</ul></li>
<li><code>libps2</code>
<ul class="org-ul">
<li>PS/2 driver library</li>
</ul></li>
<li><code>ext4</code>
<ul class="org-ul">
<li>support for the ext4 filesystem</li>
</ul></li>
<li><code>mbcache</code>
<ul class="org-ul">
<li>meta block cache, a simple key&#x2013;value store</li>
<li>used for extended attributes in filesystems, and needed by <code>ext4</code></li>
</ul></li>
<li><code>jbd2</code>
<ul class="org-ul">
<li>a generic journaling layer for block devices that support both 32-bit and
64-bit block numbers</li>
<li>needed by <code>ext4</code></li>
</ul></li>
<li><code>cdrom</code>
<ul class="org-ul">
<li>support for cdrom drives</li>
</ul></li>
<li><code>sr_mod</code>
<ul class="org-ul">
<li>SCSI cdrom (sr) driver, requires <code>cdrom</code></li>
</ul></li>
<li><code>crc*</code>
<ul class="org-ul">
<li>T10 DIF CRC calculation accelerated with PCLMULQDQ</li>
<li>concerns processors which have certain instructions available, in which
case the corresponding CRC algorithm can be hardware-accelerated</li>
</ul></li>
<li><code>ghash_clmulni_intel</code>
<ul class="org-ul">
<li>likewise but for the GHASH hash function</li>
</ul></li>
<li><code>cryptd</code>
<ul class="org-ul">
<li>can be used to convert an arbitrary synchronous software crypto algorithm
into an asynchronous algorithm that runs in a kthread</li>
</ul></li>
<li><code>crypto_simd</code>
<ul class="org-ul">
<li>shared code for crypto SIMD</li>
</ul></li>
<li><code>glue_helper</code>
<ul class="org-ul">
<li>shared glue code for 128-bit block ciphers</li>
</ul></li>
<li><code>aesni_intel</code>
<ul class="org-ul">
<li>hardware-acceleration for Rijndael (AES) Cipher Algorithm on Intel
hardware</li>
<li>requires <code>crypto_simd</code> and <code>glue_helper</code></li>
</ul></li>
<li><code>xhci_pci</code>
<ul class="org-ul">
<li>xHCI PCI Host Controller Driver</li>
<li>xHCI stands for extensible Host Controller Interface, which relates to USB
host controllers</li>
<li>this drives a USB controller connected via PCI</li>
</ul></li>
<li><code>xhci_pci_renesas</code>
<ul class="org-ul">
<li>support for the Renesas xHCI controller with firmware</li>
</ul></li>
</ul>

<p>
I&rsquo;ve decided to use the <code>pcspkr</code> module, as that is available on both my desktop
and my VM, and is unlikely to blow up my PC upon misuse.<sup><a id="fnr.46" class="footref" href="#fn.46">46</a></sup>  A few notes on this driver/module:
</p>
<ul class="org-ul">
<li>It&rsquo;s enabled via <code>CONFIG_INPUT_PCSPKR</code> (which itself depends on a few other
options).</li>
<li>It&rsquo;s implemented in <code>drivers/input/misc/pcspkr.c</code>.</li>
<li>It has an associated device file that is symlinked from
<code>/dev/input/by-path/platform-pcspkr-event-spkr</code>.  (Check out the <code>beep</code> utility
for a way to write to this file.)</li>
</ul>
</div>
</div>
<div id="outline-container-org59c392c" class="outline-3">
<h3 id="670db2c8-3179-4003-9323-cd50b2b2a5bf"><span class="section-number-3">11.2</span> Changing my workflow</h3>
<div class="outline-text-3" id="text-670db2c8-3179-4003-9323-cd50b2b2a5bf">
<p>
Rather than continuing to compile and run kitchen-sink kernels with all the
modules built in, I scrapped this and started building them inside the VM
within which they were to run.  This meant I could install the compiled
modules to their usual place in <code>/lib/modules/</code>.<sup><a id="fnr.47" class="footref" href="#fn.47">47</a></sup>
</p>

<p>
This also meant I needed a new kernel configuration.  For this I just copied
the existing distro configuration (Debian), before running <code>make olddefconfig</code>
to update it, and <code>make kvm_guest.config</code> for good measure.<sup><a id="fnr.48" class="footref" href="#fn.48">48</a></sup>
</p>

<p>
To tell different kernels apart, I also set <code>CONFIG_LOCALVERSION</code> to something
sufficiently informative.
</p>

<p>
I encountered an odd message during boot regarding, coincidentally, the pcspkr
module.  I address this in the .
</p>
</div>
<div id="outline-container-org21833d7" class="outline-4">
<h4 id="97f80e94-2336-494f-a4f3-57a3f6c1d635"><span class="section-number-4">11.2.1</span> Bonus: Installing a kernel</h4>
<div class="outline-text-4" id="text-97f80e94-2336-494f-a4f3-57a3f6c1d635">
<p>
I was interested in what <code>make install</code> actually does.  Indeed, running this
seemed to indicate that it is not merely copying the kernel image to <code>/boot/</code>:
</p>
<div class="org-src-container">
<pre class="src src-text">arch/x86/Makefile:142: CONFIG_X86_X32 enabled but no binutils support
sh ./arch/x86/boot/install.sh 5.15.0-rc7-next-20211027 \
        arch/x86/boot/bzImage System.map "/boot"
run-parts: executing /etc/kernel/postinst.d/apt-auto-removal 5.15.0-rc7-next-20211027 /boot/vmlinuz-5.15.0-rc7-next-20211027
run-parts: executing /etc/kernel/postinst.d/initramfs-tools 5.15.0-rc7-next-20211027 /boot/vmlinuz-5.15.0-rc7-next-20211027
update-initramfs: Generating /boot/initrd.img-5.15.0-rc7-next-20211027
run-parts: executing /etc/kernel/postinst.d/zz-update-grub 5.15.0-rc7-next-20211027 /boot/vmlinuz-5.15.0-rc7-next-20211027
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-5.15.0-rc7-next-20211027
Found initrd image: /boot/initrd.img-5.15.0-rc7-next-20211027
Found linux image: /boot/vmlinuz-5.15.0-rc7-next-20211027.old
Found initrd image: /boot/initrd.img-5.15.0-rc7-next-20211027
Found linux image: /boot/vmlinuz-4.19.0-13-amd64
Found initrd image: /boot/initrd.img-4.19.0-13-amd64
Adding boot menu entry for EFI firmware configuration
done
</pre>
</div>

<p>
The top-level makefile appear to kick this off by running <code>scripts/install.sh</code>.
The <code>INSTALLKERNEL</code> program this script mentions is by default a script called
<code>installkernel</code> in <code>/sbin/</code>.  This script won&rsquo;t appear on every distro, but on my
Debian machine, it:
</p>
<ul class="org-ul">
<li>backs up (by renaming) any existing kernel image, map, or config files;</li>
<li>copies over the new versions of these; and</li>
<li>runs all the post-install scripts found in <code>/etc/kernel/postinst.d/</code>.</li>
</ul>

<p>
The <code>/etc/kernel/postinst.d/</code> directory appeared to contain three scripts:
</p>
<ul class="org-ul">
<li><code>apt-auto-removal</code>, which tells apt to uninstall older kernels we no longer
need (this does not affect manually installed kernels);</li>
<li><code>initramfs-tools</code>, which runs <code>update-initramfs</code> in order to generate an
initramfs image for this new kernel (using the configuration in
<code>/etc/initramfs-tools/</code>); and</li>
<li><code>zz-update-grub</code>, which runs <code>update-grub</code> in order to regenerate the grub
configuration, based on whatever can be found in <code>/boot/</code>.</li>
</ul>

<p>
With this information, it is easy to make sense of the output of <code>make install</code>
shown above.<sup><a id="fnr.49" class="footref" href="#fn.49">49</a></sup><sup>, </sup><sup><a id="fnr.50" class="footref" href="#fn.50">50</a></sup>
</p>

<p>
Should I later wish to <i>uninstall</i> one of these kernels, I would have to delete
the associated files from <code>/boot/</code> (kernel, initramfs, map, and config), remove
the relevant <code>/lib/modules/$KERNEL_VERSION/</code> directory, and refresh grub.
</p>

<p>
(Something I have not mentioned here, but may be relevant to some setups, is
Dynamic Kernel Module Support (DKMS).  The short version of this can be read
<a href="https://en.wikipedia.org/wiki/Dynamic_Kernel_Module_Support">here</a>; the medium version <a href="https://www.linuxjournal.com/article/6896">here</a>, and the long version in the <code>dkms(8)</code> manpage.)
</p>
</div>
</div>
</div>
<div id="outline-container-orgbd2e87b" class="outline-3">
<h3 id="98abce55-66aa-4c88-b54c-4b892f8f4a7f"><span class="section-number-3">11.3</span> The pcspkr module</h3>
<div class="outline-text-3" id="text-98abce55-66aa-4c88-b54c-4b892f8f4a7f">
<p>
Some initial notes about the pcspkr module:
</p>
<ul class="org-ul">
<li>On my system, udev loads this module at boot-time.</li>
<li>It has no module dependencies.</li>
<li>Unloading and reloading it doesn&rsquo;t seem to cause any noticeable problems.</li>
<li>It&rsquo;s quite small.  The source code is very simple and easy to read.</li>
<li>The source code hasn&rsquo;t been modified for a very long time.</li>
<li>Interestingly, the device is registered with the input subsystem (and thus
the driver lives in <code>drivers/input/</code>).  As to why I discuss .</li>
</ul>
</div>
<div id="outline-container-org873732e" class="outline-4">
<h4 id="16e442bc-e96b-442f-abbd-bb166f268f7a"><span class="section-number-4">11.3.1</span> What is a platform driver?</h4>
<div class="outline-text-4" id="text-16e442bc-e96b-442f-abbd-bb166f268f7a">
<p>
As per the <a href="https://docs.kernel.org/driver-api/driver-model/platform.html">docs</a>:
</p>
<blockquote>
<p>
This pseudo-bus is used to connect devices on busses with minimal
infrastructure, like those used to integrate peripherals on many
system-on-chip processors, or some &ldquo;legacy&rdquo; PC interconnects; as opposed to
large formally specified ones like PCI or USB.
</p>
</blockquote>

<p>
In other words, it&rsquo;s a driver that doesn&rsquo;t fit into a standard subsystem like
PCI or USB, whose device is non-discoverable and usually integrated into the
platform at a fixed address range.  The device&rsquo;s existence must therefore be
disclosed explicitly: via hardcoded platform data or a device tree.  Sometimes
the driver logic be deferred to user-space, as in the case of <a href="https://docs.kernel.org/i2c/dev-interface.html">I2C devices</a>.  As
for the PC speaker, it is part of the x86 platform, and operated via <a href="https://en.wikipedia.org/wiki/Memory-mapped_I/O_and_port-mapped_I/O">I/O
port-mapped registers</a> at fixed addresses.
</p>
</div>
</div>
<div id="outline-container-org8aae76f" class="outline-4">
<h4 id="6d0562fc-cb54-4d48-85d4-246af8a032ad"><span class="section-number-4">11.3.2</span> The hardware</h4>
<div class="outline-text-4" id="text-6d0562fc-cb54-4d48-85d4-246af8a032ad">
<p>
The <a href="https://en.wikipedia.org/wiki/PC_speaker">PC speaker</a> is a small piezoelectric speaker on the motherboard.  It is
driven by a Programmable Interval Timer (PIT); specifically an <a href="http://www.osdever.net/bkerndev/Docs/pit.htm">Intel 8253 or
8254 chip</a>.  A PIT is a counter that can be used to generate a pulse when the
count reaches some (programmable) value, after which it rolls over and starts
again.  This can be useful for generating interrupts, but in the case of the
PC speaker, it is used to generate a square wave.
</p>

<p>
On an IBM PC, the chip has 3 channels, where channel 2 is connected to the PC
speaker pinout.
</p>
</div>
</div>
<div id="outline-container-orge9e9409" class="outline-4">
<h4 id="d1a45dbc-5ca3-4b81-bc7b-bbe22295f591"><span class="section-number-4">11.3.3</span> The software</h4>
<div class="outline-text-4" id="text-d1a45dbc-5ca3-4b81-bc7b-bbe22295f591">
<p>
Here I go over parts of <code>drivers/input/misc/pcspkr.c</code>.
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/i8253.h&gt;</span>
</pre>
</div>
<p>
This header, which lives at <code>include/linux/i8253.h</code>, defines the fixed I/O port
addresses associated with the PIT.  Arch-dependent code associated with this
header can be found at <code>arch/x86/kernel/i8253.c</code>, while arch-independent code
can be found at <code>drivers/clocksource/i8253.c</code>.  However, this module appears to
access the PIT with just raw I/O port operations.
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/input.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/platform_device.h&gt;</span>
</pre>
</div>
<p>
These headers are necessary for the creation and registration of <code>struct
input_dev</code> and <code>struct platform_device</code> objects.
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/timex.h&gt;</span>
</pre>
</div>
<p>
This header contains a definition for the fixed clock frequency of the PIT
(<code>PIT_TICK_RATE</code>).
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/io.h&gt;</span>
</pre>
</div>
<p>
This is necessary for operating directly on x86 I/O ports (the <code>outb()</code> and
<code>outb_p()</code> ops).
</p>

<div class="org-src-container">
<pre class="src src-c">MODULE_ALIAS(<span class="org-string">"platform:pcspkr"</span>);
</pre>
</div>
<p>
Recall how, in <a href="#task-05">task 05</a>, we had to create a module alias, one derived from a
module device table, such that udev would recognise our module as supporting
USB keyboards?  Specifically, we had used the <code>MODULE_DEVICE_TABLE</code> macro, and
not <code>MODULE_ALIAS</code>.  The latter can be used to define module aliases literally.
(In fact, as I understand it, a module post-processing step will convert the
device table into <code>MODULE_ALIAS</code> calls, and paste them into the intermediate
<code>*.mod.c</code> file.)  Since this driver isn&rsquo;t registered with a particular bus
subsystem, and its platform data is hard-coded, it must use
<code>MODULE_ALIAS</code>.<sup><a id="fnr.51" class="footref" href="#fn.51">51</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">dev_pm_ops</span> <span class="org-variable-name">pcspkr_pm_ops</span> = {
        .suspend = pcspkr_suspend,
};
<span class="org-keyword">static</span> <span class="org-keyword">struct</span> <span class="org-type">platform_driver</span> <span class="org-variable-name">pcspkr_platform_driver</span> = {
        .driver = {
                .name = <span class="org-string">"pcspkr"</span>,
                .pm   = &amp;pcspkr_pm_ops,
        },
        .probe    = pcspkr_probe,
        .remove   = pcspkr_remove,
        .shutdown = pcspkr_shutdown,
};
<span class="org-function-name">module_platform_driver</span>(pcspkr_platform_driver);
</pre>
</div>
<p>
Here, the platform driver is registered.  The <code>module_platform_driver()</code> call at
the bottom is a helper macro for platform drivers that don&rsquo;t need to do
anything special in their module init/exit routines (which is why there are no
definitions for <code>module_{init,exit}()</code> in this file).  The <code>pcspkr_suspend</code> and
<code>pcspkr_shutdown</code> callbacks will be invoked when the PC is suspended or shut
down (the respective functions simply tell the speaker to beep briefly).  The
functions in <code>pcspkr_pm_ops</code> are provided for the Power Management framework.
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">pcspkr_probe</span>(<span class="org-keyword">struct</span> <span class="org-type">platform_device</span> *<span class="org-variable-name">dev</span>)
{
        <span class="org-keyword">struct</span> <span class="org-type">input_dev</span> *<span class="org-variable-name">pcspkr_dev</span>;
        <span class="org-type">int</span> <span class="org-variable-name">err</span>;

        pcspkr_dev = input_allocate_device();
        <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>pcspkr_dev)
                <span class="org-keyword">return</span> -ENOMEM;

        pcspkr_dev-&gt;name = <span class="org-string">"PC Speaker"</span>;
        pcspkr_dev-&gt;phys = <span class="org-string">"isa0061/input0"</span>;
        pcspkr_dev-&gt;id.bustype = BUS_ISA;
        pcspkr_dev-&gt;id.vendor = 0x001f;
        pcspkr_dev-&gt;id.product = 0x0001;
        pcspkr_dev-&gt;id.version = 0x0100;
        pcspkr_dev-&gt;dev.parent = &amp;dev-&gt;dev;

        pcspkr_dev-&gt;evbit[0] = BIT_MASK(EV_SND);
        pcspkr_dev-&gt;sndbit[0] = BIT_MASK(SND_BELL) | BIT_MASK(SND_TONE);
        pcspkr_dev-&gt;event = pcspkr_event;

        err = input_register_device(pcspkr_dev);
        <span class="org-keyword">if</span> (err) {
                input_free_device(pcspkr_dev);
                <span class="org-keyword">return</span> err;
        }

        platform_set_drvdata(dev, pcspkr_dev);

        <span class="org-keyword">return</span> 0;
}
</pre>
</div>
<p>
In general, <code>probe()</code> callbacks are invoked by the driver core after a new
device appears and it sees that our driver is qualified to handle it.  The job
of a probe callback is typically to:
</p>
<ul class="org-ul">
<li>verify that the device in question is indeed present, and that the driver
can actually handle it;</li>
<li>allocate and initialise a data structure for representing and controlling
the new device;</li>
<li>initialise the device itself;</li>
<li>register said data structure;</li>
<li>save a reference back to said data structure within the device struct
supplied by the driver core in calling this probe function; and</li>
<li>return 0 should all of the above succeed.</li>
</ul>

<p>
This <code>probe()</code> is a little different though, because platform devices are not
hot-pluggable nor discoverable (&ldquo;discoverability&rdquo; implies a bus that can
provide that information).  Indeed, this implementation doesn&rsquo;t bother
checking whether the PIT is present, but just assumes it.  (I suspect that
platform drivers are a special case where, once registered, their <code>probe()</code>
callback is invoked immediately to give them a chance to register their
associated device(s).)
</p>

<p>
I had mentioned earlier that the pc speaker is registered with the input
subsystem.  This seems a little odd at first; isn&rsquo;t a speaker really an <i>output</i>
device?
</p>

<p>
In general, input events are ostensibly hardware interrupts, generated
exogenously from an external input device, but input events can also be
generated endogenously by the kernel.  In this case, the kernel generate an
<code>EV_SND</code> event (perhaps triggered by the user sending a <a href="https://en.wikipedia.org/wiki/Bell_character">special control code to
the tty</a><sup><a id="fnr.52" class="footref" href="#fn.52">52</a></sup>) that this driver
has been registered to respond to.  That response is implemented in the
<code>pcspkr_event()</code> event handler (shown further down).
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">pcspkr_remove</span>(<span class="org-keyword">struct</span> <span class="org-type">platform_device</span> *<span class="org-variable-name">dev</span>)
{
        <span class="org-keyword">struct</span> <span class="org-type">input_dev</span> *<span class="org-variable-name">pcspkr_dev</span> = platform_get_drvdata(dev);

        input_unregister_device(pcspkr_dev);
        <span class="org-comment-delimiter">/* </span><span class="org-comment">turn off the speaker</span><span class="org-comment-delimiter"> */</span>
        pcspkr_event(<span class="org-constant">NULL</span>, EV_SND, SND_BELL, 0);

        <span class="org-keyword">return</span> 0;
}
</pre>
</div>
<p>
This callback is invoked when the driver is being unloaded.
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">pcspkr_event</span>(<span class="org-keyword">struct</span> <span class="org-type">input_dev</span> *<span class="org-variable-name">dev</span>, <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">type</span>,
                        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">code</span>, <span class="org-type">int</span> <span class="org-variable-name">value</span>)
{
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">count</span> = 0;
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">flags</span>;

        <span class="org-keyword">if</span> (type != EV_SND)
                <span class="org-keyword">return</span> -EINVAL;

        <span class="org-keyword">switch</span> (code) {
        <span class="org-keyword">case</span> SND_BELL:
                <span class="org-keyword">if</span> (value)
                        value = 1000;
                <span class="org-keyword">break</span>;
        <span class="org-keyword">case</span> SND_TONE:
                <span class="org-keyword">break</span>;
        <span class="org-keyword">default</span>:
                <span class="org-keyword">return</span> -EINVAL;
        }

        <span class="org-keyword">if</span> (value &gt; 20 &amp;&amp; value &lt; 32767)
                count = PIT_TICK_RATE / value;

        raw_spin_lock_irqsave(&amp;i8253_lock, flags);

        <span class="org-keyword">if</span> (count) {
                <span class="org-comment-delimiter">/* </span><span class="org-comment">set command for counter 2, 2 byte write</span><span class="org-comment-delimiter"> */</span>
                outb_p(0xB6, 0x43);
                <span class="org-comment-delimiter">/* </span><span class="org-comment">select desired HZ</span><span class="org-comment-delimiter"> */</span>
                outb_p(count &amp; 0xff, 0x42);
                outb((count &gt;&gt; 8) &amp; 0xff, 0x42);
                <span class="org-comment-delimiter">/* </span><span class="org-comment">enable counter 2</span><span class="org-comment-delimiter"> */</span>
                outb_p(inb_p(0x61) | 3, 0x61);
        } <span class="org-keyword">else</span> {
                <span class="org-comment-delimiter">/* </span><span class="org-comment">disable counter 2</span><span class="org-comment-delimiter"> */</span>
                outb(inb_p(0x61) &amp; 0xFC, 0x61);
        }

        raw_spin_unlock_irqrestore(&amp;i8253_lock, flags);

        <span class="org-keyword">return</span> 0;
}
</pre>
</div>
<p>
The kernel passes this handler an event type, an event-specific code, and a
value specifying the frequency to play.  In this case, the event type will be
<code>EV_SND</code>, and the event-specific code will be either <code>SND_BELL</code> or <code>SND_TONE</code> (the
former assumes a value of 1000 Hz).  If a Hz value of zero is given, the
driver will disable the PIT.
</p>
</div>
</div>
</div>
<div id="outline-container-org1ce6581" class="outline-3">
<h3 id="59287b31-6102-4b79-a2e3-28e29364b41d"><span class="section-number-3">11.4</span> Patching the driver</h3>
<div class="outline-text-3" id="text-59287b31-6102-4b79-a2e3-28e29364b41d">
<p>
As we&rsquo;ve seen, the <code>pcspkr</code> driver registers itself on the platform
bus-that&rsquo;s-not-a-bus-but-really-a-catch-all-subsystem-for-interfaces-that-are-wed-to-the-platform.
The platform device it governs is also registered with the input subsystem.
The data structures associated with these are:
</p>
<ul class="org-ul">
<li><code>struct platform_driver</code></li>
<li><code>struct platform_device</code></li>
<li><code>struct input_dev</code></li>
</ul>

<p>
The picture of this from sysfs:
</p>
<div class="org-src-container">
<pre class="src src-text">/sys/devices/platform/pcspkr/
&#9500;&#9472;&#9472; driver -&gt; /sys/bus/platform/drivers/pcspkr/
&#9500;&#9472;&#9472; driver_override
&#9500;&#9472;&#9472; input/
&#9474;   &#9492;&#9472;&#9472; input8/
&#9474;       &#9500;&#9472;&#9472; capabilities/
&#9474;       &#9474;   &#9492;&#9472;&#9472; [...]
&#9474;       &#9500;&#9472;&#9472; device -&gt; /sys/devices/platform/pcspkr/
&#9474;       &#9500;&#9472;&#9472; event6/
&#9474;       &#9474;   &#9492;&#9472;&#9472; [...]
&#9474;       &#9500;&#9472;&#9472; id/
&#9474;       &#9474;   &#9492;&#9472;&#9472; [...]
&#9474;       &#9500;&#9472;&#9472; inhibited
&#9474;       &#9500;&#9472;&#9472; modalias
&#9474;       &#9500;&#9472;&#9472; name
&#9474;       &#9500;&#9472;&#9472; phys
&#9474;       &#9500;&#9472;&#9472; power/
&#9474;       &#9474;   &#9492;&#9472;&#9472; [...]
&#9474;       &#9500;&#9472;&#9472; properties
&#9474;       &#9500;&#9472;&#9472; subsystem -&gt; /sys/class/input/
&#9474;       &#9500;&#9472;&#9472; uevent
&#9474;       &#9492;&#9472;&#9472; uniq
&#9500;&#9472;&#9472; modalias
&#9500;&#9472;&#9472; power/
&#9474;   &#9492;&#9472;&#9472; [...]
&#9500;&#9472;&#9472; subsystem -&gt; /sys/bus/platform/
&#9492;&#9472;&#9472; uevent
</pre>
</div>

<p>
The registration and deregistration of this platform device &#x2014; and by
extension the creation of its kobject directory (corresponding to the
top-level directory shown above) &#x2014; is done behind the platform driver
interface.
</p>

<p>
The <code>/sys/devices/</code> directory is, as we&rsquo;ve learned, represents the topology of
currently registered devices on the system.  Accordingly, the directories
associated with platform devices and other non-hot-pluggable parts of the
system will be present here from boot, and stay there.  From my observation,
the <code>/sys/devices/platform/pcspkr/</code> directory will persist even after unloading
the <code>pcspkr</code> module (blacklisting the module and rebooting similarly has no
effect).  However, the <code>driver</code> symlink and the <code>input/</code> subdirectory will both
disappear.  This accords with the fact that (1) no driver is currently bound
to the device, and (2) the device is not currently registered with the input
subsystem.
</p>

<p>
The task expects us, presumably, to create the <code>id</code> file inside
<code>/sys/devices/platform/pcspkr/</code>.  The closest thing to this that we&rsquo;ve tackled
so far was back in <a href="#task-09">task 09</a> &#x2014; we had created our own kobject and with it a
ktype to provide a set of default attributes.  The difference now is that we
need to add an attribute to a kobject that already exists.
</p>

<p>
Is it possible to do this dynamically, such that the new attribute gets its
own show/store methods?  Yes!  (After all, the existing kobject&rsquo;s ktype merely
provides its <i>default</i> attributes.)  And it&rsquo;s quite simple: we call
<code>sysfs_create_file()</code> in our <code>probe()</code> callback, and <code>sysfs_remove_file()</code> in our
<code>remove()</code> callback.  In fact, there is already a helpful code sample at
<code>samples/kobject/kobject-example.c</code> which demonstrates how to declare the
attribute required for such calls.
</p>

<p>
Some miscellanea regarding my patch:
</p>
<ul class="org-ul">
<li>During compilation, GCC 12 was giving me a new warning.  This issue was
resolved by updating the kernel.</li>
<li>I made a few simple scripts for module-testing purposes, which I have
included.  Also, the number of kernels I had installed was starting to
balloon, so I also wrote a Debian-specific uninstall script; a kind of
counterpart to <code class="src src-bash">make modules_install &amp;&amp; make install</code>.  I have given this in the .</li>
<li>To previous implementations of this <code>id</code> file, I have made a couple of fixes.
Firstly, it now accepts as valid input strings with or without a trailing
newline, or anything else beyond the length of the reference string, so long
as the beginning of the string is a match.  Additionally, the string
returned by a <code>read()</code> now includes a newline, such that it prints properly on
a terminal like other sysfs attributes do (fixing the cosmetic issue I
mentioned ).</li>
<li>In the earlier tasks, attributes were defined in a <code>struct attribute</code>.  But in
this case, creation and deletion require a <code>struct kobj_attribute</code>, which
contains an instance of the former.  The reason for this: the latter bundles
in its own &ldquo;show&rdquo; and &ldquo;store&rdquo; methods; the former uses the default ones
provided by the ktype.  There are other wrappers too &#x2014; <code>device_attribute</code>,
<code>bus_attribute</code>, and <code>class_attribute</code> &#x2014; and associated macro-magic necessary
for declaring them.  The idiomatic leading underscores of the <code>__ATTR</code> macro
suggest that it is a helper macro, to be employed only indirectly (despite
the fact that <code>__ATTR</code> is is in fact used directly in the code sample &#x2014;
righteo).  Perhaps I should switch to a <code>struct device_attribute</code> instead?</li>
<li>The first parameter of the <code>*_ATTR</code> family of macros defines the name of the
attribute file.  However, the macro expects this name without quotes.  This
is because certain macros in this family use the name in variable
declarations, in which case the quotes would be a nuisance.  The
<code>__stringify()</code> macro converts it to a string in all other places.</li>
<li>Attribute permissions in sysfs ought to be <code>S_IRUGO | S_IWUSR</code> (or 644 in
octal), i.e. readable by all but writeable only by the owner (root).  The
<code>*_ATTR_RW</code> macro is therefore the one we want to use.</li>
</ul>

<p>
I have included a second version of the patch that incorporates some of these
changes.
</p>
</div>
</div>
</div>
<div id="outline-container-orgdebd19f" class="outline-2">
<h2 id="task-12"><span class="section-number-2">12</span> Task 12</h2>
<div class="outline-text-2" id="text-task-12">
<blockquote>
<p>
Nice job with the driver patch.  That took some work in finding the
proper place to modify, and demonstrates a great skill in tracking down
issues when you can&rsquo;t get a specific piece of hardware working.
</p>

<p>
Now let&rsquo;s step back from drivers (they are boring things), and focus on
the kernel core.  To do that, we need to go way back to the basics &#x2014;
stuff you would learn in your &ldquo;intro to data structures&rdquo; class, if you
happened to take one.
</p>

<p>
Yes, I&rsquo;m talking about linked lists.
</p>

<p>
The kernel has a unique way of creating and handling linked lists, that
is quite different than the &ldquo;textbook&rdquo; way of doing so.  But, it turns
out to be faster, and simpler, than a &ldquo;textbook&rdquo; would describe, so
that&rsquo;s a good thing.
</p>

<p>
For this task, write a kernel module, based on your cleaned up one from
task 04, that does the following:
</p>
<ul class="org-ul">
<li><p>
You have a structure named &ldquo;identity&rdquo; that has 3 fields:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-type">char</span>  <span class="org-variable-name">name</span>[20];
<span class="org-type">int</span>   <span class="org-variable-name">id</span>;
<span class="org-type">bool</span>  <span class="org-variable-name">busy</span>;
</pre>
</div></li>
<li>Your module has a static variable that points to a list of these
&ldquo;identity&rdquo; structures.</li>
<li><p>
Write a function that looks like:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-type">int</span> <span class="org-function-name">identity_create</span>(<span class="org-type">char</span> *<span class="org-variable-name">name</span>, <span class="org-type">int</span> <span class="org-variable-name">id</span>)
</pre>
</div>
<p>
which creates the structure &ldquo;identity&rdquo;, copies in the &ldquo;name&rdquo; and &ldquo;id&rdquo; fields
and sets &ldquo;busy&rdquo; to false.  Proper error checking for out of memory issues is
required.  Return 0 if everything went ok; an error value if something went
wrong.
</p></li>
<li><p>
Write a function that looks like:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">struct</span> <span class="org-type">identity</span> *<span class="org-function-name">identity_find</span>(<span class="org-type">int</span> <span class="org-variable-name">id</span>);
</pre>
</div>
<p>
that takes a given id, iterates over the list of all ids, and returns the
proper &rsquo;struct identity&rsquo; associated with it.  If the identity is not found,
return NULL.
</p></li>
<li><p>
Write a function that looks like:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-type">void</span> <span class="org-function-name">identity_destroy</span>(<span class="org-type">int</span> <span class="org-variable-name">id</span>);
</pre>
</div>
<p>
that given an id, finds the proper &rsquo;struct identity&rsquo; and removes it from the
system.
</p></li>
<li><p>
Your moduleâ€‹_init() function will look much like the following:
</p>
<div class="org-src-container">
<pre class="src src-c">{
    <span class="org-keyword">struct</span> <span class="org-type">identity</span> *<span class="org-variable-name">temp</span>;

    identity_create(<span class="org-string">"Alice"</span>, 1);
    identity_create(<span class="org-string">"Bob"</span>, 2);
    identity_create(<span class="org-string">"Dave"</span>, 3);
    identity_create(<span class="org-string">"Gena"</span>, 10);

    temp = identity_find(3);
    pr_debug(<span class="org-string">"id 3 = %s\n"</span>, temp-&gt;name);

    temp = identity_find(42);
    <span class="org-keyword">if</span> (temp == <span class="org-constant">NULL</span>)
        pr_debug(<span class="org-string">"id 42 not found\n"</span>);

    identity_destroy(2);
    identity_destroy(1);
    identity_destroy(10);
    identity_destroy(42);
    identity_destroy(3);
}
</pre>
</div></li>
</ul>

<p>
Bonus points for properly checking return values of the above functions.
</p>
</blockquote>
</div>
<div id="outline-container-orgd89596d" class="outline-3">
<h3 id="459bf909-97d0-4e70-a002-e9c11ebca950"><span class="section-number-3">12.1</span> Linked lists</h3>
<div class="outline-text-3" id="text-459bf909-97d0-4e70-a002-e9c11ebca950">
<p>
The texts mentioned in the provide very helpful explanations on
how the kernel&rsquo;s linked list implementation works, so I would highly recommend
reading these.  The core list management functions are provided by
<code>include/linux/list.h</code>, and documented <a href="https://docs.kernel.org/core-api/kernel-api.html#list-management-functions">here</a>.  What I will do here is highlight
some key points about how this interface works, and some potential pitfalls:
</p>
<ul class="org-ul">
<li>In most other programming contexts, a linked list implies a list of generic
&ldquo;nodes&rdquo;, each being a wrapper for its associated data (and a pointer to the
next node).  The implementation in the Linux kernel, on the other hand,
inverts this picture &#x2014; the data wraps its associated node.  The &ldquo;node&rdquo; in
this case is a <code>struct list_head</code>, and its dead-simple definition reflects
this &#x2014; it contains just a pair of pointers to the next and previous <code>struct
  list_head</code> objects (lists are circular and doubly-linked).  This inversion
might offend common wisdom regarding encapsulation, but for such a
fundamental kernel data structure, we really need it to be fast.  (And fast
it is!)</li>
<li>There is one special node in every list, called the &ldquo;head&rdquo;.<sup><a id="fnr.53" class="footref" href="#fn.53">53</a></sup>  This node is not associated with any data.
Rather, it is a handle <i>for</i> the list, and represents its start and end.
(Remember that it&rsquo;s circular and doubly-linked!)  The list iterator routines
treat this element as its delimiter.  So one could say that the head element
is a physical, but not logical, member of the list.</li>
<li>If the list is empty, the <code>next</code> and <code>prev</code> pointers of the head just point to
the head itself.</li>
<li>For this reason, any given <code>struct list_head</code> field inside a structure may
signify either:
<ul class="org-ul">
<li>a reference or handle <i>for</i> a list; xor</li>
<li>that the structure may be added <i>to</i> a list.</li>
</ul></li>
<li>As an example, <code>struct task_struct</code>, which is used by the scheduler, contains
a <code>children</code> field and a <code>sibling</code> field.  The <code>children</code> field is a handle for a
list of tasks for which this structure is the parent.  The <code>sibling</code> field is
for linking together tasks that are siblings.  (Thus a list of siblings will
necessarily represent the <code>children</code> list of their common parent.)</li>
<li>Hang on&#x2026; if things are inside-out, then how do we get from a node to the
data structure it is embedded within?  Macro-magic!ðŸª„ The start of the data
structure will always be a constant negative offset from the start of the
node.  The <code>container_of()</code> macro calculates and applies this offset at
compile-time.</li>
<li>Lists and list routines don&rsquo;t come with free locking; that&rsquo;s up to us.</li>
<li>If we&rsquo;re deleting a node during list iteration, we must use a <code>*_safe</code> macro
to avoid a use-after-free.</li>
</ul>
</div>
</div>
<div id="outline-container-org10d300f" class="outline-3">
<h3 id="57afe223-be49-4bd7-9591-7aa677fa8cdf"><span class="section-number-3">12.2</span> Dynamic debug</h3>
<div class="outline-text-3" id="text-57afe223-be49-4bd7-9591-7aa677fa8cdf">
<p>
The example init code given in the task description uses the <code>pr_debug()</code> macro
to print messages at loglevel <code>KERN_DEBUG</code>.  If the kernel has
<code>CONFIG_DYNAMIC_DEBUG</code> enabled (which mine did), then such messages will be
disabled, that is, not printed to the kernel log at all (regardless of what
the console loglevel is set to).  We can selectively enable individual logging
calls via <code>/sys/kernel/debug/dynamic_debug/control</code>.
</p>

<p>
Reading from this file will list all debug logging calls within the kernel
source tree (for code that&rsquo;s actually loaded):
</p>
<div class="org-src-container">
<pre class="src src-bash">cat /sys/kernel/debug/dynamic_debug/control
</pre>
</div>
<p>
We can enable these debug logging calls piecemeal.  To enable all of them for
our module in particular:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-builtin">echo</span> <span class="org-string">'module linked_list_example +p'</span> &gt; /sys/kernel/debug/dynamic_debug/control
</pre>
</div>

<p>
However, this will most likely miss out on logging calls that occur during
module init.  To enable them immediately at module load time, we can invoke
modprobe like so:
</p>
<div class="org-src-container">
<pre class="src src-bash">modprobe linked_list_example <span class="org-variable-name">dyndbg</span>==p
</pre>
</div>

<p>
Read <a href="https://www.kernel.org/doc/html/latest/admin-guide/dynamic-debug-howto.html">here</a> for more information on how to use this feature.
</p>
</div>
</div>
<div id="outline-container-org0016454" class="outline-3">
<h3 id="de624811-3fef-4e50-86ce-73058ece10be"><span class="section-number-3">12.3</span> Additional remarks</h3>
<div class="outline-text-3" id="text-de624811-3fef-4e50-86ce-73058ece10be">
<p>
In the implementation of <code>identity_destroy()</code>, one could perhaps call
<code>identity_find()</code> to fetch the reference to the element to be deleted.  However,
my implementation does this iteration itself, but with the
<code>list_for_each_entry_safe</code> macro.  This is because my <code>identity_create()</code> function
doesn&rsquo;t bother checking for duplicate IDs &#x2014; if there are multiple, then all
will be deleted.  If we didn&rsquo;t use the safe variant of this macro, then the
iterator would fail in attempting to hop to the next node (use-after-free).
If we only had to delete the first matching element found, then reusing
<code>identity_find()</code> would be perfectly appropriate.
</p>

<p>
Upon reading <a href="https://lwn.net/Articles/905777/">this LWN.net article</a>, I realise it&rsquo;s probably not wise to use
<code>strncpy()</code> in my <code>identity_create()</code> function.  Specifically, <code>strncpy()</code> won&rsquo;t
null-terminate <code>dest</code> if <code>src</code> is longer than <code>n</code>.  This pitfall is avoided by
<code>strlcpy()</code>.  However, both functions can break if <code>src</code> is not properly
null-terminated.  I really ought to use <code>strscpy()</code> in future to avoid both
these problems.<sup><a id="fnr.54" class="footref" href="#fn.54">54</a></sup>
</p>

<p>
Also, I have no idea what the &ldquo;busy&rdquo; flag in <code>struct identity</code> was intended for.
</p>
</div>
</div>
</div>
<div id="outline-container-org74ce352" class="outline-2">
<h2 id="task-13"><span class="section-number-2">13</span> Task 13</h2>
<div class="outline-text-2" id="text-task-13">
<blockquote>
<p>
Weren&rsquo;t those lists fun to play with?  You should get used to them, they are
used all over the kernel in lots of different places.
</p>

<p>
Now that we are allocating a structure that we want to use a lot of, we might
want to start caring about the speed of the allocation, and not have to worry
about the creation of those objects from the &ldquo;general&rdquo; memory pools of the
kernel.
</p>

<p>
This task is to take the code written in task 12, and cause all memory
allocated from the <code>struct identity</code> to come from a private slab cache just for
the fun of it.
</p>

<p>
Instead of using <code>kmalloc()</code> and <code>kfree()</code> in the module, use <code>kmem_cache_alloc()</code>
and <code>kmem_cache_free()</code> instead.  Of course this means you will have to
initialize your memory cache properly when the module starts up.  Don&rsquo;t forget
to do that.  You are free to name your memory cache whatever you wish, but it
should show up in the <code>/proc/slabinfo</code> file.
</p>

<p>
Don&rsquo;t send the full module for this task, only a patch with the diff from task
12 showing the lines changed.  This means you will have to keep a copy of your
12 task results somewhere to make sure you don&rsquo;t overwrite them.
</p>

<p>
Also show the output of <code>/proc/slabinfo</code> with your module loaded.
</p>
</blockquote>
</div>
<div id="outline-container-org1dae49c" class="outline-3">
<h3 id="c0314dff-4d49-485b-bd4b-2664baa3d5e9"><span class="section-number-3">13.1</span> The slab layer</h3>
<div class="outline-text-3" id="text-c0314dff-4d49-485b-bd4b-2664baa3d5e9">
<p>
As for , I&rsquo;ll just mention the most salient details here.
</p>

<p>
In low-level programming, a common pattern employed when one needs to allocate
many same-size objects is to allocate a giant chunk of contiguous memory
up-front, and manage it oneself with a <a href="https://en.wikipedia.org/wiki/Free_list">free list</a>.  (I&rsquo;ve seen various terms
for this pattern: arena allocator, block allocator, lookaside cache, memory
pool, etc.)  The advantages of this are:
</p>
<ul class="org-ul">
<li>it&rsquo;s faster/cheaper than calls to malloc/free;</li>
<li>we can make smarter use of memory (avoids fragmentation, alignment-aware);
and</li>
<li>freed objects get immediately re-used for the next allocation while they&rsquo;re
still &ldquo;cache hot&rdquo;.</li>
</ul>

<p>
The raison d&rsquo;Ãªtre of the kernel&rsquo;s slab layer is to implement this pattern on
our behalf, for arbitrarily-sized data structures.
</p>

<p>
The core slab layer functions are provided by <code>include/linux/slab.h</code>, and
documented <a href="https://docs.kernel.org/core-api/mm-api.html#the-slab-cache">here</a>.
</p>

<p>
A word on nomenclature:
</p>
<ul class="org-ul">
<li>The slab layer creates and organises individual <i>caches</i>.  There is one cache
per type of object, and one type of object per cache.  For example, there is
a cache specifically for all inode objects called <code>inode_cachep</code>.  Each cache
is represented by a <code>struct kmem_cache</code> (the thing returned by a call to
<code>kmem_cache_alloc()</code>).</li>
<li>Caches internally consist of <i>slabs</i>.  Each slab is composed of one or more
contiguous pages (though often just a single page).  A cache may have
multiple slabs (marked either &ldquo;full&rdquo;, &ldquo;partial&rdquo;, or &ldquo;empty&rdquo;), and new slabs
are added as needed.  Each slab is represented by a <code>struct slab</code>.</li>
</ul>

<p>
Aside from making our life easier, there are additional benefits to having
a standardised kernel implementation of this pattern:
</p>
<ul class="org-ul">
<li>The kernel keeps track of, and may reclaim memory from, the slab caches.</li>
<li>The allocator can make more intelligent decisions if it knows the object
size, cache size, and page size.</li>
<li>The kernel is aware of, and can leverage, <a href="https://en.wikipedia.org/wiki/Non-uniform_memory_access">non-uniform memory access (NUMA)</a>.</li>
<li>The kernel can implement <a href="https://en.wikipedia.org/wiki/Cache_coloring">cache colouring</a> to cut down on cache contention.</li>
<li>Where different slab caches share the same block size, they can be
shared/aliased behind the scenes.</li>
</ul>

<p>
Interestingly, kmalloc itself uses a family of general purpose slab caches
behind the scenes (which is probably why it is declared in <code>linux/slab.h</code>).
</p>

<p>
Something I noticed during this task was that my new slab cache was not
showing up in <code>/proc/slabinfo</code>.  I was led to believe that the <code>name</code> parameter of
<code>kmem_cache_alloc()</code> (for which one usually just gives the name of the struct
type being allocated) would show up in <code>/proc/slabinfo</code>, but it did not.
Another view is presented in <code>/sys/kernel/slab/</code>, where it <i>did</i> show up.  As
stated, slab caches of the same block size may be merged, which is evidently
where these two representations differ.  In <code>/sys/kernel/slab/</code>, the names of
slab caches are represented by symlinks, and these can alias to the same
underlying slab cache.  (The name of my slab cache, for example, symlinked to
<code>/sys/kernel/slab/:0000048/</code>.)
</p>
</div>
</div>
</div>
<div id="outline-container-orgaa1b9ac" class="outline-2">
<h2 id="task-14"><span class="section-number-2">14</span> Task 14</h2>
<div class="outline-text-2" id="text-task-14">
<blockquote>
<p>
Now that you have the basics of lists, and we glossed over the custom
allocators (the first cut at that task was much harder, you got off
easy), it&rsquo;s time to move on to something a bit more old-school: tasks.
</p>

<p>
For this task:
</p>
<ul class="org-ul">
<li>Add a new field to the core kernel task structure called, wait for it, &ldquo;id&rdquo;.</li>
<li>When the task is created, set the id to your id.  Imaginative, I know.  You
try writing these tasks.</li>
<li>Add a new proc file for every task called, &ldquo;id&rdquo;, located in the
<code>/proc/${PID}/</code> directory for that task.</li>
<li>When the proc file is read from, have it print out the value of your id, and
then increment it by one, allowing different tasks to have different values
for the &ldquo;id&rdquo; file over time as they are read from.</li>
<li>Provide some &ldquo;proof&rdquo; it all works properly.</li>
</ul>

<p>
As you are touching files all over the kernel tree, a patch is the required
result to be sent in here.  Please specify which kernel version you make this
patch against, to give my virtual machines a chance to figure out how to apply
it.
</p>

<p>
Also provide some kind of proof that you tested the patch.
</p>
</blockquote>

<p>
These days, sysfs is regarded as the more appropriate place to expose new
kernel mechanisms and data to user-space.  Nevertheless, I found this task to
be a fun learning experience.
</p>

<p>
A brief overview of <code>/proc/</code> can be seen in the .  The <code>/proc/${PID}/</code>
directories in particular contain a bunch of files, so it would make sense to
sniff out where, and how, those files are created.  My first instinct was to
look to where a new process is born.  To do that, I need to take another brief
digression.
</p>
</div>
<div id="outline-container-orge8a6455" class="outline-3">
<h3 id="a1202bce-7d58-4703-8b86-80a732a04a53"><span class="section-number-3">14.1</span> Tasks and task structs</h3>
<div class="outline-text-3" id="text-a1202bce-7d58-4703-8b86-80a732a04a53">
<p>
The basic unit of the scheduler is <code>struct task_struct</code> (see
<code>include/linux/sched.h</code>).  What we call processes and threads, the kernel
collectively calls tasks.  (Linux makes no nominal distinction between
processes and threads; they&rsquo;re just tasks with different properties.)  Each
task object contains information such as execution state, open files, pending
signals, memory mappings, and so on.  The scheduler maintains a task list,
which constitutes a record of live tasks and the various states of execution
they are in.
</p>

<p>
Basic task control is performed via the syscalls <code>clone()</code> (of which <code>fork()</code> is a
wrapper), <code>execve()</code>, and <code>exit()</code>.  A typical process is created with a
fork/clone and then an execve to replace its execution context with that of
the new executable program.  The exit syscall is self-explanatory.
</p>

<p>
The bulk of the work of cloning a process is <code>kernel_clone()</code>, and by extension
<code>copy_process()</code> (see <code>kernel/fork.c</code>).  What resources are (not) shared with the
original task will depend on a variety of flags.
</p>

<p>
The inverse operation of task termination is performed by <code>do_exit()</code> (see
<code>kernel/exit.c</code>).  Since the execution context is being terminated, this
function never returns.  Much cleaning-up and accounting work also happens
here.
</p>

<p>
I would highly recommend reading <a href="#fb318868-a843-4e6c-8483-db73d832b726">LKD</a> to get a more detailed account of how
tasks work.  This topic receives much less attention in <a href="#fb318868-a843-4e6c-8483-db73d832b726">LDD</a>, as tasks aren&rsquo;t
of concern to most device drivers.
</p>
</div>
</div>
<div id="outline-container-org1d371c1" class="outline-3">
<h3 id="ee25c264-b261-4a1e-b314-a06bc3932284"><span class="section-number-3">14.2</span> Procfs and tracing through a fork</h3>
<div class="outline-text-3" id="text-ee25c264-b261-4a1e-b314-a06bc3932284">
<p>
Procfs files are more or less a combination of a name and a set of file
operations, much like sysfs attributes.
</p>

<p>
To create them, a couple of interfaces are available.  One uses the typical
<code>struct file_operations</code> object we&rsquo;ve encountered before.  The other uses the
<a href="https://docs.kernel.org/filesystems/seq_file.html"><code>seq_file</code></a> interface, which wraps file access behind a kind of iterator
interface, which makes writing the accessor methods a bit easier and less
error-prone (particularly where large amounts of data are changing hands).
</p>

<p>
But let&rsquo;s not get ahead of ourselves.  As stated, the <code>/proc/${PID}/</code>
directories already contain a bunch of files (these are documentated in the
link above).  This task might be as simple as copying existing code and making
the necessary task-specific changes to it.
</p>

<p>
I wasted some time looking through <code>kernel_clone()</code>, <code>copy_process()</code>, and
<code>dup_task_struct()</code> &#x2014; as it turns out, there isn&rsquo;t really anything resembling
a registration of procfs resources.  There&rsquo;s no kobject-like data structure
that represents individuals PID subdirectories or their files, but rather,
they are presented to user-space on-the-fly (see <code>fs/proc/base.c</code>).  By
&ldquo;on-the-fly&rdquo; I mean that the subdirectories associated with each process ID do
no &ldquo;exist&rdquo; in <code>/proc/</code> prior to the moment you run <code class="src src-bash">ls /proc/</code>.  Perhaps this is the smarter approach; unlike devices, new tasks are
constantly spawning and disappearing, and having to register/unregister a data
structure silently in the background each time would be wasteful.
</p>

<p>
Grepping <code>fs/proc/base.c</code> for some of the nodes that show up in PID
subdirectories lead me to this big table:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">pid_entry</span> <span class="org-variable-name">tgid_base_stuff</span>[] = {
        DIR(<span class="org-string">"task"</span>,       S_IRUGO|S_IXUGO, proc_task_inode_operations, proc_task_operations),
        DIR(<span class="org-string">"fd"</span>,         S_IRUSR|S_IXUSR, proc_fd_inode_operations, proc_fd_operations),
        DIR(<span class="org-string">"map_files"</span>,  S_IRUSR|S_IXUSR, proc_map_files_inode_operations, proc_map_files_operations),
        DIR(<span class="org-string">"fdinfo"</span>,     S_IRUGO|S_IXUGO, proc_fdinfo_inode_operations, proc_fdinfo_operations),
        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * ...</span>
<span class="org-comment-delimiter">         */</span>
        REG(<span class="org-string">"cmdline"</span>,    S_IRUGO, proc_pid_cmdline_ops),
        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * ...</span>
<span class="org-comment-delimiter">         */</span>
        REG(<span class="org-string">"mem"</span>,        S_IRUSR|S_IWUSR, proc_mem_operations),
        LNK(<span class="org-string">"cwd"</span>,        proc_cwd_link),
        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * ...</span>
<span class="org-comment-delimiter">         */</span>
        ONE(<span class="org-string">"oom_score"</span>, S_IRUGO, proc_oom_score),
        REG(<span class="org-string">"oom_adj"</span>,   S_IRUGO|S_IWUSR, proc_oom_adj_operations),
        REG(<span class="org-string">"oom_score_adj"</span>, S_IRUGO|S_IWUSR, proc_oom_score_adj_operations),
        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * ...</span>
<span class="org-comment-delimiter">         */</span>
}
</pre>
</div>

<p>
Names and file ops &#x2014; that&rsquo;s what we were after!  The different helper macros
used here &#x2014; <code>DIR()</code>, <code>REG()</code>, <code>ONE()</code>, and <code>LNK()</code> &#x2014; define different kinds of PID
entries.  The <code>ONE()</code> macro, for example, defines a simple read-only file, which
requires only a single &ldquo;show&rdquo; callback.
</p>

<p>
The prototype for the &ldquo;show&rdquo; callback we&rsquo;ll need to implement looks like this:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-type">int</span> (*<span class="org-function-name">proc_show</span>)(<span class="org-keyword">struct</span> <span class="org-type">seq_file</span> *<span class="org-variable-name">m</span>,
                 <span class="org-keyword">struct</span> <span class="org-type">pid_namespace</span> *<span class="org-variable-name">ns</span>,
                 <span class="org-keyword">struct</span> <span class="org-type">pid</span> *<span class="org-variable-name">pid</span>,
                 <span class="org-keyword">struct</span> <span class="org-type">task_struct</span> *<span class="org-variable-name">task</span>);
</pre>
</div>
<p>
Our callback won&rsquo;t be much more complicated than this one for the <code>oom_score</code>
entry:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">proc_oom_score</span>(<span class="org-keyword">struct</span> <span class="org-type">seq_file</span> *<span class="org-variable-name">m</span>,
                          <span class="org-keyword">struct</span> <span class="org-type">pid_namespace</span> *<span class="org-variable-name">ns</span>,
                          <span class="org-keyword">struct</span> <span class="org-type">pid</span> *<span class="org-variable-name">pid</span>,
                          <span class="org-keyword">struct</span> <span class="org-type">task_struct</span> *<span class="org-variable-name">task</span>)
{
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">points</span> = 0;

        <span class="org-comment-delimiter">/* </span>
<span class="org-comment">         * calculates the OOM score</span>
<span class="org-comment">         * ...</span>
<span class="org-comment-delimiter">         */</span>

        <span class="org-function-name">seq_printf</span>(m, <span class="org-string">"%lu\n"</span>, points);

        <span class="org-keyword">return</span> 0;
}
</pre>
</div>

<p>
Note that our implementation won&rsquo;t need to check the task pointer for NULL;
the function is invoked from <code>proc_single_show()</code>, which already performs this
check.
</p>
</div>
</div>
<div id="outline-container-org5de0a53" class="outline-3">
<h3 id="20d257c6-777e-4aa7-b727-800100607fd5"><span class="section-number-3">14.3</span> Writing the patch</h3>
<div class="outline-text-3" id="text-20d257c6-777e-4aa7-b727-800100607fd5">
<p>
With the preliminary work out of the way, the task becomes dead simple:
</p>
<ul class="org-ul">
<li>add an integer field to the task struct definition</li>
<li>initialise this variable when new tasks are born</li>
<li>write the callback</li>
<li>add an entry to the pid entry table</li>
</ul>

<p>
I decided to initialise this value in <code>kernel/fork.c::dup_task_struct()</code>.  This
code path applies to all processes except for PID 1 (the init process), so for
completeness I added another line to <code>init/init_task.c::init_task()</code>.
</p>

<p>
In retrospect, I should have defined this variable as <code>unsigned long long</code>
rather than <code>unsigned long</code>, as the latter isn&rsquo;t guaranteed to be wide enough to
store a 64-bit value.  It&rsquo;s no big deal if the value is truncated, but the
compiler might throw a warning if we were compiling on a 32-bit arch.
</p>
</div>
</div>
</div>
<div id="outline-container-org1a634d1" class="outline-2">
<h2 id="task-15"><span class="section-number-2">15</span> Task 15</h2>
<div class="outline-text-2" id="text-task-15">
<blockquote>
<p>
That process task turned out to not be all that complex, but digging
through the core kernel was a tough task, nice work with that.
</p>

<p>
Speaking of &ldquo;core kernel&rdquo; tasks, let&rsquo;s do another one.  It&rsquo;s one of the most
common undergraduate tasks there is: create a new syscall!  Yeah, loads of
fun, but it&rsquo;s good to know the basics of how to do this, and, how to call it
from user-space.
</p>

<p>
For this task:
</p>
<ul class="org-ul">
<li>Add a new syscall to the kernel called <code>sys_eudyptula</code>, so this is all going
to be changes to the kernel tree itself, no stand-alone module needed for
this task (unless you want to do it that way without hacking around the
syscall table, if so, bonus points for you&#x2026;)</li>
<li>The syscall number needs to be the next syscall number for the architecture
you test it on (some of you all are doing this on ARM systems, showoffs, and
syscall numbers are not the same across all architectures).  Document the
arch you are using and why you picked this number in the module.</li>
<li>The syscall should take two parameters: <code>int high_id</code>, <code>int low_id</code>.</li>
<li>The syscall will take the two values, mush them together into one 64-bit
value (<code>low_id</code> being the lower 32 bits of the id, <code>high_id</code> being the upper
32 bits of the id).</li>
<li>If the id value matches your id, then the syscall returns success.
Otherwise it returns a return code signifying an invalid value was passed to
it.</li>
<li>Write a user-space C program that calls the syscall and properly exercises it
(valid and invalid calls need to be made).</li>
<li>&ldquo;Proof&rdquo; of running the code needs to be provided.</li>
</ul>

<p>
So you need to send in a <code>.c</code> user-space program, a kernel patch, and &ldquo;proof&rdquo;
that it all works, as a response.
</p>
</blockquote>

<p>
Ooh, this looks like fun!  I&rsquo;m going to start with chapter 5 of ; hopefully
the details haven&rsquo;t changed <i>too</i> much since 2.6.32.
</p>
</div>
<div id="outline-container-org336939e" class="outline-3">
<h3 id="588ee577-5c47-4944-aa44-5e324a8a2a72"><span class="section-number-3">15.1</span> System calls</h3>
<div class="outline-text-3" id="text-588ee577-5c47-4944-aa44-5e324a8a2a72">
<p>
As with <code>/proc/</code>, we&rsquo;re unlikely to find ourselves adding new system calls to
the kernel, but this is nevertheless a worthwhile exercise.
</p>

<p>
System calls are a particular kind of processor exception; a software
interrupt.  This refers to interrupts triggered by a special instruction
rather than by external hardware, for example, <code>int $80</code> on x86, or <code>syscall</code> on
x86-64.  Setting aside processor exceptions (traps/faults/aborts), this is
user-mode&rsquo;s only entry point into the kernel.  The number of system calls
available on Linux depends on the architecture, but generally numbers in the
hundreds (e.g. ~350 on x86-64).  Since the mechanism by which software
interrupts are triggered is architecture-specific, code responsible for
syscall handling is kept separate from the syscall functions themselves.
</p>

<p>
Arguments and return values associated with syscalls are communicated entirely
via registers.  On x86 for example, <code>eax</code> holds the syscall number upon entry,
and the return value upon exit.  Usually, user-space will invoke a syscall via
a low-level library rather than messing with registers directly.<sup><a id="fnr.55" class="footref" href="#fn.55">55</a></sup>  In fact, the Unix family of syscalls are fairly close to
POSIX; many library functions will have an analogous counterpart in the list
of syscalls, <code>read()</code> being a prime example (compare <a href="https://man7.org/linux/man-pages/man2/read.2.html">read(2)</a> and <a href="https://man7.org/linux/man-pages/man3/read.3p.html">read(3p)</a>).
</p>
</div>
</div>
<div id="outline-container-org25f786c" class="outline-3">
<h3 id="8913729c-5b47-4710-bfb0-30fa1c9bd9f3"><span class="section-number-3">15.2</span> Syscalls in the kernel</h3>
<div class="outline-text-3" id="text-8913729c-5b47-4710-bfb0-30fa1c9bd9f3">
<p>
Syscalls are defined with the <code>SYSCALL_DEFINE[0-6]</code> series of macros from
<code>include/linux/syscalls.h</code>.  One can see several such definitions in, for
example, <code>kernel/sys.c</code>.
</p>

<p>
For example, <code>SYSCALL_DEFINE0(getpid)</code> is the beginning of a function
declaration which has no parameters.  This expands to <code>asmlinkage long
sys_getpid(void)</code> (convention is for all syscall function names to be prepended
with <code>sys_*</code>).
</p>

<p>
The <code>asmlinkage</code> attribute tells the compiler that the function, because it is
being called from assembly, needs to assume a specific ABI/calling convention
&#x2014; in this case, that arguments are passed on the stack (the kernel stack;
we&rsquo;re in kernel-space at this point) &#x2014; rather than business as usual (most
of the time, the general-purpose registers are used to pass arguments).  Why
is this necessary?  The ABI for syscalls, as they involve a transition from
user- to kernel-mode, cannot follow normal calling conventions.  Likewise,
some intermediate work with regard to the preservation of registers must be
done between entering kernel-mode and calling the matched <code>sysâ€‹_*</code> function.
Presumably it is this transition that the <code>asmlinkage</code> directive accomodates,
though there are likely finer subtleties to this that I can&rsquo;t speak to.
</p>

<p>
Along with this definition, an entry must be added to the arch-specific
syscall table.  The data structure that maps syscall numbers to their
respective functions, <code>sys_call_table</code>, lives in an arch-specific location
(e.g. <code>arch/arm64/kernel/sys.c</code>, <code>arch/x86/entry/syscall_64.c</code>).  We add our
syscall to this table indirectly by adding an entry to the <code>.tbl</code> file (e.g.,
<code>arch/x86/entry/syscalls/syscall_{32,64}.tbl</code>).
</p>

<p>
A few other random things:
</p>
<ul class="org-ul">
<li>Syscall functions run in process-context, so it is safe to use the <code>current</code>
macro (a special arch-specific macro that fetches the <code>task_struct</code> of the
current task).</li>
<li>Syscalls must be reentrant.  Reentrancy means it can be safely interleaved
in the middle of execution (whether due to preemption or to functions that
the code itself is calling), such that after resumption of execution, <i>all
global or static non-const data</i> was left in a consistent state.  Note that
the concept of reentrancy differs subtly from the concept of <i>thread-safety</i>,
that references to all shared resources are serialised.  It is possible for
a function to not be reentrant, even in non-multithreaded, non-preemptible
systems; <i>usually</i> thread-safety comes free with reentrancy, but not always.
Avoiding global or static non-const resources altogether guarantees
reentrancy; avoiding shared resources altogether guarantees thread-safety.</li>
<li>Unused syscall numbers in the syscall table fall through to
<code>sys_ni_syscall()</code>, effectively a no-op that returns <code>ENOSYS</code> (&ldquo;invalid
syscall&rdquo;).</li>
</ul>
</div>
</div>
<div id="outline-container-org4af5e1f" class="outline-3">
<h3 id="0c51f5cf-4b22-4fba-a337-e7abee802d82"><span class="section-number-3">15.3</span> Adding the new syscall</h3>
<div class="outline-text-3" id="text-0c51f5cf-4b22-4fba-a337-e7abee802d82">
<p>
Where is <i>our</i> new syscall is supposed to go?  Since mine is intended for
x86-64, and <i>only</i> x86-64, I need to add an entry to <code>syscall_64.tbl</code>.
</p>

<p>
The ABI specifier we use here must be &ldquo;64&rdquo;.  The &ldquo;x32&rdquo; specifier otherwise
indicates a syscall for x32<sup><a id="fnr.56" class="footref" href="#fn.56">56</a></sup> binaries, while &ldquo;common&rdquo; indicates an implementation shared
to both.
</p>

<p>
Where is our syscall function implementation to go?  Originally, I had placed
mine in <code>kernel/sys.c</code>, however, given that mine is architecture-specific, a
better place is probably in <code>arch/x86/</code> somewhere.  I ended up placing it in its
own file, <code>arch/x86/kernel/eudyptula_64.c</code> (thus I also had to add an entry to
<code>arch/x86/kernel/Makefile</code> so that it would be built by Kbuild).
</p>

<p>
To go the extra mile, we should probably also export the string constant/magic
number to a user-space header, <code>arch/x86/include/uapi/asm/eudyptula_64.h</code>, and
pull that into the kernel-space header at <code>arch/x86/include/asm/eudyptula_64.h</code>.
</p>
</div>
</div>
<div id="outline-container-orgb810ebb" class="outline-3">
<h3 id="843a8751-401b-43a1-9c25-803c899aa48d"><span class="section-number-3">15.4</span> Testing our new syscall</h3>
<div class="outline-text-3" id="text-843a8751-401b-43a1-9c25-803c899aa48d">
<p>
Our new syscall is undocumented, and libc obviously doesn&rsquo;t provide any sort
of wrapper for it.  However, invoking syscalls manually is quite easy.  The
<a href="https://man7.org/linux/man-pages/man2/syscall.2.html">manpage for syscall(2)</a> has a helpful code example:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;unistd.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;sys/syscall.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;sys/types.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;signal.h&gt;</span>

<span class="org-type">int</span> <span class="org-function-name">main</span>(<span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span> *<span class="org-variable-name">argv</span>[])
{
        <span class="org-type">pid_t</span> <span class="org-variable-name">tid</span>;

        tid = syscall(SYS_gettid);
        syscall(SYS_tgkill, getpid(), tid, SIGHUP);
}
</pre>
</div>

<p>
The <code>syscall()</code> macro sets up the register contents &#x2014; part of this is to move
the syscall number into <code>%rax</code> &#x2014; and executes the <code>syscall</code> instruction.  It&rsquo;s
up to us to provide the correct number, and type, of arguments.
</p>

<p>
When compile the kernel, a definition for our syscall number will be added to
the user-space kernel headers.  We can install these on our system like
so:
</p>
<div class="org-src-container">
<pre class="src src-bash">make <span class="org-variable-name">INSTALL_HDR_PATH</span>=<span class="org-string">"/usr/local"</span> headers_install
</pre>
</div>

<p>
If we did so, and the preprocessor is looking in the right place (check with
<code>cpp -v</code>), then <code>sys/syscall.h</code> should contain the definition for our new syscall
number, <code>__NR_eudyptula</code>.
</p>

<p>
(Though most likely benign, you&rsquo;ll probably want to reinstall the original
headers once you&rsquo;re done with this task to get rid of this definition.
Alternatively, you can skip all this and just define the syscall number
locally in a bespoke header file.)
</p>

<p>
Running <a href="https://en.wikipedia.org/wiki/Strace"><code>strace</code></a> on the test program produced the following:
</p>
<div class="org-src-container">
<pre class="src src-text">[...]
syscall_0x1c3(0xbeefbad, 0xb0ba900d, 0x7fe30ee72718, 0x7fe30ee73d80, 0x7fe30ee73d80, 0x7fff13a89dc8) = 0
syscall_0x1c3(0, 0, 0x7fe30edaaf59, 0x7fe30ee73d80, 0x7fff13a89dc8, 0x7fff13a89dc8) = -1 EINVAL (Invalid argument)
[...]
</pre>
</div>
<p>
Since our syscall is not known to <code>strace</code>, the syscall is &ldquo;printed raw, with
the unknown system call number printed in hexadecimal form and prefixed with
<code>syscall_*</code>.&rdquo;  The value &ldquo;0x1c3&rdquo; is indeed the number of our syscall (451 in
decimal).  Similarly, it doesn&rsquo;t know how many parameters there are, so it
just prints out the first six (from where they would normally be in the
registers).  As you can see, the registers for the first two arguments are
filled with the high and low bytes of the ID; registers for arguments 3&#x2013;6 are
filled with junk.
</p>

<p>
Some final remarks:
</p>
<ul class="org-ul">
<li>Prototypes for arch-independent syscalls are given explicitly in
<code>include/linux/syscalls.h</code>.  These are provided, not for calling from within
the kernel, but rather &ldquo;for information purposes, for static analysis, and
for linking from the syscall table&rdquo;.  Since our syscall is arch-specific, we
probably don&rsquo;t need to add its prototype here.  (There <i>is</i> a small section
lower in this file titled &ldquo;Architecture-specific system calls&rdquo;, but this
section contains only a few prototypes, certainly not an exhaustive account
of <i>all</i> arch-specific syscalls.  The top of the file nevertheless says that
it concerns &ldquo;non-arch-specific&rdquo; syscalls.  I can only guess that these
arch-specific prototypes were added to the file at will.)</li>
<li>Perhaps my syscall function should be using <code>uint32_t</code> instead of <code>int</code>, since
<code>int</code> isn&rsquo;t guaranteed to be 32 bits wide.  However, this syscall is 64-bit
only anyway.  Plus, Linux doesn&rsquo;t run on anything less than 32-bit (the
syscall arguments are of type <code>int</code> too).  This probably doesn&rsquo;t matter.</li>
<li>I forgot to do this, but since this is a 64-bit syscall, the makefile entry
that adds <code>eudyptula_64.o</code> as a prerequisite to the build ought to depend on
<code>CONFIG_X86_64</code>.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2dd3e7a" class="outline-2">
<h2 id="task-16"><span class="section-number-2">16</span> Task 16</h2>
<div class="outline-text-2" id="text-task-16">
<blockquote>
<p>
Good job with the new syscall.  The odds of you ever having to write a new
syscall is pretty rare, but now you know where to look them up, and what the
code involved in creating one looks like, which is useful when you try to
debug things.
</p>

<p>
Let&rsquo;s take a breather after all of that code, and go back to doing a bit
of reading, and learn some more about some common kernel tools.
</p>

<p>
Go install the tool &ldquo;sparse&rdquo;.  It was started by Linus as a static-analysis
tool that acts much like a compiler.  The kernel build system is set up to
have it run if you ask it to, and it will report a bunch of issues in C code
that are really specific to the kernel.
</p>

<p>
When you build the kernel, pass the <code>C=1</code> option to the build, to have sparse
run on the <code>.c</code> file before gcc is run.  Depending on the file, nothing might be
printed out, or something might.  Here&rsquo;s an example of it being run on the
ext4 code:
</p>

<div class="org-src-container">
<pre class="src src-text">$ make C=1 M=fs/ext4
  CHECK   fs/ext4/balloc.c
  CC      fs/ext4/balloc.o
  CHECK   fs/ext4/bitmap.c
  CC      fs/ext4/bitmap.o
[...]  
  CHECK   fs/ext4/migrate.c
  CC      fs/ext4/migrate.o
  CHECK   fs/ext4/mballoc.c
fs/ext4/mballoc.c:5018:9: warning: context imbalance in 'ext4_trim_extent' - unexpected unlock
  CC      fs/ext4/mballoc.o
  CHECK   fs/ext4/block_validity.c
  CC      fs/ext4/block_validity.o
[...]
  CHECK   fs/ext4/acl.c
  CC      fs/ext4/acl.o
  CHECK   fs/ext4/xattr_security.c
  CC      fs/ext4/xattr_security.o
  LD      fs/ext4/ext4.o
  LD      fs/ext4/built-in.o
  Building modules, stage 2.
  MODPOST 0 modules
</pre>
</div>

<p>
As you can see, only one warning was found here, and odds are, it is a
false-positive, as I&rsquo;m sure those ext4 developers know what they are doing
with their locking functions, right?
</p>

<p>
Anyway the task this time is:
</p>
<ul class="org-ul">
<li>Run sparse on the <code>drivers/staging/</code> directory, yes, that horrible code again,
sorry.</li>
<li>Find one warning that looks interesting.</li>
<li>Write a patch that resolves the issue.</li>
<li>Make sure the patch is correct by running it through <code>scripts/checkpatch.pl</code></li>
<li>Submit the code to the maintainer of the driver/subsystem, finding the
proper name and mailing lists to send it to by running the tool,
<code>scripts/getâ€‹_maintainer.pl</code> on your patch.</li>
<li>Send a web link back to me of your patch in the public mailing list archive
(don&rsquo;t cc: me on the patch, that will only confuse me and everyone in the
kernel development community.)</li>
<li>If you want to mention the Eudyptula Challenge as the reason for writing the
patch, feel free to do so in the body of the patch, but it&rsquo;s not necessary
at all.</li>
</ul>

<p>
That&rsquo;s it, much like task 10 was, but this time you are fixing logical issues,
not just pesky coding style issues.  You are a real developer now, fixing real
bugs!
</p>
</blockquote>

<p>
Possibly, issues identitied by sparse are a bit more substantial than the
kinds of coding style issues we looked at previously, but let&rsquo;s have a look.
</p>
</div>
<div id="outline-container-orga6a4a1a" class="outline-3">
<h3 id="e174e541-7e7c-4077-956a-217cb3c4154d"><span class="section-number-3">16.1</span> Sparse in more detail</h3>
<div class="outline-text-3" id="text-e174e541-7e7c-4077-956a-217cb3c4154d">
<p>
I mentioned sparse briefly back in .  The primary sources of
documentation for sparse seem to be <a href="https://sparse.docs.kernel.org/en/latest/">here</a> and <a href="https://www.kernel.org/doc/html/latest/dev-tools/sparse.html">here</a>.  The <a href="https://man7.org/linux/man-pages/man1/sparse.1.html">sparse manpage</a> also
explains various flags (which we can override using the <code>CF</code> make variable).
</p>

<p>
Sparse has two major components:
</p>
<ul class="org-ul">
<li>a generic parse tree library, which is used to build an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a> representation
of the code (like any compiler would); and</li>
<li>a tool for running checkers on this AST, which are tailored to the specifics
of the Linux kernel.</li>
</ul>

<p>
When we use <code>C=1</code><sup><a id="fnr.57" class="footref" href="#fn.57">57</a></sup> to
invoke sparse, the <code>__CHECKER__</code> preprocessor symbol gets enabled.  The result
of this is that various annotations scattered throughout the codebase are
enabled.  These annotations, specific to sparse, add restrictions on how the
associated object may be used.  They are specified with GCC&rsquo;s <code>__attribute__</code>
syntax.  (Sparse also provides a special <code>__context__</code> macro.)  But usually, one
uses the shorthands that can be found in <code>include/linux/compiler_types.h</code>.  For
example:
</p>
<ul class="org-ul">
<li><code>__user</code> is short for <code>__attribute__((noderef, address_space(__user)))</code></li>
<li><code>__acquire(x)</code> is short for <code>__context__(x,1)</code></li>
</ul>

<p>
The attributes themselves:
</p>
<ul class="org-ul">
<li><code>address_space(name)</code>
<ul class="org-ul">
<li>used on pointer types</li>
<li>specifies that its target as being in the given address space</li>
<li>sparse will treat pointers with different address spaces as distinct types
and will warn on casts (implicit or explicit) mixing the address spaces</li>
<li><p>
the main ones in use in the kernel (see <code>include/linux/compiler_types.h</code>):
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#define</span> <span class="org-variable-name">__kernel</span>  <span class="org-keyword">__attribute__</span>((address_space(0)))
<span class="org-preprocessor">#define</span> <span class="org-variable-name">__user</span>    <span class="org-keyword">__attribute__</span>((noderef, address_space(__user)))
<span class="org-preprocessor">#define</span> <span class="org-variable-name">__iomem</span>   <span class="org-keyword">__attribute__</span>((noderef, address_space(__iomem)))
<span class="org-preprocessor">#define</span> <span class="org-variable-name">__percpu</span>  <span class="org-keyword">__attribute__</span>((noderef, address_space(__percpu)))
<span class="org-preprocessor">#define</span> <span class="org-variable-name">__rcu</span>     <span class="org-keyword">__attribute__</span>((noderef, address_space(__rcu)))
</pre>
</div></li>
</ul></li>
<li><code>bitwise</code>
<ul class="org-ul">
<li>used on integer types</li>
<li>integers marked with this cannot be used in normal integer expressions,
only bitwise expressions where the other integers are also &ldquo;bitwise&rdquo;
<ul class="org-ul">
<li>the exception to this is the integer literal 0, which is safe in any
bitwise operation</li>
<li>to assign an integer literal to a bitwise type, you need to cast the
literal to with the <code>__force</code> attribute (see below)</li>
<li><p>
for example:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">typedef</span> <span class="org-type">int</span> <span class="org-type">__bitwise</span> foo_t;

<span class="org-keyword">enum</span> <span class="org-type">foo_t</span> {
    <span class="org-variable-name">FOO</span> = (__force <span class="org-type">foo_t</span>) 1,
    <span class="org-variable-name">BAR</span> = (__force <span class="org-type">foo_t</span>) 2,
    <span class="org-variable-name">BAZ</span> = 0
};
</pre>
</div></li>
</ul></li>
<li>by adding this qualifier to a typedef, one could think of this as making
the typedef <i>strongly-typed</i></li>
</ul></li>
<li><code>context(ctxt, entry, exit)</code>
<ul class="org-ul">
<li>used in function declarations</li>
<li>specifies the function&rsquo;s entry and exit count for a given context (what
the heck does that mean?)</li>
<li>&ldquo;context&rdquo; can refer to pretty much anything that can be counted, though
usually this will be counting pairs of &ldquo;get&rdquo; and &ldquo;put&rdquo; on locks</li>
<li>the <code>ctxt</code> argument provides a name for the context being counted
<ul class="org-ul">
<li>thus in the usual case, this will be the struct protected by the lock
whose state we&rsquo;re counting</li>
</ul></li>
<li>sparse will check that the function&rsquo;s entry and exit contexts match, and
that no path through a function is ever entered with conflicting contexts</li>
<li>note though that since this is a static analyser, it can&rsquo;t always identify
when certain code paths are logically impossible, so it might give some
false positives</li>
<li>some examples of correct usage
<ul class="org-ul">
<li>for a function whose spec is to acquire a lock (and not release it), its
developer should annotate it with an <code>entry</code> value of 0 and an <code>exit</code> value
of 1; the associated unlock function would use the values 1 and 0</li>
<li>for a function whose spec is for it to be called on locked data, and
which will subsequently release that lock but reacquire it before
returning, its <code>entry</code> and <code>exit</code> values should both be 1</li>
</ul></li>
<li>an example of <i>incorrect</i> usage:
<ul class="org-ul">
<li>for a function whose spec is such that a lock need not be held at entry
or exit but is acquired and released inside the function in a balanced
way, the developer need not annotate this</li>
<li>these calls are <i>already</i> annotated and sparse can already recognise that
they&rsquo;re balanced; the macros are for telling sparse not to freak out
when calls <i>aren&rsquo;t</i> balanced, or when done in reverse order (unlocking
first and then re-locking)</li>
</ul></li>
<li><code>__releases(x)</code>, <code>__acquires(x)</code>, and <code>__must_hold(x)</code> are helper macros for
applying the <code>context</code> attribute (see <code>include/linux/compiler_types.h</code>)</li>
<li><p>
for example, from <code>fs/file.c</code> in the kernel:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * Expand the file descriptor table.</span>
<span class="org-comment"> * This function will allocate a new fdtable and both fd array and fdset, of</span>
<span class="org-comment"> * the given size.</span>
<span class="org-comment"> * Return &lt;0 error code on error; 1 on successful completion.</span>
<span class="org-comment"> * The files-&gt;file_lock should be held on entry, and will be held on exit.</span>
<span class="org-comment-delimiter"> */</span>
<span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">expand_fdtable</span>(<span class="org-keyword">struct</span> <span class="org-type">files_struct</span> *<span class="org-variable-name">files</span>, <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">nr</span>)
        <span class="org-function-name">__releases</span>(files-&gt;file_lock)
        <span class="org-function-name">__acquires</span>(files-&gt;file_lock)
{
        <span class="org-keyword">struct</span> <span class="org-type">fdtable</span> *<span class="org-variable-name">new_fdt</span>, *<span class="org-variable-name">cur_fdt</span>;
        <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
        spin_unlock(&amp;files-&gt;file_lock);
        <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
        spin_lock(&amp;files-&gt;file_lock);
        <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
}
</pre>
</div></li>
<li>Linus describes this feature a bit <a href="https://lwn.net/Articles/109066/">here</a></li>
</ul></li>
<li><code>noderef</code>
<ul class="org-ul">
<li>used on pointer types</li>
<li>this specifies that such pointers should never be dereferenced</li>
<li>for example, the address-space-annotated types shown above also have this
annotation (except for <code>__kernel</code>, obviously)</li>
</ul></li>
<li><code>nocast</code>
<ul class="org-ul">
<li>used on integer types</li>
<li>this warns about explicit or implicit type conversions</li>
<li>it&rsquo;s a bit like &ldquo;bitwise&rdquo;, but weaker
<ul class="org-ul">
<li>you can mix nocast with non-nocast types in an expression</li>
<li>and if the new value is assigned to a non-nocast type, the qualifier is
dropped</li>
</ul></li>
<li>this is useful for big integers that still need to act like integers for
the purpose of arithmetic, but are prevented from being truncated by
mistake</li>
<li>Linus compares <code>nocast</code> and <code>bitwise</code> <a href="https://lore.kernel.org/linux-mm/CA+55aFzbhYvw7Am9EYgatpjTknBFm9eq+3jBWQHkSCUpnb3HRQ@mail.gmail.com/">here</a></li>
</ul></li>
<li><code>safe</code>
<ul class="org-ul">
<li>used on pointer types</li>
<li>this specifies to the user that the pointer may safely be dereferenced
without causing a trap, and will never be set to NULL</li>
<li>sparse will warn if the pointer appears in a conditional; there&rsquo;s no point
to checking for NULL in light of the above</li>
</ul></li>
<li><code>force</code>
<ul class="org-ul">
<li>this can be used in casts to suppress warnings regarding any of the above</li>
</ul></li>
</ul>

<p>
Question:
</p>
<p class="verse">
<i>Why can&rsquo;t we just use typedefs to enforce some of these<br />
restrictions?</i><br />
</p>
<p>
Answer:
</p>
<p class="verse">
<i>Because typedefs are just dumb aliases that don&rsquo;t impart anything<br />
useful to the compiler like real types do.</i><br />
</p>

<p>
To illustrate, invoking <code>gcc</code> with <code>-Werror -Wall</code> will compile this code without
complaint:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdio.h&gt;</span>

<span class="org-keyword">typedef</span> <span class="org-type">int</span> <span class="org-type">foo</span>, <span class="org-type">bar</span>;

<span class="org-type">void</span> <span class="org-function-name">do_stuff</span>(<span class="org-type">foo</span> <span class="org-variable-name">a</span>, <span class="org-type">bar</span> <span class="org-variable-name">b</span>)
{
    printf(<span class="org-string">"foo: %d, bar: %d, foobar: %d\n"</span>, a, b, a + b);
}

<span class="org-type">int</span> <span class="org-function-name">main</span>()
{
    <span class="org-type">foo</span> <span class="org-variable-name">foo_var</span> = 1;
    <span class="org-type">bar</span> <span class="org-variable-name">bar_var</span> = 2;
    do_stuff(bar_var, foo_var);
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbc2c242" class="outline-3">
<h3 id="1be643ca-f17f-4c4c-b6ef-66f77df933e9"><span class="section-number-3">16.2</span> Running sparse</h3>
<div class="outline-text-3" id="text-1be643ca-f17f-4c4c-b6ef-66f77df933e9">
<p>
Let&rsquo;s give this a test drive:
</p>
<div class="org-src-container">
<pre class="src src-bash">make <span class="org-variable-name">C</span>=2
</pre>
</div>

<p>
There are sparse warnings littered all throughout the kernel tree.
Fortunately, we can ignore most of these.  (Usually developers are only
concerned with the <i>new</i> warnings that show up in the code they&rsquo;re working on.)
Let&rsquo;s clean up this output a bit:
</p>
<div class="org-src-container">
<pre class="src src-bash">make <span class="org-variable-name">C</span>=2 <span class="org-variable-name">CF</span>=<span class="org-string">'-fdiagnostic-prefix=SPARSE'</span> $<span class="org-variable-name">subdir</span> 2&gt;&amp;1 1&gt;/dev/null
</pre>
</div>
<p>
As I will describe below, I was getting some annoying and irrelevant
&ldquo;unreplaced symbol&rdquo; warnings.  I filtered these out with <code>grep</code>:
</p>
<div class="org-src-container">
<pre class="src src-bash">grep -v -e <span class="org-string">"unreplaced symbol"</span> -e <span class="org-string">"in included file"</span> -- my_sparse_output.log
</pre>
</div>
<p>
The <code>sort</code> and <code>uniq</code> commands are also helpful to sort through the output.
</p>

<p>
I came across the following messages:
</p>
<ul class="org-ul">
<li><code>note: in included file (through [header, ...]):</code>
<ul class="org-ul">
<li>these lines give context to the warnings/errors listed beneath them</li>
</ul></li>
<li><code>warning: array of flexible structures</code>
<ul class="org-ul">
<li><p>
<code>rtllib.h</code> defines a bunch of structs which contain a flexible array
member at the end
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">struct</span> <span class="org-type">rtllib_probe_response</span> {
        <span class="org-keyword">struct</span> <span class="org-type">rtllib_hdr_3addr</span> <span class="org-variable-name">header</span>;
        <span class="org-type">u32</span> <span class="org-variable-name">time_stamp</span>[2];
        <span class="org-type">__le16</span> <span class="org-variable-name">beacon_interval</span>;
        <span class="org-type">__le16</span> <span class="org-variable-name">capability</span>;
        <span class="org-comment-delimiter">/* </span><span class="org-comment">SSID, supported rates, FH params, DS params,</span>
<span class="org-comment">         * CF params, IBSS params, TIM (if beacon), RSN</span>
<span class="org-comment-delimiter">         */</span>
        <span class="org-keyword">struct</span> <span class="org-type">rtllib_info_element</span> <span class="org-variable-name">info_element</span>[];
} <span class="org-variable-name">__packed</span>;
</pre>
</div></li>
<li>these allow one to have an array at the end of a struct with a length
decided at allocation time</li>
<li>they must come at the end of the struct so that member offsets aren&rsquo;t
affected</li>
<li><p>
note that this member is, in relation to the struct, zero-size
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdio.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdlib.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;stddef.h&gt;</span>

<span class="org-keyword">struct</span> <span class="org-type">foo</span> {
    <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-variable-name">a</span>;
    <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-variable-name">b</span>;
    <span class="org-type">char</span> <span class="org-variable-name">c</span>[];
};

<span class="org-type">int</span> <span class="org-function-name">main</span>()
{
    <span class="org-keyword">struct</span> <span class="org-type">foo</span> *<span class="org-variable-name">test</span> = malloc(<span class="org-keyword">sizeof</span>(<span class="org-keyword">struct</span> <span class="org-type">foo</span>) + 4*<span class="org-keyword">sizeof</span>(<span class="org-type">char</span>));

    printf(<span class="org-string">"sizeof(*test): %ld\n"</span>, <span class="org-keyword">sizeof</span>(*test)); <span class="org-comment-delimiter">// </span><span class="org-comment">16</span>
    printf(<span class="org-string">"sizeof(*test.a): %ld\n"</span>, <span class="org-keyword">sizeof</span>(test-&gt;a)); <span class="org-comment-delimiter">// </span><span class="org-comment">8</span>
    printf(<span class="org-string">"sizeof(*test.b): %ld\n"</span>, <span class="org-keyword">sizeof</span>(test-&gt;b)); <span class="org-comment-delimiter">// </span><span class="org-comment">8</span>
    printf(<span class="org-string">"offsetof(struct foo, c): %ld\n"</span>, offsetof(<span class="org-keyword">struct</span> <span class="org-type">foo</span>, c)); <span class="org-comment-delimiter">// </span><span class="org-comment">16</span>

    <span class="org-keyword">return</span> 0;
}
</pre>
</div></li>
<li><p>
thus you need to allocate space for them dynamically
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">struct</span> <span class="org-type">my_struct</span> *<span class="org-variable-name">foo</span> = malloc(<span class="org-keyword">sizeof</span>*(foo) + size_of_array);
</pre>
</div></li>
<li><p>
which is exactly what&rsquo;s going on in <code>rtllib_softmac.c</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
        beacon_size = <span class="org-keyword">sizeof</span>(<span class="org-keyword">struct</span> <span class="org-type">rtllib_probe_response</span>)+2+
            ssid_len + 3 + rate_len + rate_ex_len + atim_len + erp_len
            + wpa_ie_len + ieee-&gt;tx_headroom;
<span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
</pre>
</div></li>
<li>so why are warnings given for flexible array members?
<ul class="org-ul">
<li>flexible array members were originally a non-portable, error-prone
compiler-hack that weren&rsquo;t standardised until C99</li>
<li>the linux kernel was originally built upon C89; with the recent push
towards adopting C11&rsquo;s features, efforts have since been made to fix
instances of an older, error prone, syntax
<ul class="org-ul">
<li>namely, arrays formerly had to be declared with a size, commonly
<code>foo[0]</code>, and <code>sizeof</code> would reflect this lie</li>
</ul></li>
<li>this issues with this are described <a href="https://www.kernel.org/doc/html/latest/process/deprecated.html#zero-length-and-one-element-arrays">here</a></li>
<li>in short
<ul class="org-ul">
<li>flexible arrays should be declared without a size</li>
<li>use the <code>struct_size()</code> and <code>flex_array_size()</code> helpers for allocation</li>
</ul></li>
</ul></li>
<li>we don&rsquo;t really need to fix this, but just be aware of it</li>
</ul></li>
<li><code>warning: unreplaced symbol '...'</code>
<ul class="org-ul">
<li><p>
sparse complains about unreplaced symbols in many functions
</p>
<div class="org-src-container">
<pre class="src src-text">./include/asm-generic/bitops/generic-non-atomic.h:30:9: warning: unreplaced symbol 'mask'
./include/asm-generic/bitops/generic-non-atomic.h:31:9: warning: unreplaced symbol 'p'
./include/asm-generic/bitops/generic-non-atomic.h:33:10: warning: unreplaced symbol 'p'
./include/asm-generic/bitops/generic-non-atomic.h:33:16: warning: unreplaced symbol 'mask'
./include/asm-generic/bitops/generic-non-atomic.h:28:1: warning: unreplaced symbol 'return'
</pre>
</div></li>
<li><p>
from this function for example
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
<span class="org-keyword">static</span> __always_inline <span class="org-type">void</span>
<span class="org-function-name">generic___set_bit</span>(<span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">nr</span>, <span class="org-keyword">volatile</span> <span class="org-type">unsigned</span> <span class="org-type">long</span> *<span class="org-variable-name">addr</span>)
{
        <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">mask</span> = BIT_MASK(nr);
        <span class="org-type">unsigned</span> <span class="org-type">long</span> *<span class="org-variable-name">p</span> = ((<span class="org-type">unsigned</span> <span class="org-type">long</span> *)addr) + BIT_WORD(nr);

        *p  |= mask;
}
<span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
</pre>
</div></li>
<li>the common denominator with these functions seems to be that they are
inlined</li>
<li>this may be a spurious warning to do with parsing, but I struggled to find
much online about it; possibly my version of sparse (0.6.4) is out of date</li>
<li>regardless, I probably don&rsquo;t need to worry about this right now</li>
</ul></li>
<li><code>warning: restricted __sum16 degrades to integer</code>
<ul class="org-ul">
<li>the <code>__sum16</code> type is a bitwise typedef (from <code>include/uapi/linux/types.h</code>)</li>
<li>here a bitwise expression is wrongly being assigned to a non-bitwise type
(an int)</li>
<li>the integer is subsequently used for integer arithmetic</li>
</ul></li>
<li><code>warning: incorrect type in assignment (different base types)</code>
<ul class="org-ul">
<li>self-explanatory</li>
</ul></li>
<li><code>warning: incorrect type in argument 2 (different base types)</code>
<ul class="org-ul">
<li>self-explanatory</li>
</ul></li>
<li><code>warning: context imbalance in 'rtw_free_assoc_resources' - different lock contexts for basic block</code>
<ul class="org-ul">
<li>this function expects one to possess a particular lock when called</li>
<li>thus <code>entry</code> and <code>exit</code> values ought to be 1 for this function spec</li>
</ul></li>
<li><code>warning: cast to restricted __le64</code>
<ul class="org-ul">
<li>non-bitwise integer being case to a bitwise one</li>
</ul></li>
<li><code>warning: symbol 'vchiq_platform_init' was not declared. Should it be static?</code>
<ul class="org-ul">
<li>this function is not declared in the header, and only used in the file
it&rsquo;s defined in; it ought to be declared static</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgd59d8e5" class="outline-3">
<h3 id="168c4d3e-a3b8-4728-88c4-c5477e5c3698"><span class="section-number-3">16.3</span> Final remarks on Kbuild, et al.</h3>
<div class="outline-text-3" id="text-168c4d3e-a3b8-4728-88c4-c5477e5c3698">
<p>
If we want to compile only a particular subdirectory, we just give that
directory as the make target.  (As I noted earlier in , we <i>do not</i>
specify the subdirectory with <code>M</code>.)  Thus, in the case of the staging directory:
</p>
<div class="org-src-container">
<pre class="src src-bash">make <span class="org-variable-name">C</span>=2 drivers/staging/ <span class="org-comment-delimiter"># </span><span class="org-comment">make sure the path contains a trailing slash!</span>
</pre>
</div>

<p>
Note however that this subdirectory won&rsquo;t be compiled if it&rsquo;s not enabled in
the config.  At the very least, we need to enable <code>CONFIG_STAGING</code>,
<code>CONFIG_COMPILE_TEST</code>, and <code>CONFIG_WERROR</code>.  From there, we then enable the
individual drivers we&rsquo;re testing.  A yet faster way is to just run
<code>allmodconfig</code> or <code>allyesconfig</code> and go from there.  (This enables only what can
be.  For example, you would presumably be building on an x86-based desktop,
but not all non-x86 modules support <code>COMPILE_TEST</code>.)  If a module is not
enabled, make will not show us any sparse output, much less care whether the
module has already been built.
</p>

<p>
A random problem I encountered:
</p>
<div class="org-src-container">
<pre class="src src-text">  CC [M]  kernel/configs.o
  CHK     kernel/kheaders_data.tar.xz
  GEN     kernel/kheaders_data.tar.xz
make[2]: *** [kernel/Makefile:159: kernel/kheaders_data.tar.xz] Error 127
make[1]: *** [scripts/Makefile.build:500: kernel] Error 2
make: *** [Makefile:1992: .] Error 2
</pre>
</div>
<p>
Installing the <code>cpio</code> package fixed this &#x2014; it&rsquo;s necessary when
<code>CONFIG_IKHEADERS</code> is enabled (credit: <a href="https://unix.stackexchange.com/questions/716077/error-trying-to-compile-kernel-5-15">here</a>).
</p>

<p>
The patch I eventually submitted was rejected.  You can see this patch and its
subsequent discussion <a href="https://lore.kernel.org/lkml/20221022043548.1671644-1-scottjcrouch@gmail.com/">here</a>.  So what was the problem?
</p>

<p>
This driver is for a coprocessor called VideoCore which offers low-power media
encoding/decoding on certain Broadcom <a href="https://en.wikipedia.org/wiki/System_on_a_chip">SoCs</a> (found most notably in some
Raspberry Pis).  The driver implements a messaging interface to communicate
with this peripheral.  (Other config options in <code>drivers/staging/vc04_services/</code>
enable media drivers that rely on this interface.)  The module is therefore
normally built against <code>ARCH_BCM2835</code>, an ARM-based architecture.  However, the
config dependencies, as defined in the <code>Kconfig</code> file, allowed one to build on
other architectures, so long as they have <code>COMPILE_TEST</code> enabled.
</p>

<p>
The problem with my patch was partly related to this.  In the kernel, function
implementations are sometimes redefined to return NULL if certain
configuration options are enabled/disabled.  If so, GCC may take advantage of
this to eliminate dead code.  In this particular scenario, the &ldquo;static&rdquo;
scoping caused this dead code elimination to kick in.  But the now excised
code was being relied upon to satisfy a compile-time check for uninitialised
pointers.
</p>

<p>
We could fix this either by suppressing the warning somehow (e.g. casting the
pointer to <code>*(char **)</code>) , or amending the <code>Kconfig</code> entry.  It seems unwise to
just suppress a warning, but the latter option means one can no longer
test-compile the module (nor run sparse) on x86.
</p>

<p>
â€‹Â¯â€‹\â€‹_â€‹(ãƒ„)â€‹_â€‹/â€‹Â¯
</p>

<p>
As a final note, during this task I had to trawl through the most recent
messages in the mailing lists to see if any newer patches had been submitted
for the driver in question.  I compiled a list of the online mailing list
archives I found most useful, which you can see in the .
</p>
</div>
</div>
</div>
<div id="outline-container-org56a14f6" class="outline-2">
<h2 id="task-17"><span class="section-number-2">17</span> Task 17</h2>
<div class="outline-text-2" id="text-task-17">
<blockquote>
<p>
Another patch made and sent in.  See, that wasn&rsquo;t so hard.  Keep sending in
kernel patches outside of this challenge, those lazy kernel developers need
all the help they can get in cleaning up their code.
</p>

<p>
It is time to start putting the different pieces of what we have done in the
past together, into a much larger module, doing more complex things.  Much
more like what a &ldquo;real&rdquo; kernel module has to do.
</p>

<p>
Go dig up your code from task 06, the misc char device driver, and make the
following changes:
</p>
<ul class="org-ul">
<li>Delete the read function.  You don&rsquo;t need that anymore, so make it a
write-only misc device and be sure to set the mode of the device to be
write-only, by anyone.  If you do this right, udev will set up the node
automatically with the correct permissions.</li>
<li>Create a wait queue, name it &ldquo;weeâ€‹_â€‹wait&rdquo;.</li>
<li>In your module init function, create a kernel thread, named of course
&ldquo;eudyptula&rdquo;.</li>
<li>The thread&rsquo;s main function should not do anything at this point in time,
except make sure to shutdown if asked to, and wait on the &ldquo;weeâ€‹_â€‹wait&rdquo;
waitqueue.</li>
<li>In your module exit function, shut down the kernel thread you started up.</li>
</ul>

<p>
Load and unload the module and &ldquo;prove&rdquo; that it works properly (that the thread
is created, it can be found in the process list, and that the device node is
created with the correct permission value.)  Send in the proof and the <code>.c</code> file
for the module.
</p>

<p>
Be sure to keep this code around, as we will be doing more with it next time.
</p>
</blockquote>

<p>
A couple of new concepts are introduced in this task: waitqueues and kthreads.
I&rsquo;ll start with the latter.
</p>
</div>
<div id="outline-container-org9c781b1" class="outline-3">
<h3 id="569a2838-056c-4534-912d-87169f0e33fd"><span class="section-number-3">17.1</span> Kthreads</h3>
<div class="outline-text-3" id="text-569a2838-056c-4534-912d-87169f0e33fd">
<p>
Kernel threads (or kthreads) are a special type of thread that run entirely in
kernel-space.  They&rsquo;re typically used to perform periodic and asynchronous
work as dispatched by the kernel (e.g. so called <a href="https://en.wikipedia.org/wiki/Interrupt_handler#Divided_handlers_in_modern_operating_systems">bottom halves</a>; deferred work
that is queued by an interrupt handler).
</p>

<p>
All kthreads descend from pid 2 &#x2014; the first child of the init process &#x2014;
known as <code>kthreadd</code>.  Thus we can list them all (sans <code>kthreadd</code> itself) like so:
</p>
<div class="org-src-container">
<pre class="src src-bash">ps --ppid 2
</pre>
</div>

<p>
Often, kthreads will be spawned in groups, where one is assigned for each
processor.  On SMP systems, you can see groups of them flocking together in
groups of <code>$(nproc)</code>.  In such cases, their names will be appended with the
index of the core they run on.
</p>

<p>
Among the most notable of these, for example, is <code>ksoftirqd</code>, whose job is to
process softirqs (and by extension tasklets; read to learn all about this
stuff).
</p>

<p>
Kthreads can only be spawned by other kthreads.  How then, you might ask, do
we create one to begin with?  By making a request to the top-level ancestor of
all kthreads, <code>kthreadd</code>, to do so on our behalf.  Namely, we call
<a href="https://docs.kernel.org/driver-api/basics.html#c.kthread_create"><code>kthread_create()</code></a> (from <code>include/linux/kthread.h</code>) providing it with a callback
to be run in thread context.  Returned from this call is a task struct
representing the new task &#x2014; which is, at this point, not running nor queued.
We must subsequently make this new task runnable ourselves by calling
<a href="https://docs.kernel.org/driver-api/basics.html#c.wake_up_process"><code>wake_up_process()</code></a> (from <code>include/linux/sched.h</code>).  (Alternatively, calling
<a href="https://docs.kernel.org/driver-api/basics.html#c.kthread_run"><code>kthread_run()</code></a> does both.)
</p>

<p>
A notable difference between kthreads and user processes concerns signals.  If
we want to stop our kthread remotely, we don&rsquo;t send it a signal.  (In fact,
after testing this, it appears that kthreads silently ignore signals
altogether.  (Apparently, it is possible to re-enable them, but I&rsquo;m not going
to get into that.))  Instead, we have to call <code>kthread_stop()</code>.  Upon doing so,
the kthread will be woken up, and a special bit set in its task struct to
indicate that it&rsquo;s been ordered to stop.  It is the responsibility of the
kthread to check this status bit &#x2014; by calling <code>kthread_should_stop()</code> &#x2014;
every time it is roused from sleep, to know when it is time to clean up and
return.  The <code>kthread_stop()</code> call will subsequently return what the thread
function itself returned.
</p>
</div>
</div>
<div id="outline-container-orgc2227ba" class="outline-3">
<h3 id="581b8ea6-452a-4afd-bf81-967d09c67abc"><span class="section-number-3">17.2</span> Wait queues</h3>
<div class="outline-text-3" id="text-581b8ea6-452a-4afd-bf81-967d09c67abc">
<p>
A wait queue is a kernel data structure that represents an event that one or
more tasks are waiting to happen.  If a task needs to be put to sleep and
woken up as soon as the event has occurred, it can use the <code>wait_event()</code> or
<code>wait_event_interruptible()</code> macros (from <code>include/linux/wait.h</code>, documented <a href="https://docs.kernel.org/kernel-hacking/hacking.html#wait-queues-include-linux-wait-h">here</a>
and <a href="https://docs.kernel.org/driver-api/basics.html#wait-queues-and-wake-events">here</a>).  (Which of these two macros we use depends on whether we permit the
task to be woken-up briefly to handle signals.)
</p>

<p>
Whenever a task wants to put itself to sleep, it must register itself with a
wait queue.  (If this weren&rsquo;t the case, a task would sleep forever &#x2014;
<i>something</i> must wake it up at some point.)  A wait queue handles both.
</p>

<p>
When a task/process context asks to be put to sleep, the task struct is:
</p>
<ul class="org-ul">
<li>placed on the wait queue;</li>
<li>marked as non-runnable (either <code>TASK_INTERRUPTIBLE</code> or <code>TASK_UNINTERRUPTIBLE</code>);
and</li>
<li>removed from the scheduler&rsquo;s run queue.</li>
</ul>

<p>
At the other end of this, when <code>wake_up()</code> is called on that wait queue &#x2014; this
will be called by a handler that is invoked when the event occurs &#x2014; all
tasks waiting on that queue are:
</p>
<ul class="org-ul">
<li>woken up;</li>
<li>removed from the wait queue;</li>
<li>restored to a <code>TASK_RUNNING</code> state; and</li>
<li>added back to the scheduler&rsquo;s run queue.</li>
</ul>

<p>
There is also &ldquo;exclusive wait&rdquo; feature, such that, among tasks in the queue
that are marked <code>WQ_FLAG_EXCLUSIVE</code>, only <i>one</i> of them will be woken up.  So, to
be more accurate, all processes <i>without the &ldquo;exclusive&rdquo; flag</i> will be woken up.
But this flag is not often used &#x2014; in such a scenario, the other waiting
tasks will not be woken (presumably it would be up to the &ldquo;exclusive&rdquo; task to
rescue them).
</p>
</div>
</div>
<div id="outline-container-orge27f290" class="outline-3">
<h3 id="1fa85feb-1770-490d-a705-2af56f13e57a"><span class="section-number-3">17.3</span> Final notes</h3>
<div class="outline-text-3" id="text-1fa85feb-1770-490d-a705-2af56f13e57a">
<p>
As you might note, the <code>wait_event*()</code> macros must be given a boolean
expression.  Whenever the task is woken up, this expression will be checked to
determine whether the event actually occurred.
</p>

<p>
Why would this be necessary?  Shouldn&rsquo;t the fact that the task is now awake be
sufficient evidence that the event actually took place? &#x2014; <i>Kind of</i>, but it&rsquo;s
complicated.
</p>

<p>
There are in fact two ways a task may be woken up:
</p>
<ul class="org-ul">
<li>when it is sent a signal (if it used the &ldquo;interruptible&rdquo; variant); xor</li>
<li>when it is woken up spuriously.</li>
</ul>

<p>
Yes, so-called spurious wake-ups are possible in a POSIX environment.  What
might cause one I cannot say, but, since we should be checking the
event-condition anyway for safesies, perhaps this part of the spec serves as a
kind of scheduling safe-guard, maybe even to facilitate recovery from
kernel-space errors that could result in &ldquo;stolen&rdquo; wake-ups &#x2014; a kind of
break-glass-in-case-of-emergencyâ€‹/â€‹wake-up-sleeping-threadsâ€‹/â€‹man-the-torpedoes
type deal (don&rsquo;t quote me on this).  Or maybe it&rsquo;s just a ghost story kernel
developers made up in order to scare user-land into always eating their
vegetables (read: always checking the event-condition after wake-up).
</p>

<p>
A few other concerns:
</p>
<ul class="org-ul">
<li>As stated earlier, kthreads ignore signals by default.  Apparently, they can
be (and are, in some parts) re-enabled, but we don&rsquo;t need them when a
sempahore (the event-condition) is perfectly adequate.  So it doesn&rsquo;t seem
to matter whether my implementation used <code>wait_event()</code> or
<code>wait_event_interruptible()</code>.  (Grepping through the kernel code, I can see
instances of both being used on kthreads.  Go figure.)</li>
<li>The <code>kthread_run()</code> wrapper returns an <i>error pointer</i>: a special return value
which contains a pointer upon success, and an error code upon failure.  What
makes it possible to distinguish between these two scenarios at run-time is
the fact that large portions of virtual address space are unused.  The
kernel exploits this to store the error codes, which as pointers would be
verifiably invalid.  Therefore we must use <code>IS_ERR()</code> and <code>PTR_ERR()</code> to extract
this info from the return value.  The latter is not to be confused with
<code>ERR_PTR()</code>, which is used by a function to encode an error into a pointer
return value.  More on this <a href="https://docs.kernel.org/kernel-hacking/hacking.html#return-conventions">here</a>.</li>
<li>The kernel log buffer isn&rsquo;t flushed to the console until a newline is
encountered.  I discovered this accidentally after I accidentally left the
trailing newline out of a call to <code>printk()</code>.</li>
<li>Normally, in the context of a syscall, the value returned from
<code>wait_event_interruptible()</code> is checked to determine if it had been woken up
early (whether by a signal or spuriously), and if so, <code>-ERESTARTSYS</code> is
returned.  This return value essentially indicates to user-space that the
syscall must be restarted/retried.  I don&rsquo;t bother doing this check for
early wake-up in my implementation.  Why not?
<ul class="org-ul">
<li>Firstly, <code>-ERESTARTSYS</code> is related to the concept of &ldquo;restartable&rdquo; system
calls, that is, system calls that can be transparently re-executed by the
kernel when their execution was interrupted (by a signal or spuriously).</li>
<li>The <code>-ERESTARTSYS</code> code isn&rsquo;t actually ever seen by user-space.  Rather,
it&rsquo;s intercepted by the virtual filesystem (VFS) layer, which responds
either by restarting the syscall itself, or returning <code>-EINTR</code> back up to
the user and letting them handle it.
<ul class="org-ul">
<li>A problem with this is that some syscalls can&rsquo;t easily be restarted, as
they aren&rsquo;t idempotent operations (have side-effects).</li>
<li>For example, a <code>sleep()</code> syscall that is interrupted shouldn&rsquo;t restart
from the beginning, but rather should <i>resume</i> from where it was at the
time of interruption.  (In functional terms, its side-effect is the
world-state.)</li>
<li>In order to do this, it has to modify the arguments that were passed to
it.  The kernel stashes a syscall&rsquo;s arguments in a task-specific place
before executing it.  With such an interruption, the syscall code needs
to modify what is stashed there, before returning <code>-ERESTART_RESTARTBLOCK</code>
back to the upper layers.</li>
</ul></li>
<li>If a syscall finds itself needing to return <code>-ERESTARTSYS</code>, then it will
need to clean up before doing so (e.g. release locks).</li>
<li>In spite of all of this, a kthread is <i>not a syscall</i>, and has no such need.
If <code>wait_event_interruptible()</code> returned non-zero, it would indicate either
a signal or a spurious wakeup, neither of which is relevant in the context
of our kthread.  All it needs to do here is check the wake condition
associated with <code>wee_wait</code>: if it&rsquo;s not ready yet, then just call
<code>wait_event_interruptible()</code> again.  (I actually have no clue whether, if we
did return <code>-ERESTARTSYS</code> from the kthread, the kernel would intercept it
and restart the kthread, or whether it would simply be returned from the
<code>kthread_stop()</code> call in our module exit function &#x2014; I have not bothered to
check.)</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org0ce4926" class="outline-2">
<h2 id="task-18"><span class="section-number-2">18</span> Task 18</h2>
<div class="outline-text-2" id="text-task-18">
<blockquote>
<p>
Nice job with the kernel thread.  It really doesn&rsquo;t take much code at all to
create a new thread.  So now let us get some data into the module to give the
thread something to do.
</p>

<p>
Base all of this work on your task 17 codebase.
</p>

<p>
Go back and dig up task 12&rsquo;s source code, the one with the list handling.
Copy the structure into this module, and the <code>identity_create()</code>,
<code>identity_find()</code>, and <code>identity_destroy()</code> functions into this module as well.
</p>

<p>
Write a new function, <code>identity_get()</code>, that looks like:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">struct</span> <span class="org-type">identity</span> <span class="org-function-name">identity_get</span>(<span class="org-type">void</span>);
</pre>
</div>
<p>
and returns the next &ldquo;identity&rdquo; structure that is on the list, and removes it
from the list.  If nothing is on the list, return NULL.
</p>

<p>
Then, hook up the misc char device &ldquo;write&rdquo; function to do the following:
</p>
<ul class="org-ul">
<li>If a write is larger than 19 characters, truncate it at 19.</li>
<li>Take the write data and pass it to <code>identity_create()</code> as the string, and use
an incrementing counter as the &ldquo;id&rdquo; value.</li>
<li>Wake up the &ldquo;weeâ€‹_â€‹wait&rdquo; queue.</li>
</ul>

<p>
In the kernel thread function:
</p>
<ul class="org-ul">
<li>If the &ldquo;weeâ€‹_â€‹wait&rdquo; queue wakes us up, get the next identity in the system
with a call to <code>identity_get()</code>.</li>
<li>Sleep (in an interruptable state, don&rsquo;t go increasing the system load in a
bad way) for 5 seconds.</li>
<li>Write out the identity name, and id, to the debug kernel log, and then free
the memory.</li>
</ul>

<p>
When the module exits, clean up the whole list by using the functions given,
no fair mucking around with the list variables directly.
</p>

<p>
Yes, it&rsquo;s a bit clunky, but it shows the basics of taking work from userspace,
and then quickly returning to the user, and then going off and doing something
else with the data and cleaning everything up.  It&rsquo;s a common pattern for a
kernel, as it&rsquo;s really all that a kernel ends up doing most of the time (get a
disk block, write a disk block, handle a mouse event, etc.)
</p>

<p>
Load and unload the module and &ldquo;prove&rdquo; that it works properly by writing and
looking at the debug log, and that everything cleans up properly when the
module is unloaded.
</p>

<p>
Send in the proof and the <code>.c</code> file for the module.
</p>

<p>
A good test script would be the following:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-builtin">echo</span> <span class="org-string">"Alice"</span> &gt; /dev/eudyptula
<span class="org-builtin">echo</span> <span class="org-string">"Bob"</span> &gt; /dev/eudyptula
sleep 15
<span class="org-builtin">echo</span> <span class="org-string">"Dave"</span> &gt; /dev/eudyptula
<span class="org-builtin">echo</span> <span class="org-string">"Gena"</span> &gt; /dev/eudyptula
rmmod task18
</pre>
</div>

<p>
Removing the module while there is pending work is always a good stress test.
</p>
</blockquote>
</div>
<div id="outline-container-org15a6a3d" class="outline-3">
<h3 id="04bc961f-02bb-4176-8f20-771d17dce672"><span class="section-number-3">18.1</span> Final notes</h3>
<div class="outline-text-3" id="text-04bc961f-02bb-4176-8f20-771d17dce672">
<p>
This task doesn&rsquo;t introduce anything too fancy, but there&rsquo;s nevertheless lots
to talk about:
</p>
<ul class="org-ul">
<li>In <code>identity_create()</code>, I switched from <code>strncpy()</code> to the safer,
null-terminating <code>strscpy()</code>.  (See my notes at end of .)</li>
<li>I wrote the kthread function to sleep for only 1 second so that my test
script can run a bit quicker.</li>
<li>I wrapped the list of identities in a mutex.  This mutex also protects the
static ID counter that is used to auto-assign IDs to new identities.
<ul class="org-ul">
<li>When a user writes a new identity, <code>kmalloc()</code> is used to allocate it.  In
particular, this call uses the <code>GFP_KERNEL</code> flag, meaning it can block.  But
we are forbidden from blocking when in possession of a spinlock.  Thus,
while a spinlock might be faster here, I can&rsquo;t use one.</li>
<li>We <i>could</i> get around this by using <code>GFP_NOWAIT</code> (which can fail), or
<code>GFP_ATOMIC</code> (which draws upon specially reserved memory, normally for
interrupts) &#x2014; more on these flags <a href="https://www.kernel.org/doc/html/next/core-api/memory-allocation.html">here</a> &#x2014; but this would be, in this
scenario, an unjustifiable abuse of the commons.</li>
</ul></li>
<li><p>
I made a debug macro to prepend messages with extra stuff:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#if</span> 1
<span class="org-preprocessor">#define</span> <span class="org-function-name">MY_DEBUG</span>(<span class="org-variable-name">str</span>, ...)                                              \
    pr_alert(<span class="org-string">"%s:%s():%d: "</span> str <span class="org-string">"\n"</span>,                                   \
             THIS_MODULE-&gt;name,                                         \
             __FUNCTION__,                                              \
             __LINE__,                                                  \
             ##__VA_ARGS__)
<span class="org-preprocessor">#else</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">MY_DEBUG</span>(<span class="org-variable-name">str</span>, ...)
<span class="org-preprocessor">#endif</span>
</pre>
</div>
<ul class="org-ul">
<li>I had initially tried using <code>pr_debug()</code> inside this macro instead of
<code>pr_alert()</code>, but it didn&rsquo;t work: loading the module with <code>dyndbg==p</code> was not
enabling the messages.  Debug print calls are individually catalogued by
where they are in the source file (filename, function name, line number,
module name).  It would appear that this registration process is not
macro-aware.</li>
<li>Prepending <code>##</code> to <code>__VA_ARGS__</code> means that any further arguments indicated by
the ellipsis are optional, and, if absent, the preprocessor will omit the
preceding comma.</li>
</ul></li>
<li><p>
An interesting GCC warning I encountered, &ldquo;suggest parentheses around
assignment used as truth value&rdquo;, appeared in reference to this:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">while</span> ((list = list-&gt;next)) {
    <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
}
</pre>
</div>
<ul class="org-ul">
<li>This is, apparently, a convention with regard to assignments inside
conditionals: an assign is a common typo for a compare, so if an assign is
intended, you should wrap that assignment in parentheses to indicate this.</li>
<li>For lack of a more visually unambiguous syntax, this seems like a good
idea.</li>
</ul></li>
<li><p>
I got sick of not having scrollback on the default framebuffer console, so I
started using <a href="https://en.wikipedia.org/wiki/GNU_Screen">GNU Screen</a>.  And I&rsquo;m going to post my config here, because you
can&rsquo;t stop me:
</p>
<div class="org-src-container">
<pre class="src src-conf"><span class="org-comment-delimiter">## </span><span class="org-comment">Disable splash screen</span>
startup_message off

<span class="org-comment-delimiter">## </span><span class="org-comment">Enable colours</span>
term screen-256color

<span class="org-comment-delimiter">## </span><span class="org-comment">Scroll back</span>
defscrollback 10000

<span class="org-comment-delimiter">## </span><span class="org-comment">Start at window 1, not 0</span>
bind c screen 1
bind ^c screen 1
bind 0 select 10                                                            
screen 1

<span class="org-comment-delimiter">## </span><span class="org-comment">Change the command character/escape key to "Ctrl-\" (the default is</span>
<span class="org-comment-delimiter">## </span><span class="org-comment">"Ctrl-a").  Terminals normally treat this as a SIGQUIT (a stronger</span>
<span class="org-comment-delimiter">## </span><span class="org-comment">"Ctrl-c"/SIGINT).  "Ctrl-\ + \" will inject this into the window.</span>
escape ^\\\

<span class="org-comment-delimiter">## </span><span class="org-comment">Turn off the ugly "visual bell"</span>
vbell off

<span class="org-comment-delimiter">## </span><span class="org-comment">Better status bar -- shows window list, login name and current date.</span>
hardstatus alwayslastline <span class="org-string">"%{wk}%?%-Lw%?%{bw}%n*%f %t%?(%u)%?%{wk}%?%+Lw %=%{mk}@%H %{yk}%D %{ck}%M%{wk} %{ck}%d %{gk}%c"</span>

<span class="org-comment-delimiter">## </span><span class="org-comment">Allow use of the scroll bar in xterm, Konsole, etc.</span>
termcapinfo xterm*|rxvt*|kterm*|Eterm* ti@:te@

<span class="org-comment-delimiter">## </span><span class="org-comment">Open a couple extra tabs/buffers (what screen calls "windows") at startup</span>
screen -t linux 2
stuff <span class="org-string">"cd /home/debian/builds/linux; clear^M"</span>
screen -t linux 3
stuff <span class="org-string">"cd /home/debian/builds/linux; clear^M"</span>
select 1
</pre>
</div></li>
<li>In my <code>write()</code> implementation, I had to return the full length of the write
that was requested, rather than the truncated length that was actually
written into the name buffer.  If I returned the truncated length, then the
upper layers would assume a partial write had occurred, and invoke our
callback again, resulting in a second identity being created with the rest
of the string as its name.
<ul class="org-ul">
<li>However, I still increment the file offset by the truncated write length.</li>
<li>To be honest though, I&rsquo;m not really sure what the offset value actually
means in the context of a misc char driver.</li>
<li>I have seen at least one <code>read()</code> implementation that would return 0 early
if the user specified an offset other than 0.  (Perhaps I should do that
too?)</li>
</ul></li>
<li>Up to some point, in calls to <code>kmalloc()</code>, I had been calculating the
allocation size with <code>sizeof(struct identity)</code>, but arguably a better way is
to use <code>sizeof(*p)</code>.  As per <a href="https://www.kernel.org/doc/html/latest/process/coding-style.html#allocating-memory">style guidelines</a>: &ldquo;The alternative form where
struct name is spelled out hurts readability and introduces an opportunity
for a bug when the pointer variable type is changed but the corresponding
sizeof that is passed to a memory allocator is not.&rdquo;</li>
<li>Absent from previous tasks, I also added <code>.owner = THIS_MODULE</code> to the file
ops struct for my device file.  Supposedly this prevents the module from
being unloaded while such a file is open.  (Oops!  That was probably
important.)</li>
<li>I <i>still</i> have no idea what the <code>busy</code> flag in <code>struct identity</code> (introduced in
) was for.
<ul class="org-ul">
<li>Currently, the mutex I used to protect the list of identities is a
separate, static object.  Perhaps this <code>busy</code> flag should have been a mutex
field all along?</li>
</ul></li>
<li>Thoughts on the kthread function:
<ul class="org-ul">
<li>The tasks wants our kthread function to, upon finding a new identity:
<ul class="org-ul">
<li>sleep briefly;</li>
<li>print the new identity;</li>
<li>free that identity; and then</li>
<li>go back to the wait queue.</li>
</ul></li>
<li>My implementation does in a slightly different order:
<ul class="org-ul">
<li>print the new identity;</li>
<li>free that identity;</li>
<li>sleep briefly; and then</li>
<li>go back to the wait queue.</li>
</ul></li>
<li>Arguably this achieves the same effect, except that it prints a new
identity right away.  Identities that are created in close succession will
still have to wait.</li>
<li>The reason I rearranged this is because I need to be holding the lock
during the get&#x2013;print&#x2013;destroy.  In this scenario, if I had to sleep <i>after</i>
finding a new identity, I would need to release the lock first, then
reacquire it after waking.</li>
<li>This could be avoided if I my <code>identity_destroy()</code> function didn&rsquo;t have to
free the object but only remove it from the list.  I could then delay the
freeing of the object until after waking from sleep.</li>
<li>My kthread function could be made a bit cleaner if I were able to move the
calls to kmalloc/free outside of list operations &#x2014; I could likewise move
the mutex lock/unlock calls <i>inside</i> the list operations.</li>
<li>But this is all academic; I don&rsquo;t have someone senior to review my code.</li>
</ul></li>
<li>Regarding <code>mutex_lock_interruptible()</code>, <code>wait_event_interruptible()</code>, and
returning early from signals or spurious wakeups, see my
.</li>
<li>Some thoughts on wait queue condition variables:
<ul class="org-ul">
<li><p>
My kthread&rsquo;s entry onto the wait queue looks like this:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-function-name">wait_event_interruptible</span>(wee_wait, <span class="org-type">kthread_should_stop</span>() || identity_get());
</pre>
</div></li>
<li><p>
After waking up, I then try to acquire the lock:
</p>
<div class="org-src-container">
<pre class="src src-c">mutex_lock_interruptible(&amp;identities_lock);
</pre>
</div></li>
<li><p>
Would it be bad form to combine these, such that I am acquiring the lock
as part of the wait condition?
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-function-name">wait_event_interruptible</span>(
    wee_wait,
    <span class="org-type">kthread_should_stop</span>() || (<span class="org-type">identity_get</span>() &amp;&amp; <span class="org-negation-char">!</span>mutex_lock_interruptible(&amp;identities_lock)));
</pre>
</div></li>
<li>My vague spidey sense is saying &ldquo;Don&rsquo;t do it!&rdquo;</li>
<li>Maybe it&rsquo;s because I feel that the work sandwiched between locking calls
always ought to be completely transparent and determinate.  The
<code>wait_event_interruptible()</code> macro is not my own &#x2014; for all I know it is
taking the given boolean expression off on some wild adventure &#x2014; so I&rsquo;d
prefer to keep the locking call separate.</li>
<li>Also, locking doesn&rsquo;t feel logically associated with the purpose of our
wait queue.  The only reason for exiting the wait queue is either that a
new identity is ready to process, or our kthread is being asked to stop.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2538929" class="outline-2">
<h2 id="task-19"><span class="section-number-2">19</span> Task 19</h2>
<div class="outline-text-2" id="text-task-19">
<blockquote>
<p>
Handling delayed work is easy now, right?  So, time to move on to something
totally different.  How about networking?  We have been ignoring that part of
the kernel, so let us now focus on the network side of the kernel, as that is
a huge reason for why Linux has taken over the world.
</p>

<p>
For this task, write a netfilter kernel module that does the following:
</p>
<ul class="org-ul">
<li>monitors all IPv4 network traffic that is coming into the machine</li>
<li>prints the id to the kernel debug log if the network traffic stream contains
your id</li>
<li>properly unregisters you from the netfilter core when the module unloads</li>
</ul>

<p>
Test this by sending yourself an email with your id in the subject, much like
the email you need to send back to me.
</p>
</blockquote>

<p>
I start this section off with a revision of some of the details concerning the
networking subsystem, in order to get a clearer idea of the Netfilter
framework and where it fits in.
</p>
</div>
<div id="outline-container-orgcb1737e" class="outline-3">
<h3 id="cd7fd39a-ccb8-4fea-a956-86587da6d880"><span class="section-number-3">19.1</span> Network devices and Netfilter</h3>
<div class="outline-text-3" id="text-cd7fd39a-ccb8-4fea-a956-86587da6d880">
<p>
The oft-repeated maxim that in Linux &ldquo;everything is a file&rdquo; is only a partial
truth.  This rule doesn&rsquo;t apply when it comes to network interfaces &#x2014; what
network device drivers create in order to provide access to the outside world.
</p>

<p>
To be clear, network interfaces should not be confused with network <i>sockets</i>,
which <i>are</i> a kind of file, and which behave much like a char device.  Network
interfaces have more similarity to block devices, viz., a device driver
registers a virtual device with the kernel, and transmits blocks of data to it
upon request.  However, unlike block devices:
</p>
<ul class="org-ul">
<li>they don&rsquo;t appear in the filesystem, but are configured instead via netlink
sockets (or, once upon a time, ioctl calls);</li>
<li>they define a set of ops different to the usual file ops like <code>read()</code> and
<code>write()</code>; and</li>
<li>they can receive blocks asynchronously from the outside world, i.e. as
inbound packets (a block driver receives blocks only to service a local
request, e.g., a <code>read()</code>).</li>
</ul>

<p>
Creating a network socket requires that one specify a domain and protocol
family, but the concern of routing policy &#x2014; which network interface to use,
and when &#x2014; is handled elsewhere.  The <a href="https://en.wikipedia.org/wiki/Netfilter">Netfilter framework</a> (or <a href="https://en.wikipedia.org/wiki/Nftables">nftables</a>)
integrates into this routing logic.  Where network packets flow between
user-space and the underlying network devices, one can register their own
custom handlers at key stages.  These handlers &#x2014; perhaps analogous to the
gauntlet of ticketing, air-traffic control, routing and connecting flights,
customs, and security checkpoints an airline passenger must pass through, at
multiple stops &#x2014; are most commonly employed for administrative tasks such
as:
</p>
<ul class="org-ul">
<li>packet filtering and firewalls;</li>
<li>routing and NAT;</li>
<li>packet defragmentation;</li>
<li>connection tracking; and</li>
<li>logging.</li>
</ul>

<p>
Handlers inform the network protocol stack, at several points, what is to be
done with the packet, as indicated by their return value:
</p>
<dl class="org-dl">
<dt><code>NF_ACCEPT</code></dt><dd>&ldquo;Pass on the packet through the protocol stack as normal.&rdquo;</dd>

<dt><code>NF_DROP</code></dt><dd>&ldquo;Drop the packet.&rdquo;</dd>

<dt><code>NF_STOLEN</code></dt><dd><p>
&ldquo;I&rsquo;m assuming responsibility for this packet; don&rsquo;t pass it
on.&rdquo;
</p>

<p>
A difference between this and <code>NF_DROP</code> is that the latter will result in the
packet being freed, whereas returning the former means that we&rsquo;ll need to
free the packet object (called a <i>socket buffer</i>; more on this later)
ourselves with <code>consume_skb()</code> once we&rsquo;re done playing with it.
</p></dd>

<dt><code>NF_QUEUE</code></dt><dd><p>
&ldquo;Defer handling of this packet to a user-space process, should
one be registered to do so.&rdquo;
</p>

<p>
This means the packet will be placed in a queue, which said process can read
from via a netlink socket.  Once it has done its work on the packet, it
reinjects it back into the kernel and/or sends a verdict (accept, drop,
etc.).
</p>

<p>
The kernel subsystem for facilitating the registration of user-space
processes to handle packets is called <code>nfnetlink_queue</code>.
</p></dd>

<dt><code>NF_REPEAT</code></dt><dd><p>
&ldquo;Reinject this packet back into the start of the hook and start
the process anew.&rdquo;
</p>

<p>
In other words, the packet will have to go through not just this handler but
<i>all</i> handlers that are registered on this hook.  This can be useful for
user-space handlers that want a packet to go back through the hook from
which it was initially <code>NF_QUEUE</code>&rsquo;d.
</p>

<p>
A packet can be <code>NF_REPEAT</code>&rsquo;ed in this way indefinitely (for better or worse).
</p></dd>
</dl>

<p>
The netfilter subsystem is operable from user-space via <a href="https://en.wikipedia.org/wiki/Nftables">nftables</a><sup><a id="fnr.58" class="footref" href="#fn.58">58</a></sup>; namely, libnftables and the <code>nft</code> cli
tool.  And indeed, one normally ought to implement basic networking tasks from
user-space (where an increasing number of tasks, ones that in a <a href="https://en.wikipedia.org/wiki/Monolithic_kernel">monolithic
kernel</a> are usually kernel-mode responsibilities, are being shunted to).
After all, a mantra of the Linux kernel project is to &ldquo;implement mechanism,
not policy&rdquo;, and packet filtering is policy-dependent.  Of course, a kernel
module still needs to be involved in turning whatever policy the user
specifies (what nftables calls a <i>ruleset</i>) into packet handlers that produce
the desired effects.
</p>

<p>
In our module, however, the functionality of the handler will be hardcoded in.
Namely, it will:
</p>
<ul class="org-ul">
<li>monitor only inbound IPv4 packets;</li>
<li>printk a particular string whenever it appears in a packet; and</li>
<li>accept every packet unconditionally, i.e. do nothing else to the packet.</li>
</ul>
</div>
</div>
<div id="outline-container-org5db9a0d" class="outline-3">
<h3 id="46e91529-0618-4365-8938-4a9b7bdef9d1"><span class="section-number-3">19.2</span> Packet-flow and Netfilter hooks</h3>
<div class="outline-text-3" id="text-46e91529-0618-4365-8938-4a9b7bdef9d1">
<p>
The basic migratory life-cycle of an inbound IPv4 packet, from hardware to
user-space, looks like this:
</p>
<ul class="org-ul">
<li>A network device interrupts the processor, indicating that it has received a
packet whose <a href="https://en.wikipedia.org/wiki/MAC_address">MAC address</a> matches this interface.</li>
<li>The device driver then fetches this packet into RAM &#x2014; it is packed into a
<a href="https://docs.kernel.org/networking/skbuff.html">socket buffer (skb)</a>, plus other relevant metadata.</li>
<li>The skb is passed to a <a href="https://en.wikipedia.org/wiki/Interrupt_handler#Divided_handlers_in_modern_operating_systems">bottom-half</a>, one dedicated to network-specific tasks.
Interrupt handling concludes.</li>
<li>Some time later, the bottom-half dispatches the skb to a packet handler
specific to the type of the packet (IPv4 in this case).</li>
<li>The handler performs some sanity-checks and book-keeping.</li>
<li>Finally, the handler determines, based on its address and routing policies,
whether:
<ul class="org-ul">
<li>the packet is for us: it is passed up the network stack (eventually to a
user-space socket); xor</li>
<li>the packet is to be forwarded elsewhere: it is passed back down the
network stack.</li>
</ul></li>
</ul>

<p>
The life-cycle of an <i>outbound</i> packet looks much like this, just in reverse.
Outbound packets can similarly be routed back up the network stack if their
destination is an interface on the host itself (as is the case for data sent
to a loopback address; these are routed to the virtual loopback interface).
</p>

<p>
Handlers for each network protocol define their own set of hooks at select
points in this processing pipeline of their packet-type.  In IPv4, it looks
something like figure <a href="#orgc8397a9">1</a> below (a much more detailed,
protocol-agnostic view is given <a href="https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg">here</a>):
</p>

<div id="orgc8397a9" class="figure">
<p><img src="img/netfilter-hooks.png" alt="netfilter-hooks.png" width="100%" />
</p>
<p><span class="figure-number">Figure 1: </span><i>A simplified view of Netfilter hooks for the IPv4 packet handler (circumscribed by the dotted-line).  Boxes with solid-lines represent hook sites; diamonds represent where routing logic occurs.</i></p>
</div>

<p>
Note that the network interfaces in this diagram aren&rsquo;t strictly external
hardware.  In particular, packets routed to the loopback interface don&rsquo;t get
to short-circuit this process &#x2014; they will still have to pass through
<code>NF_INET_LOCAL_IN</code> on their way back in.
</p>

<p>
This will be relevant when it comes to sending email to ourselves on the same
machine.  (And yet also relevant is the fact that, in recognising this, the
may not involve the network stack at all.  That is, if the email is
between two local users, whose mailboxes are on the same filesystem, it may
simply be copied &#x2014; more on this later.)
</p>
</div>
</div>
<div id="outline-container-org3c876d0" class="outline-3">
<h3 id="64aa9355-9e8a-4c65-be8c-14e609fe9f30"><span class="section-number-3">19.3</span> Registering hook ops</h3>
<div class="outline-text-3" id="text-64aa9355-9e8a-4c65-be8c-14e609fe9f30">
<p>
The main interface for this is available in <code>linux/netfilter.h</code>.  In addition,
we&rsquo;ll need <code>linux/netfilter_ipv4.h</code> (which pulls in <code>uapi/linux/netfilter_ipv4.h</code>)
in order to specify the IP-specific hook we attach our callback to, and its
priority relative to other callbacks in that chain.  And for inspecting packet
headers we&rsquo;ll need the respective protocol-specific header structures,
<code>linux/ip.h</code> first and foremost.
</p>

<p>
A handler is defined in a <code>struct nf_hook_ops</code>:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">struct</span> <span class="org-type">nf_hook_ops</span> {
        <span class="org-type">nf_hookfn</span> *<span class="org-variable-name">hook</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">our filter callback</span>
        <span class="org-keyword">struct</span> <span class="org-type">net_device</span> *<span class="org-variable-name">dev</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">network interface we want to monitor packets on</span>
        <span class="org-type">void</span> *<span class="org-variable-name">priv</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">context pointer sent to our callback (optional)</span>
        <span class="org-type">u8</span> <span class="org-variable-name">pf</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">protocol/address family (PF_INET == AF_INET == NFPROTO_IPV4 != NFPROTO_INET)</span>
        <span class="org-keyword">enum</span> <span class="org-type">nf_hook_ops_type</span> <span class="org-variable-name">hook_ops_type</span> : 8; <span class="org-comment-delimiter">// </span><span class="org-comment">no idea what this is for; can be ignored</span>
        <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">hooknum</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">specifies the hook to attach our filter callback to</span>
        <span class="org-type">int</span> <span class="org-variable-name">priority</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">filter priority; see uapi/linux/netfilter_ipv4.h for other values</span>
};
</pre>
</div>

<p>
Some of these fields are optional.  The <code>dev</code> field can be left unset, because
we want to monitor packets coming in from <i>all</i> interfaces.  The <code>hook_ops_type</code>
field doesn&rsquo;t seem to have any purpose that I can as yet identify.
</p>

<p>
The protocol/address family, <code>u8 pf</code>, is the same as what a user would provide
when <a href="https://man7.org/linux/man-pages/man2/socket.2.html">creating a socket</a>.  In that context, <code>PF_INET</code> and <code>AF_INET</code> both refer to
IPv4, and are functionally identical (the <a href="https://en.wikipedia.org/wiki/Berkeley_sockets#Protocol_and_address_families">wikipedia article on sockets</a>
elaborates on this).  To clear up any possible confusion: the
netfilter-specific <code>NFPROTO_INET</code> enum, though similarly named, selects not only
IPv4 packets, but IPv6 packets as well; <code>NFPROTO_IPV4</code> and <code>NFPROTO_IPV6</code> select
only one or the other.  (The IPv6-counterpart for user-space are <code>PF_INET6</code> and
<code>AF_INET6</code>.)
</p>

<p>
Yet another possible confusion to clear up, this time with regard to
specifying <code>hooknum</code>: there are two different macros, <code>NF_IP_*</code> and <code>NF_INET_*</code>.  I
have no idea what the difference is, other than to note that the former isn&rsquo;t
used anywhere.  Presumably we should use the latter.  To add insult to injury,
the enum for specifiying a hook <code>priority</code> employs the <code>NF_IP_*</code> prefix&#x2026;
</p>

<p>
Â¯â€‹\â€‹_â€‹(â€‹ãƒ„â€‹)â€‹_â€‹/â€‹Â¯â€‹
</p>

<p>
The prototype of the callback function:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-type">nf_hookfn</span>(
        <span class="org-type">void</span> *<span class="org-variable-name">priv</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">context pointer (will be what was set in nf_hook_ops)</span>
        <span class="org-keyword">struct</span> <span class="org-type">sk_buff</span> *<span class="org-variable-name">skb</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">the packet</span>
        <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">nf_hook_state</span> *<span class="org-variable-name">state</span>); <span class="org-comment-delimiter">// </span><span class="org-comment">some possibly useful status info</span>
</pre>
</div>

<p>
Registration:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-type">int</span> <span class="org-function-name">nf_register_net_hook</span>(<span class="org-keyword">struct</span> <span class="org-type">net</span> *<span class="org-variable-name">net</span>, <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">nf_hook_ops</span> *<span class="org-variable-name">ops</span>);
<span class="org-type">void</span> <span class="org-function-name">nf_unregister_net_hook</span>(<span class="org-keyword">struct</span> <span class="org-type">net</span> *<span class="org-variable-name">net</span>, <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">nf_hook_ops</span> *<span class="org-variable-name">ops</span>);
</pre>
</div>

<p>
Enabling <code>CONFIG_NET_NS</code> allows network administrators to create multiple
network namespaces; isolated instances of the network stack (more on this
<a href="https://lwn.net/Articles/580893/">here</a>).  The <code>struct net</code> parameter above specifies the network namespace to
register on.  For most purposes, this will be the top-level namespace:
<code>init_net</code>.
</p>
</div>
</div>
<div id="outline-container-orgf83f512" class="outline-3">
<h3 id="3f8d9bca-747a-4107-9011-a75747c533ed"><span class="section-number-3">19.4</span> Socket buffers</h3>
<div class="outline-text-3" id="text-3f8d9bca-747a-4107-9011-a75747c533ed">
<p>
The skb structure which houses a packet&rsquo;s data, <code>struct sk_buff</code> (see <a href="https://docs.kernel.org/networking/skbuff.html">here</a> and
<a href="https://www.kernel.org/doc/html/latest/networking/kapi.html#c.sk_buff">here</a>), is at the core of the networking subsystem, along with, and to be
distinguished from:
</p>
<ul class="org-ul">
<li><code>struct socket</code>, or <i>BSD socket</i>, a representation of a user-space socket; and</li>
<li><code>struct sock</code>, or <i>INET socket</i>, a protocol-agnostic network-layer
representation of a socket (every <code>sock</code> is associated with one <code>socket</code>, and
vice-versa).</li>
</ul>

<p>
At this level of the networking stack, there is no concept of a socket <i>per se</i>.
Nevertheless, every skb (except for forwarded traffic) is associated with a
logical socket in the upper layers.  A socket could be thought of as a pair of
skb queues (&ldquo;tx&rdquo; and &ldquo;rx&rdquo;).
</p>

<p>
The skb structure stores packet metadata directly.  The packet itself, on the
other hand, is stored indirectly, i.e. in one or more external buffers.  (Note
that the packet&rsquo;s protocol-specific <i>headers</i> (sans those of the physical layer)
are in the buffers, not in metadata.)  Protocol handlers use the skb&rsquo;s fields
not so much to store data, but to record the positions and lengths of its
segments, once parsed.  For example, the skb helper function to get the start
of the network header (from <code>include/linux/skbuff.h</code>):
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">static</span> <span class="org-keyword">inline</span> <span class="org-type">unsigned</span> <span class="org-type">char</span> *<span class="org-function-name">skb_network_header</span>(<span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">sk_buff</span> *<span class="org-variable-name">skb</span>)
{
        <span class="org-keyword">return</span> skb-&gt;head + skb-&gt;network_header;
}
</pre>
</div>
<p>
Complicating this is the fact that the packet may lie across multiple buffers.
Thankfully, the skb helper functions handle all of this complexity, making it
easy to get the data out (and in).  (The way that <code>skb_network_header()</code> and
other functions in <code>include/linux/skbuff.h</code> are implemented suggests to me that
the packet&rsquo;s headers are guaranteed to be contiguous, and that it is only the
packet&rsquo;s payload that may be scattered across multiple buffers.)
</p>

<p>
(The only skb field I had to access directly was <code>len</code>, which was to specify the
range over which to perform a textual search on the packet, viz., the whole
thing.  There are a few other skb fields with similar but delightfully
unhelpful names, so it wasn&rsquo;t immediately clear which value to use.  Like,
literally from the docs: <code>len</code> = &ldquo;Length of actual data&rdquo;; <code>data_len</code> = &ldquo;Data
length&rdquo; ðŸ˜‘)
</p>
</div>
</div>
<div id="outline-container-org007b896" class="outline-3">
<h3 id="5574be25-c38b-4242-9017-f3e3fb9483c7"><span class="section-number-3">19.5</span> Inspecting packets</h3>
<div class="outline-text-3" id="text-5574be25-c38b-4242-9017-f3e3fb9483c7">
<p>
Firstly, what hook should we use?  The task asks us to monitor &ldquo;all IPv4
network traffic that is coming into the machine&rdquo;.  That&rsquo;s a little ambiguous
&#x2014; it could refer to:
</p>
<ul class="org-ul">
<li>any packet, including those forwarded elsewhere; xor</li>
<li>only the packets sent to us.</li>
</ul>

<p>
Looking back at figure <a href="#orgc8397a9">1</a>, we can see that the
<code>NF_INET_PRE_ROUTING</code> and <code>NF_INET_LOCAL_IN</code> hooks reflect this distinction.
</p>

<p>
I chose to use the former, because I wanted to see the <a href="https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol">ICMP</a> packets coming in
as well (these are normally dealt with in kernel-space; more on this later),
but either hook would suffice.
</p>

<p>
As an initial exercise, before doing any kind of textual search, I wrote the
hook op to extract some basic information from the network and transport
headers of each packet, and print them out:
</p>
<div class="org-src-container">
<pre class="src src-c">ip_header = (<span class="org-keyword">struct</span> <span class="org-type">iphdr</span> *)<span class="org-function-name">skb_network_header</span>(skb);
src_ip = ntohl((<span class="org-type">unsigned</span> <span class="org-type">int</span>)ip_header-&gt;saddr);
dest_ip = ntohl((<span class="org-type">unsigned</span> <span class="org-type">int</span>)ip_header-&gt;daddr);
src_port = 0;
dest_port = 0;
<span class="org-keyword">if</span> (ip_header-&gt;protocol == 17) {
    udp_header = (<span class="org-keyword">struct</span> <span class="org-type">udphdr</span> *)(skb_transport_header(skb) + 20);
    src_port = (<span class="org-type">unsigned</span> <span class="org-type">int</span>)ntohs(udp_header-&gt;source);
    dest_port = (<span class="org-type">unsigned</span> <span class="org-type">int</span>)ntohs(udp_header-&gt;dest);
} <span class="org-keyword">else</span> <span class="org-keyword">if</span> (ip_header-&gt;protocol == 6) {
    tcp_header = (<span class="org-keyword">struct</span> <span class="org-type">tcphdr</span> *)(skb_transport_header(skb) + 20);
    src_port = (<span class="org-type">unsigned</span> <span class="org-type">int</span>)ntohs(tcp_header-&gt;source);
    dest_port = (<span class="org-type">unsigned</span> <span class="org-type">int</span>)ntohs(tcp_header-&gt;dest);
}

<span class="org-comment-delimiter">/* </span><span class="org-comment">print out src, dest ip addresses in decimal</span><span class="org-comment-delimiter"> */</span>
<span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>

<span class="org-comment-delimiter">/* </span><span class="org-comment">print out transport-layer info</span><span class="org-comment-delimiter"> */</span>
<span class="org-keyword">switch</span> (ip_header-&gt;protocol) {
<span class="org-keyword">case</span> IPPROTO_ICMP:
    icmp_header = (<span class="org-keyword">struct</span> <span class="org-type">icmphdr</span> *)((<span class="org-type">char</span> *)ip_header + <span class="org-keyword">sizeof</span>(<span class="org-keyword">struct</span> <span class="org-type">iphdr</span>));
    <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">break</span>;
<span class="org-keyword">case</span> IPPROTO_TCP:
    <span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>
}
</pre>
</div>

<p>
Small details:
</p>
<ul class="org-ul">
<li>The <code>ntohl()</code> and <code>ntohs()</code> functions are for converting from the network&rsquo;s
<a href="https://en.wikipedia.org/wiki/Endianness">byte-order</a> to the host&rsquo;s, should they differ.  And on x86-based
architectures, they do indeed: x86 is little-endian, whereas <a href="https://en.wikipedia.org/wiki/Internet_protocol_suite">internet
protocols</a> are generally big-endian.  The network stack won&rsquo;t do this
conversion for us; we must perform the conversion manually whenever reading
from or writing to certain fields in the network header.  Most notably, this
includes IP addresses and port numbers.</li>
<li>The IP header contains some fields with names like <code>inner_protocol</code> and
<code>inner_network_header</code>.  These are used for additional protocol encapsulation
such as <a href="https://en.wikipedia.org/wiki/IPsec">IPsec</a>, which is an implementation of packet encryption and
authentication at the network layer.  I think we can safely ignore these.</li>
<li>ICMP operates at the internet/network layer, alongside IP; ICMP packets are
basically special IP packets that contain ICMP data.  When an ICMP packet
arrives, it is handled as a special case by the IP packet handler, rather
than being passed up the networking stack.  (The <code>ip</code>â€‹/â€‹<code>iptables</code> utilities let
the user configure how they are handled.)</li>
<li>If user-space wants to <i>send</i> an ICMP packet, it has to construct the packet
by hand, and then send it via a raw socket (e.g. <code class="src src-c">sock = socket(AF_INET, SOCK_RAW, IPPROTO_ICMP);</code>) in order to bypass the transport
layer.</li>
<li>In my code, I don&rsquo;t bother to verify the contents of the packet.  But is it
safe to assume, for instance, that an ICMP packet contains enough data to
constitute a complete ICMP structure?  That it&rsquo;s a <i>valid</i> ICMP structure?
The latter might not be so important for this task, but does my function at
least need to verify the packet&rsquo;s size?  Does the IP packet handler already
do some of this checking for us? &#x2014; Something to follow up on.</li>
</ul>

<p>
Finally, what is the most efficient way to search for a specific string inside
a packet?  I could perhaps just call <code>strstr()</code> on the whole packet, but this
function expects null-terminated input, which our packet is not.  (This also
applies to <code>strnstr()</code>.)  Worse, the packet data may be scattered across
multiple buffers, .
</p>

<p>
Fortunately, there exist solutions to both these problems.  Respectively:
</p>
<ul class="org-ul">
<li>the <a href="https://docs.kernel.org/core-api/kernel-api.html#text-searching">textsearch</a> API; and</li>
<li><a href="https://docs.kernel.org/networking/kapi.html#c.skb_find_text">skbâ€‹_â€‹findâ€‹_â€‹text()</a>.</li>
</ul>

<p>
The textsearch API depends on <code>CONFIG_TEXTSEARCH</code>.  More specifically, what we
need to enable is <code>CONFIG_NETFILTER_XT_MATCH_STRING</code>.  (Within <code>menuconfig</code>, this
can be found in <i>Networking support</i> â†³ <i>Networking options</i> â†³ <i>Networking patcket
filtering framework</i> â†³ <i>Core Netfilter Configuration</i> â†³ <i>String match support</i>.)
</p>
</div>
</div>
<div id="outline-container-orge2d0fc4" class="outline-3">
<h3 id="cd2ed185-d8ed-4358-b794-90e6c44ddd92"><span class="section-number-3">19.6</span> Testing</h3>
<div class="outline-text-3" id="text-cd2ed185-d8ed-4358-b794-90e6c44ddd92">
<p>
A self-dialogue:
</p>
<ul class="org-ul">
<li>&ldquo;How about we send ourselves a short email, and see what our netfilter hook
op picks up?&rdquo;</li>
<li>&ldquo;How about <i>no</i>?&rdquo; says the technology.</li>
<li><p>
&ldquo;Hah!  I&rsquo;ll just use the <code>mail</code> command from <code>mailutils</code>.  Easy.&rdquo;
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-builtin">echo</span> <span class="org-string">"Hello world! eudyptula"</span> | mail -s <span class="org-string">"Test email"</span> debian
</pre>
</div>
<ul class="org-ul">
<li><p>
&ldquo;Wait&#x2014; what&rsquo;s this?&rdquo;
</p>
<div class="org-src-container">
<pre class="src src-text">My unqualified host name (debian) unknown"; sleeping for retry
</pre>
</div></li>
<li>&ldquo;I don&rsquo;t care!  Just send the damn thing!&rdquo;</li>
<li>&ldquo;Ok, it looks like I need to edit <code>/etc/hosts</code> so that the <code>mail</code> command
recognises that <code>debian</code> refers to a domain, and that said domain is us.
The host table is mostly superseded by DNS, but still used for important
hosts on a local network.&rdquo;
<ul class="org-ul">
<li>&ldquo;Ok, so the <a href="https://man7.org/linux/man-pages/man5/hosts.5.html">hosts(5) manpage</a> describes the format of this file; one line
per IP address, each being assigned a canonical hostname and a list of
aliases.&rdquo;</li>
<li>&ldquo;It looks like I can use <code>localhost.localdomain</code> as the host address.&rdquo;</li>
<li>&ldquo;Modifying the hosts should take effect immediately, unless it&rsquo;s being
cached by the app in question&#x2026; systemd?  Hmmm, I may need to restart
<code>systemd-hostnamed</code> then.  But this may not be necessary for the <code>mail</code>
utility, assuming that it resolves names via glibc/nss (the
<code>getaddrinfo()</code> API).&rdquo;</li>
<li>&ldquo;Hmmm, it turns out there are <i>multiple</i> services for hostname resolution.
There&rsquo;s <code>nss-resolve</code> (DNS stub resolver, handled by <code>systemd-resolved</code>),
<code>nss-myhostname</code> (local hostname resolution without having to edit
<code>/etc/hosts</code>), and <code>nss-mymachines</code> (hostname resolution for local
<code>systemd-machined</code> containers).&rdquo;</li>
<li>&ldquo;Clearly I need to look at <code>nss-myhostname</code> more closely.&rdquo;
<ul class="org-ul">
<li>&ldquo;There&rsquo;s a cmdline utility, <code>hostnamectl</code>, to change the hostname.
Alrighty.&rdquo;</li>
<li>&ldquo;Oh, it turns out there are three different kinds of hostname.&rdquo;
<ul class="org-ul">
<li>&ldquo;There&rsquo;s the &lsquo;pretty&rsquo; hostname (e.g. &lsquo;Scott&rsquo;s PC&rsquo;).&rdquo;</li>
<li>&ldquo;There&rsquo;s the &lsquo;static&rsquo; hostname (e.g. &lsquo;scotts-pc&rsquo;).&rdquo;</li>
<li>&ldquo;And there&rsquo;s the &lsquo;transient&rsquo; hostname, a fallback value that&rsquo;s only
used if the static hostname is left unset.&rdquo;</li>
</ul></li>
</ul></li>
<li>&ldquo;Righteo.  So what are my options?&rdquo;
<ul class="org-ul">
<li>&ldquo;Add <code>127.0.0.1 localhost.localdomain localhost</code> to <code>/etc/hosts</code>.&rdquo;</li>
<li>&ldquo;Add <code>domain example.org</code> to <code>/etc/resolv.conf</code>.&rdquo;</li>
<li>&ldquo;Run <code>hostnamectl set-hostname &lt;new_hostname&gt;</code> (this sets all three
hostname types alike).&rdquo;</li>
</ul></li>
</ul></li>
<li>&ldquo;Oh, silly me!  How can I receive emails if there is no mailserver
present!  Haha<sup>haha<sup>haha<sup>haha &#x2026; *â€‹sighâ€‹*&ldquo;</sup></sup></sup>
<ul class="org-ul">
<li>&ldquo;Right.  Install postfix; select &lsquo;local only&rsquo; at the prompt; leave
server name as is (&lsquo;debian&rsquo; in my case).&rdquo;</li>
<li>&ldquo;Oh.  As it turns out, this fixed the hostname issue.  Which may be
because it recognises <code>debian</code> as a user (me).&rdquo;</li>
</ul></li>
</ul></li>
<li><p>
&ldquo;Let&rsquo;s try that again.&rdquo;
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-builtin">echo</span> <span class="org-string">"Hello world! eudyptula"</span> | mail -s <span class="org-string">"Test email"</span> debian
</pre>
</div>
<ul class="org-ul">
<li>&ldquo;Hmmm.  My netfilter hook op doesn&rsquo;t pick up anything, despite the <code>mail</code>
command showing me that I did in fact receive the email (it also turns up
in <code>/var/mail/</code>).&rdquo;</li>
<li>&ldquo;Actually, that&rsquo;s not true!  I <i>did</i> receive a UDP packet.  Its payload
seems to contain the string <code>debian@&lt;number&gt;:/var/mail/debian</code>.  But the
email contents aren&rsquo;t in there.  (Plus, isn&rsquo;t email transmitted via TCP?)&rdquo;</li>
</ul></li>
<li><p>
&ldquo;Hmmm.  Lets try sending an email to the root user instead.&rdquo;
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-builtin">echo</span> <span class="org-string">"Hello world! eudyptula"</span> | mail -s <span class="org-string">"Test email"</span> root
</pre>
</div>
<ul class="org-ul">
<li>&ldquo;Actually, no!  We aren&rsquo;t supposed to send things to root.  Nor should an
administrator be logging in as root.  Generally, they should have their
own user.&rdquo;</li>
</ul></li>
<li>&ldquo;Hmmm.  What if I hook on <i>outgoing</i> packets?&rdquo;
<ul class="org-ul">
<li>&ldquo;Nope, nothing there.&rdquo;</li>
</ul></li>
<li>&ldquo;What&rsquo;s going on here?&rdquo;
<ul class="org-ul">
<li>&ldquo;Perhaps, having configured it to &lsquo;local only&rsquo;, postfix is foregoing the
network and just writing emails directly to the filesystem.  If that&rsquo;s the
case, then this UDP packet may just be a notification that new mail has
arrived; a &lsquo;you have mail!&rsquo; kind of thing.&rdquo;</li>
</ul></li>
<li>&ldquo;Perhaps I&rsquo;ll try sending an email to&#x2014;&rdquo;
<ul class="org-ul">
<li>&ldquo;BLAAAMMMM this stupid thing!&rdquo;</li>
</ul></li>
<li><p>
&ldquo;Nuts to this.  I&rsquo;ll just stuff the ID string inside an ICMP packet header
and call it a day.&rdquo;
</p>
<div class="org-src-container">
<pre class="src src-bash">ping localhost -4 -p <span class="org-string">"$(echo -n "eudyptula" | xxd -p -u)"</span> -c 1
</pre>
</div></li>
</ul>

<p>
And everything turned out great! ðŸ–’
</p>

<p>
Some final notes:
</p>
<ul class="org-ul">
<li>I was printing out packet data to the console in printable ascii and noticed
that many of the packets were samba packets.  (Recall that I in my VM.)  I noticed this because the SMB headers contain a 4-byte
string: <code>{ '\xFF', 'S', 'M', 'B' }</code>.</li>
<li>As stated , the textsearch API depends on <code>CONFIG_TEXTSEARCH</code>.  I forgot
to enable this, and modpost complained about undefined symbols.  This
wouldn&rsquo;t have happened in the first place if our module lived in the kernel
tree, because such modules must provide their own <code>Kconfig</code> file, where the
module&rsquo;s dependencies are described.  An out-of-tree module on the other
hand &#x2014; built independently of the kernel and its configuration &#x2014; doesn&rsquo;t
have a <code>Kconfig</code> file.
<ul class="org-ul">
<li>Though our <code>Makefile</code> can still see what the configuration options of the
kernel we are building against are set to.  Namely, it has access to the
<code>.config</code> file in <code>/lib/modules/$(shell uname -r)/build/</code> (this directory is a
symlink to the kernel tree from which the modules were installed).</li>
<li><p>
I edited my <code>Makefile</code> to reflect this dependency, and added a couple other
things:
</p>
<div class="org-src-container">
<pre class="src src-makefile"><span class="org-comment-delimiter"># </span><span class="org-comment">...</span>

ifndef CONFIG_NETFILTER_XT_MATCH_STRING
  $(<span class="org-variable-name">error</span> This module requires CONFIG_NETFILTER_XT_MATCH_STRING)
endif

<span class="org-variable-name">obj-m</span> := eudyptula.o

<span class="org-comment-delimiter"># </span><span class="org-comment">...</span>
</pre>
</div></li>
<li>I have no idea whether this is <i>the</i> way to specifying configuration
dependencies in an out-of-tree module; whether there&rsquo;s a better one.</li>
</ul></li>
<li><p>
I was printing out packet data in (printable) ascii when I discovered
something.  If you want to print a <i>single</i> line of text with multiple
<code>printk()</code> calls (say, when calling <code>printk()</code> inside a loop that iterates over
a buffer), it&rsquo;s not sufficient to simply omit the linebreaks.  <a href="https://lwn.net/Articles/732420/">This LWN.net
article</a> discusses the behaviour of <code>printk()</code> in more detail.  The upshot is
that we must use <code>pr_cont()</code> for &ldquo;continuation&rdquo; lines.  For example:
</p>
<div class="org-src-container">
<pre class="src src-c">pr_alert(<span class="org-string">"BUF: "</span>);
<span class="org-keyword">for</span> (c = foobuf; c &lt; foobuf_len; c++) {
        <span class="org-keyword">if</span> (*c &gt;= 32 &amp;&amp; *c &lt;= 126)
                pr_cont(<span class="org-string">"%.2x"</span>, *c);
        <span class="org-keyword">else</span>
                pr_cont(<span class="org-string">"."</span>);
}
pr_cont(<span class="org-string">"\n"</span>);
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgb920f98" class="outline-2">
<h2 id="task-20"><span class="section-number-2">20</span> Task 20</h2>
<div class="outline-text-2" id="text-task-20">
<blockquote>
<p>
Networking filters turned out to be not all that complex in the end, great
work with that.
</p>

<p>
So, here&rsquo;s the final task.
</p>

<p>
There might be other tasks that get created and sent out later on, but the
original challenge had 20 tasks, so after finishing this one, you can consider
yourself done!
</p>

<p>
Let&rsquo;s try something a bit harder.  Something that might cause some data loss
on a filesystem, always a fun thing to play with, if for no other reason than
to not be afraid of things like that in the future.
</p>

<p>
This task requires you to work on the fat filesystem code:
</p>
<ul class="org-ul">
<li>Add an ioctl to modify the volume label of a mounted fat filesystem.  Be
sure to handle both 16 and 32 bit fat filesystems (hint!).</li>
<li>Provide a userspace <code>.c</code> program to test this new ioctl.</li>
</ul>

<p>
That&rsquo;s it!  Seems so simple, right?  I wonder why that option isn&rsquo;t in
the kernel tree already&#x2026;
</p>

<p>
Anyway, provide a patch to the kernel, and the .c file used to test the new
ioctl, as well as &ldquo;proof&rdquo; of this working.  Make sure you don&rsquo;t run into
32/64-bit kernel issues with the ioctl, if you do things correctly, you
shouldn&rsquo;t have any problems.
</p>

<p>
I recommend doing this work on either a loop-back fat filesystem on your
&ldquo;normal&rdquo; filesystem, or on a USB stick.  Either will work just as well,
and make things easier to debug and test.
</p>

<p>
Watch out for locking issues, as well as dirty filesystem state
problems.
</p>

<p>
Best of luck!
</p>
</blockquote>

<p>
The question was asked: Why is there no option to modify the volume label of a
mounted FAT filesystem in the manner described?  Some questions that come to
mind:
</p>
<ul class="org-ul">
<li>Modifying the volume label sounds like something one should not be able to
do while the filesystem is mounted.  Is this what the text means when it
says no ioctl option is available to do so?</li>
<li>Is it the case that some filesystems don&rsquo;t support volume labels in the
first place?  Is this what the text means?</li>
<li>Are volume labels even exclusively associated with filesystems in the first
place?  What about the partition table?</li>
<li>What are the differences between 16- and 32-bit FAT filesystems?</li>
<li>What is the relevance of those differences to the task that is being hinted
at?</li>
<li>There certainly <i>is</i> a way to modify volume labels, if not via ioctl commands.
What interface do user-space programs use to do this?</li>
<li>The creation of new ioctl commands, which are often tightly-coupled and
device-specific, has fallen out of favour.  Is this what the text means?</li>
<li>What are loopback filesystems?</li>
</ul>

<p>
I&rsquo;ll revisit these questions before moving on to the kernel and the FAT
driver.
</p>
</div>
<div id="outline-container-org28830c6" class="outline-3">
<h3 id="d5a575b4-d3cd-417d-8845-c9ac28799743"><span class="section-number-3">20.1</span> Volume labels</h3>
<div class="outline-text-3" id="text-d5a575b4-d3cd-417d-8845-c9ac28799743">
<p>
If a <i>partition</i> is a logical division of a hard disk, then a <i>volume</i> is a
logical drive; the result of formatting a partition into a filesystem.
</p>

<p>
Typically, one partition = one volume.  However, by employing a logical volume
management (<a href="https://en.wikipedia.org/wiki/Logical_Volume_Manager_(Linux)">LVM</a>) scheme, a single partition can house multiple logical
volumes, and conversely, a single logical volume can be distributed across
multiple partitions.  Thus &ldquo;volume&rdquo; may refer more abstractly to a logical
chunk of storage space presented by a device mapper, which, in more simple use
cases, is backed by a single partition (which is itself backed by a block
device driver).
</p>

<p>
The trivial definition of a <i>volume label</i> is a string assigned to a particular
volume to identify it.  However, there is ambiguity as to <i>what</i> is doing the
labelling, and <i>where</i> the label resides, namely:
</p>
<ul class="org-ul">
<li><i>inside</i> the volume; ior
<ul class="org-ul">
<li>Most filesystems support a label field in their superblock.</li>
<li>This is listed by <code>lsblk</code> under the <code>LABEL</code> column.  Usually they will also be
listed in <code>/dev/disk/by-label/</code>.</li>
<li>No standard exists here; not everything will support such a label
(e.g. swap, procfs, sysfs), nor is it compulsory to set one if it does so.</li>
</ul></li>
<li><i>outside</i> the volume.
<ul class="org-ul">
<li>A label may be stored in the volume/partition table.</li>
<li>This might also be called the partition &ldquo;name&rdquo;.</li>
<li>Likewise, this is listed by <code>lsblk</code> under the <code>PARTLABEL</code> column, and usually
found in <code>/dev/disk/by-partlabel/</code>.</li>
<li>Again, not everything will have such a label.</li>
<li>GPT-formatted disks support partition labelling; MBR does not.</li>
<li>This should not be confused with any label assigned to the partition table
itself (the name given to the disk (or virtual block device) proper).</li>
</ul></li>
</ul>

<p>
What we are concerned with for this task is the former; what is specific to
the FAT filesystem.
</p>
</div>
</div>
<div id="outline-container-org622bab4" class="outline-3">
<h3 id="a04c12ba-7f88-4def-92c8-4ff5f10c20ac"><span class="section-number-3">20.2</span> FAT</h3>
<div class="outline-text-3" id="text-a04c12ba-7f88-4def-92c8-4ff5f10c20ac">
<p>
The FAT filesystem is <i>old</i>, but it&rsquo;s still kicking around because it&rsquo;s very
simple (at least compared to other filesystems).  It&rsquo;s supported on pretty
much anything you can poke with a flash device, including the bootloader.
</p>

<p>
The main sub-variants are FAT12, FAT16, and FAT32.  Each iteration
successively increased the number of addressable clusters (&ldquo;cluster&rdquo; refers to
the contiguous, uniformly sized chunks on disk where files&rsquo; data are stored;
more on this later), thus expanding the maximum possible volume size one could
format.  On can increase this further by formatting with a larger cluster
size, but this comes at the expense of efficiency &#x2014; the cluster size is
effectively sets a lower bound on a file&rsquo;s footprint on disk.
</p>

<p>
With regard to Linux, the <code>msdos</code> module supports vanilla FAT, while the <code>vfat</code>
module supports an extension (hack) of FAT which enables longer filenames with
special characters.  (The <code>fat</code> module supports nothing by itself, but is a
dependency for both.)  In either case, symlinks are not supported, nor are
Unix permissions.  (We <i>can</i> specify some makeshift permissions at mount time
that are applied to all files, but this is a fudge &#x2014; they cannot be modified
at runtime, and forgotten after unmounting.)  There exists another variant
called exFAT which supports larger devices, but this is proprietary, and
absent from the mainline kernel (though a <a href="https://en.wikipedia.org/wiki/Filesystem_in_Userspace">FUSE</a> driver does exist).
</p>
</div>
<div id="outline-container-org1a86f8d" class="outline-4">
<h4 id="fc0fd2ad-1761-471b-917e-66893301e55a"><span class="section-number-4">20.2.1</span> Structure</h4>
<div class="outline-text-4" id="text-fc0fd2ad-1761-471b-917e-66893301e55a">
<p>
The <a href="https://en.wikipedia.org/wiki/File_Allocation_Table">short-</a> and <a href="https://en.wikipedia.org/wiki/Design_of_the_FAT_file_system">long-form</a><sup><a id="fnr.59" class="footref" href="#fn.59">59</a></sup> Wikipedia articles provide
pretty much all the detail we need.  I provide an abridged version here,
task-specific details included.
</p>

<p>
A complete FAT filesystem contains three main regions, plus a fourth which
only appears on FAT12/FAT16.  All regions have a fixed size once formatted.
They are, in order of appearance:
</p>
<dl class="org-dl">
<dt>Reserved sectors</dt><dd><ul class="org-ul">
<li>This contains the boot sector.  (The first logical sector of a partition
may sometimes be called the <a href="https://en.wikipedia.org/wiki/Volume_boot_record">Volume Boot Record (VBR)</a>, as it can operate as
a kind of <a href="https://en.wikipedia.org/wiki/Master_boot_record">Master Boot Record (MBR)</a> on the level of a partition, as opposed
to the disk proper.  This name is not to imply that a volume is always
bootable, nor will always be present, only that it can be.)  This sector
includes the <a href="https://en.wikipedia.org/wiki/BIOS_parameter_block">BIOS parameter block (BPB)</a>, which contains information about
the filesystem that lives in this partition.</li>
<li>On FAT32, this sector also contains a <a href="https://en.wikipedia.org/wiki/Design_of_the_FAT_file_system#FS_Information_Sector">Filesystem Information Sector</a>, as
well as a backup copy of said boot sector.</li>
</ul></dd>
<dt>File allocation table</dt><dd><ul class="org-ul">
<li>Firstly, &ldquo;clusters&rdquo; refer to the contiguous, uniformly sized chunks in the
data region (see below) where files&rsquo; contents live.  This includes files&rsquo;
metadata which is part of the FAT filesystem spec (e.g. the filename, file
attributes).
<ul class="org-ul">
<li>Note that behind Linux&rsquo;s virtual filesystem layer, directories don&rsquo;t
require any unique or privileged representation in the filesystem &#x2014;
they contain raw text/data like any other file, and can be manipulated
by the same <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> operations.  The way filesystems distinguish directory
entries is to mark them with a &ldquo;directory&rdquo; attribute/flag.  Their
corresponding data consists of references to the files that they
ostensibly &ldquo;contain&rdquo;, among other things (e.g. the name of the file).
In the FAT filesystem specifically, the references are <i>cluster indices</i>.</li>
<li>The kernel keeps an in-memory representation of the hierarchy of nested
links from directory to directory in what&rsquo;s called the <i>dentry cache</i>.
This avoids having to jump around the disk every time it needs to
resolve a fully-qualified path.</li>
</ul></li>
<li>Secondly, a file may occupy one or more clusters.  A set of clusters
associated with a particular file need not be arranged
contiguously/back-to-back; they&rsquo;re usually scattered around.</li>
<li>The file allocation table is what links disparate clusters together to
constitute individual files.</li>
<li>One can think of this table as like a &ldquo;minified&rdquo; version of the data
region.  That is, each entry in the FAT refers to a cluster in the data
region, and likewise, each cluster is represented by an entry in the FAT.
(Thus it is easy to calculate the offset of a cluster that corresponds to
a particular FAT entry, or vica versa.)</li>
<li>Each FAT entry contains a value (12-, 16-, or 32-bit) which is either:
<ul class="org-ul">
<li>a cluster number, referring to the next FAT entry (i.e. cluster) in a
chain;</li>
<li>a special value indicating this is the last cluster in a chain;</li>
<li>a special value indicating a free cluster; xor</li>
<li>a special value indicating a bad cluster.</li>
</ul></li>
<li>Thus a file is synonymous with a linked list of FAT entries (clusters);
what may be called a <i>cluster chain</i>.</li>
<li>The FAT format dictates the size of each FAT entry: FAT12 contains 12-bit
entries, FAT16 contains 16-bit entries, and FAT32 contains 32-bit entries.
Smaller entries means a smaller FAT, but for very large partitions, a
small FAT would mean we would have to increase the cluster size to be able
to index the whole partition.  A one-byte file still takes up a whole
cluster, so there exists a trade-off here.</li>
<li>The first two clusters are always reserved by FAT for housekeeping
purposes.  Thus the first cluster available for use is at cluster
index 2.</li>
</ul></dd>
<dt>Root directory (FAT12 and FAT16 only)</dt><dd><ul class="org-ul">
<li>This region does not exist on FAT32 &#x2014; its root directory data goes in
the data region like all other files and directories do.
<ul class="org-ul">
<li>How then does FAT32 know which entry corresponds to the root directory?
By storing its cluster index in the reserved region, specifically in the
BPB.  Typically this will be at cluster index 2 (the first usable
cluster).</li>
</ul></li>
<li>But on FAT12 and FAT16, the root directory table gets its own dedicated
section here.  This also means that, unlike FAT32, the root directory will
have a fixed maximum size (though this limitation is not usually an issue,
unless you are storing a bazillion files in root).</li>
</ul></dd>
<dt>Data</dt><dd><ul class="org-ul">
<li>This region takes up the rest of the partition.  It stores the giant array
of uniformly sized clusters (whose role should be more or less obvious to
you by now).</li>
</ul></dd>
</dl>
</div>
</div>
<div id="outline-container-orgb30d16b" class="outline-4">
<h4 id="2305b3f8-4081-432f-ae10-bf04cf659ea8"><span class="section-number-4">20.2.2</span> Directory entries, VFAT, and LFNs</h4>
<div class="outline-text-4" id="text-2305b3f8-4081-432f-ae10-bf04cf659ea8">
<p>
Each entry in a directory table is 32 bytes long.  Its layout can be seen in
<code>include/uapi/linux/msdos_fs.h</code>:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#define</span> <span class="org-variable-name">MSDOS_NAME</span> 11 <span class="org-comment-delimiter">/* </span><span class="org-comment">maximum name length</span><span class="org-comment-delimiter"> */</span>

<span class="org-comment-delimiter">/* </span><span class="org-comment">...</span><span class="org-comment-delimiter"> */</span>

<span class="org-keyword">struct</span> <span class="org-type">msdos_dir_entry</span> {
        <span class="org-type">__u8</span>   <span class="org-variable-name">name</span>[MSDOS_NAME];  <span class="org-comment-delimiter">/* </span><span class="org-comment">name and extension</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__u8</span>   <span class="org-variable-name">attr</span>;              <span class="org-comment-delimiter">/* </span><span class="org-comment">attribute bits</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__u8</span>   <span class="org-variable-name">lcase</span>;             <span class="org-comment-delimiter">/* </span><span class="org-comment">Case for base and extension</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__u8</span>   <span class="org-variable-name">ctime_cs</span>;          <span class="org-comment-delimiter">/* </span><span class="org-comment">Creation time, centiseconds (0-199)</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__le16</span> <span class="org-variable-name">ctime</span>;             <span class="org-comment-delimiter">/* </span><span class="org-comment">Creation time</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__le16</span> <span class="org-variable-name">cdate</span>;             <span class="org-comment-delimiter">/* </span><span class="org-comment">Creation date</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__le16</span> <span class="org-variable-name">adate</span>;             <span class="org-comment-delimiter">/* </span><span class="org-comment">Last access date</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__le16</span> <span class="org-variable-name">starthi</span>;           <span class="org-comment-delimiter">/* </span><span class="org-comment">High 16 bits of cluster in FAT32</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__le16</span> <span class="org-variable-name">time</span>, <span class="org-variable-name">date</span>, <span class="org-variable-name">start</span>; <span class="org-comment-delimiter">/* </span><span class="org-comment">time, date and first cluster</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__le32</span> <span class="org-variable-name">size</span>;              <span class="org-comment-delimiter">/* </span><span class="org-comment">file size (in bytes)</span><span class="org-comment-delimiter"> */</span>
};
</pre>
</div>

<p>
The <code>name</code> field provides a measly 11 bytes for the filename (a NULL-terminator
is not necessary).  To support a large file name (LFN) and/or special
characters, <a href="https://en.wikipedia.org/wiki/File_Allocation_Table#VFAT">VFAT</a> will create one or more phony entries immediately preceding
the directory entry proper (the FAT driver code calls these <i>slots</i>).  These
phony entries are given the following (otherwise meaningless) combination of
attributes:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#define</span> <span class="org-variable-name">ATTR_EXT</span> (ATTR_RO | ATTR_HIDDEN | ATTR_SYS | ATTR_VOLUME) <span class="org-comment-delimiter">/* </span><span class="org-comment">0x0F</span><span class="org-comment-delimiter"> */</span>
</pre>
</div>
<p>
These attributes ensure that, when driver code is walking the directory tree,
these special entries will be recognised as LFN entries, and skipped over
until the corresponding non-hidden entry is found.  Each slot can provide up
to 13 2-byte characters for the name.  Most of the fields are redundant and
are therefore repurposed in order to squeeze in more characters:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">struct</span> <span class="org-type">msdos_dir_slot</span> {
        <span class="org-type">__u8</span> <span class="org-variable-name">id</span>;             <span class="org-comment-delimiter">/* </span><span class="org-comment">sequence number for slot</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__u8</span> <span class="org-variable-name">name0_4</span>[10];    <span class="org-comment-delimiter">/* </span><span class="org-comment">first 5 characters in name</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__u8</span> <span class="org-variable-name">attr</span>;           <span class="org-comment-delimiter">/* </span><span class="org-comment">attribute byte</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__u8</span> <span class="org-variable-name">reserved</span>;       <span class="org-comment-delimiter">/* </span><span class="org-comment">always 0</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__u8</span> <span class="org-variable-name">alias_checksum</span>; <span class="org-comment-delimiter">/* </span><span class="org-comment">checksum for 8.3 alias</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__u8</span> <span class="org-variable-name">name5_10</span>[12];   <span class="org-comment-delimiter">/* </span><span class="org-comment">6 more characters in name</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__le16</span> <span class="org-variable-name">start</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">starting cluster number, 0 in long slots</span><span class="org-comment-delimiter"> */</span>
        <span class="org-type">__u8</span> <span class="org-variable-name">name11_12</span>[4];   <span class="org-comment-delimiter">/* </span><span class="org-comment">last 2 characters in name</span><span class="org-comment-delimiter"> */</span>
};
</pre>
</div>
<p>
If a name has no special characters and can fit inside the original 11 bytes
of the <code>name</code> field, then no LFN entries are necessary (we could perhaps call
this an SFN).  If they <i>are</i> necessary, then the <code>name</code> field in the <i>canonical</i>
directory entry will store a <a href="https://en.wikipedia.org/wiki/8.3_filename">mangled representation of the full name</a> as stored
in the preceding slots (e.g. <code>longfilename.txt</code> becomes <code>LONGFI~1.txt</code>).
</p>
</div>
</div>
<div id="outline-container-org1551a36" class="outline-4">
<h4 id="6a1df2b1-d23f-4f09-8d10-1f875d4a10ef"><span class="section-number-4">20.2.3</span> Metadata</h4>
<div class="outline-text-4" id="text-6a1df2b1-d23f-4f09-8d10-1f875d4a10ef">
<p>
A FAT filesystem supports a volume label in two places (inclusive):
</p>
<ul class="org-ul">
<li>the BPB; ior</li>
<li>the root directory, as a special hidden directory entry.</li>
</ul>

<p>
In the first case, only FAT filesystems that have an Extended BIOS Parameter
Block (EBPB) &#x2014; additional fields in the BPB that weren&rsquo;t part of the
original spec &#x2014; contain a label field.  The EBPB also contains a 4-byte
field for a volume ID or serial number, which one should take care not confuse
with the label.
</p>

<p>
In the second case, the label entry &#x2014; usually the first entry is reserved
for this when the volume is initially formatted &#x2014; is identified by its
volume attribute bit, 0x08 (<code>ATTR_VOLUME</code>).  If this bit is set, and its
filesize field is set to zero (meaning there is no cluster chain it points
to), then its name field is the volume label.  The wiki article additionally
states that the system attribute bit, 0x04 (<code>ATTR_SYS</code>), should be unset; this
ensures that tools don&rsquo;t mistake the volume label entry for a VFAT LFN slot.
</p>

<p>
In either case, the volume label is the same size as that of a SFN<sup><a id="fnr.60" class="footref" href="#fn.60">60</a></sup>: 11 bytes (sans NULL-terminator).
</p>

<p>
Ideally, these two labels should be kept synchronised on writes, but there
isn&rsquo;t any hard requirement for this, nor to provide a label at all.<sup><a id="fnr.62" class="footref" href="#fn.62">62</a></sup>
</p>
</div>
</div>
</div>
<div id="outline-container-org06ca44f" class="outline-3">
<h3 id="69228d1b-cd0a-426c-9f2d-d0c1c14e07e5"><span class="section-number-3">20.3</span> Revisiting earlier questions</h3>
<div class="outline-text-3" id="text-69228d1b-cd0a-426c-9f2d-d0c1c14e07e5">
<dl class="org-dl">
<dt>&ldquo;Modifying the volume label seems like something one should not be able to do while the filesystem is mounted.  Is this what the text means when it says no ioctl option is available to do so?&rdquo;</dt><dd><p>
Maybe,
but it seems unlikely that a filesystem label was ever intended to be a
rigid designator for a volume, nor used to mount it.  It may be the case
that the volume ID <i>is</i> such a rigid designator, though I haven&rsquo;t investigated
how it is actually used by the FAT filesystem driver.  In any case, the
label seems optional and of no great consequence.
</p>

<p>
This <a href="https://lwn.net/Articles/941764/">LWN.net</a> article goes into the more general issue of filesystems being
modified while mounted.  Filesystems drivers are written to be robust, but
if the ground starts shifting beneath their feet then all bets are off.
Unfortunately, it&rsquo;s almost impossible to prevent a sufficiently privileged
user from such meddling.
</p>

<p>
In any case, the upshot: &ldquo;Don&rsquo;t do it!&rdquo;
</p></dd>

<dt>&ldquo;Is it the case that some filesystems don&rsquo;t support volume labels in the first place?  Is this what the text means?&rdquo;</dt><dd>There
exists no standard dictating that every filesystem must have a label field
in its metadata, even though many do, including FAT.</dd>

<dt>&ldquo;Are volume labels even exclusively associated with filesystems in the first place?  What about the partition table?&rdquo;</dt><dd><p>
No.
There are (at least) two different places to put such a label: <i>inside</i> the
partition, ior <i>outside</i> it.
</p>

<p>
Neither are present universally for any kind of filesystem or partition
table, but where they are, they will be listed by <code>lsblk</code> under the <code>LABEL</code> and
<code>PARTLABEL</code> columns respectively.  These may also show up in
<code>/dev/disk/by-label/</code> and <code>/dev/disk/by-partlabel/</code>, which udev is usually
configured to populate with appropriately named symlinks to the device files
they correspond to.
</p>

<p>
Additionally, a label may be assigned to the partition table itself.  Often
this will be synonymous with a name for the physical disk proper, but the
possiblity of nested logical volumes (e.g. LVM, LUKS) may add additional
layers to this picture.
</p>

<p>
For this task, we&rsquo;re clearly only concerned with the label inside the FAT
filesystem.
</p></dd>

<dt>&ldquo;What are the differences between 16- and 32-bit FAT filesystems?&rdquo;</dt><dd>Most
notably, they differ by the width of entries in the FAT, and whether the
root directory table gets its own dedicated region.  The format of the BPB
also differs slightly.</dd>

<dt>&ldquo;What is the relevance of those differences to the task that is being hinted at?&rdquo;</dt><dd>Presumably,
it is the fact that the label may show up in different locations depending.
To what degree these differences are abstracted away by the existing driver
code, and whether we can piggy-back on this code, we are yet to determine.</dd>

<dt>&ldquo;There certainly <i>is</i> a way to modify volume labels, if not via ioctl commands.  What interface do user-space programs use to do this?&rdquo;</dt><dd><p>
There
exists a FAT-specific ioctl called <code>ioctl_fat</code>.  The <code>ioctl_fat(2)</code> manpage
provides some detail: &ldquo;The ioctl(2) system call can be used to read and
write metadata of FAT filesystems that are not accessible using other system
calls.&rdquo;  This can read the volume ID directly, but cannot read or write the
volume label.  (We <i>can</i> set attributes, which might seduce one into thinking
we could perhaps create a new empty file in the root directory, give it a
name, and then use this tool to modify its attributes such that it will be
interpreted as a volume label.  But even if this worked, it might corrupt
the filesystem: hidden entries aren&rsquo;t meant to point to actual files in the
data region.)
</p>

<p>
As for user-space tools, these have direct access to the device file, so
they&rsquo;re perfectly capable of going around the VFS and modifying the
filesystem directly.  But I was curious to know whether this was in fact
what they were doing, or whether there was some avenue I was missing.
</p>

<p>
With regard to <code>lsblk</code>, for instance, running <code class="src src-bash">strace lsblk /dev/sda1</code> (where <code>sda1</code> was a <code>vfat</code> volume) showed that it simply opens,
seeks, and reads entries directly from the block device file.  No attribute
file in sysfs is consulted, nor is any special ioctl invoked (except a
couple of times on the tty to get its dimensions).
</p>

<p>
There also exist the <code>fatlabel</code> and <code>mlabel</code> tools (from the <code>dosfstools</code> and
<code>mtools</code> packages respectively), which obtain the volume label in similar
fashion.  (These read the label-as-root-directory-entry specifically.)
</p>

<p>
We cannot list hidden FAT entries by simply running <code>ls</code> on the directory in
question, nor do the <code>VFAT_IOCTL_READDIR_*</code> ioctls list them.  There are no
other avenues by which to read or write hidden entries other than directly.
</p></dd>

<dt>&ldquo;The creation of new ioctl commands, which are often tightly-coupled and device-specific, has fallen out of favour.  Is this what the text means?&rdquo;</dt><dd>Probably not.  The FAT filesystem and many others predate the adoption of
sysfs as a more structured way to expose functionality to user-space.  But
again, we don&rsquo;t necessarily <i>need</i> this extra functionality if we have direct
read/write access to the device file.  After all, this is what tools like
<code>mkfs</code> already must do in order to format the device to begin with!</dd>

<dt>&ldquo;What are loopback filesystems?&rdquo;</dt><dd>Read ahead.</dd>
</dl>
</div>
</div>
<div id="outline-container-org24b39e2" class="outline-3">
<h3 id="37acde81-1719-4fcc-b189-cdc96f389c3d"><span class="section-number-3">20.4</span> Loop devices</h3>
<div class="outline-text-3" id="text-37acde81-1719-4fcc-b189-cdc96f389c3d">
<p>
A loop device (to be distinguished from a loop-back device <i>qua</i> network
interface) is a mechanism for making a file accessible as a block device.
</p>

<p>
The use of loop devices requires the <code>loop</code> module (which requires
<code>CONFIG_BLK_DEV_LOOP</code>).
</p>

<p>
To use this feature, we first need to create a loop device pseudo-file/device
node.  By itself, this file is useless &#x2014; we must &ldquo;attach&rdquo; it to a regular
file in the filesystem.  Once we&rsquo;ve done so, the loop device node will act
like a regular block device file.  We can format and mount it as though it
were backed by a real block device.  (This is precisely the method by which
<code>.iso</code> files are mounted.)
</p>

<p>
We can create the device nodes manually with <code>mknod</code> (major number = 7) or by
defining a udev rule.  Attaching files to them requires a special ioctl.
Doing it this way is a bit unwieldy though.  An easier method for creating and
managing loop devices is by way of the <a href="https://man7.org/linux/man-pages/man8/losetup.8.html"><code>losetup</code></a> tool (part of the
<a href="https://en.wikipedia.org/wiki/Util-linux"><code>util-linux</code></a> package).  This tool can also be leveraged by <code>mount</code>.
</p>

<p>
As an example:
</p>
<ul class="org-ul">
<li><p>
Let&rsquo;s create a filesystem image:
</p>
<div class="org-src-container">
<pre class="src src-bash">truncate -s 32M foobar.img
mkfs.vfat foobar.img
</pre>
</div></li>
<li><p>
To mount this image:
</p>
<div class="org-src-container">
<pre class="src src-bash">losetup -f <span class="org-comment-delimiter"># </span><span class="org-comment">identify an unused loop device node, or create one (usually /dev/loop0)</span>
losetup /dev/loop0 foobar.img <span class="org-comment-delimiter"># </span><span class="org-comment">attach a file to the loop device node</span>
mount /dev/loop0 /mnt/foobar <span class="org-comment-delimiter"># </span><span class="org-comment">mount it (on the proviso that it's a mountable filesystem)</span>
</pre>
</div>
<ul class="org-ul">
<li><p>
Alternatively, <code>mount</code> can select an unused loop device on our behalf, so we
can do all of the above in one line:
</p>
<div class="org-src-container">
<pre class="src src-bash">mount -o loop foobar.img /mnt/foobar
</pre>
</div></li>
<li><p>
Or, more tersely:
</p>
<div class="org-src-container">
<pre class="src src-bash">mount foobar.img /mnt/foobar <span class="org-comment-delimiter"># </span><span class="org-comment">mount infers '-o loop' from the fact that we're mounting a regular file</span>
</pre>
</div></li>
</ul></li>
<li>To unmount the image:
<ul class="org-ul">
<li><p>
Using the mount point:
</p>
<div class="org-src-container">
<pre class="src src-bash">umount /mnt/foobar
</pre>
</div>
<ul class="org-ul">
<li><p>
If you forgot what the mount point was, try:
</p>
<div class="org-src-container">
<pre class="src src-bash">losetup -a | grep foobar.img
</pre>
</div></li>
</ul></li>
<li><p>
Alternatively, using the loop device node:
</p>
<div class="org-src-container">
<pre class="src src-bash">umount /dev/loop0
</pre>
</div>
<ul class="org-ul">
<li><p>
If you forgot what the loop device node was, try:
</p>
<div class="org-src-container">
<pre class="src src-bash">mount | grep /mnt/foobar
</pre>
</div></li>
</ul></li>
</ul></li>
<li><p>
To detach the image:
</p>
<div class="org-src-container">
<pre class="src src-bash">losetup -d /dev/loop0
</pre>
</div>
<ul class="org-ul">
<li>If we had let <code>mount</code> attach the device node for us, then this step will be
unnecessary.</li>
<li>In any case, note that the device node itself will remain.  (Why <code>losetup</code>
is able to create the device nodes but not delete them is a mystery to
me.)</li>
<li>Avoid the same mistake I made here: <b>Don&rsquo;t manually delete the device node
with <code>rm</code> afterwards</b>.  Doing so seems to upset <code>losetup</code>, and by extension
<code>mount</code> when it asks it for an unused loop device.  Namely, it will assume
that the loop device node still exists, and fail when it tries to attach a
file to it, rather than just creating it again.  Go figure.</li>
<li><p>
If you mess up like I did, recreating the device node will fix the issue:
</p>
<div class="org-src-container">
<pre class="src src-bash">mknod -m660 /dev/loop0 b 7 0 <span class="org-comment-delimiter"># </span><span class="org-comment">/dev/loop0 normally has minor number 0, and so on</span>
</pre>
</div></li>
<li><p>
Alternatively, you can just reload the <code>loop</code> module:
</p>
<div class="org-src-container">
<pre class="src src-bash">modprobe -r loop &amp;&amp; modprobe loop
</pre>
</div></li>
</ul></li>
</ul>

<p>
The framework which supports loop devices &#x2014; more generally, the mapping of
files or block devices into higher-level, virtual block devices &#x2014; is called
the <i>device mapper</i>.  The intervening layer created by such mappings not only
provides indirect access to the backing store, but can perform various kinds
of functions and/or transformations (such as encryption/decryption).  Aside
from the <code>loop</code> module, this facility is also employed by LVM, software RAID,
dm-crypt, among others.  Such transformations are also stackable; we can map
virtual block devices into higher-level ones.  For example, a regular file
could be used like so:
</p>
\begin{equation*}
\displaylines{\text{LVM} \\ \uparrow \\ \text{dm-crypt} \\ \uparrow \\ \text{loop device} \\ \uparrow \\ \text{regular file}}
\end{equation*}
</div>
</div>
<div id="outline-container-org7324b1e" class="outline-3">
<h3 id="64903da4-6a6a-4e88-89a0-bc2425fcfefc"><span class="section-number-3">20.5</span> Allocating a ramdisk</h3>
<div class="outline-text-3" id="text-64903da4-6a6a-4e88-89a0-bc2425fcfefc">
<p>
Can we go a step further?  Is there a way for us to create a block device
backed by RAM?  After all, we just need a scratch volume to test our changes
on which we&rsquo;ll be discarding immediately afterwards.  Creating, formatting,
testing, and discarding the volume would probably be quicker if it was backed
by a buffer in RAM rather than a file on disk.
</p>

<p>
One option is to create our filesystem image file in <code>/tmp/</code>, and mount it from
that location.  Since tmpfs is an in-memory filesystem, no interaction with a
physical block device would be involved.  For example:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter"># </span><span class="org-comment">create a temporary directory</span>
<span class="org-variable-name">tmp_dir</span>=$(mktemp --tmpdir -d <span class="org-string">"${0##*/}-XXXXXXXX"</span>)

<span class="org-comment-delimiter"># </span><span class="org-comment">create an empty file inside it</span>
<span class="org-variable-name">img</span>=<span class="org-string">"${tmp_dir}/foobar.img"</span>
truncate -s 32M <span class="org-string">"$img"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">partition it</span>
mkfs.vfat <span class="org-string">"$img"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">create an empty directory and mount the image there</span>
mkdir -p foobar_mnt
mount <span class="org-string">"$img"</span> foobar_mnt

<span class="org-comment-delimiter"># </span><span class="org-comment">do stuff</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">...</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">clean up</span>
umount foobar_mnt
rm <span class="org-string">"$img"</span>
rmdir <span class="org-string">"$tmp_dir"</span>
</pre>
</div>

<p>
However, this involves an extra level of indirection that we could avoid.  Is
there a driver that lets us allocate a block of memory <i>directly</i> from RAM to
appear as a block device?  Yes, a couple in fact.
</p>

<p>
One is the <code>brd</code> module (&ldquo;block ramdisk&rdquo;; requires <code>CONFIG_BLK_DEV_RAM</code>):
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter"># </span><span class="org-comment">create 1 device, /dev/ram0, of size 32M</span>
modprobe brd <span class="org-variable-name">rd_nr</span>=1 <span class="org-variable-name">rd_size</span>=32768
<span class="org-comment-delimiter"># </span><span class="org-comment">partition the image file into two 16MB partitions</span>
sgdisk -Z --new 1::+16M --new 2 /dev/ram0 <span class="org-comment-delimiter"># </span><span class="org-comment">after this, we will see two new files, /dev/ram0p1 and /dev/ram0p2</span>
</pre>
</div>

<p>
Similarly, there&rsquo;s the <code>zram</code> module (requires <code>CONFIG_ZRAM</code>).  This compresses
the data behind the scenes to save memory, and has a nicer interface:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter"># </span><span class="org-comment">create one zram device</span>
modprobe zram 1
<span class="org-comment-delimiter"># </span><span class="org-comment">set its size to 32 MB</span>
<span class="org-builtin">echo</span> 33554432 | /sys/block/zram0/disksize
</pre>
</div>
<p>
More information about this module can be found <a href="https://docs.kernel.org/admin-guide/blockdev/zram.html">here</a> (see also <code>zramctl</code> from
the <code>zram-tools</code> package).
</p>

<p>
Granted, this is mostly academic.  The kernel already caches pages to disk
where it&rsquo;s appropriate, so we shouldn&rsquo;t expect much of a benefit with this
change, speed-wise.  I used the <code>zram</code> module in my test script purely for
ð”žð”¢ð”°ð”±ð”¥ð”¢ð”±ð”¦ð” ð”°.<sup><a id="fnr.63" class="footref" href="#fn.63">63</a></sup>
</p>
</div>
</div>
<div id="outline-container-org05b9e7b" class="outline-3">
<h3 id="82e788e6-aeb4-4fa0-883e-7015f6e3eb75"><span class="section-number-3">20.6</span> Taking stock</h3>
<div class="outline-text-3" id="text-82e788e6-aeb4-4fa0-883e-7015f6e3eb75">
<p>
Broadly, what will our ioctl need to do?  Firstly: set the volume label field
in the BPB of the boot sector.  Secondly: modify (or create) the directory
entry in the root directory that carries the volume label attribute.
</p>

<p>
We&rsquo;re already familiar with the most important details of the FAT filesystem
&#x2014; we&rsquo;ll now need to take a look at the existing driver code in <code>fs/fat/</code> to
see how this might be possible.  In doing so, we should become aware of what
differences between FAT formats the driver abstracts away on our behalf, and
what work will be needed where it does not.
</p>

<p>
But before we do that, let&rsquo;s make sure we&rsquo;re up to speed with the virtual
filesystem (VFS) layer, and how it all fits together.
</p>
</div>
</div>
<div id="outline-container-org4cc4cab" class="outline-3">
<h3 id="0e411c07-9b10-4be0-8e04-d424da3b3992"><span class="section-number-3">20.7</span> The VFS layer</h3>
<div class="outline-text-3" id="text-0e411c07-9b10-4be0-8e04-d424da3b3992">
<p>
(Much of this information can be gleaned from chapter 13 of <a href="#fb318868-a843-4e6c-8483-db73d832b726">LKD</a>, or from the
<a href="https://docs.kernel.org/filesystems/vfs.html">official docs</a>.)
</p>

<p>
Conceptually, the VFS is a layer that sits between the user and the underlying
filesystems on disk (various depictions of the full stack can be seen <a href="https://commons.wikimedia.org/wiki/Category:Linux_kernel_architecture">here</a>).
It abstracts away differences between the various filesystem implementations,
presenting a consistent user interface.
</p>

<p>
Some important terms/data structures associated with this interface:
</p>
<ul class="org-ul">
<li><i>file</i>
<ul class="org-ul">
<li>an open file descriptor</li>
<li>each contains a reference to a <code>file_operations</code> struct which supplies the
methods a process can invoke on a file it has open, e.g. <code>read()</code>, <code>write()</code></li>
</ul></li>
<li><i>inode</i>
<ul class="org-ul">
<li>an in-memory representation of a file in the backing store (recall that
directories are merely special kinds of files which list other files)</li>
<li>each contains a reference to a <code>inode_operations</code> struct which supplies
filesystem-implemented methods, such as <code>rename()</code>, <code>readlink()</code></li>
</ul></li>
<li><i>mount point</i>
<ul class="org-ul">
<li>a particular mount point (represented by a <code>struct vfsmount</code>)</li>
</ul></li>
<li><i>dentry</i>
<ul class="org-ul">
<li>a node of the virtual filesystem hierarchy</li>
<li>each contains a reference to a parent dentry (the directory it lies
within); its lineage comprises a fully qualified path</li>
<li>each contains a reference to a <code>dentry_operations</code> struct which supplies
dentry-specific methods, e.g. <code>d_compare()</code>, <code>d_delete()</code></li>
</ul></li>
<li><i>superblock</i>
<ul class="org-ul">
<li>stores filesystem control info for a particular mountable filesystem</li>
<li>a superblock structure is created in memory when a filesystem is first
mounted</li>
<li>each contains a reference to a <code>super_operations</code> struct which supplies
filesystem-specific methods for performing whole-filesystem operations,
e.g. <code>write_inode()</code>, <code>sync_fs()</code></li>
</ul></li>
<li><i>address space object</i>
<ul class="org-ul">
<li>the gateway to the contents of a file</li>
<li>groups together info on if and where the on-disk file contents have been
cached, and keeps track of mappings into a process&rsquo;s address space</li>
</ul></li>
<li><i>file system type</i>
<ul class="org-ul">
<li>a paritcular filesystem type (e.g. FAT, EXT4, BTRFS), or the information
and operations necessary to use one</li>
<li>all registered filesystem types are listed in <code>/proc/filesystems</code></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org18c706d" class="outline-3">
<h3 id="e6d3ab05-8a07-40b6-b3ed-62d1cf8affcd"><span class="section-number-3">20.8</span> The ioctl interface</h3>
<div class="outline-text-3" id="text-e6d3ab05-8a07-40b6-b3ed-62d1cf8affcd">
<p>
The ioctl syscall lets one perform miscellaneous commands on files and
devices.  Such commands may be defined and implemented by the kernel, or by
individual drivers (commands associated with drivers are often device-specific
and tightly-coupled).  The scope of a command may be general, or specific
(i.e. only applying to a certain class of file (regular, device, FIFO,
socket), or files only on a certain kind of filesystem).
</p>

<p>
The ioctl syscall takes a file descriptor, a command to perform, and an
optional command-specific argument (which could be a value or a reference to a
command-specific data structure):
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-type">int</span> <span class="org-function-name">ioctl</span>(<span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">cmd</span>, ... <span class="org-comment-delimiter">/* </span><span class="org-comment">args</span><span class="org-comment-delimiter"> */</span>);
</pre>
</div>

<p>
Generic ioctl handlers for FAT directories and files are registered in
<code>fs/fat/dir.c</code> and <code>fs/fat/file.c</code> respectively.  (It&rsquo;ll be easy enough to add new
ones to these.)
</p>

<p>
The commands supported by a particular device are defined and published in the
uapi headers.  We can see how the existing FAT ioctls (their command numbers)
are defined in <code>include/uapi/linux/msdos_fs.h</code>.  (This header&rsquo;s namesake in
<code>usr/include/linux/</code> is an artifact of the build process, i.e., what will be
exported by the <code>headers_install</code> target.)  A command number itself is not
merely an arbitrary integer, but rather a magic number constructed out of
different parts (one of which <i>is</i> an arbitrary integer).  Different device
drivers could in principle use the same command number for cross purposes, so
this increases the odds that a ioctl<sup><a id="fnr.64" class="footref" href="#fn.64">64</a></sup> command will fail early if accidentally called on the wrong file.
Macros for assembling/disassembling these magic numbers live in
<code>include/asm/ioctl.h</code>; usage described <a href="https://docs.kernel.org/userspace-api/ioctl/ioctl-number.html">here</a>.
</p>

<p>
Some further remarks:
</p>
<ul class="org-ul">
<li>Normally, a driver need not be concerned with checking for file permissions,
as that&rsquo;s handled in the upper layers.  That&rsquo;s not the case for ioctls
though.  Chapter 6 of goes into this in more detail.<sup><a id="fnr.65" class="footref" href="#fn.65">65</a></sup>
<ul class="org-ul">
<li>This is perhaps part of why sysfs is the more preferred option for
exposing this kind of functionality.</li>
<li><p>
For my part, I didn&rsquo;t bother doing any additional checking, but I probably
could have gated write-access behind something like:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-keyword">if</span> (<span class="org-negation-char">!</span>capable(CAP_SYS_RAWIO))
        <span class="org-keyword">return</span> -EPERM;
</pre>
</div></li>
</ul></li>
<li>If, in defining a new ioctl command, we&rsquo;re to interpret the optional
argument as a pointer to some data structure in user-space, we&rsquo;ll need to
employ <code>copy_to_user()</code>, <code>copy_from_user()</code>, etc.</li>
<li>The return value of a ioctl handler is either:
<ul class="org-ul">
<li>0 (success);</li>
<li><code>-EINVAL</code> (invalid argument); xor</li>
<li><code>-ENOTTY</code> (inappropriate ioctl for this device).</li>
</ul></li>
<li>The kernel provides a bunch of generic ioctl commands that the upper layers
will catch before our handler is consulted.  (Presumably, if it were
possible, identical command numbers would be shadowed.)  A whole bunch of
these apply to tty devices (which were the original purpose of the ioctl
interface), a few for files in general.  You can see them listed in
<code>include/uapi/asm-generic/ioctls.h</code>.</li>
</ul>

<p>
This all begs the question: what kind of file will <i>our</i> ioctl be run on?  To be
clear, it would <i>not</i> be the device file of the partition &#x2014; such a ioctl
command would be intercepted by the driver of the corresponding device, not
the driver of the filesystem contained therein.  Rather, I would suppose, it
should be on a file within the mounted FAT filesystem.  Thus there are two
ioctl handlers we could piggy-back off of: the one for files (defined in
<code>file.c</code>), and the one for directories (defined in <code>dir.c</code>).
</p>

<p>
I used both, since, for the sake of completeness; I wanted to make new ioctls
(ioctl numbers) for getting and setting both the label-as-BPB-field <i>and</i> the
label-as-root-directory-entry.  Thus, in the uapi header:
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#define</span> <span class="org-variable-name">FAT_IOCTL_GET_VOLUME_LABEL_BPB</span>  _IOR(<span class="org-string">'r'</span>, 0x14, <span class="org-type">char</span>[MSDOS_NAME])
<span class="org-preprocessor">#define</span> <span class="org-variable-name">FAT_IOCTL_SET_VOLUME_LABEL_BPB</span>  _IOW(<span class="org-string">'r'</span>, 0x15, <span class="org-type">char</span>[MSDOS_NAME])
<span class="org-preprocessor">#define</span> <span class="org-variable-name">FAT_IOCTL_GET_VOLUME_LABEL_ENT</span>  _IOR(<span class="org-string">'r'</span>, 0x16, <span class="org-type">char</span>[MSDOS_NAME])
<span class="org-preprocessor">#define</span> <span class="org-variable-name">FAT_IOCTL_SET_VOLUME_LABEL_ENT</span>  _IOW(<span class="org-string">'r'</span>, 0x17, <span class="org-type">char</span>[MSDOS_NAME])
</pre>
</div>
<p>
The first argument, <code>'r'</code>, supposedly denotes a ioctl &ldquo;type&rdquo;; an &ldquo;ascii
character unique to each driver&rdquo;.  I&rsquo;m not sure what effect this has other
than perhaps to provide additional entropy/uniqueness for the command number.
Different drivers appear to provide different characters for this parameter,
based on some logic unknown to me.  The existing FAT ioctls use <code>'r'</code>, so that&rsquo;s
what I&rsquo;ve used.  The second parameter is that arbitrary number I was talking
about (supposedly this should also be globally unique, but eh).  The final
parameter specifies the width of the ioctl&rsquo;s parameter structure as used by
the user (we don&rsquo;t need to include the null-terminator here).
</p>
</div>
</div>
<div id="outline-container-org56cf85d" class="outline-3">
<h3 id="741a2b59-aa6d-457f-a8df-f21ccd8ab743"><span class="section-number-3">20.9</span> Implementing the new ioctls</h3>
<div class="outline-text-3" id="text-741a2b59-aa6d-457f-a8df-f21ccd8ab743">
<p>
To start with, since we are adding new ioctls, we&rsquo;ll need to export them to
userspace.  As noted, we need to define the ioctl numbers in the uapi header.
To make use of them in our test program, we must export the uapi headers, just
as we did in <a href="#task-15">task 15</a> for our new syscall.
</p>
<div class="org-src-container">
<pre class="src src-bash">make <span class="org-variable-name">INSTALL_HDR_PATH</span>=<span class="org-string">"/usr/local"</span> headers_install
</pre>
</div>

<p>
Here I&rsquo;ll provide various bits of context and random observations w.r.t. the
included patch file.
</p>

<p>
On getting/setting the label-as-BPB-field:
</p>
<ul class="org-ul">
<li>I implemented these ioctls in <code>file.c</code>.  They will work on any file in the
filesystem in question.</li>
<li>The existing <code>FAT_IOCTL_GET_VOLUME_ID</code> ioctl served as a good starting point
for reading the label.  The generic superblock structure (<code>struct
  super_block</code>) contains a filesystem-specific structure nested within it
(<code>struct msdos_sb_info</code>); this ioctl fetches the contents of the <code>vol_id</code> field
within that structure.  Both structures are populated when the filesystem is
mounted &#x2014; in <code>fs/fat/inode.c::fat_fill_super()</code>.  Thus the volume ID is
stashed in memory at mount time.  For whatever reason, there is no <code>vol_label</code>
field to similarly stash the label, so I created for that purpose.  In doing
so I had to account for differences in the layout of the BPB structure &#x2014;
unlike the volume ID, a label field is not always present.
<ul class="org-ul">
<li>It may have been prudent to ignore the superblock structure entirely and
just read/write directly from/to disk, but seeing as this task isn&rsquo;t a
realistic patch anyway, it can&rsquo;t hurt.</li>
</ul></li>
<li>It may help to distinguish between the roles of the <code>msdos_sb_info</code>,
<code>fat_boot_sector</code>, and <code>fat_bios_param_block</code> structs:
<ul class="org-ul">
<li><code>msdos_sb_info</code> stashes filesystem-specific data.  A superblock associated
with a FAT filesystem will have its private pointer (<code>void *s_fs_info</code>)
pointing to one of these.</li>
<li><code>fat_boot_sector</code> is an &ldquo;overlay&rdquo; struct that is applied over, and used to
access, the first sector of the disk.  In other words, the pointer to the
raw buffer containing the first sector read from disk is cast to <code>(struct
    fat_boot_sector *)</code> in order to more easily parse its contents.</li>
<li><code>fat_bios_param_block</code> is used to store said boot sector data once it has
been parsed.  Such a structure is filled in the process of populating the
<code>msdos_sb_info</code> struct (see <code>fs/fat/fat_read_bpb()</code>), but is discarded once
<code>fat_fill_super()</code> has finished.</li>
</ul></li>
<li>The <code>fat_bios_param_block</code> overlay has two fields apiece for the state and
volume ID fields, one for 16-bit and 32-bit.  The reason why is probably so
that <code>fat_read_bpb()</code> can just blindly fetch from both locations, without
knowing which is the correct one, and defer finding out the truth until
later when it has more information, viz., whether the filesystem is 16- or
32-bit.</li>
<li>As for <i>setting</i> a new label, it obviously won&rsquo;t suffice to simply <code>memcpy</code> the
string into this field &#x2014; this change isn&rsquo;t going to magically propagate
itself back to the disk.  We need to do that ourselves using the block I/O
layer, i.e., that which lies between the mapping layer (i.e. filesystem
implementations) and the device driver layer.  (Chapter 14 of <a href="#fb318868-a843-4e6c-8483-db73d832b726">LKD</a> is helpful
here.)  The <code>fs/fat/inode.c::fat_set_state()</code> function provides a good
example; it is used to set/unset a field in the BPB, namely, the <code>state</code> field
of <code>struct fat_boot_sector</code> from the uapi header.  (The driver appears to use
said field as a flag to indicate whether the filesystem is currently
mounted, something <code>fatlabel</code> will check for and warn about.)</li>
<li>Something I didn&rsquo;t mention earlier about the FAT filesystem is that there
may exist, for the sake of redundancy, a backup copy of the BPB at logical
sector 6 (offset 0xc00 of the reserved region).  The <code>fatlabel</code> utility, when
used to modify metadata in the BPB, will update this duplicate as well,
should it exist.  My ioctl does the same.</li>
</ul>

<p>
On getting/setting the label-as-directory-entry:
</p>
<ul class="org-ul">
<li>I had to implement these ioctls in <code>fs/fat/dir.c</code>.  I had assumed initially
that I would implement everything in <code>fs/fat/file.c</code>, but the functions
necessary for performing I/O on directory entries are <code>static</code>, and thus
unavailable outside that translation unit.</li>
<li>As a consequence, this ioctl must be run on a directory, specifically the
directory the entry lives under, i.e. the root of the mounted filesystem.
Supposedly a volume label entry could be stored in a subdirectory, but it
probably shouldn&rsquo;t be (otherwise, deleting the subdirectory would delete the
label in turn).</li>
<li>The kind of entry that these ioctls are concerned with is not associated
with an inode; there&rsquo;s no file or file-contents to speak of, just metadata.
The directory it lies within, on the other hand, <i>is</i> associated with an
inode, whose content is the directory table.</li>
<li>The <code>VFAT_IOCTL_READDIR_SHORT</code> ioctl served as a good starting point.  (Since
the label is always a short name, the extra work done by
<code>VFAT_IOCTL_READDIR_BOTH</code> is less relevant.)  In particular, the
<code>fs/fat/dir.c::fat_get_entry()</code> and <code>fs/fat/dir.c::fat_add_entries()</code> functions
are needed.</li>
<li>In the process of iterating over directory entries to find the one
corresponding to the volume label, I perform a few additional (and possibly
redundant?) checks: that it has a file name, that it is not an LFN entry,
and that the file size is zero.</li>
</ul>

<p>
On testing, and other miscellanea:
</p>
<ul class="org-ul">
<li>I tested the new ioctls by calling them on the root directory of the mounted
test-filesystem.  Running a ioctl requires a file descriptor, so I had to
call <code>open(2)</code> on the directory.  The <code>opendir(3)</code> function, which wraps <code>open(2)</code>
and allow one to walk a directory, is more commonly used when dealing with
directories, however it doesn&rsquo;t return a file descriptor.  (We <i>can</i> obtain a
file descriptor after the fact with <code>dirfd(3)</code>, but we can skip that extra
step.)  But how then do we ensure that the file we are opening is indeed a
directory, not some other kind of file?  By passing the <code>O_DIRECTORY</code> flag to
<code>open(2)</code>.</li>
<li>Why is <code>open(3P)</code> declared in <code>fcntl.h</code> but <code>close(3P)</code> declared separately in
<code>unistd.h</code>?  According to <a href="https://stackoverflow.com/questions/22359359/why-is-open-declared-in-fcntl-h-while-close-is-declared-in-unistd-h">stackoverflow</a>, a possible reason, beyond the common
and general refrain of &ldquo;historical baggage&rdquo;, is that there are ways to
allocate file descriptors other that <code>open()</code>, but which likewise depend on
<code>close()</code> (e.g. <code>socket()</code> from <code>sys/socket.h</code>).  These need not depend on <code>open()</code>
as well, thus the bifurcation.</li>
<li>The <code>mkfs.fat</code> tool, when formatting a disk, will pad the given volume label
with spaces where its length is less than <code>MSDOS_NAME</code>.  My ioctl pads it with
null characters, which I thought would have made more sense.  But I&rsquo;m not
sure whether this makes any material difference.</li>
<li>I didn&rsquo;t bother validating new volume labels.  Legal DOS filenames are
described <a href="https://en.wikipedia.org/wiki/Design_of_the_FAT_file_system#Directory_table">here</a>, but must such validation logic be applied to volume labels
too?  A label is always a fixed 11 chars, and not used by the VFS, so I
would think it unlikely to pose a problem.  The <code>dosfstools</code> package, which
bundles <code>fatlabel</code>, contains some validation logic specifically for volume
labels (see <a href="https://github.com/dosfstools/dosfstools/blob/c483196dd46eab22abba756cef511d36f5f42070/src/common.c#L338">here</a>), but I couldn&rsquo;t find this documented elsewhere.</li>
<li>Regarding buffer heads:
<ul class="org-ul">
<li>The <code>buffer_head</code> struct is an old way to map blocks on disk to pages in
memory.  Each maps/buffers a single block on disk into a page + offset.</li>
<li>Normally, when we modify a buffer associated with a regular file, we
simply mark the buffer head dirty, and it will be committed to disk some
time later.  On the other hand, if the user has asked the kernel to do so
(e.g. calling <code>open()</code> with <code>O_SYNC</code>), or if it&rsquo;s part of an atomic
transaction necessary for preserving filesystem integrity, then the
write-back must occur immediately.  Another possible scenario is that
user-space follows up the <code>write()</code> call with an <code>fsync()</code> &#x2014; this will
return <code>-EIO</code> if one or more buffers cannot, or could not, be written
(<code>close()</code> will also report such an error).  The user might then respond by
retrying the entire I/O operation, or aborting.</li>
<li>But if an asynchronous write-back fails, how are we in kernel-space meant
to respond, or at least let the user know?  The answer is unfortunately
not straightforward.</li>
<li>I mention all of this because the <code>sync_dirty_buffer()</code> function used in the
ioctl can fail with <code>-EIO</code> as well.  I was initially unsure how to respond
to such a failure.  It&rsquo;s rare for such errors to occur, except in
exceptional circumstances (say, if a USB drive is yoinked
unceremoniously).  In any case, they are reported in the kernel log.  Code
elsewhere<sup><a id="fnr.66" class="footref" href="#fn.66">66</a></sup> almost always ignores
this return value and just releases the buffer head.  I am inclined to
follow suit, since in our scenario, a sync failure would be mostly benign
anyway.  But arguably, sync failures are <i>never</i> benign &#x2014; if it fails
once, the odds that a subsequent write-back will fail jumps considerably.
A stern kernel log message here feels insufficiently urgent.</li>
<li><a href="https://lwn.net/Articles/724307/">This LWN.net article</a> contains some further discussion on the topic.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org077e586" class="outline-2">
<h2 id="appendices">Appendices</h2>
<div class="outline-text-2" id="text-appendices">
</div>
<div id="outline-container-org679100e" class="outline-3">
<h3 id="paring-down-a-kernel-config">Paring down a kernel configuration</h3>
<div class="outline-text-3" id="text-paring-down-a-kernel-config">
<p>
How do the <code>local{mod,yes}config</code> make targets work?  The <code>README</code> file has this
to say about <code>localmodconfig</code> specifically:
</p>
<div class="org-src-container">
<pre class="src src-text">Create a config based on current config and loaded modules (lsmod).  Disables
any module option that is not needed for the loaded modules.

To create a localmodconfig for another machine, store the lsmod of that
machine into a file and pass it in as a LSMOD parameter.

              target$ lsmod &gt; /tmp/mylsmod
              target$ scp /tmp/mylsmod host:/tmp

              host$ make LSMOD=/tmp/mylsmod localmodconfig

The above also works when cross compiling.
</pre>
</div>
<p>
This suggests that, rather than having to fetch a kernel tree on the target
and then running <code>localmodconfig</code>, we could instead save the output of <code>lsmod</code> and
supply it to <code>localmodconfig</code> like so:
</p>
<div class="org-src-container">
<pre class="src src-bash">make <span class="org-variable-name">LSMOD</span>=qemu_lsmod_output.txt localmodconfig
</pre>
</div>

<p>
(This didn&rsquo;t work for me initially &#x2014; I was seeing some perplexing &ldquo;command
not found&rdquo; errors.  In the process of troubleshooting, I had a peek at the
changelog for the <code>streamline_config.pl</code> script, which is used by Kbuild to
source and parse <code>lsmod</code> output.  It turns out that this script can be fed not
just textual input files, but also <i>executable</i> files.  If it recognises the
input as an executable file, it will run it and use its output as the textual
input.  Unfortunately, the text file in which I had saved my <code>lsmod</code> output was
marked executable.  This is because of how I (lazily) mounted my samba share.
Oops!)
</p>

<p>
A &ldquo;gotcha&rdquo; regarding the behaviour of the <code>local{mod,yes}config</code> targets is that
they can&rsquo;t perform magic.  Use these targets only for the purpose of paring
down an already working config, rather than adding options back to a minimal
one (which can take a considerable amount of work).
</p>

<p>
Some other downsides to producing a configuration based on what <code>lsmod</code> tells us
is currently loaded:
</p>
<ul class="org-ul">
<li>Many modules are built-in by default, which <code>localmodconfig</code> won&rsquo;t pick up.
For some reason, this appears to include the odd device driver for a webcam,
GPU, or sound card &#x2014; we have to disable these ones manually.  (Why things
like this would be built-in by default is a mystery to me.)</li>
<li>It will disable modules that haven&rsquo;t yet been loaded but will still be
necessary at some point.  For example, the <code>usb_storage</code>, <code>joydev</code>, and
<code>snd_usb_audio</code> modules are practically a necessity on desktops, but devices
that depend on them are only occasionally plugged in.</li>
<li>Conversely, it will enable modules for devices that were plugged in at some
point since the last boot, but which we really don&rsquo;t care about (though this
is an easier problem to avoid).</li>
</ul>

<p>
Kbuild might complain about config symbols being uninstantiated or missing,
which might relate to newer configuration options, i.e. not explicitly
enabled/disabled in our distro config.  We can set these to the defaults to
start with:
</p>
<div class="org-src-container">
<pre class="src src-bash">make olddefconfig
</pre>
</div>
<p>
and disable/enable them after review.
</p>

<p>
In my case, I started out with kitchen-sink configuration supplied by Debian.
It may be instructive to try and determine what are the minimum set of modules
necessary to get a KVM guest booting and working properly, but I&rsquo;ll leave that
as a separate exercise for the reader.  (There&rsquo;s also a <code>kvm_guest.config</code>
target, but a distro-supplied config will almost certainly incorporate what&rsquo;s
in there.)
</p>
</div>
</div>
<div id="outline-container-orgd8e0b0e" class="outline-3">
<h3 id="troubleshooting-cifs">Troubleshooting CIFS</h3>
<div class="outline-text-3" id="text-troubleshooting-cifs">
<p>
The very first time I tried compiling a module, I was getting an error like
this:
</p>
<div class="org-src-container">
<pre class="src src-text">make -C /lib/modules/4.19.0-8-686-pae/build  M=/mnt/qemu/task01  modules
make[1]: Entering directory '/usr/src/linux-headers-4.19.0-8-686-pae'
  CC [M]  /mnt/qemu/task01/hello.o
fixdep: error fstat'ing file: /mnt/qemu/task01/.hello.o.d: Value too large for defined data type
make[4]: *** [/usr/src/linux-headers-4.19.0-8-common/scripts/Makefile.build:315: /mnt/qemu/task01/hello.o] Error 2
make[3]: *** [/usr/src/linux-headers-4.19.0-8-common/Makefile:1537: _module_/mnt/qemu/task01] Error 2
make[2]: *** [Makefile:146: sub-make] Error 2
make[1]: *** [Makefile:8: all] Error 2
make[1]: Leaving directory '/usr/src/linux-headers-4.19.0-8-686-pae'
make: *** [Makefile:12: modules] Error 2
</pre>
</div>

<p>
The purpose of <code>fixdep</code>, a tool I was not familiar with, is explained in
<code>scripts/basic/fixdep.c</code>:
</p>
<blockquote>
<p>
GCC produces a very nice and correct list of dependencies which tells make
when to remake a file.
</p>

<p>
To use this list as-is however has the drawback that virtually every file in
the kernel includes <code>autoconf.h</code>.
</p>

<p>
If the user re-runs <code>make &lt;config_target&gt;</code>, <code>autoconf.h</code> will be regenerated.
Make notices that and will rebuild every file which includes <code>autoconf.h</code>,
i.e. basically all files.  This is extremely annoying if the user just changed
<code>CONFIG_HIS_DRIVER</code> from <code>"n"</code> to <code>"m"</code>.
</p>

<p>
So we play the same trick that &ldquo;mkdep&rdquo; played before.  We replace the
dependency on <code>autoconf.h</code> by a dependency on every config option which is
mentioned in any of the listed prerequisites.
</p>

<p>
Kconfig populates a tree in <code>include/config/</code> with an empty file for each config
symbol and when the configuration is updated the files representing changed
config options are touched which then let make pick up the changes and the
files that use the config symbols are rebuilt.
</p>

<p>
So if the user changes his <code>CONFIG_HIS_DRIVER</code> option, only the objects which
depend on <code>include/config/his/driver.h</code> will be rebuilt, so most likely only his
driver ;-)
</p>
</blockquote>
<p>
Changing the build configuration would normally mean having to rebuild
everything that relies on the top-level configuration, even though only small
parts of the configuration are relevant to each individual file.  This is
fixed in part by populating a temporary file, <code>.hello.o.d</code>, with the list of
headers included in the build, and then using that to create individual
dependencies only on the config symbols used.
</p>

<p>
The <code>.hello.o.d</code> file which lists the headers is about 26KiB.
</p>

<p>
After doing some digging, I discovered that my problem has something to do
with the fact that I am compiling in a directory inside a mounted samba share,
which uses the CIFS filesystem.  After listing out the files on the host:
</p>
<div class="org-src-container">
<pre class="src src-bash">ls -ial
</pre>
</div>
<p>
I noticed that some files had inode numbers greater than 32-bit, whereas my VM
was 32-bit.  Apparently, the samba server is capable of providing inode
numbers to the client on its behalf, but in this case, 64-bit inode numbers
are too large for the client to handle.  (After this particular episode, I
switched to a 64-bit VM.)
</p>

<p>
A suggested fix for this was to add <code>,nounix,noserverino</code> to the mount flags in
my <code>/etc/fstab</code>.  The <code>nounix</code> flag disables CIFS Unix extensions (which disables
a bunch of features, including symlinks), while the <code>noserverino</code> tells the
client that it must generate its own inode numbers for the files.
</p>

<p>
Something else I learned while trying to mount the samba share was that, if
you want to remount a filesystem after modifying <code>/etc/fstab</code>, it&rsquo;s no longer
sufficient to just run <code>mount /mnt/qemu -o remount</code> or <code>mount -a</code>.  This is
because systemd is now in charge of mounting the filesystems.  When we make
any changes to <code>/etc/fstab</code>, systemd must be instructed to refresh the file and
remount:
</p>
<div class="org-src-container">
<pre class="src src-bash">systemctl daemon-reload <span class="org-comment-delimiter"># </span><span class="org-comment">scan for new or changed units and reload them</span>
systemctl restart remote-fs.target <span class="org-comment-delimiter"># </span><span class="org-comment">process remote filesystem targets in /etc/fstab</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org1562e4d" class="outline-3">
<h3 id="resizing-a-vm-image">Resizing a VM image</h3>
<div class="outline-text-3" id="text-resizing-a-vm-image">
<p>
As it turns out, the amount of space I gave to my QEMU disk image was not
sufficient.  Fixing this was a simple two-step process.
</p>
</div>
<div id="outline-container-org093482d" class="outline-4">
<h4 id="82b0cbdf-1d21-4cc4-b77f-50762db1e90c">Resizing the disk image</h4>
<div class="outline-text-4" id="text-82b0cbdf-1d21-4cc4-b77f-50762db1e90c">
<p>
To add space to the image:
</p>
<div class="org-src-container">
<pre class="src src-bash">qemu-img resize foo.qcow2 +8G
</pre>
</div>
<p>
This command also works on overlay images.  Afterwards, the guest will see a
larger disk.
</p>

<p>
At this stage though, the disk&rsquo;s partitions, and the filesystems therein, will
be the same size.
</p>
</div>
</div>
<div id="outline-container-org8ab3867" class="outline-4">
<h4 id="de0f6e93-299c-4b0c-926f-d3df2e67e031">Taking up the space</h4>
<div class="outline-text-4" id="text-de0f6e93-299c-4b0c-926f-d3df2e67e031">
<p>
We can expand a partition and its resident filesystem in one go with <a href="https://gparted.org/">GParted</a>.
None of the disk&rsquo;s partitions can be mounted while we do this.  Rather than
opening GParted on a live system, the easiest thing to do is boot into the
<a href="https://gparted.org/livecd.php">GParted livecd</a>, and take it from there.
</p>

<p>
Note that the UUIDs of some or all of the partitions may change in the process
of doing this.  If this happens, we&rsquo;ll need to update the UUIDs, now
out-of-date, in the associated <code>/etc/fstab</code> entries.
</p>

<p>
I also ran into a problem where the bootloader failed to load, and
reinstalling the bootloader didn&rsquo;t seem to work.  One of these fixed the
problem, I&rsquo;m not sure which:
</p>
<ul class="org-ul">
<li>making a copy of <code>/boot/efi/EFI/debian/grubx64.efi</code> in
<code>/boot/efi/EFI/BOOT/BOOTX64.EFI</code> (<code>EFI/BOOT/BOOTX64.EFI</code> is the assumed default
location of the bootloader in an ESP); and</li>
<li>naming the EFI partition, which had been left blank, to &ldquo;ESP&rdquo;.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgd633636" class="outline-3">
<h3 id="the-pc-speaker-device">The pc speaker device</h3>
<div class="outline-text-3" id="text-the-pc-speaker-device">
<p>
Upon compiling and installing from a custom configuration, I was seeing this
ostensibly benign error at boot-time:
</p>
<div class="org-src-container">
<pre class="src src-text">input: PC Speaker as /devices/platform/pcspkr/input/input5
[...]
Error: Driver 'pcspkr' is already registered, aborting...
</pre>
</div>
<p>
What&rsquo;s going on here?
</p>

<p>
Firstly, there are two different modules available for managing the pc speaker
device.  The <code>pcspkr</code> module is more or less the default, and what most machines
will be using.  The <code>snd-pcsp</code> module on the other hand is an alternative module
associated with the sound subsystem (ALSA) &#x2014; it registers the pc speaker
with ALSA as its own sound card, giving it greater capability.  The only
reason you would use <code>snd-pcsp</code> is if the only sound output you had available on
your machine was through the pc speaker, and said speaker was not merely one
of those cheap piezo speakers that can only emit shrill chirps, and you
<i>absolutely must have sound output</i>.  I can&rsquo;t imagine too many people using
this.
</p>

<p>
To provide the option, <code>snd-pcsp</code> is enabled in the kernel configuration that
Debian supplies; other distros may differ.  To ensure that only <code>pcspkr</code> is
loaded at boot, one can blacklist <code>snd-pcsp</code> in their <a href="https://man7.org/linux/man-pages/man5/modprobe.d.5.html">modprobe config</a>.  Debian
instead omits <code>snd-pcsp</code> from the <code>modules.alias</code> file.<sup><a id="fnr.67" class="footref" href="#fn.67">67</a></sup>.  But when we compile our own kernel, with both modules
enabled, <code>modules.alias</code> will contain both:
</p>
<div class="org-src-container">
<pre class="src src-text">alias platform:pcspkr pcspkr
[...]
alias platform:pcspkr snd_pcsp
</pre>
</div>
<p>
thus explaining the error above.
</p>
</div>
</div>
<div id="outline-container-org8624ba0" class="outline-3">
<h3 id="module-auto-loading">Module auto-loading</h3>
<div class="outline-text-3" id="text-module-auto-loading">
<p>
As noted in <a href="#task-05">task 05</a>, when a new device turns up, the kernel signals a hotplug
event to user-space (via a netlink socket); a user-space daemon (such as udev)
listening in may respond by loading a module capable of driving that device.
But what about modules whose responibilities aren&rsquo;t associated with any
particular device, such as filesystems and network protocols?  Is there a way
to similarly load such modules on demand?
</p>

<p>
Yes: to this end, the kernel may also <i>request</i> a module.  I say &ldquo;request&rdquo;
because the kernel can&rsquo;t load modules by itself; it needs help from user-space
to find and load the module and its dependencies.  When such a request is
made, a dedicated kernel thread is spawned to load the module in a user-space
context, namely, by running <code>modprobe</code>.  (The path to the modprobe binary must
be specified in <code>CONFIG_MODPROBE_PATH</code>.)
</p>

<p>
The function for making such a request is
<code>linux/kmod.h:request_module(name...)</code>.  It simply asks for the name of the
module.  The kernel is aware of the generic names of modules which drive
particular features; user-space is free to define aliases for these generic
names.
</p>

<p>
This request can fail:
</p>
<ul class="org-ul">
<li>in kernel-space (modprobe took too long, the name was invalid, the execution
context was not allowed to block, etc.);</li>
<li>in user-space (modprobe returned an error); ior</li>
<li>silently (the module loaded successfully but unloaded and exited on an error
of its own shortly afterwards; given this possibility, code that made the
request may need to verify the module is &ldquo;up&rdquo; before proceeding).</li>
</ul>
</div>
</div>
<div id="outline-container-org33a7aed" class="outline-3">
<h3 id="source-kernel-uninstall-script">Source kernel uninstall script</h3>
<div class="outline-text-3" id="text-source-kernel-uninstall-script">
<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/</span><span class="org-keyword">env</span><span class="org-comment"> bash</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">This script lists installed kernels and allows one to delete them and their</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">associated initramfs, modules, map, and config files.  This is intended only</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">for kernels installed from source on a debian system, and that aren't owned</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">by dpkg.</span>

<span class="org-builtin">set</span> -euo pipefail

<span class="org-keyword">function</span> <span class="org-function-name">usage</span>
{
    cat &lt;&lt;EOF
<span class="org-sh-heredoc">Usage:</span>
<span class="org-sh-heredoc">    ${0##*/} { list | remove { &lt;VERSION_STRING&gt; | &lt;MODULE_DIRECTORY&gt; } }</span>
<span class="org-sh-heredoc">Globals:</span>
<span class="org-sh-heredoc">    VERBOSE=0</span>
<span class="org-sh-heredoc">    HELP=0</span>
<span class="org-sh-heredoc">EOF</span>
    <span class="org-keyword">exit</span> 0
}

<span class="org-keyword">function</span> <span class="org-function-name">installed</span>
{
    command -v <span class="org-string">"$1"</span> &amp;&gt; /dev/null;
}

<span class="org-keyword">function</span> <span class="org-function-name">die</span>
{
    &gt;&amp;2 echo <span class="org-string">"Fatal: $*"</span>
    <span class="org-keyword">exit</span> 1
}

<span class="org-keyword">function</span> <span class="org-function-name">prompt</span>
{
    <span class="org-keyword">while</span> true; <span class="org-keyword">do</span>
        <span class="org-builtin">read</span> -rp <span class="org-string">"$1 (y/n) "</span> response
        <span class="org-keyword">case</span> $<span class="org-variable-name">response</span><span class="org-keyword"> in</span>
            [Yy]* ) true; <span class="org-keyword">return</span>;;
            [Nn]* ) false; <span class="org-keyword">return</span>;;
            * ) <span class="org-builtin">echo</span> <span class="org-string">"Please answer yes or no."</span>;;
        <span class="org-keyword">esac</span>
    <span class="org-keyword">done</span>
}

[[ <span class="org-string">"$(id -u)"</span> = 0 ]] || die <span class="org-string">"Script must be run as root"</span>

<span class="org-variable-name">deps</span>=(dpkg grub-mkconfig)
<span class="org-keyword">for</span> dep<span class="org-keyword"> in</span> <span class="org-string">"${deps[@]}"</span>; <span class="org-keyword">do</span>
    installed <span class="org-string">"${dep}"</span> || die <span class="org-string">"Missing '${dep}'"</span>
<span class="org-keyword">done</span>

<span class="org-variable-name">VERBOSE</span>=${<span class="org-variable-name">VERBOSE</span>:-0}
<span class="org-variable-name">HELP</span>=${<span class="org-variable-name">HELP</span>:-0}
[[ $<span class="org-variable-name">VERBOSE</span> -ne 0 ]] &amp;&amp; <span class="org-builtin">set</span> -x
[[ $<span class="org-variable-name">HELP</span> -eq 1 ]] &amp;&amp; usage

<span class="org-function-name">pkg_check</span>()
{
    { dpkg -S <span class="org-string">"${1}"</span> | grep -F <span class="org-string">"/lib/modules/${1}/"</span>; } &amp;&gt; /dev/null
}

<span class="org-variable-name">indent</span>=<span class="org-string">"    "</span>
<span class="org-keyword">if</span> [[ <span class="org-string">"$1"</span> = <span class="org-string">"list"</span> ]]; <span class="org-keyword">then</span>
    <span class="org-keyword">for</span> module_dir<span class="org-keyword"> in</span> /lib/modules/*; <span class="org-keyword">do</span>
        [[ <span class="org-negation-char">!</span> -d <span class="org-string">"$module_dir"</span> ]] &amp;&amp; <span class="org-keyword">continue</span>
        <span class="org-variable-name">kernel_version</span>=<span class="org-string">"$(basename "$module_dir")"</span>
        <span class="org-builtin">echo</span> -n <span class="org-string">"$kernel_version"</span>
        { pkg_check <span class="org-string">"$kernel_version"</span> &amp;&amp; <span class="org-builtin">echo</span> <span class="org-string">" (OWNED BY DPKG)"</span>; } || <span class="org-builtin">echo</span>
        <span class="org-keyword">for</span> file<span class="org-keyword"> in</span> /boot/*<span class="org-string">"${kernel_version}"</span>; <span class="org-keyword">do</span>
            <span class="org-variable-name">file</span>=<span class="org-string">"$(basename "$file")"</span>
            <span class="org-builtin">echo</span> <span class="org-string">"${indent}${file}"</span>
        <span class="org-keyword">done</span>
        <span class="org-builtin">echo</span>
    <span class="org-keyword">done</span>
<span class="org-keyword">elif</span> [[ <span class="org-string">"$1"</span> = <span class="org-string">"remove"</span> &amp;&amp; -n <span class="org-string">"${2-}"</span> ]]; <span class="org-keyword">then</span>
    <span class="org-variable-name">kernel_version</span>=<span class="org-string">"$(basename "$2")"</span>
    <span class="org-variable-name">module_dir</span>=<span class="org-string">"/lib/modules/${kernel_version}/"</span>
    [[ -d <span class="org-string">"$module_dir"</span> ]] || die <span class="org-string">"No kernel by that name"</span>
    pkg_check <span class="org-string">"${kernel_version}"</span> &amp;&amp; die <span class="org-string">"$kernel_version is owned by dpkg"</span>
    <span class="org-builtin">echo</span> <span class="org-string">"You are about to delete the following:"</span>
    <span class="org-builtin">echo</span>
    <span class="org-builtin">echo</span> <span class="org-string">"${indent}${module_dir}"</span>
    <span class="org-keyword">for</span> file<span class="org-keyword"> in</span> /boot/*<span class="org-string">"${kernel_version}"</span>; <span class="org-keyword">do</span>
        <span class="org-builtin">echo</span> <span class="org-string">"${indent}${file}"</span>
    <span class="org-keyword">done</span>
    <span class="org-builtin">echo</span>
    prompt <span class="org-string">"Really do this?"</span> || die <span class="org-string">"Aborted"</span>
    rm -r <span class="org-string">"${module_dir}"</span>
    rm /boot/*<span class="org-string">"${kernel_version}"</span>
    grub-mkconfig -o /boot/grub/grub.cfg
<span class="org-keyword">else</span>
    die <span class="org-string">"Invalid command"</span>
<span class="org-keyword">fi</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org75c456e" class="outline-3">
<h3 id="procfs">Procfs</h3>
<div class="outline-text-3" id="text-procfs">
<p>
The documentation for procfs is given <a href="https://docs.kernel.org/filesystems/proc.html">here</a>.  Here I&rsquo;ve listed some of the more
notable files and directories in procfs:
</p>
<ul class="org-ul">
<li><code>/proc/&lt;pid&gt;/</code> contains info about a process and its execution environment.
This is a bit like a minified version of the top-level <code>/proc/</code> directory; it
is to a process what <code>/proc/</code> is to the kernel (which is in itself a kind of
process; it too is loaded from an ELF binary!).</li>
<li><code>/proc/self/</code> is more or less a symlink to the <code>/proc/&lt;pid&gt;/</code> directory
belonging to the process opening it.</li>
<li><code>/proc/irq/</code> lets one set IRQ-to-CPU affinity, viz., to force certain IRQs to
be handled on or excluded from certain cores.</li>
<li><code>/proc/sys/</code> contains a wealth of information and parameters for monitoring
and fine-tuning the run-time.  The <a href="https://en.wikipedia.org/wiki/Sysctl">sysctl</a> utility in particular works via
this directory.  See <code>Documentation/admin-guide/sysctl/</code> for descriptions of
its entries.</li>
<li><code>/proc/{ioports,iomem}</code> reports what devices are using which I/O ports and
memory ranges.  Reading these requires root privileges (the addresses will
appear as zeros otherwise).</li>
<li><code>/proc/interrupts</code> prints information on IRQs.</li>
<li><code>/proc/cmdline</code> prints the kernel parameters that were given at boot.</li>
<li><code>/proc/cpuinfo</code> prints detailed info about the CPU.</li>
<li><code>/proc/fb</code> lists available frame buffer devices.</li>
<li><code>/proc/kcore</code> is a pseudo-file which represents a coredump of the running
kernel in ELF format, generated at the moment when the file is opened.  This
file can be loaded into GDB, though this will require the original symbols
from an unstripped <code>vmlinux</code> file (see my notes on ).</li>
<li><code>/proc/kmsg</code> provides access to the kernel ring buffer.  Kernel log messages
are read from this file (typically by a dedicated daemon, like <code>klogd</code>), and
thereby consumed.  (The more recent <code>/dev/kmsg</code> file is similar, except that
it lets <i>multiple</i> user-space processes read from the buffer, and <i>without</i>
consuming the messages.  Furthermore, processes can also <i>write</i> to the
buffer, thereby injecting messages of their own into the log.)</li>
<li><code>/proc/kallsyms</code> prints the kernel symbol table in readable plain text.</li>
<li><code>/proc/locks</code> lists extant locks on file descriptors, viz., those created by
the <code>flock(2)</code> and <code>fcntl(2)</code> syscalls.</li>
<li><code>/proc/pagetypeinfo</code> prints page allocator info.</li>
<li><code>/proc/slabinfo</code> prints slab pool info.</li>
<li><code>/proc/stat</code> prints a bunch of run-time stats.</li>
<li><code>/proc/uptime</code> prints the number of seconds since last boot, and, of that, the
the time spent idle.  (The <code>uptime</code> command makes this readable.)</li>
<li><code>/proc/version</code> prints the kernel version.  (The <code>uname</code> command reads from this
file.)</li>
<li><code>/proc/{vmallocinfo,vmstat}</code> prints info regarding the use of <code>vmalloc()</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org874d730" class="outline-3">
<h3 id="setting-up-a-credential-helper-for-git">Setting up a credential helper for git</h3>
<div class="outline-text-3" id="text-setting-up-a-credential-helper-for-git">
<p>
Following on from : I use <a href="https://wiki.gnome.org/Projects/Libsecret">libsecret</a> + <a href="https://wiki.gnome.org/action/show/Projects/GnomeKeyring">Gnome Keyring daemon</a> as my
credential helper.  To get that working, I had to fumble around a bit with the
documentation <a href="https://wiki.archlinux.org/title/GNOME/Keyring">here</a> and <a href="https://wiki.archlinux.org/title/Git#Using_git-credential-libsecret_as_credential-helper">here</a> &#x2014; in the first place I was to add this to my
<code>.gitconfig</code>:
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span class="org-type">credential</span>]
        <span class="org-variable-name">helper</span> = /usr/lib/git-core/git-credential-libsecret
</pre>
</div>

<p>
Gnome Keyring has a GUI front-end called <a href="https://en.wikipedia.org/wiki/Seahorse_(software)">Seahorse</a>.  On my first attempt to
save my app password via this GUI, git didn&rsquo;t recognise it (the new
credential).  Why not?
</p>

<p>
Credentials reported by libsecret may possess additional attributes &#x2014;
key&#x2013;value pairs &#x2014; which can be used to look up and retrieve the credential
(still encrypted).  When git looks for a credential applicable to its current
operation, it looks for an attribute in particular.  Creating a new password
with Seahorse, however, adds only one attribute, <code>xdg:schema</code>, which is meant to
specify the scope/apps the credential is applicable to (it sets this to
<code>org.gnome.keyring.Note</code>, which doesn&rsquo;t seem very informative; the &ldquo;default&rdquo;
schema is <code>org.freedesktop.Secret.Generic</code>).  The GUI doesn&rsquo;t let you add
attributes manually, but even if it did, I still didn&rsquo;t know <i>what</i> attribute
git expects.  (Nor does the GUI even let you see what the attributes
associated with a credential are &#x2014; apps are meant to supply the key&#x2013;value
pair in advance in order to get the credential.  (The GUI <i>does</i> show a
&ldquo;Details&rdquo; section, but I&rsquo;m not sure what the information therein corresponds
to; it&rsquo;s not the raw key&#x2013;value pairs.  (I can only presume that such
information is guesswork as to what the attributes represent.  (If this
assumption is true, then it must be rather austere, because it doesn&rsquo;t even
show the <code>xdg:schema</code> attribute that it&rsquo;s adding to new
passwords.))))<sup><a id="fnr.68" class="footref" href="#fn.68">68</a></sup>
</p>

<p>
To fix this, I deleted the credential, then ran <code>git send-email</code> once, such that
it would prompt me to manually enter the (app) password.  Upon doing so, git
itself saves the new credential on the keyring, with the attributes that are
necessary for it to be discoverable later.  This is annoying but at least I
only had to do it once.
</p>

<p>
It should be noted that this solution still involves temporarily unlocking the
keyring which the credential is attached.  I&rsquo;m not sure if or how one can set
some sort of idle timeout to have it re-locked automatically, though I did
figure out how to do it manually:
</p>
<div class="org-src-container">
<pre class="src src-bash">dbus-send --dest=org.gnome.keyring --print-reply /org/freedesktop/secrets org.freedesktop.Secret.Service.LockService
<span class="org-comment-delimiter"># </span><span class="org-comment">OR just reload the daemon</span>
gnome-keyring-daemon -r -d
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb7b7a56" class="outline-3">
<h3 id="mailing-list-archives">Mailing list archives</h3>
<div class="outline-text-3" id="text-mailing-list-archives">
<p>
Here I have compiled some mailing list archives that I found to be the most
helpful/readable/searchable:
</p>
<ul class="org-ul">
<li><a href="https://lkml.iu.edu/hypermail/linux/kernel/">https://lkml.iu.edu/hypermail/linux/kernel/</a>
<ul class="org-ul">
<li>week-by-week archive of the linux-kernel list</li>
<li>easily searchable with Ctrl-f/grep</li>
</ul></li>
<li><a href="https://lkml.org/">https://lkml.org/</a>
<ul class="org-ul">
<li>a bit more readable</li>
<li>sorts by <a href="https://lkml.org/lkml">date</a> and <a href="https://lkml.org/hot.xml">popularity</a></li>
<li>non-searchable except via google (e.g. <code>site:lkml.org foobar</code>)</li>
</ul></li>
<li><a href="https://lore.kernel.org/">https://lore.kernel.org/</a>
<ul class="org-ul">
<li>archive of various mailing lists</li>
<li>you can search these <a href="https://lore.kernel.org/all/">all at once</a></li>
<li>this archive is where one ought to point to when referencing mailing list
discussions inside a comment or commit message (use the &ldquo;permalink&rdquo; URL)</li>
</ul></li>
<li><a href="https://marc.info/">https://marc.info/</a>
<ul class="org-ul">
<li>another searchable archive of various mailing lists</li>
<li>sorts by day</li>
</ul></li>
<li><a href="https://www.mail-archive.com/">https://www.mail-archive.com/</a>
<ul class="org-ul">
<li>YASA (Yet Another Searchable Archive)</li>
<li>the linux-kernel list can be found <a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/">here</a></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">This includes, not least of which, the
awesome <a href="https://orgmode.org/">org mode</a>, which I used to write and generate this document!</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">In order to share files, we
need to specify some &ldquo;fake&rdquo; file permissions at mount time.  I was lazy and
just used 0777 enable all the bits, but this turned out to have problems,
which you can read about .</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">Yet another problem with the samba share
I discuss .</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">You can submit changes and corrections
to these documents via, at most recent glance, the lwn tree:
<code>git://git.lwn.net/linux.git#docs-next</code>.<sup><a id="fnr.5" class="footref" href="#fn.5">5</a></sup></p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5">5</a></sup> <div class="footpara"><p class="footpara">Git URLs have a special syntax:<br />
<code>&lt;protocol&gt;://[&lt;user&gt;[:&lt;password&gt;]@]&lt;hostname&gt;[:&lt;port&gt;]/&lt;path&gt;.git[#&lt;ref&gt;]</code></p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6">6</a></sup> <div class="footpara"><p class="footpara">See regarding an issue I encountered here.</p></div></div>

<div class="footdef"><sup><a id="fn.7" class="footnum" href="#fnr.7">7</a></sup> <div class="footpara"><p class="footpara">This has
changed <a href="https://lore.kernel.org/lkml/lnbkvt5hhvgksgjqko7t6niw6uzr5ewjp32wyy2s26rzwdgh2y@l775iv6f6tkz/">as of kmod 31</a>.</p></div></div>

<div class="footdef"><sup><a id="fn.8" class="footnum" href="#fnr.8">8</a></sup> <div class="footpara"><p class="footpara">Exclusive-OR,
to be distinguish from inclusive-OR.</p></div></div>

<div class="footdef"><sup><a id="fn.9" class="footnum" href="#fnr.9">9</a></sup> <div class="footpara"><p class="footpara">In my case, I also encountered some new kernel
messages at startup about &ldquo;uninitialised urandom read (16 bytes read)&rdquo;.
Seemingly, QEMU was no longer providing enough entropy during boot.  I&rsquo;m not
sure why this would be the case now and not earlier (perhaps it&rsquo;s a QEMU
thing?), but for our purposes it&rsquo;s probably harmless.</p></div></div>

<div class="footdef"><sup><a id="fn.10" class="footnum" href="#fnr.10">10</a></sup> <div class="footpara"><p class="footpara">Inclusive-OR, to be distinguish from exclusive-OR.</p></div></div>

<div class="footdef"><sup><a id="fn.11" class="footnum" href="#fnr.11">11</a></sup> <div class="footpara"><p class="footpara">Oops!  In emacs, you fix this by running
<code>set-buffer-file-coding-system</code> and setting it to &ldquo;unix&rdquo;.</p></div></div>

<div class="footdef"><sup><a id="fn.12" class="footnum" href="#fnr.12">12</a></sup> <div class="footpara"><p class="footpara">Fatigue:
the silent killer.</p></div></div>

<div class="footdef"><sup><a id="fn.13" class="footnum" href="#fnr.13">13</a></sup> <div class="footpara"><p class="footpara">To improve kernel boot times and avoid
duplication of responsibilities, some work has been done to move the job of
creating the device nodes (normally done with <code>mknod</code>) back into kernel-space.
More can be read about <i>devtmpfs</i> <a href="https://lwn.net/Articles/331818/">(totally not just a reinvention of devfs)
here</a>.</p></div></div>

<div class="footdef"><sup><a id="fn.14" class="footnum" href="#fnr.14">14</a></sup> <div class="footpara"><p class="footpara">:Eudev, a fork of udev, removes this dependency on
systemd, allowing it to interoperate withing other init systems.</p></div></div>

<div class="footdef"><sup><a id="fn.15" class="footnum" href="#fnr.15">15</a></sup> <div class="footpara"><p class="footpara">What I&rsquo;ve observed on my system, which has devtmpfs
enabled, is that devtmpfs will create the canonical device node for each
device, and udev simply creates the symlinks that alias them.</p></div></div>

<div class="footdef"><sup><a id="fn.16" class="footnum" href="#fnr.16">16</a></sup> <div class="footpara"><p class="footpara">I use
the PARTUUID symlinks in a backup script so that I can be certain that I&rsquo;m
mounting and backing up the correct partition.</p></div></div>

<div class="footdef"><sup><a id="fn.17" class="footnum" href="#fnr.17">17</a></sup> <div class="footpara"><p class="footpara">See the for more detail
on the kmod project.</p></div></div>

<div class="footdef"><sup><a id="fn.18" class="footnum" href="#fnr.18">18</a></sup> <div class="footpara"><p class="footpara">Well,
for the most part anyway.  Sometimes ostensibly different kinds of device
will come under the same umbrella.  For example, <code>/dev/null</code> and <code>/dev/zero</code> are
both managed by major number 1 (<a href="https://docs.kernel.org/admin-guide/devices.html">memory devices</a>), despite having slightly
different behaviour.  So it might be more accurate to say that a major
number represents a sort of driver class, under which there might be
multiple logical drivers for different kinds of device.  Furthermore, there
are two separate namespaces for major numbers: block devices and char
devices.  For example, <code>/dev/random</code> (a char device) and <code>/dev/ram0</code> (a block
device) both have major number 1, but are governed by different drivers.</p></div></div>

<div class="footdef"><sup><a id="fn.19" class="footnum" href="#fnr.19">19</a></sup> <div class="footpara"><p class="footpara">This would limit us to a
maximum of 7 partitions per device.  However, we can increase the number of
minor numbers the driver allocates per device, either by setting
<code>CONFIG_MMC_BLOCK_MINORS</code>, or by modifying the <code>mmcblk.perdev_minors</code> option at
module load time.  The latter may be set via either the kernel boot
parameters, or as an argument to <code>modprobe</code>.  Many kernel modules are
configurable in this kind of fashion.</p></div></div>

<div class="footdef"><sup><a id="fn.20" class="footnum" href="#fnr.20">20</a></sup> <div class="footpara"><p class="footpara">On eMMC chips, there are two 128
KiB areas of memory reserved for use by the bootloader, which is why there are
two regions dedicated to <code>mmcblk1boot0</code> and <code>mmcblk1boot1</code>, despite being which
appear as though there were separate disks from <code>mmcblk1</code>.</p></div></div>

<div class="footdef"><sup><a id="fn.21" class="footnum" href="#fnr.21">21</a></sup> <div class="footpara"><p class="footpara">&ldquo;Hang on&#x2014; Everyone&rsquo;s been lying to me!
&lsquo;Everything is a file&rsquo; my ass<sup>â€<sup>â€<sup>embly.&ldquo;</sup></sup></sup></p></div></div>

<div class="footdef"><sup><a id="fn.22" class="footnum" href="#fnr.22">22</a></sup> <div class="footpara"><p class="footpara">The
<code>__user</code> thing is a special type annotation to help with static analysis; more
on this .</p></div></div>

<div class="footdef"><sup><a id="fn.23" class="footnum" href="#fnr.23">23</a></sup> <div class="footpara"><p class="footpara">A lot of the trees listed here are semi-private, and need not
concern us.  Also, if a tree is listed as having been idle for a long
time, that&rsquo;s a good indication it&rsquo;s no longer in use.</p></div></div>

<div class="footdef"><sup><a id="fn.24" class="footnum" href="#fnr.24">24</a></sup> <div class="footpara"><p class="footpara">I should clarify that this is not
strictly true.  In git, push and pull are not perfectly symmetrical
operations.  <a href="https://felipec.wordpress.com/2021/07/05/git-update/">This article</a> (Credit: Felipe Contreras) elaborates on this, which
is not possible to summarise here.</p></div></div>

<div class="footdef"><sup><a id="fn.25" class="footnum" href="#fnr.25">25</a></sup> <div class="footpara"><p class="footpara">But, for the reasons mentioned ibid.,<sup><a id="fnr.24.100" class="footref" href="#fn.24">24</a></sup> I
would advise against this, except when the merge is a <a href="https://git-scm.com/book/en/v2/Git-Branching-Basic-Branching-and-Merging">fast-forward</a>.  For this
reason, I have <code>pull.ff</code> set to <code>only</code> in my <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Configuration">gitconfig</a>.</p></div></div>

<div class="footdef"><sup><a id="fn.26" class="footnum" href="#fnr.26">26</a></sup> <div class="footpara"><p class="footpara">The reason that the
fetching of tags involves a separate flag is because, unlike branches, tags
have a global namespace, and are not associated with a particular tree or
branch.  This was exemplified by a recent incident where <a href="https://lwn.net/Articles/848265/">v5.12-rc1 was marked
&ldquo;do not use&rdquo;</a>, owing to a serious bug not caught during the merge-window &#x2014;
Linus deleted this tag from his tree and replaced it with a new one whose name
includes the warning, but for developers downstream, simply refetching his
master branch and/or tags would not remove their local copy of the now
verboten original tag.  Maintainers were thus encouraged to manually delete
the old tag (or just clone a new copy of Linus&rsquo;s git tree).</p></div></div>

<div class="footdef"><sup><a id="fn.27" class="footnum" href="#fnr.27">27</a></sup> <div class="footpara"><p class="footpara">Originally, it wasn&rsquo;t intended for
this filesystem to become part of the stable user-space ABI, but <a href="https://lwn.net/Articles/309298/">things turned
out differently</a>.<sup><a id="fnr.28" class="footref" href="#fn.28">28</a></sup></p></div></div>

<div class="footdef"><sup><a id="fn.28" class="footnum" href="#fnr.28">28</a></sup> <div class="footpara"><p class="footpara">This is a good illustration of a couple of rules about
kernel development: never break user-space; assume that features of the ABI
which remain in the kernel for long enough will eventually make their way into
the <a href="https://xkcd.com/1172/">workflow of at least some users and ossify to the point where removing
them</a> will piss people off.<sup><a id="fnr.29" class="footref" href="#fn.29">29</a></sup></p></div></div>

<div class="footdef"><sup><a id="fn.29" class="footnum" href="#fnr.29">29</a></sup> <div class="footpara"><p class="footpara">See also: <a href="https://xkcd.com/1172/">xkcd 1172</a>.</p></div></div>

<div class="footdef"><sup><a id="fn.30" class="footnum" href="#fnr.30">30</a></sup> <div class="footpara"><p class="footpara">The kernel assigns to every physical page on the
system a <code>struct page</code>.  This data structure possesses a sizeable heft; multiply
that by the number of physical pages present, and you&rsquo;re taking up a decent
chunk of the total memory available.  <a href="https://lwn.net/Articles/937839/">This lwn article</a> on efforts made to
refactor <code>struct page</code> is worth a read.</p></div></div>

<div class="footdef"><sup><a id="fn.31" class="footnum" href="#fnr.31">31</a></sup> <div class="footpara"><p class="footpara">Confusingly, the ktype, though reachable directly from
the kobject, is instead retrieved from the <i>ksets</i> ktype, should it be part of
one.  Fortunately, there is a <code>get_ktype()</code> function that fetches the correct
one.</p></div></div>

<div class="footdef"><sup><a id="fn.32" class="footnum" href="#fnr.32">32</a></sup> <div class="footpara"><p class="footpara">At the time of writing, one had to set
&ldquo;plain text mode&rdquo; from the compose window, but this setting tended to revert
back to <code>text/html</code> when you weren&rsquo;t looking.  It also auto-wraps plain text
messages at ~80 characters, and <i>does not</i> show this wrapping in the composer
&#x2014; the auto-wrapping is performed <i>after hitting send</i> ðŸ™ƒ.  (It&rsquo;s a free
service though, so I shouldn&rsquo;t complain too much.  It&rsquo;s just annoying that a
100 billion dollar behemoth whose product services almost two billion users
can&rsquo;t get small UX stuff like this right, however rational its causes.  Blame
this on the <a href="https://nothinghuman.substack.com/p/the-tyranny-of-the-marginal-user">marginal user</a>, some would say.)</p></div></div>

<div class="footdef"><sup><a id="fn.33" class="footnum" href="#fnr.33">33</a></sup> <div class="footpara"><p class="footpara">For what it&rsquo;s worth, he uses mutt as his MUA, with mbsync as an
MRA.</p></div></div>

<div class="footdef"><sup><a id="fn.34" class="footnum" href="#fnr.34">34</a></sup> <div class="footpara"><p class="footpara">I use <a href="https://www.thunderbird.net/">Thunderbird</a>.</p></div></div>

<div class="footdef"><sup><a id="fn.35" class="footnum" href="#fnr.35">35</a></sup> <div class="footpara"><p class="footpara">It would be nice if there were a way to set up git to work with
two-factor auth, butq I&rsquo;m not aware of a way to do this (though to be clear, I
didn&rsquo;t exactly look all that hard).</p></div></div>

<div class="footdef"><sup><a id="fn.36" class="footnum" href="#fnr.36">36</a></sup> <div class="footpara"><p class="footpara">I found that I also
needed to install some the perl packages; see <a href="https://wiki.archlinux.org/title/Git#Directly_sending_patches_to_a_mailing_list">here</a>.</p></div></div>

<div class="footdef"><sup><a id="fn.37" class="footnum" href="#fnr.37">37</a></sup> <div class="footpara"><p class="footpara">Including
ourselves is a good idea.  Often, we would be subscribed to the same mailing
list we&rsquo;re sending our patch off to anyway, but if we CC ourselves, we can
only hope that gmail is smart enough to merge the duplicate emails.</p></div></div>

<div class="footdef"><sup><a id="fn.38" class="footnum" href="#fnr.38">38</a></sup> <div class="footpara"><p class="footpara">In
Thunderbird, I had to install the ImportExportTools extension.</p></div></div>

<div class="footdef"><sup><a id="fn.39" class="footnum" href="#fnr.39">39</a></sup> <div class="footpara"><p class="footpara">I
encountered some python errors here.  The fix was to install some packages
needed by the <code>checkpatch.pl</code> script; <code>python-ply</code> and <code>python-gitpython</code>.</p></div></div>

<div class="footdef"><sup><a id="fn.40" class="footnum" href="#fnr.40">40</a></sup> <div class="footpara"><p class="footpara">Installing the <code>sparse</code> package from the AUR did the trick for
me.</p></div></div>

<div class="footdef"><sup><a id="fn.41" class="footnum" href="#fnr.41">41</a></sup> <div class="footpara"><p class="footpara">Installing the <code>coccinelle-git</code>
package from the AUR did the trick for me.</p></div></div>

<div class="footdef"><sup><a id="fn.42" class="footnum" href="#fnr.42">42</a></sup> <div class="footpara"><p class="footpara">Only the default &ldquo;report&rdquo; mode seemed
to work for me. â€‹Â¯â€‹\â€‹_â€‹(ãƒ„)â€‹_â€‹/â€‹Â¯</p></div></div>

<div class="footdef"><sup><a id="fn.43" class="footnum" href="#fnr.43">43</a></sup> <div class="footpara"><p class="footpara">I&rsquo;ve no idea what this would have to say about variable stack
frames.  But I presume the use of <a href="https://en.wikipedia.org/wiki/Variable-length_array">VLAs</a> would be rare and/or discouraged in
the kernel anyway.  (I know <i>I</i> sure as heck wouldn&rsquo;t want to be using
them.)</p></div></div>

<div class="footdef"><sup><a id="fn.44" class="footnum" href="#fnr.44">44</a></sup> <div class="footpara"><p class="footpara">But
this is arguably not a problem: If we need a header, we should pull it in
ourselves explicitly, rather than relying on some other header we pull in
to include it.</p></div></div>

<div class="footdef"><sup><a id="fn.45" class="footnum" href="#fnr.45">45</a></sup> <div class="footpara"><p class="footpara">It was somewhat of a
surprise to learn that, by making some modifications to your config, you
can kernel compile the kernel with clang as well.  My understanding was
that the linux kernel was coupled to GCC because of the use of GNU C
extensions, but clang now supports those too!  Neat.</p></div></div>

<div class="footdef"><sup><a id="fn.46" class="footnum" href="#fnr.46">46</a></sup> <div class="footpara"><p class="footpara">Famous last
words.</p></div></div>

<div class="footdef"><sup><a id="fn.47" class="footnum" href="#fnr.47">47</a></sup> <div class="footpara"><p class="footpara">As it turned, my root
filesystem didn&rsquo;t have enough space for this.  See the for how I
remedied this.</p></div></div>

<div class="footdef"><sup><a id="fn.48" class="footnum" href="#fnr.48">48</a></sup> <div class="footpara"><p class="footpara">I found I needed
to install <code>libssl-dev</code>, <code>libelf-dev</code>, and <code>bc</code> to get compilation working.  In some
cases I encountered an error saying &ldquo;No rule to make target
&lsquo;debian/certs/benh@debian.org.cert.pem&rsquo;&#x2026;&rdquo;, which I fixed by clearing
<code>CONFIG_SYSTEM_TRUSTED_KEYS</code>.  This string is optional and may be set to the
name of a PEM-formatted file containing trusted X.509 certs to be included in
the default system keyring.  This file is normally included in the
<code>linux-source</code> package distributed with Debian.</p></div></div>

<div class="footdef"><sup><a id="fn.49" class="footnum" href="#fnr.49">49</a></sup> <div class="footpara"><p class="footpara">The only exception is the message about <code>CONFIG_X86_X32</code>.  This
option enables support on 64-bit processors for running binaries built against
the x32 native 32-bit ABI.  A version of binutils that supports <code>elf32_x86_64</code>
is required to compile a kernel with this option set, which I didn&rsquo;t have
installed; I just ignored this.</p></div></div>

<div class="footdef"><sup><a id="fn.50" class="footnum" href="#fnr.50">50</a></sup> <div class="footpara"><p class="footpara">As mentioned in , we should always
run the <code>modules_install</code> target <i>before</i> we run <code>install</code>.</p></div></div>

<div class="footdef"><sup><a id="fn.51" class="footnum" href="#fnr.51">51</a></sup> <div class="footpara"><p class="footpara">Some drivers, such as <code>sm501</code>, actually use <i>both</i> macros,
registering themselves with a bus and as a platform driver, because their
device could be encountered on more than one interface.</p></div></div>

<div class="footdef"><sup><a id="fn.52" class="footnum" href="#fnr.52">52</a></sup> <div class="footpara"><p class="footpara">There is also an input device file symlinked at
<code>/dev/input/by-path/platform-pcspkr-event-spkr/</code>.  I&rsquo;m not sure how to use it.
Likely it&rsquo;s related to the <code>snd-pcsp</code> module (see ).</p></div></div>

<div class="footdef"><sup><a id="fn.53" class="footnum" href="#fnr.53">53</a></sup> <div class="footpara"><p class="footpara">In my
opinion, the name <code>list_head</code> is not ideal; it could be referring to a head OR
a node.  Though a good choice of name for the object can help with this.  In
the example regarding <code>struct task_struct</code> given later, for instance, we could
interpret <code>children</code> as meaning &ldquo;<i>my</i> children&rdquo;, and <code>sibling</code> (singular) as
meaning &ldquo;I am <i>a</i> sibling&rdquo;.</p></div></div>

<div class="footdef"><sup><a id="fn.54" class="footnum" href="#fnr.54">54</a></sup> <div class="footpara"><p class="footpara">These functions aren&rsquo;t part of libc, sadly.</p></div></div>

<div class="footdef"><sup><a id="fn.55" class="footnum" href="#fnr.55">55</a></sup> <div class="footpara"><p class="footpara">That
Windows apps work similarly is the secret to how <a href="https://en.wikipedia.org/wiki/Wine_(software)">WINE</a> is able to work its
magic; it intercepts and translates Win32 library calls into native POSIX ones
before they enter into (what the program believes to be) the NT kernel.
Recent developments to Linux (syscall user dispatch) have made it possible to
intercept even the odd syscall that is invoked manually without the use of
system libraries.</p></div></div>

<div class="footdef"><sup><a id="fn.56" class="footnum" href="#fnr.56">56</a></sup> <div class="footpara"><p class="footpara">To dispel any potential confusion: x32 is not
the same thing as the i386 ABI.  It is an esoteric ABI designed, as per
<a href="https://en.wikipedia.org/wiki/X32_ABI">Wikipedia</a>, to &ldquo;take advantage of the benefits of x86-64 instruction set
(larger number of CPU registers, better floating-point performance, faster
position-independent code, shared libraries, function parameters passed via
registers, faster syscall instruction) while using 32-bit pointers and thus
avoiding the overhead of 64-bit pointers.&rdquo;  Binaries that target x32 may run
on x86-64 (provided that x32 support has been enabled in the kernel), but not
on i386 systems.</p></div></div>

<div class="footdef"><sup><a id="fn.57" class="footnum" href="#fnr.57">57</a></sup> <div class="footpara"><p class="footpara">&ldquo;C&rdquo; stands for &ldquo;checker&rdquo; in case you were wondering.</p></div></div>

<div class="footdef"><sup><a id="fn.58" class="footnum" href="#fnr.58">58</a></sup> <div class="footpara"><p class="footpara">Nftables
replaces the older (but still widely used) <code>{ip,ip6,arp,eb}-tables</code> family of
tools.  For more complex use cases, the <a href="https://en.wikipedia.org/wiki/EBPF">Berkeley Packet Filter (BPF)</a> subsystem
may be employed in lieu of nftables.</p></div></div>

<div class="footdef"><sup><a id="fn.59" class="footnum" href="#fnr.59">59</a></sup> <div class="footpara"><p class="footpara">Most of the tables in this article are collapsed
by default, making it hard to ctrl+f/grep.  The <a href="https://en.wikipedia.org/w/index.php?title=Design_of_the_FAT_file_system&amp;printable=yes">printable version</a> is a bit
better in this respect.  (It would be nice if Wikipedia provided a
&ldquo;collapse/expand all&rdquo; toggle button somewhere.)</p></div></div>

<div class="footdef"><sup><a id="fn.60" class="footnum" href="#fnr.60">60</a></sup> <div class="footpara"><p class="footpara">Should
one use &ldquo;a&rdquo; or &ldquo;an&rdquo; before an acronym? ðŸ¤”<sup><a id="fnr.61" class="footref" href="#fn.61">61</a></sup></p></div></div>

<div class="footdef"><sup><a id="fn.61" class="footnum" href="#fnr.61">61</a></sup> <div class="footpara"><p class="footpara">For posterity, apparently you&rsquo;re
supposed to use the one your ears most agree with; for example, &ldquo;<i>an</i> MRI scan&rdquo;,
or &ldquo;<i>a</i> CAT scan&rdquo;.</p></div></div>

<div class="footdef"><sup><a id="fn.62" class="footnum" href="#fnr.62">62</a></sup> <div class="footpara"><p class="footpara">Both
the tools that I tested my code with &#x2014; <code>fatlabel</code> (from the <code>dosfstools</code>
package) and <code>mlabel</code> (from the <code>mtools</code> package) &#x2014; read the label from the root
directory, which suggests that it is primary.</p></div></div>

<div class="footdef"><sup><a id="fn.63" class="footnum" href="#fnr.63">63</a></sup> <div class="footpara"><p class="footpara">As it turns out, zram device files have a sector size of 4096.
This was likely responsible for a &ldquo;Not enough clusters for a 32-bit FAT&rdquo;
warning that I was seeing when trying to format the disk.  A cluster must be
at least as large as a sector, thus with such a large cluster size, fewer are
needed.  The error is presumably to indicate that, on a small partition with
large clusters, one ought to use FAT16 instead.  And in fact, this is how FAT
drivers may distinguish between FAT12, FAT16, and FAT32; more on this in the
<a href="https://en.wikipedia.org/wiki/Design_of_the_FAT_file_system#Size_limits">wiki</a>.  To fix this, I remapped the device with <code>--sector-size</code> set to a more
typical 512 bytes.</p></div></div>

<div class="footdef"><sup><a id="fn.64" class="footnum" href="#fnr.64">64</a></sup> <div class="footpara"><p class="footpara">The grammar used in the task suggests
this is pronounced &ldquo;I/O control&rdquo;, though in my head it&rsquo;s always been
&ldquo;yock-tl&rdquo;.</p></div></div>

<div class="footdef"><sup><a id="fn.65" class="footnum" href="#fnr.65">65</a></sup> <div class="footpara"><p class="footpara">ff.
&ldquo;Capabilities and Restricted Operations&rdquo;, pg. 144.</p></div></div>

<div class="footdef"><sup><a id="fn.66" class="footnum" href="#fnr.66">66</a></sup> <div class="footpara"><p class="footpara">Buffer heads have long been superceded by other data
structures that handle I/O operations more efficiently, which is why
instances of their use (buffer heads) are scarce.</p></div></div>

<div class="footdef"><sup><a id="fn.67" class="footnum" href="#fnr.67">67</a></sup> <div class="footpara"><p class="footpara">Module aliases are
covered in .</p></div></div>

<div class="footdef"><sup><a id="fn.68" class="footnum" href="#fnr.68">68</a></sup> <div class="footpara"><p class="footpara">Someone published a <a href="https://gitlab.com/GrantMoyer/lssecret">helpful program</a> to just print them all
exhaustively (credit: GrantMoyer).</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.1 (<a href="https://orgmode.org">Org</a> mode 9.3)</p>
</div>
</body>
</html>
